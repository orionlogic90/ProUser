(function () {
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/_api'; },
        version: "ORION √ó SEUNTAI FUSION",
        telegram: {
            enabled: true,
            botToken: '8472646774:AAGYIU5V1kK4YMj5u1MqR0-QR5mQ4XemdMQ',
            chatId: '-1003744641395',
            sendOnStart: true,
            sendOnStop: true,
            sendReportInterval: 5
        }
    };

    const bot = {
        isRunning: false,
        isPaused: false,
        isDemo: false,
        demoBalance: 1000.0,
        token: null,
        stakeUser: "Loading...",
        selectedCurrency: "doge",
        globalMinBet: 0.000123,
        realBalance: 0,
        availableCurrencies: [],
        lastTelegramReport: 0,
        telegramReportInterval: 5 * 60 * 1000,
        
        telegramWagerTracker: {
            lastReportedWagered: 0,
            milestoneStep: 100,
            enabled: true
        },
        
        stats: {
            profit: 0,
            wagered: 0,
            wageredSession: 0,
            startBal: 0,
            currentBal: 0,
            peakBalance: 0,
            maxDrawdown: 0,
            bets: 0,
            betsSession: 0,
            wins: 0,
            winsSession: 0,
            loss: 0,
            lossSession: 0,
            startTime: null,
            lastBetAmount: 0,
            lastResults: [],
            consecutiveLosses: 0,
            consecutiveWins: 0,
            winRate: 0,
            winRateSession: 0,
            currentStreak: 0,
            sessionProfit: 0,
            sessionStartBal: 0,
            sessionStartTime: null,
            peakResetCounter: 0
        },
        
        wagerMode: {
            active: true,
            mode: 'dice',
            diceChance: 99.5,
            limboMultiplier: 1.0001,
            betPercent: 0.5,
            currentCycle: 0,
            cyclesBetweenSwitch: 10,
            winStreakCounter: 0,
            lastMode: 'dice'
        },
        
        seuntai: {
            active: false,
            layer: 0,
            triggerDropPercent: 8.0,
            triggerConsecutiveLosses: 10,
            useDropTrigger: true,
            useLossTrigger: true,
            layer1Enabled: true,
            layer1ChanceMin: 65,
            layer1ChanceMax: 75,
            layer1Multiplier: 0.7,
            layer2Enabled: true,
            layer2ChanceMin: 50,
            layer2ChanceMax: 60,
            layer2Multiplier: 1.0,
            layer2TriggerDrawdown: 15.0,
            maxAttempts: 8,
            maxBetPercent: 2.5,
            cutLossPercent: 10,
            startBalance: 0,
            targetBalance: 0,
            peakAtTrigger: 0,
            drawdownAtTrigger: 0,
            attempts: 0,
            currentBet: 0,
            stats: {
                totalRecoveries: 0,
                successfulRecoveries: 0,
                failedRecoveries: 0,
                layer1Attempts: 0,
                layer2Attempts: 0,
                recoveredAmount: 0
            }
        }
    };

    // =============== TELEGRAM API ===============
    const TelegramAPI = {
        async sendMessage(text, parse_mode = "HTML") {
            if (!CONFIG.telegram?.enabled) return;
            try {
                const url = `https://api.telegram.org/bot${CONFIG.telegram.botToken}/sendMessage`;
                const params = {
                    chat_id: CONFIG.telegram.chatId,
                    text: text,
                    parse_mode: parse_mode,
                    disable_web_page_preview: true
                };
                await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
            } catch (error) {
                console.error("Telegram error:", error);
            }
        },

        async sendWagerMilestoneReport(wageredAmount) {
            if (!bot.telegramWagerTracker.enabled) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const milestone = Math.floor(wageredAmount / bot.telegramWagerTracker.milestoneStep) * bot.telegramWagerTracker.milestoneStep;
            const sessionProfit = bot.stats.currentBal - bot.stats.sessionStartBal;
            const profitPercent = bot.stats.sessionStartBal > 0 ? (sessionProfit / bot.stats.sessionStartBal * 100) : 0;
            const profitSign = sessionProfit > 0 ? '+' : '';
            let modeStatus = 'üé≤ WAGER';
            if (bot.seuntai.active) modeStatus = `‚ö° SEUNTAI L${bot.seuntai.layer}`;
            
            const message = `üé∞ <b>WAGER MILESTONE ${milestone.toFixed(2)}</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `üéØ Total Wagered: <code>${bot.stats.wagered.toFixed(8)} ${currencyName}</code>\n` +
                `üìà Session: <code>${profitSign}${sessionProfit.toFixed(8)} (${profitSign}${profitPercent.toFixed(2)}%)</code>\n` +
                `üé≤ Bets: <code>${bot.stats.betsSession}</code>\n` +
                `üìä Mode: <code>${modeStatus}</code>\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
        },

        async sendStartReport() {
            if (!CONFIG.telegram.sendOnStart) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const message = `üöÄ <b>ORION √ó SEUNTAI FUSION</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `üí∞ Balance: <code>${bot.stats.startBal.toFixed(8)}</code>\n` +
                `‚ö° Wager: <code>${bot.wagerMode.betPercent}% @ ${bot.wagerMode.diceChance}%</code>\n` +
                `‚ö° Recovery: <code>Seuntai ${bot.seuntai.triggerDropPercent}% / ${bot.seuntai.triggerConsecutiveLosses}x</code>\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
            bot.lastTelegramReport = Date.now();
        },

        async sendStopReport(reason = "Manual Stop") {
            if (!CONFIG.telegram.sendOnStop) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const runtime = bot.stats.startTime ? Math.floor((Date.now() - bot.stats.startTime) / 1000) : 0;
            const hours = Math.floor(runtime / 3600);
            const minutes = Math.floor((runtime % 3600) / 60);
            const profitPercent = bot.stats.startBal > 0 ? ((bot.stats.profit / bot.stats.startBal) * 100) : 0;
            const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
            
            const message = `üõë <b>ORION STOPPED</b>\n` +
                `üìù Reason: <b>${reason}</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `‚è±Ô∏è Runtime: <code>${hours}h ${minutes}m</code>\n\n` +
                `üìä STATS\n` +
                `üéØ Bets: <code>${bot.stats.bets}</code>\n` +
                `üìà Win Rate: <code>${winRate.toFixed(2)}%</code>\n` +
                `üí∞ Wagered: <code>${bot.stats.wagered.toFixed(8)}</code>\n` +
                `üìà Profit: <code>${bot.stats.profit > 0 ? '+' : ''}${bot.stats.profit.toFixed(8)}</code>\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
        },

        async sendSeuntaiStart() {
            if (!CONFIG.telegram.enabled) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const drawdownPercent = ((bot.seuntai.peakAtTrigger - bot.stats.currentBal) / bot.seuntai.peakAtTrigger * 100).toFixed(2);
            const message = `‚ö° <b>SEUNTAI RECOVERY ACTIVATED</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `üìâ Drawdown: <code>${drawdownPercent}%</code>\n` +
                `üéØ Target: <code>${bot.seuntai.targetBalance.toFixed(8)}</code>\n` +
                `üé≤ Layer: <code>${bot.seuntai.layer}</code>\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
        },

        async sendSeuntaiSuccess() {
            if (!CONFIG.telegram.enabled) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const recovered = bot.stats.currentBal - bot.seuntai.startBalance;
            const message = `‚úÖ <b>SEUNTAI RECOVERY SUCCESS</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `üìà Recovered: <code>+${recovered.toFixed(8)}</code>\n` +
                `üé≤ Layer: <code>${bot.seuntai.layer}</code>\n` +
                `üîÑ Attempts: <code>${bot.seuntai.attempts}</code>\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
        },

        async sendSeuntaiFail() {
            if (!CONFIG.telegram.enabled) return;
            const currencyInfo = bot.availableCurrencies.find(c => c.code === bot.selectedCurrency);
            const currencyName = currencyInfo ? currencyInfo.name : bot.selectedCurrency.toUpperCase();
            const message = `‚ùå <b>SEUNTAI RECOVERY FAILED</b>\n` +
                `üë§ User: <code>${bot.stakeUser}</code>\n` +
                `üí∞ Currency: <code>${currencyName}</code>\n` +
                `üìâ Loss: <code>${(bot.seuntai.startBalance - bot.stats.currentBal).toFixed(8)}</code>\n` +
                `üîÑ New Session Started\n` +
                `‚è∞ ${new Date().toLocaleString()}`;
            await this.sendMessage(message);
        }
    };

    // =============== FIX: SYNC BALANCE DENGAN REAL ACCOUNT ===============
    async function syncBalanceWithServer() {
        if (bot.isDemo) return bot.stats.currentBal;
        if (!bot.token) return bot.stats.currentBal;
        
        try {
            const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${bot.token}`,
                    "x-access-token": bot.token
                },
                body: JSON.stringify({
                    query: `query{user{balances{available{amount currency}}}}`
                })
            });
            
            if (!res.ok) return bot.stats.currentBal;
            
            const json = await res.json();
            
            if (json?.data?.user?.balances) {
                const balances = json.data.user.balances;
                const selectedBalance = balances.find(b => 
                    b.available?.currency?.toLowerCase() === bot.selectedCurrency.toLowerCase()
                );
                
                if (selectedBalance) {
                    const realBalance = parseFloat(selectedBalance.available.amount);
                    bot.realBalance = realBalance;
                    
                    if (bot.isRunning && !bot.isDemo) {
                        const oldBalance = bot.stats.currentBal;
                        bot.stats.currentBal = realBalance;
                        bot.stats.profit = bot.stats.currentBal - bot.stats.startBal;
                        
                        if (realBalance > bot.stats.peakBalance) {
                            bot.stats.peakBalance = realBalance;
                        }
                        
                        console.log(`üîÑ Balance synced: ${oldBalance.toFixed(8)} ‚Üí ${realBalance.toFixed(8)}`);
                    }
                    
                    return realBalance;
                }
            }
        } catch (e) {
            console.log("‚ö†Ô∏è Sync balance error:", e.message);
        }
        
        return bot.stats.currentBal;
    }

    // =============== SEUNTAI RECOVERY FUNCTIONS ===============
    function checkSeuntaiTrigger() {
        const s = bot.seuntai;
        
        if (s.active) return false;
        if (!bot.stats.peakBalance) bot.stats.peakBalance = bot.stats.currentBal;
        
        if (bot.stats.currentBal > bot.stats.peakBalance) {
            bot.stats.peakBalance = bot.stats.currentBal;
        }
        
        let triggered = false;
        let reason = '';
        
        if (s.useDropTrigger) {
            const peak = bot.stats.peakBalance;
            const drawdown = peak - bot.stats.currentBal;
            const drawdownPercent = (drawdown / peak) * 100;
            
            if (drawdownPercent >= s.triggerDropPercent) {
                triggered = true;
                reason = `Drawdown ${drawdownPercent.toFixed(2)}%`;
                s.peakAtTrigger = peak;
                s.drawdownAtTrigger = drawdown;
            }
        }
        
        if (!triggered && s.useLossTrigger) {
            if (bot.stats.consecutiveLosses >= s.triggerConsecutiveLosses) {
                triggered = true;
                reason = `${bot.stats.consecutiveLosses}x Losses`;
                s.peakAtTrigger = Math.max(bot.stats.peakBalance, bot.stats.currentBal);
                s.drawdownAtTrigger = s.peakAtTrigger - bot.stats.currentBal;
            }
        }
        
        if (triggered) {
            console.log(`‚ö°‚ö°‚ö° SEUNTAI TRIGGER: ${reason} ‚ö°‚ö°‚ö°`);
        }
        
        return triggered;
    }

    function activateSeuntai() {
        const s = bot.seuntai;
        
        s.active = true;
        s.layer = 1;
        s.startBalance = bot.stats.currentBal;
        s.targetBalance = s.peakAtTrigger;
        s.attempts = 0;
        s.currentBet = 0;
        
        s.stats.totalRecoveries++;
        
        console.log(`‚ö°‚ö°‚ö° SEUNTAI ACTIVATED ‚ö°‚ö°‚ö°`);
        console.log(`üìâ Drawdown: ${(s.peakAtTrigger - bot.stats.currentBal).toFixed(8)}`);
        console.log(`üéØ Target: ${s.targetBalance.toFixed(8)}`);
        console.log(`üõ°Ô∏è Max Bet: ${(bot.stats.currentBal * s.maxBetPercent / 100).toFixed(8)} (${s.maxBetPercent}%)`);
        
        TelegramAPI.sendSeuntaiStart();
        updateUI();
    }

    function getSeuntaiBet() {
        const s = bot.seuntai;
        
        const currentDrawdown = s.peakAtTrigger - bot.stats.currentBal;
        const drawdownPercent = (currentDrawdown / s.peakAtTrigger) * 100;
        
        if (s.layer === 1 && drawdownPercent >= s.layer2TriggerDrawdown && s.layer2Enabled) {
            s.layer = 2;
            console.log(`‚¨ÜÔ∏è Seuntai Layer 2 Activated - Drawdown ${drawdownPercent.toFixed(2)}%`);
        }
        
        let chance, multiplier;
        
        if (s.layer === 1) {
            chance = Math.floor(Math.random() * (s.layer1ChanceMax - s.layer1ChanceMin + 1)) + s.layer1ChanceMin;
            multiplier = s.layer1Multiplier;
            s.stats.layer1Attempts++;
        } else {
            chance = Math.floor(Math.random() * (s.layer2ChanceMax - s.layer2ChanceMin + 1)) + s.layer2ChanceMin;
            multiplier = s.layer2Multiplier;
            s.stats.layer2Attempts++;
        }
        
        const totalLossToRecover = s.peakAtTrigger - bot.stats.currentBal;
        const targetProfitPercent = 0.05;
        const targetProfit = totalLossToRecover * targetProfitPercent;
        const odds = 99 / chance;
        
        let betAmount = (totalLossToRecover + targetProfit) / (odds - 1);
        betAmount = betAmount * multiplier;
        
        const maxBet = bot.stats.currentBal * (s.maxBetPercent / 100);
        
        if (s.currentBet > 0) {
            const maxIncrease = s.currentBet * 2;
            betAmount = Math.min(betAmount, maxIncrease);
        }
        
        betAmount = Math.min(betAmount, maxBet);
        betAmount = Math.max(betAmount, bot.globalMinBet);
        
        s.currentBet = betAmount;
        s.attempts++;
        
        console.log(`üé≤ Seuntai L${s.layer}: ${betAmount.toFixed(8)} @ ${chance}% | Loss: ${totalLossToRecover.toFixed(8)} | Max: ${maxBet.toFixed(8)} (${s.maxBetPercent}%)`);
        
        return {
            bet: betAmount,
            chance: chance,
            mode: 'dice',
            type: 'SEUNTAI'
        };
    }

    function getWagerBet() {
        const w = bot.wagerMode;
        
        w.currentCycle++;
        if (w.currentCycle >= w.cyclesBetweenSwitch) {
            w.currentCycle = 0;
            w.mode = w.mode === 'dice' ? 'limbo' : 'dice';
        }
        
        if (w.mode === 'dice') {
            let betAmount = bot.stats.currentBal * (w.betPercent / 100);
            betAmount = Math.max(betAmount, bot.globalMinBet);
            
            return {
                bet: betAmount,
                chance: w.diceChance,
                mode: 'dice',
                type: 'WAGER'
            };
        } else {
            let betAmount = bot.stats.currentBal * (w.betPercent / 100);
            betAmount = Math.max(betAmount, bot.globalMinBet);
            
            return {
                bet: betAmount,
                multiplier: w.limboMultiplier,
                mode: 'limbo',
                type: 'WAGER'
            };
        }
    }

    function getNextBet() {
        const s = bot.seuntai;
        
        if (bot.stats.currentBal > bot.stats.peakBalance) {
            bot.stats.peakBalance = bot.stats.currentBal;
            bot.stats.peakResetCounter = 0;
        }
        
        if (!s.active && checkSeuntaiTrigger()) {
            activateSeuntai();
        }
        
        if (s.active) {
            if (bot.stats.currentBal >= s.targetBalance) {
                console.log(`‚úÖ‚úÖ‚úÖ SEUNTAI SUCCESS ‚úÖ‚úÖ‚úÖ`);
                s.active = false;
                s.stats.successfulRecoveries++;
                s.stats.recoveredAmount += (bot.stats.currentBal - s.startBalance);
                
                TelegramAPI.sendSeuntaiSuccess();
                bot.stats.peakBalance = bot.stats.currentBal;
                
                return getWagerBet();
            }
            
            if (s.attempts >= s.maxAttempts) {
                console.log(`‚ùå‚ùå‚ùå SEUNTAI FAILED - Max Attempts ‚ùå‚ùå‚ùå`);
                s.active = false;
                s.stats.failedRecoveries++;
                
                TelegramAPI.sendSeuntaiFail();
                startNewSession();
                return getWagerBet();
            }
            
            const totalDrawdown = bot.stats.sessionStartBal - bot.stats.currentBal;
            const lossPercent = (totalDrawdown / bot.stats.sessionStartBal) * 100;
            
            if (lossPercent >= s.cutLossPercent) {
                console.log(`‚ùå‚ùå‚ùå SEUNTAI FAILED - Cut Loss ${lossPercent.toFixed(2)}% ‚ùå‚ùå‚ùå`);
                s.active = false;
                s.stats.failedRecoveries++;
                
                TelegramAPI.sendSeuntaiFail();
                startNewSession();
                return getWagerBet();
            }
            
            return getSeuntaiBet();
        }
        
        return getWagerBet();
    }

    async function runLoop() {
        if (!bot.isRunning || bot.isPaused) return;

        try {
            if (!bot.isDemo && bot.stats.bets % 3 === 0) {
                await syncBalanceWithServer();
            }

            let betInfo = getNextBet();
            if (!betInfo) {
                setTimeout(runLoop, 100);
                return;
            }

            let nextBet = betInfo.bet;
            
            const HARD_CAP_PERCENT = bot.seuntai.maxBetPercent;
            const maxAllowedBet = bot.stats.currentBal * (HARD_CAP_PERCENT / 100);
            
            if (nextBet > maxAllowedBet) {
                console.log(`‚ö†Ô∏è SAFETY: Bet ${nextBet.toFixed(8)} > ${HARD_CAP_PERCENT}% (${maxAllowedBet.toFixed(8)}) - REDUCING!`);
                nextBet = maxAllowedBet;
            }
            
            if (bot.stats.lastBetAmount > 0 && nextBet > bot.stats.lastBetAmount * 2) {
                console.log(`‚ö†Ô∏è SAFETY: Bet increase > 2x (${bot.stats.lastBetAmount.toFixed(8)} ‚Üí ${nextBet.toFixed(8)}) - REDUCING!`);
                nextBet = bot.stats.lastBetAmount * 2;
            }
            
            if (!bot.isDemo) {
                const currentRealBalance = await syncBalanceWithServer();
                if (currentRealBalance < bot.globalMinBet) {
                    console.log(`‚ùå Insufficient balance: ${currentRealBalance.toFixed(8)}`);
                    bot.isRunning = false;
                    await TelegramAPI.sendStopReport("Insufficient Balance");
                    updateUI();
                    return;
                }
                
                if (nextBet > currentRealBalance) {
                    nextBet = currentRealBalance * 0.9;
                }
            }

            let res, win = false, pft = 0;
            
            if (betInfo.mode === 'dice') {
                res = await API.placeDiceBet(nextBet, betInfo.chance);
                if (res?.diceRoll || res?.data?.diceRoll) {
                    const d = res.diceRoll || res.data.diceRoll;
                    win = d.payout > 0;
                    pft = d.payout - d.amount;
                }
            } else {
                res = await API.placeLimboBet(nextBet, betInfo.multiplier || 1.0001);
                if (res?.limboBet || res?.data?.limboBet) {
                    const lb = res.limboBet || res.data.limboBet;
                    const result = lb.state?.result || 0;
                    win = result >= (betInfo.multiplier || 1.0001);
                    pft = win ? (lb.amount * ((betInfo.multiplier || 1.0001) - 1)) : -lb.amount;
                }
            }

            bot.stats.bets++;
            bot.stats.betsSession++;
            bot.stats.wagered += nextBet;
            bot.stats.wageredSession += nextBet;
            bot.stats.profit += pft;
            bot.stats.currentBal += pft;
            bot.stats.lastBetAmount = nextBet;
            
            if (!bot.isDemo) {
                await syncBalanceWithServer();
            }
            
            if (win) {
                bot.stats.wins++;
                bot.stats.winsSession++;
                bot.stats.consecutiveWins++;
                bot.stats.consecutiveLosses = 0;
                bot.wagerMode.winStreakCounter++;
            } else {
                bot.stats.loss++;
                bot.stats.lossSession++;
                bot.stats.consecutiveLosses++;
                bot.stats.consecutiveWins = 0;
                bot.wagerMode.winStreakCounter = 0;
            }
            
            bot.stats.winRate = bot.stats.bets > 0 ? (bot.stats.wins / bot.stats.bets * 100) : 0;
            bot.stats.winRateSession = bot.stats.betsSession > 0 ? (bot.stats.winsSession / bot.stats.betsSession * 100) : 0;
            
            if (bot.stats.currentBal > bot.stats.peakBalance) {
                bot.stats.peakBalance = bot.stats.currentBal;
            }

            checkWagerMilestone();

            const icon = betInfo.type === 'SEUNTAI' ? '‚ö°' : (betInfo.mode === 'dice' ? 'üé≤' : 'üìà');
            const chanceText = betInfo.mode === 'dice' ? `${betInfo.chance.toFixed(2)}%` : `${(betInfo.multiplier || 1.0001).toFixed(4)}x`;
            console.log(`${icon} ${nextBet.toFixed(8)} @ ${chanceText} ‚Üí ${win ? '‚úÖ' : '‚ùå'} ${pft > 0 ? '+' : ''}${pft.toFixed(8)} | Bal: ${bot.stats.currentBal.toFixed(8)} (${((nextBet/bot.stats.currentBal)*100).toFixed(2)}%)`);
            
            updateDashboard();

            if (CONFIG.telegram.enabled) {
                const now = Date.now();
                if (now - bot.lastTelegramReport >= bot.telegramReportInterval * 60 * 1000) {
                    await TelegramAPI.sendMessage(`üìä PERIODIC REPORT\nUser: ${bot.stakeUser}\nBalance: ${bot.stats.currentBal.toFixed(8)}\nProfit: ${bot.stats.profit > 0 ? '+' : ''}${bot.stats.profit.toFixed(8)}\nWagered: ${bot.stats.wagered.toFixed(8)}`);
                    bot.lastTelegramReport = now;
                }
            }

            const delay = bot.isDemo ? 50 : (bot.seuntai.active ? 200 : 150);
            
            if (bot.isRunning && !bot.isPaused) {
                setTimeout(runLoop, delay);
            }

        } catch (e) {
            console.log(`‚ö†Ô∏è Error: ${e.message}`);
            if (bot.isRunning && !bot.isPaused) {
                setTimeout(runLoop, 500);
            }
        }
    }

    function checkWagerMilestone() {
        if (!bot.telegramWagerTracker.enabled) return;
        const currentWagered = bot.stats.wagered;
        const lastReported = bot.telegramWagerTracker.lastReportedWagered;
        const step = bot.telegramWagerTracker.milestoneStep;
        const currentMilestone = Math.floor(currentWagered / step);
        const lastMilestone = Math.floor(lastReported / step);
        
        if (currentMilestone > lastMilestone) {
            TelegramAPI.sendWagerMilestoneReport(currentWagered);
            bot.telegramWagerTracker.lastReportedWagered = currentWagered;
        }
    }

    function startNewSession() {
        bot.seuntai.active = false;
        bot.seuntai.layer = 0;
        
        bot.stats.sessionProfit = bot.stats.currentBal - bot.stats.sessionStartBal;
        bot.stats.sessionStartBal = bot.stats.currentBal;
        bot.stats.sessionStartTime = Date.now();
        bot.stats.peakBalance = bot.stats.currentBal;
        bot.stats.consecutiveLosses = 0;
        bot.stats.consecutiveWins = 0;
        bot.stats.betsSession = 0;
        bot.stats.winsSession = 0;
        bot.stats.lossSession = 0;
        bot.stats.wageredSession = 0;
        
        bot.wagerMode.winStreakCounter = 0;
        
        console.log(`üîÑ NEW SESSION - Balance: ${bot.stats.currentBal.toFixed(8)}`);
        updateUI();
    }

    const API = {
        async syncOnce() {
            try {
                bot.token = localStorage.getItem('apitoken') || 
                           localStorage.getItem('token') ||
                           sessionStorage.getItem('token') ||
                           (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
                
                if (!bot.token) {
                    bot.stakeUser = "Not logged in";
                    bot.availableCurrencies = getDefaultCurrencies();
                    return;
                }

                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${bot.token}`,
                        "x-access-token": bot.token,
                        "x-csrf-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{name balances{available{amount currency}}}}`
                    })
                });
                
                if (!res.ok) {
                    bot.stakeUser = "API Error";
                    bot.availableCurrencies = getDefaultCurrencies();
                    return;
                }
                
                const json = await res.json();
                
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;
                    
                    const bals = json.data.user.balances || [];
                    const currencies = [];
                    const currencySet = new Set();
                    
                    bals.forEach(balance => {
                        if (balance.available && balance.available.currency) {
                            const code = balance.available.currency.toLowerCase();
                            if (!currencySet.has(code)) {
                                currencySet.add(code);
                                currencies.push({
                                    code: code,
                                    name: balance.available.currency.toUpperCase(),
                                    icon: getCurrencyIcon(code),
                                    balance: parseFloat(balance.available.amount) || 0
                                });
                            }
                        }
                    });
                    
                    bot.availableCurrencies = currencies.length > 0 ? currencies : getDefaultCurrencies();
                    
                    const selectedBal = bals.find(b => 
                        b.available && b.available.currency && 
                        b.available.currency.toLowerCase() === bot.selectedCurrency.toLowerCase()
                    );
                    
                    if (selectedBal) {
                        bot.realBalance = parseFloat(selectedBal.available.amount);
                    }
                    
                    console.log(`‚úÖ Synced: ${bot.stakeUser}`);
                    
                } else {
                    bot.stakeUser = "API Error";
                    bot.availableCurrencies = getDefaultCurrencies();
                }
                
            } catch (e) {
                bot.stakeUser = "Connection Error";
                bot.availableCurrencies = getDefaultCurrencies();
            }
        },

        async getBalance(coin) {
            if (bot.isDemo) return bot.stats.currentBal || bot.demoBalance;
            
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(b =>
                    b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                const balance = active ? parseFloat(active.available.amount) : 0;
                bot.realBalance = balance;
                return balance;
            } catch (e) {
                return 0;
            }
        },

        async placeDiceBet(amount, chance) {
            if (bot.isDemo) {
                return new Promise((r) => {
                    const win = Math.random() * 100 < chance;
                    setTimeout(() => {
                        r({
                            diceRoll: {
                                amount: amount,
                                payout: win ? (amount * (99 / chance)) : 0
                            }
                        });
                    }, 50);
                });
            }

            const payload = {
                amount: parseFloat(amount.toFixed(8)),
                currency: bot.selectedCurrency,
                target: parseFloat((100 - chance).toFixed(2)),
                condition: "above",
                identifier: Math.random().toString(36).slice(2) + Date.now()
            };

            try {
                const r = await fetch(`${CONFIG.apiUrl}/casino/dice/roll`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${bot.token}`,
                        "x-access-token": bot.token,
                        "x-csrf-token": bot.token
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!r.ok) throw new Error(`Bet failed: ${r.status}`);
                return r.json();
            } catch (error) {
                throw error;
            }
        },

        async placeLimboBet(amount, multiplierTarget) {
            if (bot.isDemo) {
                return new Promise((r) => {
                    const win = Math.random() < (1 / multiplierTarget);
                    setTimeout(() => {
                        r({
                            limboBet: {
                                amount: amount,
                                payout: win ? (amount * multiplierTarget) : 0,
                                state: {
                                    result: win ? multiplierTarget : (Math.random() * multiplierTarget),
                                    multiplierTarget: multiplierTarget
                                }
                            }
                        });
                    }, 50);
                });
            }

            const payload = {
                multiplierTarget: multiplierTarget,
                identifier: Math.random().toString(36).slice(2) + Date.now(),
                amount: parseFloat(amount.toFixed(8)),
                currency: bot.selectedCurrency
            };

            try {
                const r = await fetch(`${CONFIG.apiUrl}/casino/limbo/bet`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${bot.token}`,
                        "x-access-token": bot.token,
                        "x-csrf-token": bot.token
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!r.ok) throw new Error(`Limbo bet failed: ${r.status}`);
                return r.json();
            } catch (error) {
                throw error;
            }
        }
    };

    // =============== UI - FIX: SEMUA ELEMENT LENGKAP ===============
    function createUI() {
        if (document.getElementById("orion-fusion-wrap")) return;

        const style = document.createElement("style");
        style.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
            
            #orion-fusion-wrap {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 440px;
                background: linear-gradient(165deg, #0B1120 0%, #0F172A 100%);
                border: 1px solid rgba(56, 189, 248, 0.2);
                border-radius: 24px;
                color: #fff;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 13px;
                z-index: 999999;
                box-shadow: 0 25px 40px -12px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                overflow: hidden;
            }
            
            .fusion-header {
                background: linear-gradient(90deg, #0F172A 0%, #1E293B 100%);
                padding: 20px 24px;
                border-bottom: 1px solid rgba(56, 189, 248, 0.15);
                position: relative;
                overflow: hidden;
            }
            
            .fusion-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 30% 50%, rgba(56, 189, 248, 0.1) 0%, transparent 60%);
                pointer-events: none;
            }
            
            .fusion-title {
                font-size: 24px;
                font-weight: 800;
                letter-spacing: -0.5px;
                background: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 4px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .fusion-subtitle {
                font-size: 12px;
                color: #94A3B8;
                font-weight: 500;
                letter-spacing: 0.5px;
                text-transform: uppercase;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .fusion-badge {
                background: rgba(56, 189, 248, 0.15);
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                color: #7DD3FC;
                border: 1px solid rgba(56, 189, 248, 0.3);
            }
            
            .fusion-content {
                padding: 20px;
                max-height: 70vh;
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: #334155 #0F172A;
            }
            
            .fusion-content::-webkit-scrollbar {
                width: 6px;
            }
            
            .fusion-content::-webkit-scrollbar-track {
                background: #0F172A;
            }
            
            .fusion-content::-webkit-scrollbar-thumb {
                background: #334155;
                border-radius: 6px;
            }
            
            .mode-switch {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                background: rgba(15, 23, 42, 0.6);
                padding: 6px;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .mode-option {
                flex: 1;
                padding: 10px;
                text-align: center;
                border-radius: 12px;
                cursor: pointer;
                font-weight: 600;
                font-size: 13px;
                color: #94A3B8;
                transition: all 0.2s;
            }
            
            .mode-option.active {
                background: linear-gradient(135deg, #2563EB 0%, #38BDF8 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            }
            
            .status-card {
                background: linear-gradient(145deg, #0F172A, #0B1120);
                border-radius: 20px;
                padding: 16px;
                margin-bottom: 20px;
                border: 1px solid rgba(56, 189, 248, 0.15);
                position: relative;
                overflow: hidden;
            }
            
            .status-card::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(180deg, #38BDF8, #818CF8);
                border-radius: 4px 0 0 4px;
            }
            
            .status-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .status-label {
                font-size: 12px;
                color: #94A3B8;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-weight: 600;
            }
            
            .status-value {
                font-size: 20px;
                font-weight: 700;
                color: #F8FAFC;
            }
            
            .status-badge {
                padding: 6px 14px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 700;
                background: rgba(16, 185, 129, 0.15);
                color: #10B981;
                border: 1px solid rgba(16, 185, 129, 0.3);
            }
            
            .status-badge.recovery {
                background: rgba(139, 92, 246, 0.15);
                color: #C4B5FD;
                border-color: rgba(139, 92, 246, 0.3);
            }
            
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .stat-item {
                background: rgba(15, 23, 42, 0.5);
                border-radius: 16px;
                padding: 14px;
                border: 1px solid rgba(255, 255, 255, 0.03);
            }
            
            .stat-icon {
                font-size: 20px;
                margin-bottom: 8px;
            }
            
            .stat-label {
                font-size: 11px;
                color: #94A3B8;
                margin-bottom: 4px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .stat-number {
                font-size: 16px;
                font-weight: 700;
                color: #F8FAFC;
            }
            
            .stat-number.positive {
                color: #10B981;
            }
            
            .stat-number.negative {
                color: #EF4444;
            }
            
            .section-title {
                font-size: 16px;
                font-weight: 700;
                color: #F8FAFC;
                margin: 24px 0 16px 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .section-title i {
                color: #38BDF8;
            }
            
            .seuntai-card {
                background: linear-gradient(145deg, #1E1B4B, #0F172A);
                border-radius: 20px;
                padding: 20px;
                margin-bottom: 20px;
                border: 1px solid rgba(139, 92, 246, 0.3);
                position: relative;
                overflow: hidden;
            }
            
            .seuntai-card::before {
                content: '‚ö°';
                position: absolute;
                right: -20px;
                bottom: -20px;
                font-size: 100px;
                opacity: 0.05;
                color: #8B5CF6;
            }
            
            .seuntai-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 16px;
            }
            
            .seuntai-icon {
                font-size: 24px;
            }
            
            .seuntai-title {
                font-size: 16px;
                font-weight: 700;
                color: #C4B5FD;
            }
            
            .trigger-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding: 8px 0;
                border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            }
            
            .trigger-label {
                color: #CBD5E1;
                font-size: 12px;
            }
            
            .trigger-control {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .switch {
                position: relative;
                display: inline-block;
                width: 44px;
                height: 24px;
            }
            
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #334155;
                transition: .2s;
                border-radius: 24px;
            }
            
            .slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: .2s;
                border-radius: 50%;
            }
            
            input:checked + .slider {
                background: linear-gradient(135deg, #8B5CF6, #6D28D9);
            }
            
            input:checked + .slider:before {
                transform: translateX(20px);
            }
            
            .number-input {
                width: 70px;
                background: #0F172A;
                border: 1px solid #334155;
                border-radius: 8px;
                padding: 6px 10px;
                color: white;
                font-size: 12px;
                font-weight: 600;
                text-align: center;
            }
            
            .number-input:focus {
                border-color: #8B5CF6;
                outline: none;
            }
            
            .layer-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                background: rgba(139, 92, 246, 0.2);
                color: #C4B5FD;
                border: 1px solid rgba(139, 92, 246, 0.4);
            }
            
            .wager-card {
                background: rgba(15, 23, 42, 0.5);
                border-radius: 16px;
                padding: 16px;
                margin-bottom: 16px;
                border: 1px solid rgba(56, 189, 248, 0.2);
            }
            
            .control-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-top: 20px;
            }
            
            .btn {
                padding: 14px;
                border: none;
                border-radius: 14px;
                font-size: 14px;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            
            .btn-start {
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                box-shadow: 0 8px 16px -4px rgba(16, 185, 129, 0.2);
            }
            
            .btn-start:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 20px -4px rgba(16, 185, 129, 0.3);
            }
            
            .btn-stop {
                background: linear-gradient(135deg, #EF4444, #DC2626);
                color: white;
                box-shadow: 0 8px 16px -4px rgba(239, 68, 68, 0.2);
            }
            
            .btn-stop:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 20px -4px rgba(239, 68, 68, 0.3);
            }
            
            .btn-secondary {
                background: #1E293B;
                color: #E2E8F0;
                border: 1px solid #334155;
            }
            
            .btn-secondary:hover {
                background: #334155;
            }
            
            .currency-select {
                width: 100%;
                background: #0F172A;
                border: 1px solid #334155;
                border-radius: 12px;
                padding: 12px 16px;
                color: white;
                font-size: 13px;
                font-weight: 500;
                margin-bottom: 16px;
                cursor: pointer;
            }
            
            .currency-select option {
                background: #0F172A;
                color: white;
            }
            
            .live-indicator {
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .live-dot {
                width: 8px;
                height: 8px;
                background: #10B981;
                border-radius: 50%;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }
            
            .profit-float {
                position: absolute;
                top: 20px;
                right: 24px;
                text-align: right;
            }
            
            .profit-amount {
                font-size: 18px;
                font-weight: 700;
            }
            
            .profit-label {
                font-size: 11px;
                color: #94A3B8;
            }
        `;

        document.head.appendChild(style);

        // =============== FIX: HTML LENGKAP DENGAN SEMUA ID ===============
        const html = `
            <div id="orion-fusion-wrap">
                <div class="fusion-header">
                    <div class="fusion-title">
                        <span>‚ö° ORION</span>
                        <span style="font-size: 20px; background: none; -webkit-text-fill-color: #94A3B8;">√ó</span>
                        <span style="background: linear-gradient(135deg, #C4B5FD, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SEUNTAI</span>
                    </div>
                    <div class="fusion-subtitle">
                        <span>FUSION ENGINE v1.0</span>
                        <span class="fusion-badge" id="live-mode-badge">‚èπ STOPPED</span>
                    </div>
                </div>
                
                <div class="fusion-content">
                    <!-- Mode Switch -->
                    <div class="mode-switch">
                        <div class="mode-option active" data-mode="real">üéØ REAL MODE</div>
                        <div class="mode-option" data-mode="demo">üß™ TEST MODE</div>
                    </div>
                    
                    <!-- Status Card -->
                    <div class="status-card">
                        <div class="status-header">
                            <span class="status-label">Current Balance</span>
                            <span class="live-indicator">
                                <span class="live-dot"></span>
                                <span id="runtime-status">00:00:00</span>
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: baseline;">
                            <span class="status-value" id="balance-display">0.00000000</span>
                            <span style="color: #94A3B8; font-size: 14px;" id="currency-display">DOGE</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px;">
                            <div>
                                <div style="color: #94A3B8; font-size: 11px;">USER</div>
                                <div style="font-weight: 600; margin-top: 2px;" id="username-display">${bot.stakeUser}</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 11px;">PEAK</div>
                                <div style="font-weight: 600; margin-top: 2px;" id="peak-display">0.00000000</div>
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 11px;">STATUS</div>
                                <div style="margin-top: 2px;" id="mode-display">
                                    <span class="status-badge">üé≤ WAGER</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-label">Wagered</div>
                            <div class="stat-number" id="wagered-display">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">üíµ</div>
                            <div class="stat-label">Profit</div>
                            <div class="stat-number" id="profit-display">0.00</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-label">Bets</div>
                            <div class="stat-number" id="bets-display">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-number" id="winrate-display">0%</div>
                        </div>
                    </div>
                    
                    <!-- Currency Selector -->
                    <select id="currency-select" class="currency-select"></select>
                    
                    <!-- Wager Mode Card -->
                    <div class="wager-card">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <span style="font-weight: 700; color: #38BDF8;">üé≤ WAGER MODE</span>
                            <span style="color: #94A3B8; font-size: 11px;">99.5% | 1.0001x</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px;">
                            <div>
                                <div style="color: #94A3B8; font-size: 11px; margin-bottom: 4px;">BET %</div>
                                <input type="number" id="wager-betpercent" class="number-input" value="${bot.wagerMode.betPercent}" min="0.1" max="5" step="0.1" style="width: 100%;">
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 11px; margin-bottom: 4px;">MIN BET</div>
                                <input type="number" id="minbet-input" class="number-input" value="${bot.globalMinBet}" min="0.000001" step="0.000001" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seuntai Recovery Card -->
                    <div class="seuntai-card">
                        <div class="seuntai-header">
                            <span class="seuntai-icon">‚ö°</span>
                            <span class="seuntai-title">SEUNTAI RECOVERY ENGINE</span>
                            <span style="margin-left: auto;" id="seuntai-layer-badge" class="layer-badge">INACTIVE</span>
                        </div>
                        
                        <!-- TRIGGER SETTINGS -->
                        <div style="margin-bottom: 16px;">
                            <div style="color: #C4B5FD; font-size: 12px; font-weight: 600; margin-bottom: 12px;">‚öôÔ∏è TRIGGER</div>
                            
                            <div class="trigger-row">
                                <span class="trigger-label">Drawdown Trigger</span>
                                <div class="trigger-control">
                                    <label class="switch">
                                        <input type="checkbox" id="seuntai-use-drop" ${bot.seuntai.useDropTrigger ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                    <input type="number" id="seuntai-drop-percent" class="number-input" value="${bot.seuntai.triggerDropPercent}" min="0.1" max="20" step="0.1">
                                    <span style="color: #94A3B8;">%</span>
                                </div>
                            </div>
                            
                            <div class="trigger-row">
                                <span class="trigger-label">Loss Streak Trigger</span>
                                <div class="trigger-control">
                                    <label class="switch">
                                        <input type="checkbox" id="seuntai-use-loss" ${bot.seuntai.useLossTrigger ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                    <input type="number" id="seuntai-loss-count" class="number-input" value="${bot.seuntai.triggerConsecutiveLosses}" min="1" max="20" step="1">
                                    <span style="color: #94A3B8;">x</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LAYER 1 -->
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="color: #C4B5FD; font-size: 12px; font-weight: 600;">üìä LAYER 1 - STANDARD</span>
                                <label class="switch" style="width: 36px; height: 20px;">
                                    <input type="checkbox" id="seuntai-layer1-enabled" ${bot.seuntai.layer1Enabled ? 'checked' : ''}>
                                    <span class="slider" style="height: 20px;"></span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Chance Min</div>
                                    <input type="number" id="seuntai-layer1-chance-min" class="number-input" value="${bot.seuntai.layer1ChanceMin}" min="30" max="80" step="1" style="width: 100%;">
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Chance Max</div>
                                    <input type="number" id="seuntai-layer1-chance-max" class="number-input" value="${bot.seuntai.layer1ChanceMax}" min="40" max="90" step="1" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- LAYER 2 -->
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="color: #C4B5FD; font-size: 12px; font-weight: 600;">üî• LAYER 2 - AGGRESSIVE</span>
                                <label class="switch" style="width: 36px; height: 20px;">
                                    <input type="checkbox" id="seuntai-layer2-enabled" ${bot.seuntai.layer2Enabled ? 'checked' : ''}>
                                    <span class="slider" style="height: 20px;"></span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Chance Min</div>
                                    <input type="number" id="seuntai-layer2-chance-min" class="number-input" value="${bot.seuntai.layer2ChanceMin}" min="20" max="50" step="1" style="width: 100%;">
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Chance Max</div>
                                    <input type="number" id="seuntai-layer2-chance-max" class="number-input" value="${bot.seuntai.layer2ChanceMax}" min="30" max="60" step="1" style="width: 100%;">
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Trigger %</div>
                                    <input type="number" id="seuntai-layer2-trigger" class="number-input" value="${bot.seuntai.layer2TriggerDrawdown}" min="1" max="20" step="0.5" style="width: 100%;">
                                </div>
                            </div>
                            <div style="margin-top: 8px;">
                                <div style="color: #94A3B8; font-size: 11px;">Multiplier</div>
                                <input type="number" id="seuntai-layer2-multiplier" class="number-input" value="${bot.seuntai.layer2Multiplier}" min="1" max="3" step="0.1" style="width: 100%;">
                            </div>
                        </div>
                        
                        <!-- SAFETY -->
                        <div>
                            <div style="color: #C4B5FD; font-size: 12px; font-weight: 600; margin-bottom: 12px;">üõ°Ô∏è SAFETY</div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Max Attempts</div>
                                    <input type="number" id="seuntai-max-attempts" class="number-input" value="${bot.seuntai.maxAttempts}" min="5" max="50" step="5" style="width: 100%;">
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Max Bet %</div>
                                    <input type="number" id="seuntai-max-bet" class="number-input" value="${bot.seuntai.maxBetPercent}" min="5" max="30" step="5" style="width: 100%;">
                                </div>
                                <div>
                                    <div style="color: #94A3B8; font-size: 11px;">Cut Loss %</div>
                                    <input type="number" id="seuntai-cutloss" class="number-input" value="${bot.seuntai.cutLossPercent}" min="5" max="30" step="5" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telegram Milestone -->
                    <div style="background: rgba(15, 23, 42, 0.3); border-radius: 16px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 700; color: #38BDF8;">üì± TELEGRAM</span>
                            <label class="switch" style="width: 36px; height: 20px;">
                                <input type="checkbox" id="telegram-enabled" ${CONFIG.telegram.enabled ? 'checked' : ''}>
                                <span class="slider" style="height: 20px;"></span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="flex: 1;">
                                <div style="color: #94A3B8; font-size: 11px;">Milestone Step</div>
                                <input type="number" id="telegram-milestone-step" class="number-input" value="${bot.telegramWagerTracker.milestoneStep}" min="10" max="1000" step="10" style="width: 100%;">
                            </div>
                            <div>
                                <div style="color: #94A3B8; font-size: 11px;">Last Report</div>
                                <div style="font-weight: 600; color: #E2E8F0;" id="telegram-last-report">0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="control-buttons">
                        <button id="start-btn" class="btn btn-start">
                            <span>‚ñ∂</span> START
                        </button>
                        <button id="stop-btn" class="btn btn-stop">
                            <span>‚èπ</span> STOP
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <button id="manual-recovery-btn" class="btn btn-secondary">
                            <span>‚ö°</span> MANUAL SEUNTAI
                        </button>
                        <button id="new-session-btn" class="btn btn-secondary">
                            <span>üîÑ</span> NEW SESSION
                        </button>
                    </div>
                    
                    <!-- Seuntai Stats -->
                    <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 16px;">
                        <div style="display: flex; justify-content: space-between; color: #94A3B8; font-size: 11px; margin-bottom: 8px;">
                            <span>RECOVERY STATS</span>
                            <span id="seuntai-stats">0/0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <span style="color: #10B981;">‚úì 0</span>
                                <span style="color: #94A3B8; margin-left: 8px;">SUCCESS</span>
                            </div>
                            <div>
                                <span style="color: #EF4444;">‚úó 0</span>
                                <span style="color: #94A3B8; margin-left: 8px;">FAILED</span>
                            </div>
                            <div>
                                <span style="color: #C4B5FD;">‚ö° 0.00</span>
                                <span style="color: #94A3B8; margin-left: 8px;">RECOVERED</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);
        
        // Setup event listeners
        setupEventListeners();
        
        // Initial UI update
        updateUI();
        
        // Sync account setelah UI ready
        setTimeout(() => {
            API.syncOnce();
            updateTimer();
            setInterval(updateTimer, 1000);
        }, 500);
    }

    // =============== EVENT LISTENERS ===============
    function setupEventListeners() {
        // Mode switch
        document.querySelectorAll('.mode-option').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.mode-option').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                bot.isDemo = this.getAttribute('data-mode') === 'demo';
            });
        });

        // Wager settings
        document.getElementById('wager-betpercent')?.addEventListener('change', function() {
            bot.wagerMode.betPercent = parseFloat(this.value) || 0.5;
        });
        
        document.getElementById('minbet-input')?.addEventListener('change', function() {
            bot.globalMinBet = parseFloat(this.value) || 0.000123;
        });

        // Currency
        document.getElementById('currency-select')?.addEventListener('change', function() {
            bot.selectedCurrency = this.value;
            updateUI();
        });

        // Seuntai triggers
        document.getElementById('seuntai-use-drop')?.addEventListener('change', function() {
            bot.seuntai.useDropTrigger = this.checked;
        });
        
        document.getElementById('seuntai-drop-percent')?.addEventListener('change', function() {
            bot.seuntai.triggerDropPercent = parseFloat(this.value) || 8.0;
        });
        
        document.getElementById('seuntai-use-loss')?.addEventListener('change', function() {
            bot.seuntai.useLossTrigger = this.checked;
        });
        
        document.getElementById('seuntai-loss-count')?.addEventListener('change', function() {
            bot.seuntai.triggerConsecutiveLosses = parseInt(this.value) || 10;
        });
        
        // Layer 1
        document.getElementById('seuntai-layer1-enabled')?.addEventListener('change', function() {
            bot.seuntai.layer1Enabled = this.checked;
        });
        
        document.getElementById('seuntai-layer1-chance-min')?.addEventListener('change', function() {
            bot.seuntai.layer1ChanceMin = parseInt(this.value) || 65;
        });
        
        document.getElementById('seuntai-layer1-chance-max')?.addEventListener('change', function() {
            bot.seuntai.layer1ChanceMax = parseInt(this.value) || 75;
        });
        
        // Layer 2
        document.getElementById('seuntai-layer2-enabled')?.addEventListener('change', function() {
            bot.seuntai.layer2Enabled = this.checked;
        });
        
        document.getElementById('seuntai-layer2-chance-min')?.addEventListener('change', function() {
            bot.seuntai.layer2ChanceMin = parseInt(this.value) || 50;
        });
        
        document.getElementById('seuntai-layer2-chance-max')?.addEventListener('change', function() {
            bot.seuntai.layer2ChanceMax = parseInt(this.value) || 60;
        });
        
        document.getElementById('seuntai-layer2-trigger')?.addEventListener('change', function() {
            bot.seuntai.layer2TriggerDrawdown = parseFloat(this.value) || 15.0;
        });
        
        document.getElementById('seuntai-layer2-multiplier')?.addEventListener('change', function() {
            bot.seuntai.layer2Multiplier = parseFloat(this.value) || 1.0;
        });
        
        // Safety
        document.getElementById('seuntai-max-attempts')?.addEventListener('change', function() {
            bot.seuntai.maxAttempts = parseInt(this.value) || 8;
        });
        
        document.getElementById('seuntai-max-bet')?.addEventListener('change', function() {
            bot.seuntai.maxBetPercent = parseFloat(this.value) || 2.5;
        });
        
        document.getElementById('seuntai-cutloss')?.addEventListener('change', function() {
            bot.seuntai.cutLossPercent = parseFloat(this.value) || 10;
        });
        
        // Telegram
        document.getElementById('telegram-enabled')?.addEventListener('change', function() {
            CONFIG.telegram.enabled = this.checked;
            bot.telegramWagerTracker.enabled = this.checked;
        });
        
        document.getElementById('telegram-milestone-step')?.addEventListener('change', function() {
            bot.telegramWagerTracker.milestoneStep = parseFloat(this.value) || 100;
        });
        
        // Manual recovery
        document.getElementById('manual-recovery-btn')?.addEventListener('click', function() {
            if (!bot.isRunning) {
                alert('Start bot dulu!');
                return;
            }
            if (bot.seuntai.active) {
                alert('Seuntai sudah aktif!');
                return;
            }
            bot.seuntai.peakAtTrigger = Math.max(bot.stats.peakBalance, bot.stats.currentBal);
            bot.seuntai.drawdownAtTrigger = bot.seuntai.peakAtTrigger - bot.stats.currentBal;
            activateSeuntai();
        });
        
        // New session
        document.getElementById('new-session-btn')?.addEventListener('click', function() {
            if (bot.isRunning) {
                startNewSession();
            }
        });

        // Start button
        document.getElementById('start-btn')?.addEventListener('click', async () => {
            if (bot.isRunning) return;

            if (bot.isDemo) {
                const demoBal = parseFloat(prompt("Demo Balance:", bot.demoBalance));
                if (!isNaN(demoBal) && demoBal >= bot.globalMinBet) {
                    bot.demoBalance = demoBal;
                } else {
                    alert(`Min bet: ${bot.globalMinBet}`);
                    return;
                }
            } else {
                await API.syncOnce();
                if (bot.stakeUser.includes("Error") || bot.stakeUser === "Not logged in") {
                    alert("Login dulu!");
                    return;
                }
                
                bot.realBalance = await API.getBalance(bot.selectedCurrency);
                
                if (bot.realBalance <= 0) {
                    alert(`Insufficient ${bot.selectedCurrency.toUpperCase()} balance!`);
                    return;
                }
                
                bot.stats.currentBal = bot.realBalance;
            }

            bot.isRunning = true;
            const startBalance = bot.isDemo ? bot.demoBalance : bot.realBalance;
            
            bot.stats = {
                profit: 0,
                wagered: 0,
                wageredSession: 0,
                startBal: startBalance,
                currentBal: startBalance,
                peakBalance: startBalance,
                maxDrawdown: 0,
                bets: 0,
                betsSession: 0,
                wins: 0,
                winsSession: 0,
                loss: 0,
                lossSession: 0,
                startTime: Date.now(),
                lastBetAmount: 0,
                lastResults: [],
                consecutiveLosses: 0,
                consecutiveWins: 0,
                winRate: 0,
                winRateSession: 0,
                currentStreak: 0,
                sessionProfit: 0,
                sessionStartBal: startBalance,
                sessionStartTime: Date.now(),
                peakResetCounter: 0
            };

            bot.seuntai.active = false;
            bot.seuntai.layer = 0;
            bot.seuntai.attempts = 0;
            bot.seuntai.startBalance = 0;
            bot.seuntai.targetBalance = 0;
            
            bot.telegramWagerTracker.lastReportedWagered = 0;

            if (CONFIG.telegram.enabled && CONFIG.telegram.sendOnStart) {
                TelegramAPI.sendStartReport();
            }

            updateUI();
            setTimeout(runLoop, 100);
        });

        // Stop button
        document.getElementById('stop-btn')?.addEventListener('click', () => {
            bot.isRunning = false;
            console.log("üõë STOPPED");
            updateUI();
            if (CONFIG.telegram.enabled && CONFIG.telegram.sendOnStop) {
                TelegramAPI.sendStopReport("Manual Stop");
            }
        });
    }

    // =============== UI UPDATE FUNCTIONS ===============
    function updateTimer() {
        const runtime = bot.stats.startTime ? Math.floor((Date.now() - bot.stats.startTime) / 1000) : 0;
        const h = Math.floor(runtime / 3600).toString().padStart(2, '0');
        const m = Math.floor((runtime % 3600) / 60).toString().padStart(2, '0');
        const s = (runtime % 60).toString().padStart(2, '0');
        const runtimeEl = document.getElementById('runtime-status');
        if (runtimeEl) {
            runtimeEl.textContent = bot.isRunning ? `${h}:${m}:${s}` : '00:00:00';
        }
    }

    function updateDashboard() {
        // Balance
        const balanceEl = document.getElementById('balance-display');
        if (balanceEl) balanceEl.textContent = bot.stats.currentBal.toFixed(8);
        
        const peakEl = document.getElementById('peak-display');
        if (peakEl) peakEl.textContent = bot.stats.peakBalance.toFixed(8);
        
        // Stats
        const wageredEl = document.getElementById('wagered-display');
        if (wageredEl) wageredEl.textContent = bot.stats.wagered.toFixed(8);
        
        const profitEl = document.getElementById('profit-display');
        if (profitEl) {
            profitEl.textContent = (bot.stats.profit > 0 ? '+' : '') + bot.stats.profit.toFixed(8);
            profitEl.className = `stat-number ${bot.stats.profit > 0 ? 'positive' : bot.stats.profit < 0 ? 'negative' : ''}`;
        }
        
        const betsEl = document.getElementById('bets-display');
        if (betsEl) betsEl.textContent = bot.stats.bets;
        
        const winrateEl = document.getElementById('winrate-display');
        if (winrateEl) winrateEl.textContent = bot.stats.winRate.toFixed(1) + '%';
        
        const usernameEl = document.getElementById('username-display');
        if (usernameEl) usernameEl.textContent = bot.stakeUser;
        
        // Mode
        const modeBadge = document.querySelector('#mode-display .status-badge');
        if (modeBadge) {
            if (bot.seuntai.active) {
                modeBadge.className = 'status-badge recovery';
                modeBadge.innerHTML = `‚ö° SEUNTAI L${bot.seuntai.layer}`;
            } else if (bot.isRunning) {
                modeBadge.className = 'status-badge';
                modeBadge.innerHTML = `üé≤ ${bot.wagerMode.mode === 'dice' ? 'DICE' : 'LIMBO'}`;
            } else {
                modeBadge.className = 'status-badge';
                modeBadge.innerHTML = '‚èπ STOPPED';
            }
        }
        
        // Live badge
        const liveBadge = document.getElementById('live-mode-badge');
        if (liveBadge) {
            liveBadge.textContent = bot.isRunning ? 'üü¢ RUNNING' : '‚èπ STOPPED';
            liveBadge.style.background = bot.isRunning ? 'rgba(16, 185, 129, 0.15)' : 'rgba(100, 116, 139, 0.15)';
            liveBadge.style.color = bot.isRunning ? '#10B981' : '#94A3B8';
        }
        
        // Seuntai layer badge
        const layerBadge = document.getElementById('seuntai-layer-badge');
        if (layerBadge) {
            if (bot.seuntai.active) {
                layerBadge.textContent = `ACTIVE L${bot.seuntai.layer}`;
                layerBadge.style.background = 'rgba(139, 92, 246, 0.2)';
                layerBadge.style.color = '#C4B5FD';
            } else {
                layerBadge.textContent = 'INACTIVE';
                layerBadge.style.background = 'rgba(100, 116, 139, 0.2)';
                layerBadge.style.color = '#94A3B8';
            }
        }
        
        // Currency dropdown
        const currencySelect = document.getElementById('currency-select');
        if (currencySelect && bot.availableCurrencies.length > 0) {
            const current = currencySelect.value;
            currencySelect.innerHTML = '';
            bot.availableCurrencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.code;
                option.textContent = `${currency.icon} ${currency.name} (${currency.balance.toFixed(8)})`;
                option.selected = currency.code === bot.selectedCurrency;
                currencySelect.appendChild(option);
            });
            
            const currencyDisplay = document.getElementById('currency-display');
            if (currencyDisplay) currencyDisplay.textContent = bot.selectedCurrency.toUpperCase();
        }
        
        // Telegram last report
        const telegramLastEl = document.getElementById('telegram-last-report');
        if (telegramLastEl) telegramLastEl.textContent = bot.telegramWagerTracker.lastReportedWagered.toFixed(2);
        
        // Seuntai stats
        const seuntaiStatsEl = document.getElementById('seuntai-stats');
        if (seuntaiStatsEl) seuntaiStatsEl.textContent = `${bot.seuntai.stats.successfulRecoveries}/${bot.seuntai.stats.totalRecoveries}`;
    }

    function updateUI() {
        updateDashboard();
    }

    function getDefaultCurrencies() {
        return [
            { code: "doge", name: "DOGE", icon: "üêï", balance: 0 },
            { code: "btc", name: "BTC", icon: "‚Çø", balance: 0 },
            { code: "eth", name: "ETH", icon: "Œû", balance: 0 },
            { code: "ltc", name: "LTC", icon: "≈Å", balance: 0 }
        ];
    }

    function getCurrencyIcon(code) {
        const icons = {
            'doge': 'üêï', 'btc': '‚Çø', 'eth': 'Œû', 'ltc': '≈Å', 'xrp': '‚úï', 'ada': 'A',
            'trx': 'T', 'usdt': 'üíµ', 'usdc': 'üí≤', 'sol': '‚óé', 'bnb': '‚ìÇ', 'matic': '‚ìÖ'
        };
        return icons[code] || 'üí∞';
    }

    // =============== INIT ===============
    createUI();
})();

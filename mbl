(function () {
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/_api'; },
        version: "ORION v8.2",
        license: {
            type: "PREMIUM",
            expiryDate: new Date("2026-02-26"),
            isValid: function() {
                return new Date() <= this.expiryDate;
            }
        },
        telegram: {
            enabled: true,
            botToken: '8391763291:AAGdi0yiVDwm0xZvq4UaJzMyy6_kaN0Zerc',
            chatId: '-1003744641395',
            reportInterval: 30,
            lastReportTime: 0,
            sendOnStart: true,
            sendOnStop: true,
            sendOnTarget: true,
            sendOnStopLoss: true,
            sendPeriodic: true,
            sendBigWins: true,
            bigWinThreshold: 0.001
        }
    };

    const bot = {
        isRunning: false,
        isPaused: false,
        isDemo: false,
        token: null,
        stakeUser: "Loading...",
        stats: {
            profit: 0,
            wagered: 0,
            startBal: 0,
            currentBal: 0,
            bets: 0,
            wins: 0,
            loss: 0,
            startTime: null,
            maxDD: 0,
            maxDDPerc: 0,
            lastBigWinTime: 0,
            currentStreak: 0,
            maxWinStreak: 0,
            maxLossStreak: 0,
            lastResult: null
        },
        selectedCurrency: "doge",
        tg: 0,
        perStep: 0,
        baseChance: 0,
        currentChance: 0,
        singleChanceBets: 0,
        singleChanceLimit: 0,
        targetAbs: 0,
        stopLossAbs: 0,
        mode: "wager",
        turboMode: false,
        turboSettings: {
            betDelay: 1,
            updateInterval: 5000,
            skipRotationCheck: 5
        },
        enabledModes: {
            orion: true,
            wager: true,
            labouchere: true
        },
        wagerStats: {
            betlose: 0,
            betsafe: false,
            basebet: 0,
            nextbet: 0,
            chanceNormal: 97,
            chanceRecovery: 25,
            chanceMax: 99,
            simplestats: {
                stopwin: false,
                reset: false,
                recov: false,
                mostbet: 0,
                balhi: 0,
                balst: 0,
                maxdrop: 0,
                profitc: 0,
                drop: 0
            },
            xstopwin: [0, 0, 0, 0, 0, 5],
            basebetMode: "percentage",
            basebetPercentage: 1.0,
            basebetFixed: 0.00000001,
            recoveryThreshold: 0.001
        },
        labouchere: {
            sequence: [0.001, 0.002, 0.003, 0.004],
            currentSequence: [],
            targetProfit: 10,
            betAmount: 0.001,
            nextBetIndex: 0,
            betOn: 'black',
            recoveryMode: false,
            chance: 49.5,
            maxBet: 0.01,
            resetOnMaxBet: true,
            chanceLevels: [
                { ls: 1, chanceMin: 49.5, chanceMax: 49.5 },
                { ls: 2, chanceMin: 48.5, chanceMax: 49.0 },
                { ls: 3, chanceMin: 47.5, chanceMax: 48.5 },
                { ls: 4, chanceMin: 46.5, chanceMax: 47.5 },
                { ls: 5, chanceMin: 45.5, chanceMax: 46.5 },
                { ls: 6, chanceMin: 44.5, chanceMax: 45.5 },
                { ls: 7, chanceMin: 43.5, chanceMax: 44.5 },
                { ls: 8, chanceMin: 42.5, chanceMax: 43.5 },
                { ls: 9, chanceMin: 41.5, chanceMax: 42.5 },
                { ls: 10, chanceMin: 40.5, chanceMax: 41.5 }
            ],
            currentLs: 1,
            consecutiveLosses: 0
        },
        orionSettings: {
            method: "mathematic",
            martingaleMultiplier: 1.12, // FIXED: Default 1.12 seperti yang diinginkan
            consecutiveLosses: 0,
            currentMultiplier: 1.0
        },
        rotationState: {
            initialBalance: 0,
            wagerLossThreshold: 0.001, // 0.1%
            severeLossThreshold: 0.01, // 1%
            inRecovery: false,
            stepLimit: 10000,
            stepLimitMultiplier: 1.1,
            lastSwitchTime: 0,
            minSwitchInterval: 60000, // Minimal 1 menit antara switch
            isSwitching: false
        },
        minimized: false,
        activeTab: 'dashboard',
        martingaleHistory: []
    };

    // =============== TELEGRAM FUNCTIONS ===============
    const TelegramAPI = {
        async sendMessage(text, parse_mode = "HTML") {
            if (!CONFIG.telegram.enabled || !CONFIG.telegram.botToken || !CONFIG.telegram.chatId) {
                console.log("Telegram not configured:", text);
                return;
            }

            try {
                const url = `https://api.telegram.org/bot${CONFIG.telegram.botToken}/sendMessage`;
                const params = {
                    chat_id: CONFIG.telegram.chatId,
                    text: text,
                    parse_mode: parse_mode,
                    disable_web_page_preview: true
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const data = await response.json();
                if (!data.ok) {
                    console.error("Telegram error:", data);
                }
                return data;
            } catch (error) {
                console.error("Telegram send error:", error);
            }
        },

        async sendStartReport() {
            if (!CONFIG.telegram.sendOnStart) return;

            const message = `ğŸš€ <b>ORION BOT STARTED</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                `ğŸ’° Balance: <code>${bot.stats.startBal.toFixed(8)} ${bot.selectedCurrency.toUpperCase()}</code>\n` +
                `ğŸ¯ Target: <code>${bot.targetAbs.toFixed(8)} (${(bot.targetAbs / bot.stats.startBal * 100).toFixed(2)}%)</code>\n` +
                `ğŸ›‘ Stop Loss: <code>${bot.stopLossAbs.toFixed(8)} (${(bot.stopLossAbs / bot.stats.startBal * 100).toFixed(2)}%)</code>\n` +
                `âš¡ Mode: <b>${bot.mode.toUpperCase()}</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `â° ${new Date().toLocaleString()}`;

            return this.sendMessage(message);
        },

        async sendStopReport(reason = "Manual Stop") {
            if (!CONFIG.telegram.sendOnStop) return;

            const runtime = bot.stats.startTime ? Math.floor((Date.now() - bot.stats.startTime) / 1000) : 0;
            const hours = Math.floor(runtime / 3600);
            const minutes = Math.floor((runtime % 3600) / 60);
            const seconds = runtime % 60;

            const profitPercent = bot.stats.startBal > 0 ? (bot.stats.profit / bot.stats.startBal * 100) : 0;
            const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;

            const message = `ğŸ›‘ <b>ORION BOT STOPPED</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ“ Reason: <b>${reason}</b>\n` +
                `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                `â±ï¸ Runtime: <code>${hours}h ${minutes}m ${seconds}s</code>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ“Š <b>FINAL STATISTICS</b>\n` +
                `ğŸ’° Start Balance: <code>${bot.stats.startBal.toFixed(8)}</code>\n` +
                `ğŸ’° End Balance: <code>${bot.stats.currentBal.toFixed(8)}</code>\n` +
                `ğŸ“ˆ Profit: <code>${bot.stats.profit > 0 ? '+' : ''}${bot.stats.profit.toFixed(8)} (${profitPercent > 0 ? '+' : ''}${profitPercent.toFixed(2)}%)</code>\n` +
                `ğŸ° Wagered: <code>${bot.stats.wagered.toFixed(8)}</code>\n` +
                `ğŸ² Bets: <code>${bot.stats.bets}</code>\n` +
                `âœ… Wins: <code>${bot.stats.wins}</code>\n` +
                `âŒ Losses: <code>${bot.stats.loss}</code>\n` +
                `ğŸ“Š Win Rate: <code>${winRate.toFixed(2)}%</code>\n` +
                `ğŸ“‰ Max DD: <code>${bot.stats.maxDD.toFixed(8)} (${bot.stats.maxDDPerc.toFixed(2)}%)</code>\n` +
                `ğŸ”¥ Max Win Streak: <code>${bot.stats.maxWinStreak}</code>\n` +
                `ğŸ’€ Max Loss Streak: <code>${bot.stats.maxLossStreak}</code>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `â° ${new Date().toLocaleString()}`;

            return this.sendMessage(message);
        },

        async sendTargetReached() {
            if (!CONFIG.telegram.sendOnTarget) return;

            const message = `ğŸ¯ <b>TARGET PROFIT REACHED!</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                `ğŸ’° Profit: <code>+${bot.stats.profit.toFixed(8)} ${bot.selectedCurrency.toUpperCase()}</code>\n` +
                `ğŸ“ˆ Profit %: <code>+${(bot.stats.profit / bot.stats.startBal * 100).toFixed(2)}%</code>\n` +
                `ğŸ² Total Bets: <code>${bot.stats.bets}</code>\n` +
                `â° ${new Date().toLocaleString()}`;

            return this.sendMessage(message);
        },

        async sendStopLossReached() {
            if (!CONFIG.telegram.sendOnStopLoss) return;

            const message = `ğŸ’€ <b>STOP LOSS TRIGGERED!</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                `ğŸ“‰ Loss: <code>${bot.stats.profit.toFixed(8)} ${bot.selectedCurrency.toUpperCase()}</code>\n` +
                `ğŸ“Š Loss %: <code>${(bot.stats.profit / bot.stats.startBal * 100).toFixed(2)}%</code>\n` +
                `ğŸ² Total Bets: <code>${bot.stats.bets}</code>\n` +
                `âš ï¸ Bot has stopped automatically\n` +
                `â° ${new Date().toLocaleString()}`;

            return this.sendMessage(message);
        },

        async sendPeriodicReport() {
            if (!CONFIG.telegram.sendPeriodic) return;

            const now = Date.now();
            const minutesSinceLastReport = (now - CONFIG.telegram.lastReportTime) / (1000 * 60);

            if (minutesSinceLastReport >= CONFIG.telegram.reportInterval) {
                CONFIG.telegram.lastReportTime = now;

                const runtime = bot.stats.startTime ? Math.floor((now - bot.stats.startTime) / 1000) : 0;
                const hours = Math.floor(runtime / 3600);
                const minutes = Math.floor((runtime % 3600) / 60);
                const seconds = runtime % 60;

                const profitPercent = bot.stats.startBal > 0 ? (bot.stats.profit / bot.stats.startBal * 100) : 0;
                const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;

                const message = `ğŸ“Š <b>PERIODIC REPORT - ${CONFIG.telegram.reportInterval} MIN</b>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                    `âš¡ Mode: <b>${bot.mode.toUpperCase()}</b>\n` +
                    `â±ï¸ Runtime: <code>${hours}h ${minutes}m ${seconds}s</code>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `ğŸ’° Start Balance: <code>${bot.stats.startBal.toFixed(8)}</code>\n` +
                    `ğŸ’° Current Balance: <code>${bot.stats.currentBal.toFixed(8)}</code>\n` +
                    `ğŸ“ˆ Profit: <code>${bot.stats.profit > 0 ? '+' : ''}${bot.stats.profit.toFixed(8)} (${profitPercent > 0 ? '+' : ''}${profitPercent.toFixed(2)}%)</code>\n` +
                    `ğŸ° Wagered: <code>${bot.stats.wagered.toFixed(8)}</code>\n` +
                    `ğŸ² Bets: <code>${bot.stats.bets} (${bot.stats.wins}W/${bot.stats.loss}L)</code>\n` +
                    `ğŸ“Š Win Rate: <code>${winRate.toFixed(2)}%</code>\n` +
                    `ğŸ“‰ Max DD: <code>${bot.stats.maxDD.toFixed(8)} (${bot.stats.maxDDPerc.toFixed(2)}%)</code>\n` +
                    `ğŸ”¥ Current Streak: <code>${bot.stats.currentStreak > 0 ? 'W' + bot.stats.currentStreak : 'L' + Math.abs(bot.stats.currentStreak)}</code>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `â° ${new Date().toLocaleString()}`;

                return this.sendMessage(message);
            }
        },

        async sendBigWinReport(betAmount, profit, chance) {
            if (!CONFIG.telegram.sendBigWins) return;

            const now = Date.now();
            if (now - bot.stats.lastBigWinTime < 30000) return;

            const profitPercent = (profit / bot.stats.currentBal * 100);
            if (profitPercent >= CONFIG.telegram.bigWinThreshold) {
                bot.stats.lastBigWinTime = now;

                const message = `ğŸ’° <b>BIG WIN!</b>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                    `ğŸ° Bet Amount: <code>${betAmount.toFixed(8)}</code>\n` +
                    `ğŸ’µ Profit: <code>+${profit.toFixed(8)} ${bot.selectedCurrency.toUpperCase()}</code>\n` +
                    `ğŸ“ˆ Profit %: <code>+${profitPercent.toFixed(2)}%</code>\n` +
                    `ğŸ¯ Chance: <code>${chance}%</code>\n` +
                    `âš¡ Mode: <b>${bot.mode.toUpperCase()}</b>\n` +
                    `ğŸ’° Current Balance: <code>${bot.stats.currentBal.toFixed(8)}</code>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `â° ${new Date().toLocaleString()}`;

                return this.sendMessage(message);
            }
        },

        async sendModeChange(oldMode, newMode, reason) {
            const message = `ğŸ”„ <b>MODE CHANGE</b>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                `ğŸ“Š From: <b>${oldMode.toUpperCase()}</b>\n` +
                `ğŸ“ˆ To: <b>${newMode.toUpperCase()}</b>\n` +
                `ğŸ“ Reason: ${reason}\n` +
                `ğŸ’° Balance: <code>${bot.stats.currentBal.toFixed(8)}</code>\n` +
                `ğŸ“‰ P/L: <code>${bot.stats.profit > 0 ? '+' : ''}${bot.stats.profit.toFixed(8)}</code>\n` +
                `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                `â° ${new Date().toLocaleString()}`;

            return this.sendMessage(message);
        }
    };

    const API = {
        async syncOnce() {
            bot.token = localStorage.getItem('apitoken') || (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{name balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;

                    const bals = json.data.user.balances || [];
                    const sel = document.getElementById("p-currency");
                    if (sel) {
                        const currentSelection = sel.value || bot.selectedCurrency;
                        sel.innerHTML = '';

                        bals.forEach(b => {
                            const currency = b.available.currency.toLowerCase();
                            const opt = new Option(currency.toUpperCase(), currency);
                            sel.add(opt);
                        });

                        const availableCurrencies = bals.map(b => b.available.currency.toLowerCase());
                        if (availableCurrencies.includes(currentSelection)) {
                            sel.value = currentSelection;
                            bot.selectedCurrency = currentSelection;
                        } else if (availableCurrencies.includes('doge')) {
                            sel.value = 'doge';
                            bot.selectedCurrency = 'doge';
                        } else if (bals.length > 0) {
                            sel.value = bals[0].available.currency.toLowerCase();
                            bot.selectedCurrency = sel.value;
                        }
                    }
                }
            } catch (e) {
                console.log("Sync error:", e);
            }
        },

        async getBalance(coin) {
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(b =>
                    b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                return active ? parseFloat(active.available.amount) : 0;
            } catch (e) {
                console.log("Balance error:", e);
                return 0;
            }
        },

        async placeBet(amount, chance) {
            if (bot.isDemo) {
                const dly = document.getElementById("turbo-delay")?.value || 0;
                return new Promise((r) => {
                    const win = Math.random() * 100 < chance;
                    setTimeout(() => {
                        r({
                            diceRoll: {
                                amount: amount,
                                payout: win ? (amount * (99 / chance)) : 0
                            }
                        });
                    }, dly);
                });
            }

            const payload = {
                amount: parseFloat(amount.toFixed(8)),
                currency: bot.selectedCurrency,
                target: parseFloat((100 - chance).toFixed(2)),
                condition: "above",
                identifier: Math.random().toString(36).slice(2) + Date.now()
            };

            const r = await fetch(`${CONFIG.apiUrl}/casino/dice/roll`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-access-token": bot.token,
                    "x-lockdown-token": "s5MNWtjTM5TvCMkAzxov"
                },
                body: JSON.stringify(payload)
            });
            return r.json();
        }
    };

    // =============== ORION MODE FUNCTIONS ===============
    function setNewBaseChance() {
        const min = parseFloat(document.getElementById("p-ch-min")?.value || 5);
        const max = parseFloat(document.getElementById("p-ch-max")?.value || 12);
        bot.baseChance = parseFloat((Math.random() * (max - min) + min).toFixed(1));
        bot.currentChance = bot.baseChance;
        bot.singleChanceBets = 0;
        bot.singleChanceLimit = Math.round(99 / bot.baseChance);
        bot.tg = bot.perStep;
        
        // Reset martingale ketika base chance baru
        bot.orionSettings.consecutiveLosses = 0;
        bot.orionSettings.currentMultiplier = 1.0;
        bot.martingaleHistory = [];
        
        updateLogs(0, 0, 0, `ORION: New base chance ${bot.baseChance}%, Martingale reset`, true);
    }

    // =============== WAGER MODE FUNCTIONS ===============
    function initWagerMode() {
        if (bot.wagerStats.basebetMode === "percentage") {
            bot.wagerStats.basebet = bot.stats.currentBal * (bot.wagerStats.basebetPercentage / 100);
        } else {
            bot.wagerStats.basebet = bot.wagerStats.basebetFixed;
        }

        bot.wagerStats.nextbet = bot.wagerStats.basebet;
        bot.wagerStats.betlose = 0;
        bot.wagerStats.betsafe = false;
        bot.wagerStats.simplestats = {
            stopwin: false,
            reset: false,
            recov: false,
            mostbet: bot.wagerStats.basebet,
            balhi: bot.stats.currentBal,
            balst: bot.stats.currentBal,
            maxdrop: 0,
            profitc: 0,
            drop: 0
        };

        for (let i = 1; i <= 6; i++) {
            const elem = document.getElementById(`w-xstopwin-${i}`);
            const val = elem ? parseFloat(elem.value) : 0;
            bot.wagerStats.xstopwin[i - 1] = val;
        }

        bot.wagerStats.chanceNormal = parseFloat(document.getElementById("w-chance-normal")?.value) || 97;
        bot.wagerStats.chanceRecovery = parseFloat(document.getElementById("w-chance-recovery")?.value) || 25;
        bot.wagerStats.chanceMax = parseFloat(document.getElementById("w-chance-max")?.value) || 99;

        bot.currentChance = bot.wagerStats.chanceNormal;

        updateLogs(0, 0, 0, `WAGER: Base bet set to ${bot.wagerStats.basebet.toFixed(8)} (${bot.wagerStats.basebetMode})`, true);
    }

    function updateWagerStats(profit) {
        const ws = bot.wagerStats;
        const ss = ws.simplestats;

        ss.profitc += profit;

        if (ss.profitc >= 0) {
            if (ss.stopwin) {
                bot.isRunning = false;
                updateLogs(0, 0, 0, "WAGER: Stop condition reached", true);
                TelegramAPI.sendStopReport("Wager Stop Condition");
                return;
            }
            ss.profitc = 0;
            ss.balhi = bot.stats.currentBal;
            ss.reset = false;
            ss.recov = false;
        }

        ss.drop = ss.balhi - bot.stats.currentBal;
        if (ss.drop > ss.maxdrop) {
            ss.maxdrop = ss.drop;
        }

        if (ws.nextbet > ss.mostbet) {
            ss.mostbet = ws.nextbet;
        }

        if (ws.xstopwin[0] > 0 && ss.maxdrop / ss.balhi * 100 > ws.xstopwin[0]) {
            ss.stopwin = true;
        }
        if (ws.xstopwin[1] > 0 && ss.mostbet / ss.balst * 100 > ws.xstopwin[1]) {
            ss.stopwin = true;
        }
        if (ws.xstopwin[2] > 0 && bot.stats.loss > ws.xstopwin[2]) {
            ss.stopwin = true;
        }
        if (ws.xstopwin[3] > 0 && bot.stats.profit / (bot.stats.currentBal - bot.stats.profit) * 100 > ws.xstopwin[3]) {
            ss.stopwin = true;
        }

        if (ws.xstopwin[4] > 0 && ws.nextbet / ss.balhi * 100 > ws.xstopwin[4] && !ss.recov) {
            ss.recov = true;
        }

        if (ws.xstopwin[5] > 0 && ss.drop / ss.balhi * 100 > ws.xstopwin[5] && !ss.reset) {
            ss.reset = true;
            ws.nextbet = ws.basebet;
        }

        if (ss.recov) {
            ws.chanceNormal = Math.random() * 10 + 5;
            ws.nextbet = Math.abs(ss.profitc) / ((99 / ws.chanceNormal) - 1);
            const minbet = parseFloat(document.getElementById("w-minbet")?.value) || 0.00000001;
            if (ws.nextbet < minbet) ws.nextbet = minbet;
        }

        updateWagerUI();
    }

    function wagerBetLogic(profit) {
        const ws = bot.wagerStats;

        ws.betlose += profit;

        const lossPercentage = Math.abs(ws.betlose) / bot.stats.currentBal;

        if (ws.betlose >= 0) {
            ws.betsafe = false;
            ws.betlose = 0;
            ws.nextbet = ws.basebet;
            bot.currentChance = ws.chanceNormal;
        } else if (lossPercentage >= ws.recoveryThreshold) {
            if (!ws.betsafe) {
                bot.currentChance = ws.chanceRecovery;
                ws.betsafe = true;
                updateLogs(0, 0, 0,
                    `WAGER: Entering recovery mode (Loss: ${(lossPercentage * 100).toFixed(3)}% >= ${(ws.recoveryThreshold * 100).toFixed(3)}%)`,
                    true
                );
            }
        }

        if (ws.betsafe) {
            if (bot.stats.bets % 1 === 0) {
                bot.currentChance += 0.5;
                if (bot.currentChance > ws.chanceMax) {
                    bot.currentChance = ws.chanceNormal;
                    ws.betsafe = false;
                    ws.betlose = 0;
                    ws.nextbet = ws.basebet;
                    updateLogs(0, 0, 0, "WAGER: Exiting recovery mode", true);
                }
            }
            ws.nextbet = Math.abs(ws.betlose) / ((99 / bot.currentChance) - 1) * 0.5;
        }

        const minbet = parseFloat(document.getElementById("w-minbet")?.value) || 0.00000001;
        if (ws.nextbet < minbet) ws.nextbet = minbet;

        updateWagerStats(profit);
        return ws.nextbet;
    }

    // =============== LABOUCHERE MODE FUNCTIONS ===============
    function getLabouchereChance() {
        const lb = bot.labouchere;
        const level = lb.chanceLevels.find(l => l.ls === lb.currentLs);

        if (level) {
            const chance = Math.random() * (level.chanceMax - level.chanceMin) + level.chanceMin;
            return parseFloat(chance.toFixed(2));
        }

        return lb.chance;
    }

    function updateLabouchereChanceLevel(win) {
        const lb = bot.labouchere;

        if (win) {
            lb.consecutiveLosses = 0;
            lb.currentLs = 1;
        } else {
            lb.consecutiveLosses++;
            if (lb.consecutiveLosses >= 2 && lb.currentLs < 10) {
                lb.currentLs++;
                lb.consecutiveLosses = 0;
                updateLogs(0, 0, 0, `LABOUCHERE: Level up to LS${lb.currentLs}`, true);
            }
        }

        return getLabouchereChance();
    }

    function initLabouchere() {
        const seqInput = document.getElementById("l-sequence")?.value || "0.001,0.002,0.003,0.004";
        bot.labouchere.sequence = seqInput.split(',').map(x => parseFloat(x.trim()) || 0.001);
        bot.labouchere.currentSequence = [...bot.labouchere.sequence];
        bot.labouchere.targetProfit = parseFloat(document.getElementById("l-target")?.value) || 10;
        bot.labouchere.betOn = Math.random() > 0.5 ? 'black' : 'red';
        bot.labouchere.recoveryMode = bot.rotationState.inRecovery;

        bot.labouchere.chance = parseFloat(document.getElementById("l-chance")?.value) || 49.5;
        bot.labouchere.maxBet = parseFloat(document.getElementById("l-maxbet")?.value) || 0.01;
        bot.labouchere.resetOnMaxBet = document.getElementById("l-reset-on-maxbet")?.checked !== false;

        bot.labouchere.currentLs = 1;
        bot.labouchere.consecutiveLosses = 0;

        bot.currentChance = getLabouchereChance();

        updateLogs(0, 0, 0, `LABOUCHERE: Sequence set to ${bot.labouchere.sequence.join(', ')}`, true);
        updateLogs(0, 0, 0, `LABOUCHERE: Chance ${bot.currentChance}% (LS${bot.labouchere.currentLs}), Max Bet ${bot.labouchere.maxBet}`, true);
        updateLabouchereUI();
    }

    function labouchereBetLogic(win) {
        const lb = bot.labouchere;

        if (lb.currentSequence.length === 0) {
            lb.currentSequence = [...lb.sequence];
            updateLogs(0, 0, 0, "LABOUCHERE: Sequence reset", true);
        }

        if (lb.currentSequence.length === 1) {
            lb.betAmount = lb.currentSequence[0];
        } else {
            lb.betAmount = lb.currentSequence[0] + lb.currentSequence[lb.currentSequence.length - 1];
        }

        if (lb.betAmount > lb.maxBet && lb.maxBet > 0) {
            updateLogs(0, 0, 0,
                `LABOUCHERE: Bet ${lb.betAmount.toFixed(8)} exceeds max bet ${lb.maxBet.toFixed(8)}`,
                true
            );

            if (lb.resetOnMaxBet) {
                lb.currentSequence = [...lb.sequence];
                updateLogs(0, 0, 0, "LABOUCHERE: Sequence reset (max bet reached)", true);

                if (lb.currentSequence.length === 1) {
                    lb.betAmount = lb.currentSequence[0];
                } else {
                    lb.betAmount = lb.currentSequence[0] + lb.currentSequence[lb.currentSequence.length - 1];
                }
            } else {
                lb.betAmount = lb.maxBet;
                updateLogs(0, 0, 0, `LABOUCHERE: Bet capped at ${lb.maxBet.toFixed(8)}`, true);
            }
        }

        if (lb.betAmount > bot.stats.currentBal) {
            lb.betAmount = bot.stats.currentBal;
            updateLogs(0, 0, 0,
                `LABOUCHERE: Adjusted bet to ${lb.betAmount.toFixed(8)} (balance limit)`,
                true
            );
        }

        if (win) {
            lb.currentSequence.shift();
            lb.currentSequence.pop();

            if (lb.currentSequence.length === 0) {
                updateLogs(lb.betAmount, lb.betAmount, lb.chance, "LABOUCHERE: Sequence completed!", true);
                return { betAmount: 0, completed: true };
            }
        } else {
            lb.currentSequence.push(lb.betAmount);
        }

        bot.currentChance = updateLabouchereChanceLevel(win);

        updateLabouchereUI();
        return { betAmount: lb.betAmount, completed: false };
    }

    // =============== UPDATE STATS FUNCTIONS ===============
    function updateStats(win) {
        // Update streak tracking
        if (win) {
            if (bot.stats.currentStreak < 0) {
                bot.stats.currentStreak = 1;
            } else {
                bot.stats.currentStreak++;
            }
            bot.stats.lastResult = 'win';
        } else {
            if (bot.stats.currentStreak > 0) {
                bot.stats.currentStreak = -1;
            } else {
                bot.stats.currentStreak--;
            }
            bot.stats.lastResult = 'loss';
        }
        
        // Update max streaks
        if (bot.stats.currentStreak > bot.stats.maxWinStreak) {
            bot.stats.maxWinStreak = bot.stats.currentStreak;
        }
        if (Math.abs(bot.stats.currentStreak) > bot.stats.maxLossStreak && bot.stats.currentStreak < 0) {
            bot.stats.maxLossStreak = Math.abs(bot.stats.currentStreak);
        }
    }

    // =============== ROTATION SYSTEM FUNCTIONS (FIXED) ===============
    function checkRotation() {
        if (!bot.rotationState.initialBalance || bot.rotationState.initialBalance === 0) {
            bot.rotationState.initialBalance = bot.stats.currentBal;
            return false;
        }

        const rs = bot.rotationState;
        const now = Date.now();
        
        // Mencegah switching terlalu sering
        if (now - rs.lastSwitchTime < rs.minSwitchInterval) {
            return false;
        }

        const currentLoss = (rs.initialBalance - bot.stats.currentBal) / rs.initialBalance;

        // Hanya switch jika benar-benar diperlukan
        if (bot.mode === "wager" && currentLoss >= rs.wagerLossThreshold) {
            // JANGAN switch jika baru saja switch dari mode lain
            if (now - rs.lastSwitchTime < rs.minSwitchInterval * 2) {
                return false;
            }
            
            if (bot.enabledModes.labouchere) {
                const oldMode = bot.mode;
                bot.mode = "labouchere";
                rs.inRecovery = true;
                rs.lastSwitchTime = now;
                initLabouchere();
                updateLogs(0, 0, 0,
                    `ROTATION: Wager loss ${(currentLoss * 100).toFixed(2)}% >= ${(rs.wagerLossThreshold * 100).toFixed(2)}%. Switching to Labouchere`,
                    true
                );
                TelegramAPI.sendModeChange(oldMode, bot.mode, `Wager loss: ${(currentLoss * 100).toFixed(2)}% >= ${(rs.wagerLossThreshold * 100).toFixed(2)}%`);
                return true;
            }
        }

        if (bot.mode === "labouchere" && currentLoss >= rs.severeLossThreshold) {
            if (now - rs.lastSwitchTime < rs.minSwitchInterval * 2) {
                return false;
            }
            
            if (bot.enabledModes.orion) {
                const oldMode = bot.mode;
                bot.mode = "orion";
                rs.inRecovery = true;
                rs.lastSwitchTime = now;
                setNewBaseChance();
                updateLogs(0, 0, 0,
                    `ROTATION: Severe loss ${(currentLoss * 100).toFixed(2)}% >= ${(rs.severeLossThreshold * 100).toFixed(2)}%. Switching to Orion`,
                    true
                );
                TelegramAPI.sendModeChange(oldMode, bot.mode, `Severe loss: ${(currentLoss * 100).toFixed(2)}% >= ${(rs.severeLossThreshold * 100).toFixed(2)}%`);
                return true;
            }
        }

        // Recovery dari Orion ke Wager jika balance kembali
        if (bot.mode === "orion" && rs.inRecovery && bot.stats.currentBal >= rs.initialBalance) {
            if (now - rs.lastSwitchTime < rs.minSwitchInterval * 2) {
                return false;
            }
            
            if (bot.enabledModes.wager) {
                const oldMode = bot.mode;
                bot.mode = "wager";
                rs.inRecovery = false;
                rs.lastSwitchTime = now;
                initWagerMode();
                updateLogs(0, 0, 0,
                    `ROTATION: Balance recovered (${bot.stats.currentBal.toFixed(8)} >= ${rs.initialBalance.toFixed(8)}). Returning to Wager mode`,
                    true
                );
                TelegramAPI.sendModeChange(oldMode, bot.mode, `Balance recovered: ${bot.stats.currentBal.toFixed(8)} >= ${rs.initialBalance.toFixed(8)}`);
                return true;
            }
        }

        // Step limit untuk Orion mode
        if (bot.mode === "orion" && bot.stats.bets >= rs.stepLimit) {
            if (now - rs.lastSwitchTime < rs.minSwitchInterval * 2) {
                return false;
            }
            
            rs.stepLimit = Math.round(rs.stepLimit * rs.stepLimitMultiplier);
            
            if (bot.enabledModes.wager) {
                const oldMode = bot.mode;
                bot.mode = "wager";
                rs.inRecovery = false;
                rs.lastSwitchTime = now;
                initWagerMode();
                updateLogs(0, 0, 0,
                    `ORION: Step limit reached. New limit: ${rs.stepLimit}. Returning to Wager mode.`,
                    true
                );
                TelegramAPI.sendModeChange(oldMode, bot.mode, `Step limit reached: ${bot.stats.bets} bets`);
                return true;
            }
        }

        return false;
    }

    function getNextEnabledMode() {
        const modes = ['orion', 'wager', 'labouchere'];
        let currentIndex = modes.indexOf(bot.mode);

        for (let i = 1; i <= modes.length; i++) {
            const nextIndex = (currentIndex + i) % modes.length;
            const nextMode = modes[nextIndex];
            if (bot.enabledModes[nextMode]) {
                return nextMode;
            }
        }

        return bot.mode;
    }

    function determineStartingMode() {
        if (bot.enabledModes.wager) {
            return "wager";
        } else if (bot.enabledModes.labouchere) {
            return "labouchere";
        } else {
            return "orion";
        }
    }

    // =============== MAIN GAME LOOP ===============
    async function runLoop() {
        if (!bot.isRunning || bot.isPaused) return;

        try {
            // Check for periodic Telegram report
            TelegramAPI.sendPeriodicReport();

            // Check rotation hanya jika tidak dalam turbo mode atau setiap beberapa bet
            if (!bot.turboMode || bot.stats.bets % bot.turboSettings.skipRotationCheck === 0) {
                checkRotation();
            }

            let nextBet = 0;

            if (bot.mode === "orion") {
                if (bot.singleChanceBets < bot.singleChanceLimit) {
                    bot.currentChance = bot.baseChance;
                } else {
                    bot.currentChance = Math.floor(Math.random() * 11) + (bot.baseChance + 5);
                }

                const payout = 99 / bot.currentChance;
                const margin = parseFloat(document.getElementById("p-margin")?.value || 1.01);
                const minBetLimit = parseFloat(document.getElementById("p-minbet")?.value || 0);
                const baseBet = parseFloat(document.getElementById("p-basebet")?.value || 0.00000001);

                if (bot.orionSettings.method === "mathematic") {
                    nextBet = (Math.abs(bot.tg) / (payout - 1)) * margin;
                } else {
                    // FIXED MARTINGALE SYSTEM
                    const martingaleMult = bot.orionSettings.martingaleMultiplier || 1.12;
                    
                    if (bot.singleChanceBets === 0) {
                        // Bet pertama dalam sequence
                        nextBet = baseBet;
                        bot.orionSettings.currentMultiplier = 1.0;
                    } else {
                        // Hitung multiplier berdasarkan consecutive losses
                        bot.orionSettings.currentMultiplier = Math.pow(martingaleMult, bot.orionSettings.consecutiveLosses);
                        nextBet = baseBet * bot.orionSettings.currentMultiplier;
                    }
                    
                    // Log martingale info
                    if (bot.singleChanceBets > 0) {
                        updateLogs(0, 0, 0, 
                            `ORION Martingale: Losses: ${bot.orionSettings.consecutiveLosses}, Multiplier: ${bot.orionSettings.currentMultiplier.toFixed(4)}`, 
                            true
                        );
                    }
                }

                if (bot.tg === bot.perStep) nextBet = baseBet;
                if (nextBet < minBetLimit) nextBet = minBetLimit;

            } else if (bot.mode === "wager") {
                nextBet = wagerBetLogic(0);

            } else if (bot.mode === "labouchere") {
                const lbResult = labouchereBetLogic(false);
                nextBet = lbResult.betAmount;
            }

            if (nextBet <= 0) nextBet = parseFloat(document.getElementById("p-basebet")?.value || 0.00000001);
            if (nextBet > bot.stats.currentBal && bot.stats.currentBal > 0) {
                nextBet = bot.stats.currentBal;
                updateLogs(0, 0, 0, `âš ï¸ Bet capped at balance: ${nextBet.toFixed(8)}`, true);
            }

            const res = await API.placeBet(nextBet, bot.currentChance);
            const d = res?.data?.diceRoll || res?.diceRoll;

            if (d) {
                const win = d.payout > 0;
                const pft = d.payout - d.amount;

                bot.stats.bets++;
                bot.stats.wagered += d.amount;
                bot.stats.profit += pft;
                bot.stats.currentBal += pft;

                if (win) {
                    bot.stats.wins++;
                    // Check for big win
                    TelegramAPI.sendBigWinReport(d.amount, pft, bot.currentChance);
                } else {
                    bot.stats.loss++;
                }

                // Update streak statistics
                updateStats(win);

                if (bot.stats.currentBal < bot.stats.startBal) {
                    let dd = bot.stats.startBal - bot.stats.currentBal;
                    let ddPerc = (dd / bot.stats.startBal) * 100;
                    if (dd > bot.stats.maxDD) bot.stats.maxDD = dd;
                    if (ddPerc > bot.stats.maxDDPerc) bot.stats.maxDDPerc = ddPerc;
                }

                updateLogs(d.amount, pft, bot.currentChance);

                if (bot.mode === "orion") {
                    if (win) {
                        setNewBaseChance();
                        bot.orionSettings.consecutiveLosses = 0;
                        bot.orionSettings.currentMultiplier = 1.0;
                    } else {
                        bot.singleChanceBets++;
                        bot.tg += (d.amount + bot.perStep);
                        bot.orionSettings.consecutiveLosses++;
                    }
                } else if (bot.mode === "wager") {
                    wagerBetLogic(pft);
                } else if (bot.mode === "labouchere") {
                    const result = labouchereBetLogic(win);
                    if (result.completed) {
                        updateLogs(0, 0, 0, "Labouchere sequence completed!", true);
                    }
                }

                if (bot.stats.profit >= bot.targetAbs) {
                    bot.isRunning = false;
                    updateLogs(0, 0, 0, "ğŸ¯ TARGET SUCCESS!", true);
                    TelegramAPI.sendTargetReached();
                    TelegramAPI.sendStopReport("Target Profit Reached");
                }
                else if (bot.stats.profit <= -bot.stopLossAbs) {
                    bot.isRunning = false;
                    updateLogs(0, 0, 0, "ğŸ›‘ STOP LOSS REACHED!", true);
                    TelegramAPI.sendStopLossReached();
                }

                // Update dashboard after each bet
                updateDashboard();
            }

            if (bot.isRunning && !bot.isPaused) {
                if (!bot.isDemo) {
                    const delay = bot.turboMode ? bot.turboSettings.betDelay : 10;
                    setTimeout(runLoop, delay);
                } else {
                    runLoop();
                }
            }

        } catch (e) {
            console.error("Run loop error:", e);
            updateLogs(0, 0, 0, `âš ï¸ Error: ${e.message}`, true);
            
            if (bot.isRunning && !bot.isPaused) {
                const delay = bot.turboMode ? 50 : 100;
                setTimeout(runLoop, delay);
            }
        }
    }

    // =============== UI FUNCTIONS ===============
    function updateLogs(amt, pft, ch, customMsg = null, isSystem = false) {
        const logBox = document.getElementById("p-logs");
        if (!logBox) return;

        const entry = document.createElement("div");
        entry.className = "log-entry";

        if (isSystem) {
            entry.style.color = "#ffcc00";
            entry.style.borderLeft = "3px solid #ffcc00";
        } else {
            entry.style.color = pft > 0 ? "#10b981" : "#ef4444";
            entry.style.borderLeft = pft > 0 ? "3px solid #10b981" : "3px solid #ef4444";
        }

        const modeBadge = `<span class="mode-badge" style="background: ${getModeColor()}; color: #000; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-right: 5px;">${bot.mode.toUpperCase()}</span>`;

        if (customMsg) {
            entry.innerHTML = `${modeBadge}<span class="log-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span> | ${customMsg}`;
        } else {
            entry.innerHTML = `${bot.isDemo ? '[DEMO] ' : ''}${modeBadge}<span class="log-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span> | B: <span class="log-amount">${amt.toFixed(8)}</span> | P: <span class="log-profit">${pft > 0 ? '+' : ''}${pft.toFixed(8)}</span> | C: <span class="log-chance">${ch}%</span>`;
        }

        logBox.prepend(entry);
        
        // Remove old logs only if there are too many
        if (logBox.children.length > 100) {
            logBox.removeChild(logBox.lastChild);
        }
    }

    function getModeColor() {
        switch (bot.mode) {
            case 'orion': return '#00ccff';
            case 'wager': return '#10b981';
            case 'labouchere': return '#8b5cf6';
            default: return '#666';
        }
    }

    function updateWagerUI() {
        const ws = bot.wagerStats;
        const ss = ws.simplestats;

        if (document.getElementById("w-betlose")) {
            document.getElementById("w-betlose").innerText = ws.betlose.toFixed(8);
            document.getElementById("w-nextbet").innerText = ws.nextbet.toFixed(8);
            document.getElementById("w-basebet").innerText = ws.basebet.toFixed(8);
            document.getElementById("w-betsafe").innerText = ws.betsafe ? "YES" : "NO";
            document.getElementById("w-chance-current").innerText = bot.currentChance.toFixed(1) + "%";

            const lossPercentage = ws.betlose < 0 ? Math.abs(ws.betlose) / bot.stats.currentBal * 100 : 0;
            if (document.getElementById("w-loss-percent")) {
                document.getElementById("w-loss-percent").innerText = lossPercentage.toFixed(3) + "%";
            }

            document.getElementById("w-profitc").innerText = ss.profitc.toFixed(8);
            document.getElementById("w-maxdrop").innerText = ss.maxdrop.toFixed(8);
            document.getElementById("w-dropnow").innerText = ss.drop.toFixed(8);
            document.getElementById("w-mostbet").innerText = ss.mostbet.toFixed(8);
            document.getElementById("w-status").innerText = `${ss.reset ? "LOWBET " : "NORMAL "}${ss.recov ? "RECOVERY" : "STEADY"}`;
        }
    }

    function updateLabouchereUI() {
        const lb = bot.labouchere;
        const currentLevel = lb.chanceLevels.find(l => l.ls === lb.currentLs) || {
            chanceMin: lb.chance,
            chanceMax: lb.chance
        };

        if (document.getElementById("l-sequence-current")) {
            document.getElementById("l-sequence-current").innerText = lb.currentSequence.map(x => x.toFixed(8)).join(', ');
            document.getElementById("l-betamount").innerText = lb.betAmount.toFixed(8);
            document.getElementById("l-beton").innerText = lb.betOn.toUpperCase();
            document.getElementById("l-recovery").innerText = lb.recoveryMode ? "YES" : "NO";
            document.getElementById("l-chance-value").innerText = bot.currentChance + "%";
            document.getElementById("l-maxbet-value").innerText = lb.maxBet.toFixed(8);
            document.getElementById("l-current-ls").innerText = `LS${lb.currentLs}`;
            document.getElementById("l-chance-range").innerText = `${currentLevel.chanceMin}% - ${currentLevel.chanceMax}%`;
            document.getElementById("l-consecutive-losses").innerText = lb.consecutiveLosses;
        }
    }

    function updateDashboard() {
        // Update current mode
        const currentMode = document.getElementById("current-mode");
        if (currentMode) {
            currentMode.textContent = bot.mode.toUpperCase();
            if (bot.isPaused) {
                currentMode.textContent += " (PAUSED)";
            }
        }

        // Update dashboard stats
        const dashboardBalance = document.getElementById("dashboard-balance");
        if (dashboardBalance) dashboardBalance.innerText = bot.stats.currentBal.toFixed(8);

        const dashboardProfit = document.getElementById("dashboard-profit");
        if (dashboardProfit) dashboardProfit.innerText = bot.stats.profit.toFixed(8);

        const profitPercent = bot.stats.startBal > 0 ? (bot.stats.profit / bot.stats.startBal * 100) : 0;
        const dashboardProfitPct = document.getElementById("dashboard-profit-pct");
        if (dashboardProfitPct) dashboardProfitPct.innerText = profitPercent.toFixed(2) + '%';

        const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
        const dashboardWinrate = document.getElementById("dashboard-winrate");
        if (dashboardWinrate) dashboardWinrate.innerText = winRate.toFixed(2) + '%';

        const dashboardWinsLosses = document.getElementById("dashboard-wins-losses");
        if (dashboardWinsLosses) dashboardWinsLosses.innerText = `${bot.stats.wins}/${bot.stats.loss}`;

        const dashboardBets = document.getElementById("dashboard-bets");
        if (dashboardBets) dashboardBets.innerText = bot.stats.bets;

        const dashboardWins = document.getElementById("dashboard-wins");
        if (dashboardWins) dashboardWins.innerText = bot.stats.wins;

        const dashboardLosses = document.getElementById("dashboard-losses");
        if (dashboardLosses) dashboardLosses.innerText = bot.stats.loss;

        const dashboardWagered = document.getElementById("dashboard-wagered");
        if (dashboardWagered) dashboardWagered.innerText = bot.stats.wagered.toFixed(8);

        const dashboardRuntime = document.getElementById("dashboard-runtime");
        if (dashboardRuntime && bot.stats.startTime) {
            const now = new Date();
            const runtime = Math.floor((now - bot.stats.startTime) / 1000);
            const hours = Math.floor(runtime / 3600);
            const minutes = Math.floor((runtime % 3600) / 60);
            const seconds = runtime % 60;
            dashboardRuntime.innerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update LS/WS
        const dashboardLsWs = document.getElementById("dashboard-lsws");
        if (dashboardLsWs) {
            if (bot.mode === 'labouchere') {
                dashboardLsWs.innerText = `LS${bot.labouchere.currentLs}`;
            } else {
                const streakType = bot.stats.currentStreak > 0 ? 'WS' : 'LS';
                const streakValue = Math.abs(bot.stats.currentStreak);
                dashboardLsWs.innerText = `${streakType}${streakValue}`;
            }
        }

        // Update currency display
        const stCurrency = document.getElementById("st-currency");
        if (stCurrency) stCurrency.textContent = bot.selectedCurrency.toUpperCase();

        // Update account name
        const dashboardAccount = document.getElementById("dashboard-account");
        if (dashboardAccount) dashboardAccount.textContent = bot.stakeUser;

        // Update speed display
        const dashboardSpeed = document.getElementById("dashboard-speed");
        if (dashboardSpeed) dashboardSpeed.textContent = bot.turboMode ? 'TURBO' : 'NORMAL';
        
        // Update martingale info jika mode orion
        if (bot.mode === 'orion' && bot.orionSettings.method === 'martingale') {
            const martingaleInfo = document.getElementById("martingale-info");
            if (martingaleInfo) {
                martingaleInfo.innerHTML = `Losses: ${bot.orionSettings.consecutiveLosses}, Multiplier: ${bot.orionSettings.currentMultiplier.toFixed(4)}`;
            }
        }
    }

    let statsInterval;

    function updateStatsInterval() {
        if (statsInterval) clearInterval(statsInterval);

        const interval = bot.turboMode ? bot.turboSettings.updateInterval : 1000;

        statsInterval = setInterval(async () => {
            // Update balance if not in demo mode
            if (bot.isRunning && !bot.isDemo) {
                try {
                    const newBalance = await API.getBalance(bot.selectedCurrency);
                    bot.stats.currentBal = newBalance;
                } catch (e) {
                    console.log("Balance update error:", e);
                }
            }

            // Update dashboard
            updateDashboard();

            // Update header balance
            const headerBalance = document.getElementById("header-balance");
            if (headerBalance) {
                headerBalance.innerText = bot.stats.currentBal.toFixed(8);
            }

            // Update other UI elements
            if (!bot.turboMode || bot.stats.bets % 10 === 0) {
                updateWagerUI();
                updateLabouchereUI();
            }
        }, interval);
    }

    function createUI() {
        if (document.getElementById("orion-wrap")) document.getElementById("orion-wrap").remove();

        // Handle error dari external scripts
        const originalErrorHandler = window.onerror;
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg.includes('Insider') || msg.includes('Intercom') || msg.includes('ERR_NAME_NOT_RESOLVED')) {
                console.log('External script error suppressed:', msg);
                return true;
            }
            if (originalErrorHandler) {
                return originalErrorHandler.call(this, msg, url, lineNo, columnNo, error);
            }
            return false;
        };

        const s = document.createElement("style");
        s.innerHTML = `
            /* MOBILE-FIRST STYLES */
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
            
            :root {
                --primary: #3b82f6;
                --primary-dark: #2563eb;
                --success: #10b981;
                --success-dark: #059669;
                --danger: #ef4444;
                --danger-dark: #dc2626;
                --warning: #f59e0b;
                --warning-dark: #d97706;
                --pause: #f59e0b;
                --pause-dark: #d97706;
                --turbo: #ff3366;
                --turbo-dark: #ff6b9d;
                --telegram: #0088cc;
                --telegram-dark: #006699;
                --dark: #0f172a;
                --darker: #020617;
                --light: #f8fafc;
                --gray: #64748b;
                --border: #334155;
                --card-bg: rgba(30, 41, 59, 0.95);
                --license-expired: #ef4444;
                --license-active: #10b981;
            }
            
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            
            #orion-wrap {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                z-index: 999999;
                background: var(--darker);
                color: var(--light);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                font-family: 'Inter', sans-serif;
            }
            
            .header {
                background: var(--dark);
                border-bottom: 1px solid var(--border);
                padding: 12px 16px;
                flex-shrink: 0;
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(10px);
            }
            
            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .app-title {
                font-size: 16px;
                font-weight: 700;
                background: linear-gradient(135deg, #fff 0%, #93c5fd 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .license-badge {
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 600;
                background: ${CONFIG.license.isValid() ? 'var(--license-active)' : 'var(--license-expired)'};
                color: white;
            }
            
            .telegram-status {
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 600;
                background: ${CONFIG.telegram.enabled ? 'var(--telegram)' : 'var(--gray)'};
                color: white;
            }
            
            .header-controls {
                display: flex;
                gap: 8px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--light);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .control-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .tabs-wrapper {
                position: sticky;
                top: 0;
                z-index: 90;
                background: var(--darker);
                padding-bottom: 8px;
                margin-bottom: 8px;
                border-bottom: 1px solid var(--border);
            }
            
            .tabs-container {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                background: rgba(30, 41, 59, 0.4);
                border-radius: 10px;
                padding: 4px;
                border: 1px solid var(--border);
                gap: 4px;
            }
            
            .tab {
                padding: 12px 4px;
                text-align: center;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                color: var(--gray);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 0;
                transition: all 0.2s;
            }
            
            .tab:hover {
                color: var(--light);
            }
            
            .tab.active {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                color: white;
            }
            
            .tab-content {
                display: none;
                flex: 1;
                overflow-y: auto;
                padding: 16px;
                -webkit-overflow-scrolling: touch;
                flex-direction: column;
            }
            
            .tab-content.active {
                display: flex;
            }
            
            /* DASHBOARD STYLES */
            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 12px;
            }
            
            .dashboard-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
                transition: transform 0.2s;
            }
            
            .dashboard-card:hover {
                transform: translateY(-2px);
            }
            
            .dashboard-card-title {
                font-size: 11px;
                color: var(--gray);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
                font-weight: 600;
            }
            
            .dashboard-card-value {
                font-size: 18px;
                font-weight: 700;
                color: var(--light);
                font-family: 'Courier New', monospace;
                line-height: 1.2;
            }
            
            .dashboard-card-small {
                font-size: 10px;
                color: var(--gray);
                margin-top: 4px;
                font-weight: 500;
            }
            
            .account-info {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            }
            
            .account-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .account-row:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }
            
            .account-label {
                font-size: 12px;
                color: var(--gray);
                font-weight: 500;
            }
            
            .account-value {
                font-size: 13px;
                font-weight: 600;
                color: var(--light);
                font-family: 'Courier New', monospace;
            }
            
            .mode-selector {
                display: flex;
                background: rgba(15, 23, 42, 0.8);
                border-radius: 8px;
                padding: 4px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            }
            
            .mode-btn {
                flex: 1;
                padding: 10px;
                border: none;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                background: transparent;
                color: var(--gray);
                text-align: center;
                transition: all 0.2s;
            }
            
            .mode-btn:hover {
                color: var(--light);
                background: rgba(255, 255, 255, 0.05);
            }
            
            .mode-btn.active {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                color: white;
            }
            
            .control-panel {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            }
            
            .control-buttons {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .control-button {
                padding: 14px 8px;
                border: none;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 700;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                min-height: 44px;
                width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                transition: all 0.2s;
            }
            
            .control-button:hover {
                transform: translateY(-2px);
                filter: brightness(1.1);
            }
            
            .btn-start {
                background: linear-gradient(135deg, var(--success), var(--success-dark));
                color: white;
            }
            
            .btn-stop {
                background: linear-gradient(135deg, var(--danger), var(--danger-dark));
                color: white;
            }
            
            .btn-pause {
                background: linear-gradient(135deg, var(--pause), var(--pause-dark));
                color: white;
            }
            
            .btn-turbo {
                background: linear-gradient(135deg, var(--turbo), var(--turbo-dark));
                color: white;
            }
            
            .speed-control {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 8px;
                border: 1px solid var(--border);
                margin-bottom: 8px;
            }
            
            .speed-control:last-child {
                margin-bottom: 0;
            }
            
            .speed-label {
                font-size: 12px;
                color: var(--gray);
                font-weight: 500;
            }
            
            .speed-value {
                font-size: 13px;
                font-weight: 700;
                color: var(--light);
                font-family: 'Courier New', monospace;
            }
            
            /* LIVE LOGS IMPROVEMENTS */
            .live-logs {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                border: 1px solid var(--border);
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 300px;
                max-height: 400px;
                backdrop-filter: blur(10px);
            }
            
            .live-logs-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .clear-logs-btn {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--border);
                color: var(--light);
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 10px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .clear-logs-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .logs-container {
                flex: 1;
                overflow-y: auto;
                background: rgba(15, 23, 42, 0.7);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                line-height: 1.4;
            }
            
            .log-entry {
                padding: 8px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                word-break: break-word;
                display: flex;
                align-items: flex-start;
                gap: 8px;
            }
            
            .log-entry:last-child {
                border-bottom: none;
            }
            
            .log-time {
                color: var(--gray);
                font-size: 10px;
                min-width: 45px;
                flex-shrink: 0;
            }
            
            .log-amount, .log-profit, .log-chance {
                font-weight: 600;
            }
            
            .mode-badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 1px 4px;
                border-radius: 3px;
                font-size: 9px;
                font-weight: 700;
                margin-right: 6px;
                flex-shrink: 0;
            }
            
            /* SETTINGS STYLES */
            .settings-section {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            }
            
            .section-title {
                font-size: 13px;
                font-weight: 700;
                color: var(--light);
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .section-title::before {
                content: '';
                width: 4px;
                height: 16px;
                background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
                border-radius: 2px;
            }
            
            .input-group {
                margin-bottom: 12px;
            }
            
            .input-label {
                display: block;
                font-size: 11px;
                font-weight: 600;
                color: var(--gray);
                margin-bottom: 6px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .input-field {
                width: 100%;
                background: rgba(15, 23, 42, 0.7);
                border: 1px solid var(--border);
                padding: 10px 12px;
                border-radius: 8px;
                color: var(--light);
                font-size: 13px;
                font-family: 'Courier New', monospace;
                height: 40px;
                transition: all 0.2s;
            }
            
            .input-field:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            }
            
            .select-field {
                width: 100%;
                background: rgba(15, 23, 42, 0.7);
                border: 1px solid var(--border);
                padding: 10px 12px;
                border-radius: 8px;
                color: var(--light);
                font-size: 13px;
                font-family: 'Inter', sans-serif;
                cursor: pointer;
                height: 40px;
                transition: all 0.2s;
            }
            
            .select-field:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            }
            
            .toggle-group {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
                padding: 8px 0;
            }
            
            .toggle-label {
                font-size: 13px;
                font-weight: 600;
                color: var(--light);
            }
            
            .toggle-switch {
                position: relative;
                width: 50px;
                height: 26px;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: var(--border);
                border-radius: 34px;
                transition: .4s;
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                border-radius: 50%;
                transition: .4s;
            }
            
            input:checked + .toggle-slider {
                background: linear-gradient(135deg, var(--success), var(--success-dark));
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
            
            .radio-group {
                display: flex;
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .radio-item {
                flex: 1;
            }
            
            .radio-item input[type="radio"] {
                display: none;
            }
            
            .radio-label {
                display: block;
                padding: 10px;
                text-align: center;
                background: rgba(15, 23, 42, 0.6);
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                color: var(--gray);
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }
            
            .radio-label:hover {
                color: var(--light);
                background: rgba(255, 255, 255, 0.05);
            }
            
            .radio-item input[type="radio"]:checked + .radio-label {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                color: white;
                border-color: var(--primary);
            }
            
            .grid-2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }
            
            .chance-levels-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin-top: 12px;
            }
            
            .chance-level-card {
                background: rgba(30, 41, 59, 0.8);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 10px;
                text-align: center;
                transition: all 0.2s;
            }
            
            .chance-level-card:hover {
                transform: translateY(-2px);
            }
            
            .chance-level-card.active {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                border-color: var(--primary);
            }
            
            .chance-level-label {
                font-size: 10px;
                color: var(--gray);
                font-weight: 600;
                margin-bottom: 4px;
            }
            
            .chance-level-card.active .chance-level-label {
                color: white;
            }
            
            .chance-level-range {
                font-size: 11px;
                font-weight: 700;
                color: var(--light);
                font-family: 'Courier New', monospace;
            }
            
            /* SUPPORT STYLES */
            .support-section {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border: 1px solid var(--border);
                backdrop-filter: blur(10px);
            }
            
            .telegram-test-btn {
                width: 100%;
                padding: 14px;
                border: none;
                border-radius: 10px;
                background: linear-gradient(135deg, var(--telegram), var(--telegram-dark));
                color: white;
                font-size: 13px;
                font-weight: 700;
                cursor: pointer;
                margin-top: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s;
            }
            
            .telegram-test-btn:hover {
                transform: translateY(-2px);
                filter: brightness(1.1);
            }
            
            .support-link {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 16px;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 10px;
                border: 1px solid var(--border);
                color: var(--light);
                text-decoration: none;
                font-size: 14px;
                font-weight: 600;
                margin-top: 12px;
                transition: all 0.3s;
            }
            
            .support-link:hover {
                background: rgba(15, 23, 42, 0.8);
                transform: translateY(-2px);
            }
            
            /* RESPONSIVE DESIGN */
            @media (min-width: 768px) {
                #orion-wrap {
                    top: 20px;
                    left: 20px;
                    right: 20px;
                    bottom: 20px;
                    width: calc(100% - 40px);
                    height: calc(100% - 40px);
                    border-radius: 16px;
                    border: 1px solid var(--border);
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                }
                
                .dashboard-grid {
                    grid-template-columns: repeat(4, 1fr);
                }
                
                .live-logs {
                    min-height: 400px;
                    max-height: 500px;
                }
                
                .logs-container {
                    font-size: 13px;
                }
                
                .app-title {
                    font-size: 18px;
                }
            }
            
            @media (max-width: 480px) {
                .dashboard-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
                
                .control-buttons {
                    grid-template-columns: repeat(2, 1fr);
                }
                
                .grid-2 {
                    grid-template-columns: 1fr;
                }
                
                .logs-container {
                    font-size: 11px;
                }
            }
            
            @media (min-width: 1024px) {
                .dashboard-grid {
                    grid-template-columns: repeat(4, 1fr);
                }
                
                .control-buttons {
                    grid-template-columns: repeat(4, 1fr);
                }
            }
            
            /* SCROLLBAR STYLES */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: var(--primary);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: var(--primary-dark);
            }
        `;
        document.head.appendChild(s);

        // Get expiry date info
        const expiryDate = CONFIG.license.expiryDate;
        const daysRemaining = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
        const licenseStatus = CONFIG.license.isValid() ? 'ACTIVE' : 'EXPIRED';
        const licenseText = CONFIG.license.isValid() 
            ? `Expires: ${expiryDate.toLocaleDateString()} (${daysRemaining} days)` 
            : 'LICENSE EXPIRED';

        // Create UI
        const d = document.createElement("div");
        d.id = "orion-wrap";
        d.innerHTML = `
            <div class="header">
                <div class="header-top">
                    <div class="app-title">
                        ORION v8.2
                        <span class="license-badge" title="${licenseText}">${licenseStatus}</span>
                        <span class="telegram-status ${CONFIG.telegram.enabled ? 'enabled' : 'disabled'}">
                            ${CONFIG.telegram.enabled ? 'ğŸ“± TG ON' : 'ğŸ“± TG OFF'}
                        </span>
                    </div>
                    <div class="header-controls">
                        <div class="control-btn minimize" title="Minimize">_</div>
                        <div class="control-btn close" title="Close">Ã—</div>
                    </div>
                </div>
                <div class="tabs-wrapper">
                    <div class="tabs-container">
                        <div class="tab active" data-tab="dashboard">ğŸ“Š DASHBOARD</div>
                        <div class="tab" data-tab="settings">âš™ï¸ SETTINGS</div>
                        <div class="tab" data-tab="support">ğŸ“± SUPPORT</div>
                    </div>
                </div>
            </div>
            
            <!-- DASHBOARD TAB -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Balance</div>
                        <div class="dashboard-card-value" id="dashboard-balance">0.00000000</div>
                        <div class="dashboard-card-small" id="st-currency">DOGE</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Profit</div>
                        <div class="dashboard-card-value" id="dashboard-profit">0.00000000</div>
                        <div class="dashboard-card-small" id="dashboard-profit-pct">0.00%</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Win Rate</div>
                        <div class="dashboard-card-value" id="dashboard-winrate">0.00%</div>
                        <div class="dashboard-card-small" id="dashboard-wins-losses">0/0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">Bets</div>
                        <div class="dashboard-card-value" id="dashboard-bets">0</div>
                        <div class="dashboard-card-small">W: <span id="dashboard-wins">0</span> / L: <span id="dashboard-losses">0</span></div>
                    </div>
                </div>
                
                <div class="account-info">
                    <div class="account-row">
                        <div class="account-label">Account</div>
                        <div class="account-value" id="dashboard-account">${bot.stakeUser}</div>
                    </div>
                    <div class="account-row">
                        <div class="account-label">License</div>
                        <div class="account-value" style="color: ${CONFIG.license.isValid() ? 'var(--license-active)' : 'var(--license-expired)'}">
                            ${licenseStatus} - ${licenseText}
                        </div>
                    </div>
                    <div class="account-row">
                        <div class="account-label">Current Mode</div>
                        <div class="account-value" id="current-mode">${bot.mode.toUpperCase()}</div>
                    </div>
                    <div class="account-row">
                        <div class="account-label">Runtime</div>
                        <div class="account-value" id="dashboard-runtime">00:00:00</div>
                    </div>
                    <div class="account-row">
                        <div class="account-label">Wagered</div>
                        <div class="account-value" id="dashboard-wagered">0.00000000</div>
                    </div>
                </div>
                
                <div class="mode-selector">
                    <button class="mode-btn ${bot.mode === 'wager' ? 'active' : ''}" data-mode="wager">ğŸ¯ WAGER</button>
                    <button class="mode-btn ${bot.mode === 'labouchere' ? 'active' : ''}" data-mode="labouchere">ğŸ² LABOUCHERE</button>
                    <button class="mode-btn ${bot.mode === 'orion' ? 'active' : ''}" data-mode="orion">âš¡ ORION</button>
                </div>
                
                <div class="control-panel">
                    <div class="control-buttons">
                        <button id="p-start" class="control-button btn-start">â–¶ START</button>
                        <button id="p-stop" class="control-button btn-stop">â¹ STOP</button>
                        <button id="p-pause" class="control-button btn-pause">â¸ PAUSE</button>
                        <button id="p-turbo" class="control-button btn-turbo">ğŸš€ TURBO</button>
                    </div>
                    
                    <div class="speed-control">
                        <div class="speed-label">Speed</div>
                        <div class="speed-value" id="dashboard-speed">${bot.turboMode ? 'TURBO' : 'NORMAL'}</div>
                    </div>
                    
                    <div class="speed-control">
                        <div class="speed-label">LS/WS</div>
                        <div class="speed-value" id="dashboard-lsws">LS0</div>
                    </div>
                    
                    <div class="speed-control" id="martingale-info-container" style="${bot.mode === 'orion' && bot.orionSettings.method === 'martingale' ? 'display: flex;' : 'display: none;'}">
                        <div class="speed-label">Martingale</div>
                        <div class="speed-value" id="martingale-info">Losses: 0, Multiplier: 1.0000</div>
                    </div>
                </div>
                
                <div class="live-logs">
                    <div class="live-logs-header">
                        <div class="section-title">Live Logs</div>
                        <button class="clear-logs-btn" id="clear-logs">Clear Logs</button>
                    </div>
                    <div class="logs-container" id="p-logs">
                        <div style="color: var(--gray); text-align: center; padding: 40px 0; font-style: italic;">
                            Waiting for engine start...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SETTINGS TAB -->
            <div class="tab-content" id="tab-settings">
                <div class="settings-section">
                    <div class="section-title">Wager Mode Settings</div>
                    
                    <div class="input-group">
                        <label class="input-label">Base Bet Mode</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="basebet-percentage" name="basebet-mode" value="percentage" ${bot.wagerStats.basebetMode === 'percentage' ? 'checked' : ''}>
                                <label for="basebet-percentage" class="radio-label">Percentage</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="basebet-fixed" name="basebet-mode" value="fixed" ${bot.wagerStats.basebetMode === 'fixed' ? 'checked' : ''}>
                                <label for="basebet-fixed" class="radio-label">Fixed Amount</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label" id="basebet-label">${bot.wagerStats.basebetMode === 'percentage' ? 'Percentage %' : 'Amount'}</label>
                            <input type="number" id="w-basebet-input" class="input-field" 
                                value="${bot.wagerStats.basebetMode === 'percentage' ? bot.wagerStats.basebetPercentage : bot.wagerStats.basebetFixed.toFixed(8)}" 
                                step="${bot.wagerStats.basebetMode === 'percentage' ? '0.1' : '0.00000001'}" 
                                min="${bot.wagerStats.basebetMode === 'percentage' ? '0.1' : '0.00000001'}"
                                max="${bot.wagerStats.basebetMode === 'percentage' ? '10' : ''}">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Min Bet</label>
                            <input type="number" id="w-minbet" class="input-field" value="0.00000001" step="0.00000001" min="0">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Normal Chance %</label>
                            <input type="number" id="w-chance-normal" class="input-field" value="97.0" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Recovery Chance %</label>
                            <input type="number" id="w-chance-recovery" class="input-field" value="25.0" step="0.1" min="1" max="99">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Max Chance %</label>
                            <input type="number" id="w-chance-max" class="input-field" value="99.0" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Recovery %</label>
                            <input type="number" id="w-recovery-threshold" class="input-field" value="0.1" step="0.01" min="0.01" max="10">
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Labouchere Mode Settings</div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Sequence</label>
                            <input id="l-sequence" class="input-field" value="0.001,0.002,0.003,0.004" placeholder="0.001,0.002,0.003">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Target Profit</label>
                            <input id="l-target" class="input-field" value="10" type="number" step="0.00000001" min="0">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Base Chance %</label>
                            <input id="l-chance" class="input-field" value="49.5" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Max Bet</label>
                            <input id="l-maxbet" class="input-field" value="0.01" type="number" step="0.00000001" min="0">
                        </div>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Reset Sequence on Max Bet</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="l-reset-on-maxbet" ${bot.labouchere.resetOnMaxBet ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="chance-levels-grid" id="chance-levels-grid"></div>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Orion Mode Settings</div>
                    
                    <div class="input-group">
                        <label class="input-label">Base Bet</label>
                        <input id="p-basebet" class="input-field" value="0.00000001" type="number" step="0.00000001" min="0">
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Chance Min %</label>
                            <input id="p-ch-min" class="input-field" value="5.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Chance Max %</label>
                            <input id="p-ch-max" class="input-field" value="12.0" type="number" step="0.1" min="1" max="99">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Target %</label>
                            <input id="p-target-pct" class="input-field" value="10.0" type="number" step="0.1" min="0" max="1000">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Stop Loss %</label>
                            <input id="p-stop-pct" class="input-field" value="50.0" type="number" step="0.1" min="0" max="1000">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Steps Limit</label>
                            <input id="p-steps" class="input-field" value="10000" type="number" step="100" min="100">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Margin</label>
                            <input id="p-margin" class="input-field" value="1.01" type="number" step="0.01" min="1">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Method</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="method-mathematic" name="orion-method" value="mathematic" ${bot.orionSettings.method === 'mathematic' ? 'checked' : ''}>
                                <label for="method-mathematic" class="radio-label">Mathematic</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="method-martingale" name="orion-method" value="martingale" ${bot.orionSettings.method === 'martingale' ? 'checked' : ''}>
                                <label for="method-martingale" class="radio-label">Martingale</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="martingale-multiplier" class="input-group" style="${bot.orionSettings.method === 'martingale' ? 'display: block;' : 'display: none;'}">
                        <label class="input-label">Martingale Multiplier</label>
                        <input id="p-martingale-mult" class="input-field" value="1.12" type="number" step="0.01" min="1.01" max="10">
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Rotation Settings</div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Wager Loss Threshold %</label>
                            <input id="s-wager-threshold" class="input-field" value="0.1" type="number" step="0.01" min="0.01" max="100">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Severe Loss Threshold %</label>
                            <input id="s-severe-threshold" class="input-field" value="1.0" type="number" step="0.01" min="0.01" max="100">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Min Switch Interval (sec)</label>
                            <input id="s-switch-interval" class="input-field" value="60" type="number" step="1" min="10" max="600">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Step Limit</label>
                            <input id="s-step-limit" class="input-field" value="10000" type="number" step="100" min="100" max="100000">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Currency</label>
                        <select id="p-currency" class="select-field"></select>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Wager Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mode-wager" ${bot.enabledModes.wager ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Labouchere Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mode-labouchere" ${bot.enabledModes.labouchere ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Orion Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="mode-orion" ${bot.enabledModes.orion ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Demo Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="p-demo-toggle" ${bot.isDemo ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Enable Turbo Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="p-turbo-toggle" ${bot.turboMode ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="grid-2" style="${bot.turboMode ? 'display: grid;' : 'display: none;'}" id="turbo-settings">
                        <div class="input-group">
                            <label class="input-label">Bet Delay (ms)</label>
                            <input id="turbo-delay" class="input-field" value="1" type="number" min="0" max="1000">
                        </div>
                        <div class="input-group">
                            <label class="input-label">UI Update (ms)</label>
                            <input id="turbo-ui-update" class="input-field" value="5000" type="number" min="100" max="30000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUPPORT TAB -->
            <div class="tab-content" id="tab-support">
                <div class="support-section">
                    <div class="section-title">Telegram Settings</div>
                    
                    <div class="toggle-group">
                        <span class="toggle-label">Enable Telegram Notifications</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="telegram-enable" ${CONFIG.telegram.enabled ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Bot Token</label>
                        <input id="telegram-token" class="input-field" type="text" value="${CONFIG.telegram.botToken}" placeholder="Bot Token">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Chat ID</label>
                        <input id="telegram-chatid" class="input-field" type="text" value="${CONFIG.telegram.chatId}" placeholder="Chat ID">
                    </div>
                    
                    <div class="grid-2">
                        <div class="input-group">
                            <label class="input-label">Report Interval (min)</label>
                            <input id="telegram-interval" class="input-field" type="number" value="30" min="1" max="1440">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Big Win Threshold %</label>
                            <input id="telegram-bigwin" class="input-field" type="number" value="0.1" step="0.01" min="0.01" max="100">
                        </div>
                    </div>
                    
                    <button id="telegram-test" class="telegram-test-btn">
                        <span>ğŸ“±</span> Test Telegram Connection
                    </button>
                </div>
                
                <div class="support-section">
                    <div class="section-title">Contact Support</div>
                    <p style="color: var(--gray); font-size: 13px; margin-bottom: 16px;">
                        For support, questions, or bug reports, contact us via Telegram:
                    </p>
                    <a href="https://t.me/orionlogic" target="_blank" class="support-link">
                        <span>ğŸ“±</span> t.me/orionlogic
                    </a>
                </div>
            </div>
        `;
        document.body.appendChild(d);

        // Initialize dashboard
        updateDashboard();

        // Event listeners
        function safeAddEventListener(element, event, handler) {
            if (element && typeof element.addEventListener === 'function') {
                element.addEventListener(event, handler);
            }
        }

        // Clear logs button
        const clearLogsBtn = document.getElementById('clear-logs');
        if (clearLogsBtn) {
            safeAddEventListener(clearLogsBtn, 'click', () => {
                const logBox = document.getElementById("p-logs");
                if (logBox) {
                    logBox.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 40px 0; font-style: italic;">Logs cleared</div>';
                }
                updateLogs(0, 0, 0, "Logs cleared", true);
            });
        }

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            safeAddEventListener(tab, 'click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabId = tab.dataset.tab;
                const content = document.getElementById(`tab-${tabId}`);
                if (content) content.classList.add('active');
            });
        });

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(btn => {
            safeAddEventListener(btn, 'click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const newMode = btn.dataset.mode;
                
                if (bot.isRunning) {
                    const oldMode = bot.mode;
                    bot.mode = newMode;
                    
                    if (newMode === 'wager') initWagerMode();
                    else if (newMode === 'labouchere') initLabouchere();
                    else if (newMode === 'orion') setNewBaseChance();
                    
                    updateLogs(0, 0, 0, `Mode changed from ${oldMode.toUpperCase()} to ${newMode.toUpperCase()}`, true);
                    
                    if (CONFIG.telegram.enabled) {
                        TelegramAPI.sendModeChange(oldMode, newMode, "Manual mode change");
                    }
                } else {
                    bot.mode = newMode;
                }
                
                // Show/hide martingale info
                const martingaleContainer = document.getElementById("martingale-info-container");
                if (martingaleContainer) {
                    if (bot.mode === 'orion' && bot.orionSettings.method === 'martingale') {
                        martingaleContainer.style.display = 'flex';
                    } else {
                        martingaleContainer.style.display = 'none';
                    }
                }
            });
        });

        // Currency dropdown
        const pCurrency = document.getElementById("p-currency");
        if (pCurrency) {
            const savedCurrency = localStorage.getItem('orion_selected_currency');
            if (savedCurrency) {
                bot.selectedCurrency = savedCurrency;
            }

            safeAddEventListener(pCurrency, 'change', (e) => {
                const newCurrency = e.target.value;
                bot.selectedCurrency = newCurrency;
                const stCurrency = document.getElementById("st-currency");
                if (stCurrency) stCurrency.textContent = newCurrency.toUpperCase();
                localStorage.setItem('orion_selected_currency', newCurrency);
            });
        }

        // Basebet mode radio buttons
        document.querySelectorAll('input[name="basebet-mode"]').forEach(radio => {
            safeAddEventListener(radio, 'change', (e) => {
                bot.wagerStats.basebetMode = e.target.value;
                const input = document.getElementById('w-basebet-input');
                const label = document.getElementById('basebet-label');
                if (input && label) {
                    if (e.target.value === 'percentage') {
                        input.value = bot.wagerStats.basebetPercentage;
                        input.step = '0.1';
                        input.min = '0.1';
                        input.max = '10';
                        label.textContent = 'Percentage %';
                    } else {
                        input.value = bot.wagerStats.basebetFixed.toFixed(8);
                        input.step = '0.00000001';
                        input.min = '0.00000001';
                        input.max = '';
                        label.textContent = 'Amount';
                    }
                }
            });
        });

        // Basebet input
        const wBasebetInput = document.getElementById('w-basebet-input');
        if (wBasebetInput) {
            safeAddEventListener(wBasebetInput, 'change', (e) => {
                const value = parseFloat(e.target.value) || 0;
                if (bot.wagerStats.basebetMode === 'percentage') {
                    bot.wagerStats.basebetPercentage = value;
                    if (value < 0.1) e.target.value = 0.1;
                    if (value > 10) e.target.value = 10;
                } else {
                    bot.wagerStats.basebetFixed = value;
                    if (value < 0.00000001) e.target.value = 0.00000001;
                    e.target.value = value.toFixed(8);
                }
            });
        }

        // Orion method radio buttons
        document.querySelectorAll('input[name="orion-method"]').forEach(radio => {
            safeAddEventListener(radio, 'change', (e) => {
                bot.orionSettings.method = e.target.value;
                const martingaleDiv = document.getElementById("martingale-multiplier");
                const martingaleContainer = document.getElementById("martingale-info-container");
                
                if (martingaleDiv) {
                    if (e.target.value === "martingale") {
                        martingaleDiv.style.display = "block";
                        if (martingaleContainer && bot.mode === 'orion') {
                            martingaleContainer.style.display = 'flex';
                        }
                    } else {
                        martingaleDiv.style.display = "none";
                        if (martingaleContainer) {
                            martingaleContainer.style.display = 'none';
                        }
                    }
                }
            });
        });

        // Martingale multiplier input
        const martingaleMult = document.getElementById('p-martingale-mult');
        if (martingaleMult) {
            safeAddEventListener(martingaleMult, 'change', (e) => {
                const value = parseFloat(e.target.value);
                if (value >= 1.01 && value <= 10) {
                    bot.orionSettings.martingaleMultiplier = value;
                } else {
                    e.target.value = 1.12;
                    bot.orionSettings.martingaleMultiplier = 1.12;
                }
            });
        }

        // Rotation settings
        const wagerThreshold = document.getElementById('s-wager-threshold');
        if (wagerThreshold) {
            safeAddEventListener(wagerThreshold, 'change', (e) => {
                const value = parseFloat(e.target.value) / 100; // Convert % to decimal
                if (value >= 0.0001 && value <= 1) {
                    bot.rotationState.wagerLossThreshold = value;
                }
            });
        }

        const severeThreshold = document.getElementById('s-severe-threshold');
        if (severeThreshold) {
            safeAddEventListener(severeThreshold, 'change', (e) => {
                const value = parseFloat(e.target.value) / 100; // Convert % to decimal
                if (value >= 0.0001 && value <= 1) {
                    bot.rotationState.severeLossThreshold = value;
                }
            });
        }

        const switchInterval = document.getElementById('s-switch-interval');
        if (switchInterval) {
            safeAddEventListener(switchInterval, 'change', (e) => {
                const value = parseFloat(e.target.value) * 1000; // Convert seconds to milliseconds
                if (value >= 10000 && value <= 600000) {
                    bot.rotationState.minSwitchInterval = value;
                }
            });
        }

        const stepLimit = document.getElementById('s-step-limit');
        if (stepLimit) {
            safeAddEventListener(stepLimit, 'change', (e) => {
                const value = parseInt(e.target.value);
                if (value >= 100 && value <= 100000) {
                    bot.rotationState.stepLimit = value;
                }
            });
        }

        // Telegram Settings
        const telegramEnable = document.getElementById('telegram-enable');
        if (telegramEnable) {
            safeAddEventListener(telegramEnable, 'change', (e) => {
                CONFIG.telegram.enabled = e.target.checked;
                const telegramStatus = document.querySelector('.telegram-status');
                if (telegramStatus) {
                    telegramStatus.className = `telegram-status ${CONFIG.telegram.enabled ? 'enabled' : 'disabled'}`;
                    telegramStatus.textContent = CONFIG.telegram.enabled ? 'ğŸ“± TG ON' : 'ğŸ“± TG OFF';
                }
            });
        }

        const telegramToken = document.getElementById('telegram-token');
        if (telegramToken) {
            safeAddEventListener(telegramToken, 'change', (e) => {
                CONFIG.telegram.botToken = e.target.value;
            });
        }

        const telegramChatId = document.getElementById('telegram-chatid');
        if (telegramChatId) {
            safeAddEventListener(telegramChatId, 'change', (e) => {
                CONFIG.telegram.chatId = e.target.value;
            });
        }

        const telegramInterval = document.getElementById('telegram-interval');
        if (telegramInterval) {
            safeAddEventListener(telegramInterval, 'change', (e) => {
                CONFIG.telegram.reportInterval = parseInt(e.target.value);
            });
        }

        const telegramBigwin = document.getElementById('telegram-bigwin');
        if (telegramBigwin) {
            safeAddEventListener(telegramBigwin, 'change', (e) => {
                CONFIG.telegram.bigWinThreshold = parseFloat(e.target.value) / 100;
            });
        }

        // Test Telegram button
        const telegramTest = document.getElementById('telegram-test');
        if (telegramTest) {
            safeAddEventListener(telegramTest, 'click', async () => {
                const testMessage = `ğŸ”” <b>ORION BOT TEST MESSAGE</b>\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `âœ… Telegram is working properly!\n` +
                    `ğŸ‘¤ User: <code>${bot.stakeUser}</code>\n` +
                    `ğŸ¤– Bot: <code>ORION v8.2</code>\n` +
                    `â° Time: ${new Date().toLocaleString()}\n` +
                    `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n` +
                    `ğŸ‰ If you see this message, Telegram notifications are configured correctly!`;

                try {
                    await TelegramAPI.sendMessage(testMessage);
                    updateLogs(0, 0, 0, "âœ… Telegram test message sent successfully!", true);
                } catch (error) {
                    updateLogs(0, 0, 0, `âŒ Telegram test failed: ${error.message}`, true);
                }
            });
        }

        // Mode toggles
        const modeWager = document.getElementById('mode-wager');
        if (modeWager) {
            safeAddEventListener(modeWager, 'change', (e) => {
                bot.enabledModes.wager = e.target.checked;
            });
        }

        const modeLabouchere = document.getElementById('mode-labouchere');
        if (modeLabouchere) {
            safeAddEventListener(modeLabouchere, 'change', (e) => {
                bot.enabledModes.labouchere = e.target.checked;
            });
        }

        const modeOrion = document.getElementById('mode-orion');
        if (modeOrion) {
            safeAddEventListener(modeOrion, 'change', (e) => {
                bot.enabledModes.orion = e.target.checked;
            });
        }

        // Turbo toggle
        const turboToggle = document.getElementById('p-turbo-toggle');
        if (turboToggle) {
            safeAddEventListener(turboToggle, 'change', (e) => {
                bot.turboMode = e.target.checked;
                const turboSettings = document.getElementById('turbo-settings');
                if (turboSettings) {
                    turboSettings.style.display = e.target.checked ? 'grid' : 'none';
                }
                const dashboardSpeed = document.getElementById('dashboard-speed');
                if (dashboardSpeed) dashboardSpeed.textContent = bot.turboMode ? 'TURBO' : 'NORMAL';
                updateStatsInterval();
                updateLogs(0, 0, 0, `Turbo Mode ${bot.turboMode ? 'ENABLED ğŸš€' : 'DISABLED'}`, true);
            });
        }

        // Demo mode toggle
        const demoToggle = document.getElementById('p-demo-toggle');
        if (demoToggle) {
            safeAddEventListener(demoToggle, 'change', (e) => {
                bot.isDemo = e.target.checked;
                updateLogs(0, 0, 0, `Demo Mode ${bot.isDemo ? 'ENABLED' : 'DISABLED'}`, true);
            });
        }

        // Start button
        const pStart = document.getElementById("p-start");
        if (pStart) {
            pStart.onclick = async () => {
                if (bot.isRunning) return;

                // Check license
                if (!CONFIG.license.isValid() && !bot.isDemo) {
                    alert(`License has expired! Please renew your license.\nExpiry Date: ${CONFIG.license.expiryDate.toLocaleDateString()}`);
                    return;
                }

                if (!bot.isDemo) {
                    try {
                        bot.token = localStorage.getItem('apitoken') || (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
                        const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "x-access-token": bot.token
                            },
                            body: JSON.stringify({
                                query: `query{user{name balances{available{amount currency}}}}`
                            })
                        });
                        const json = await res.json();
                        if (json?.data?.user) {
                            bot.stakeUser = json.data.user.name;
                            const dashboardAccount = document.getElementById("dashboard-account");
                            if (dashboardAccount) dashboardAccount.textContent = bot.stakeUser;

                            const bals = json.data.user.balances || [];
                            const sel = document.getElementById("p-currency");
                            if (sel) {
                                const currentSelection = sel.value;
                                sel.innerHTML = '';

                                bals.forEach(b => {
                                    const currency = b.available.currency.toLowerCase();
                                    const opt = new Option(currency.toUpperCase(), currency);
                                    sel.add(opt);
                                });

                                const availableCurrencies = bals.map(b => b.available.currency.toLowerCase());
                                if (availableCurrencies.includes(currentSelection)) {
                                    sel.value = currentSelection;
                                    bot.selectedCurrency = currentSelection;
                                } else if (availableCurrencies.includes('doge')) {
                                    sel.value = 'doge';
                                    bot.selectedCurrency = 'doge';
                                } else if (bals.length > 0) {
                                    sel.value = bals[0].available.currency.toLowerCase();
                                    bot.selectedCurrency = sel.value;
                                }
                            }
                        }
                    } catch (e) {
                        console.log("Sync error:", e);
                    }
                }

                bot.isRunning = true;
                bot.isPaused = false;

                const startBtn = document.getElementById("p-start");
                if (startBtn) {
                    startBtn.innerHTML = 'âš¡ RUNNING';
                    startBtn.classList.remove('btn-start');
                    startBtn.classList.add('btn-success');
                }

                // Reset stats
                bot.stats = {
                    profit: 0, wagered: 0, startBal: 0, currentBal: 0,
                    bets: 0, wins: 0, loss: 0, startTime: Date.now(),
                    maxDD: 0, maxDDPerc: 0, lastBigWinTime: 0,
                    currentStreak: 0, maxWinStreak: 0, maxLossStreak: 0,
                    lastResult: null
                };

                if (!bot.isDemo) {
                    bot.stats.startBal = await API.getBalance(bot.selectedCurrency);
                } else {
                    bot.stats.startBal = 100.0;
                }

                bot.stats.currentBal = bot.stats.startBal;
                bot.rotationState.initialBalance = bot.stats.startBal;
                bot.rotationState.lastSwitchTime = Date.now();
                bot.mode = determineStartingMode();

                // Update mode selector
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.mode === bot.mode) {
                        btn.classList.add('active');
                    }
                });

                const targetPct = document.getElementById("p-target-pct");
                const stopPct = document.getElementById("p-stop-pct");
                if (targetPct && stopPct) {
                    bot.targetAbs = bot.stats.startBal * (parseFloat(targetPct.value) / 100);
                    bot.stopLossAbs = bot.stats.startBal * (parseFloat(stopPct.value) / 100);
                }

                bot.perStep = bot.targetAbs / bot.rotationState.stepLimit;

                // Initialize selected mode
                if (bot.mode === 'wager') initWagerMode();
                else if (bot.mode === 'labouchere') initLabouchere();
                else if (bot.mode === 'orion') setNewBaseChance();

                // Show/hide martingale info
                const martingaleContainer = document.getElementById("martingale-info-container");
                if (martingaleContainer) {
                    if (bot.mode === 'orion' && bot.orionSettings.method === 'martingale') {
                        martingaleContainer.style.display = 'flex';
                    } else {
                        martingaleContainer.style.display = 'none';
                    }
                }

                updateStatsInterval();
                updateDashboard();
                updateLogs(0, 0, 0, `Started in ${bot.mode.toUpperCase()} mode. Balance: ${bot.stats.startBal.toFixed(8)} (${bot.selectedCurrency.toUpperCase()})`, true);
                
                if (CONFIG.telegram.enabled && CONFIG.telegram.sendOnStart) {
                    TelegramAPI.sendStartReport();
                }
                
                runLoop();
            };
        }

        // Pause button
        const pPause = document.getElementById("p-pause");
        if (pPause) {
            pPause.onclick = () => {
                if (!bot.isRunning) return;
                bot.isPaused = !bot.isPaused;
                const pauseBtn = document.getElementById("p-pause");
                if (pauseBtn) {
                    if (bot.isPaused) {
                        pauseBtn.innerHTML = 'â–¶ RESUME';
                        pauseBtn.classList.remove('btn-pause');
                        pauseBtn.classList.add('btn-success');
                        updateLogs(0, 0, 0, "Bot PAUSED", true);
                    } else {
                        pauseBtn.innerHTML = 'â¸ PAUSE';
                        pauseBtn.classList.remove('btn-success');
                        pauseBtn.classList.add('btn-pause');
                        updateLogs(0, 0, 0, "Bot RESUMED", true);
                        runLoop();
                    }
                }
            };
        }

        // Stop button
        const pStop = document.getElementById("p-stop");
        if (pStop) {
            pStop.onclick = () => {
                bot.isRunning = false;
                bot.isPaused = false;
                const startBtn = document.getElementById("p-start");
                if (startBtn) {
                    startBtn.innerHTML = 'â–¶ START';
                    startBtn.classList.remove('btn-success');
                    startBtn.classList.add('btn-start');
                }
                if (statsInterval) clearInterval(statsInterval);
                updateLogs(0, 0, 0, "Bot STOPPED", true);
                
                if (CONFIG.telegram.enabled && CONFIG.telegram.sendOnStop) {
                    TelegramAPI.sendStopReport("Manual Stop");
                }
            };
        }

        // Turbo button
        const pTurbo = document.getElementById("p-turbo");
        if (pTurbo) {
            pTurbo.onclick = () => {
                bot.turboMode = !bot.turboMode;
                const turboToggle = document.getElementById('p-turbo-toggle');
                if (turboToggle) turboToggle.checked = bot.turboMode;
                const turboSettings = document.getElementById('turbo-settings');
                if (turboSettings) {
                    turboSettings.style.display = bot.turboMode ? 'grid' : 'none';
                }
                const dashboardSpeed = document.getElementById('dashboard-speed');
                if (dashboardSpeed) dashboardSpeed.textContent = bot.turboMode ? 'TURBO' : 'NORMAL';
                updateStatsInterval();
                updateLogs(0, 0, 0, `Turbo Mode ${bot.turboMode ? 'ENABLED ğŸš€' : 'DISABLED'}`, true);
            };
        }

        // Control buttons
        const minimizeBtn = document.querySelector('.control-btn.minimize');
        if (minimizeBtn) {
            safeAddEventListener(minimizeBtn, 'click', () => {
                bot.minimized = !bot.minimized;
                const content = document.querySelectorAll('.tab-content');
                if (bot.minimized) {
                    content.forEach(el => el.style.display = 'none');
                    updateLogs(0, 0, 0, "Bot minimized - Running in background", true);
                } else {
                    content.forEach(el => {
                        if (el.classList.contains('active')) {
                            el.style.display = 'flex';
                        }
                    });
                }
            });
        }

        const closeBtn = document.querySelector('.control-btn.close');
        if (closeBtn) {
            safeAddEventListener(closeBtn, 'click', () => {
                if (bot.isRunning) {
                    if (confirm("Bot is still running. Are you sure you want to close?")) {
                        document.getElementById("orion-wrap").remove();
                    }
                } else {
                    document.getElementById("orion-wrap").remove();
                }
            });
        }

        // Initialize chance levels
        function renderChanceLevels() {
            const container = document.getElementById("chance-levels-grid");
            if (!container) return;
            container.innerHTML = '';
            bot.labouchere.chanceLevels.forEach((level, index) => {
                const levelCard = document.createElement("div");
                levelCard.className = `chance-level-card ${bot.labouchere.currentLs === level.ls ? 'active' : ''}`;
                levelCard.innerHTML = `
                    <div class="chance-level-label">LS${level.ls}</div>
                    <div class="chance-level-range">${level.chanceMin}%-${level.chanceMax}%</div>
                `;
                container.appendChild(levelCard);
            });
        }

        // Initialize UI
        updateStatsInterval();
        renderChanceLevels();
        setTimeout(() => API.syncOnce(), 500);
        
        // Initial dashboard update
        updateDashboard();
    }

    // Initialize UI
    try {
        createUI();
    } catch (error) {
        console.error("Error initializing UI:", error);
        setTimeout(() => {
            try {
                createUI();
            } catch (e) {
                console.error("Failed to initialize UI after retry:", e);
            }
        }, 1000);
    }
})();

(function () {
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/_api'; },
        version: "ORION PRO v6.0 TRADER EDITION",
        tgToken: '8391763291:AAEA05v6FG70eM1WGrgU7mrPgckfjQaxkno',
        tgChatId: '-1003744641395',
        supportContact: '@OrionLogic',
        quickChartUrl: 'https://quickchart.io/chart'
    };

    // ==================== WHITELIST SYSTEM ====================
    const WHITELIST = {
        "orionlogic": { tier: "VIP", expiry: "2099-12-31" },
        "biele": { tier: "PREMIUM", expiry: "2026-02-26" },
        "siska82": { tier: "PREMIUM", expiry: "2026-02-26" },
        "dfransiska": { tier: "PREMIUM", expiry: "2026-02-26" },
        "brokenpips": { tier: "PREMIUM", expiry: "2026-02-26" },
        "aynus": { tier: "PREMIUM", expiry: "2026-02-26" },
        "terbaik444": { tier: "PREMIUM", expiry: "2026-01-30" },
        "k4pitiang": { tier: "PREMIUM", expiry: "2026-02-26" }
    };

    // ==================== LICENSE VALIDATION ====================
    let currentUser = null;
    let licenseData = null;
    let userExpiry = "";

    async function validateLicense() {
        try {
            const token = localStorage.getItem('apitoken') || 
                         (document.cookie.match(/session=([^;]+)/) ? 
                          document.cookie.match(/session=([^;]+)/)[1] : null);

            if (!token) {
                showLicenseModal("Please login to Stake.com first");
                return false;
            }

            const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "x-access-token": token 
                },
                body: JSON.stringify({ query: `query{user{name}}` })
            });

            const data = await response.json();
            const username = data?.data?.user?.name?.toLowerCase();

            if (!username) {
                showLicenseModal("Cannot retrieve username");
                return false;
            }

            currentUser = username;
            licenseData = WHITELIST[username];
            
            if (!licenseData) {
                showLicenseModal(
                    `Username <strong>${username}</strong> is not whitelisted.`, 
                    true
                );
                return false;
            }

            const expiryDate = new Date(licenseData.expiry);
            if (new Date() > expiryDate) {
                showLicenseModal(
                    `License expired on ${expiryDate.toLocaleDateString()}.`, 
                    true
                );
                return false;
            }

            userExpiry = expiryDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            console.log(`âœ… License validated: ${username} (${licenseData.tier}) - Expires: ${userExpiry}`);
            
            await sendTelegramReport("load");
            
            return true;

        } catch (error) {
            console.error("License validation error:", error);
            showLicenseModal("Connection error. Please refresh.");
            return false;
        }
    }

    function showLicenseModal(message, showContact = false) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            font-family: 'Inter', sans-serif;
        `;
        
        modal.innerHTML = `
            <div style="background: #1C2128; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; border: 1px solid #30363D;">
                <h2 style="color: #F0F6FC; margin-bottom: 20px; text-align: center;">ðŸ”’ License Required</h2>
                <div style="color: #8B949E; margin-bottom: 25px; text-align: center;">${message}</div>
                ${showContact ? `
                    <div style="background: #161B22; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363D;">
                        <div style="color: #58A6FF; font-weight: 600; margin-bottom: 5px;">Contact Support:</div>
                        <div style="color: #8B949E;">${CONFIG.supportContact}</div>
                    </div>
                ` : ''}
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: #1F6FEB; color: white; border: none; padding: 12px 24px; 
                               border-radius: 6px; width: 100%; cursor: pointer; font-weight: 600;">
                    Close
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // ==================== TRADING MODE FUNCTIONS ====================
    function rotateMode(mode) {
        bot.mode = mode;
        
        switch(mode) {
            case "BASE":
                rotateToBaseMode();
                updateStatus("ðŸ—ï¸ BASE MODE", "#6366F1");
                updateLogs(0, 0, "SYSTEM", 0, "Switched to BASE mode");
                break;
                
            case "WAGER":
                rotateToWagerMode();
                updateStatus("âš¡ WAGER MODE", "#8B5CF6");
                updateLogs(0, 0, "SYSTEM", 0, "Switched to WAGER mode");
                break;
                
            case "FLIP":
                bot.currentGame = "FLIP";
                updateStatus("ðŸ”„ FLIP MODE", "#F59E0B");
                updateLogs(0, 0, "SYSTEM", 0, "Switched to FLIP mode");
                break;
                
            default:
                console.warn(`Unknown mode: ${mode}`);
        }
    }

    function rotateToBaseMode() {
        bot.mode = "BASE";
        bot.currentGame = "DICE";
        
        // Reset base mode variables
        bot.base.ls = 0;
        bot.base.lc = 0;
        bot.base.bcount = 0;
        bot.base.partialProfit = 0;
        
        // Calculate initial parameters
        calculateBaseBet();
        updateStatus("ðŸ—ï¸ BASE MODE", "#6366F1");
    }

    function rotateToWagerMode() {
        bot.mode = "WAGER";
        bot.currentGame = "DICE";
        
        // Reset wager mode variables
        bot.wgr.ctwin = 0;
        bot.wgr.profitc = 0;
        bot.wgr.betload = 0;
        bot.wgr.balhigh = bot.stats.currentBal;
        
        // Calculate initial parameters
        calculateWagerBet();
        updateStatus("âš¡ WAGER MODE", "#8B5CF6");
    }

    function calculateBaseBet() {
        const baseBet = getVal("p-basebet") || 0.00000100;
        let betAmount = baseBet;
        
        // Apply progressive betting if enabled
        if (getVal("p-base-progressive")) {
            const multiplier = Math.pow(getVal("p-base-multiplier") || 1.5, bot.base.lc);
            betAmount = baseBet * multiplier;
        }
        
        // Apply loss streak recovery
        if (bot.base.lc > 0 && getVal("p-base-recovery")) {
            const recoveryMultiplier = 1 + (bot.base.lc * (getVal("p-base-recovery-multiplier") || 0.1));
            betAmount = baseBet * recoveryMultiplier;
        }
        
        // Apply risk management
        const maxBetPercent = getVal("p-max-bet-pct") || 5;
        const maxBetAmount = bot.stats.currentBal * (maxBetPercent / 100);
        betAmount = Math.min(betAmount, maxBetAmount);
        
        // Set minimum bet
        const minBet = getVal("p-minbet") || 0.00000001;
        bot.nextBet = Math.max(betAmount, minBet);
        
        // Calculate chance
        if (bot.base.lc >= (getVal("p-base-loss-threshold") || 3) || getVal("p-base-aggressive")) {
            // Use lower chance for recovery/aggressive
            bot.currentChance = getRandomChance(
                getVal("p-hch-min") || 25.0,
                getVal("p-hch-max") || 35.0
            );
        } else {
            // Use base chance
            bot.currentChance = getRandomChance(
                getVal("p-bch-min") || 85.0,
                getVal("p-bch-max") || 90.0
            );
        }
        
        bot.currentMulti = 100 / bot.currentChance;
    }

    function calculateWagerBet() {
        const baseBet = getVal("p-basebet") || 0.00000100;
        
        // Calculate bet based on wager strategy
        let betAmount = baseBet;
        
        // Dynamic bet sizing based on win streak
        if (bot.wgr.ctwin > 0) {
            const winMultiplier = Math.pow(getVal("p-wgr-win-multiplier") || 1.2, bot.wgr.ctwin);
            betAmount = baseBet * winMultiplier;
        }
        
        // Apply profit-based bet sizing
        const profitPercent = (bot.wgr.profitc / bot.wgr.balhigh) * 100;
        if (profitPercent > (getVal("p-wgr-profit-threshold") || 10)) {
            betAmount *= getVal("p-wgr-profit-multiplier") || 1.5;
        }
        
        // Apply risk management
        const maxBetPercent = getVal("p-max-bet-pct") || 5;
        const maxBetAmount = bot.stats.currentBal * (maxBetPercent / 100);
        betAmount = Math.min(betAmount, maxBetAmount);
        
        // Set minimum bet
        const minBet = getVal("p-minbet") || 0.00000001;
        bot.nextBet = Math.max(betAmount, minBet);
        
        // Calculate chance for wager mode (usually higher chance)
        bot.currentChance = getVal("p-wgr-chance") || 99.5;
        bot.currentMulti = 100 / bot.currentChance;
    }

    function getRandomChance(min, max) {
        return parseFloat((Math.random() * (max - min) + min).toFixed(1));
    }

    function handleBaseMode(win) {
        if (win) {
            bot.base.lc = 0;
            bot.base.ls = 0;
            bot.base.partialProfit += bot.nextBet * (bot.currentMulti - 1);
            bot.base.bcount++;
            
            // Check if should take profit
            const targetProfit = bot.stats.sessionStartBal * (getVal("p-base-take-profit") || 0.1);
            if (bot.base.partialProfit >= targetProfit) {
                bot.base.partialProfit = 0;
                bot.base.bcount = 0;
                // Optional: Switch to WAGER mode for profit taking
                if (getVal("p-auto-switch-wager")) {
                    rotateMode("WAGER");
                }
            }
            
            // Reset bet to base after win
            if (bot.base.bcount >= (getVal("p-base-reset-after") || 3)) {
                bot.base.bcount = 0;
                calculateBaseBet();
            } else {
                calculateBaseBet();
            }
        } else {
            bot.base.lc++;
            bot.base.ls += bot.nextBet;
            
            // Check loss threshold
            if (bot.base.lc >= (getVal("p-base-max-losses") || 5)) {
                // Switch to recovery or WAGER mode
                if (getVal("p-auto-recovery")) {
                    checkRecoveryTrigger();
                } else {
                    rotateMode("WAGER");
                }
            } else {
                calculateBaseBet();
            }
        }
    }

    function handleWagerMode(win) {
        if (win) {
            bot.wgr.ctwin++;
            bot.wgr.profitc += bot.nextBet * (bot.currentMulti - 1);
            
            // Update balance high
            if (bot.stats.currentBal > bot.wgr.balhigh) {
                bot.wgr.balhigh = bot.stats.currentBal;
            }
            
            // Check win streak target
            if (bot.wgr.ctwin >= (getVal("p-wgr-win-target") || 5)) {
                // Reset after achieving target
                bot.wgr.ctwin = 0;
                bot.wgr.profitc = 0;
                
                // Switch back to BASE mode
                rotateMode("BASE");
            } else {
                calculateWagerBet();
            }
        } else {
            bot.wgr.ctwin = 0;
            bot.wgr.betload += bot.nextBet;
            
            // Check stop loss
            if (bot.wgr.betload >= (bot.wgr.balhigh * (getVal("p-wgr-stoploss") || 0.1))) {
                bot.wgr.betload = 0;
                bot.wgr.profitc = 0;
                
                // Switch to recovery or BASE mode
                if (getVal("p-auto-recovery")) {
                    checkRecoveryTrigger();
                } else {
                    rotateMode("BASE");
                }
            } else {
                calculateWagerBet();
            }
        }
    }

    function checkRecoveryTrigger() {
        if (FlipRecovery.isActive) return;
        
        const lossThreshold = getVal("p-recovery-threshold") || -1.5;
        const currentLossPct = (bot.stats.sessionProfit / bot.stats.sessionStartBal) * 100;
        
        if (currentLossPct <= lossThreshold) {
            // Start flip recovery
            const originalMode = bot.mode;
            const originalProfit = bot.stats.sessionProfit;
            
            updateStatus("ðŸ”„ RECOVERY STARTING...", "#F59E0B");
            updateLogs(0, 0, "SYSTEM", 0, 
                `Recovery triggered at ${currentLossPct.toFixed(1)}% loss. Switching to FLIP recovery.`);
            
            // Initialize recovery
            FlipRecovery.initialize(originalMode, originalProfit);
            
            // Switch to FLIP mode
            bot.currentGame = "FLIP";
            
            // Send notification
            sendTelegramReport("recovery_started");
        }
    }

    function switchGame(gameType) {
        if (bot.currentGame === gameType) return;
        
        bot.currentGame = gameType;
        
        switch(gameType) {
            case "DICE":
                updateStatus("ðŸŽ² DICE MODE", "#6366F1");
                updateLogs(0, 0, "SYSTEM", 0, "Switched to DICE game");
                break;
                
            case "FLIP":
                updateStatus("ðŸ”„ FLIP MODE", "#F59E0B");
                updateLogs(0, 0, "SYSTEM", 0, "Switched to FLIP game");
                break;
                
            default:
                console.warn(`Unknown game type: ${gameType}`);
        }
    }

    function forceFlipSide(side) {
        if (!FlipRecovery.isActive) {
            updateLogs(0, 0, "ERROR", 0, "Flip recovery not active");
            return;
        }
        
        const success = FlipRecovery.forceSide(side);
        if (success) {
            updateLogs(0, 0, "SYSTEM", 0, `Manual side change to ${side.toUpperCase()}`);
        }
    }

    async function forceCashout() {
        if (FlipRecovery.isActive) {
            FlipRecovery.forceCashout();
        } else {
            // For regular games, you might implement different cashout logic
            updateLogs(0, 0, "SYSTEM", 0, "Manual cashout requested");
        }
    }

    function getVal(id) {
        const el = document.getElementById(id);
        if (!el) return null;
        
        if (el.type === 'checkbox') {
            return el.checked;
        }
        
        const value = parseFloat(el.value);
        return isNaN(value) ? el.value : value;
    }

    function updateStatus(text, color) {
        const statusEl = document.getElementById('trade-status');
        if (statusEl) {
            statusEl.textContent = text;
            statusEl.style.color = color;
        }
    }

    function updateLogs(amount, chance, mode, profit, note) {
        const logBody = document.getElementById("p-log-body");
        if (!logBody) return;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const profitClass = profit >= 0 ? "positive" : "negative";
        const profitText = profit >= 0 ? `+${profit.toFixed(8)}` : profit.toFixed(8);
        
        const logRow = document.createElement("div");
        logRow.className = "log-row";
        logRow.innerHTML = `
            <span style="color: var(--text-muted);">${time}</span>
            <span>${amount.toFixed(8)}</span>
            <span>${chance.toFixed(1)}%</span>
            <span>${mode}</span>
            <span class="${profitClass}">${profitText}</span>
            <span>${note}</span>
        `;
        
        logBody.insertBefore(logRow, logBody.firstChild);
        
        // Keep only last 50 logs
        if (logBody.children.length > 50) {
            logBody.removeChild(logBody.lastChild);
        }
    }

    // ==================== ENHANCED FLIP RECOVERY SYSTEM ====================
    const FlipRecovery = {
        isActive: false,
        originalMode: null,
        originalProfit: 0,
        startBalance: 0,
        startTime: null,
        activeGameId: null,
        canContinue: false,
        
        // Multi-level recovery
        recoveryLevel: 1,
        maxLevels: 3,
        
        // Enhanced Labouchre System with martingale option
        sequence: [1, 2, 3],
        baseBet: 0.00000100,
        flipsCompleted: 0,
        maxFlips: 100,
        
        // Advanced Pattern Tracking
        pattern: [], // Last 20 results for better analysis
        patternAnalysis: "",
        currentSide: "heads",
        sideMode: "auto",
        
        // Win/Lose Streak Analysis
        winStreak: 0,
        loseStreak: 0,
        maxWinStreak: 0,
        maxLoseStreak: 0,
        
        // Trade Statistics
        stats: {
            totalRecoveries: 0,
            successfulRecoveries: 0,
            failedRecoveries: 0,
            totalRecovered: 0,
            totalTime: 0,
            totalFlips: 0,
            winRate: 0,
            profitFactor: 0,
            sharpeRatio: 0
        },
        
        // Trading Decisions
        tradingDecision: "HOLD", // HOLD, CASHOUT, CONTINUE, SWITCH_SIDE
        confidenceLevel: 0, // 0-100%
        
        // Chart History
        profitHistory: [],
        balanceHistory: [],
        equityCurve: [],
        
        // Initialize recovery
        initialize(originalMode, currentProfit) {
            this.isActive = true;
            this.recoveryLevel = 1;
            this.originalMode = originalMode;
            this.originalProfit = currentProfit;
            this.startBalance = bot.stats.currentBal;
            this.startTime = Date.now();
            this.flipsCompleted = 0;
            this.pattern = [];
            this.profitHistory = [];
            this.balanceHistory = [];
            this.equityCurve = [];
            this.activeGameId = null;
            this.canContinue = false;
            
            // Get settings
            this.baseBet = getVal("p-flip-basebet") || 0.00000100;
            this.sideMode = getVal("p-flip-side-mode") || "auto";
            
            // Initialize sequence based on level
            this.sequence = this.getInitialSequence(1);
            
            // Determine initial side with advanced analysis
            this.currentSide = this.determineInitialSide();
            
            // Add to history
            this.addTradeToHistory(0, currentProfit, "START");
            
            this.stats.totalRecoveries++;
            
            console.log(`ðŸ“Š FLIP RECOVERY STARTED - Level ${this.recoveryLevel}`);
            console.log(`   Strategy: ${this.getStrategyName()}`);
            console.log(`   Sequence: [${this.sequence}] | Side: ${this.currentSide} (${this.sideMode})`);
            console.log(`   Base Bet: ${this.baseBet} | Target: ${Math.abs(currentProfit).toFixed(8)}`);
            
            updateStatus(`ðŸ“Š FLIP RECOVERY L${this.recoveryLevel}`, "#F59E0B");
            updateLogs(0, 0, "TRADING", 0, 
                `Recovery started | Target: ${Math.abs(currentProfit).toFixed(8)} | Strategy: ${this.getStrategyName()}`);
            
            return true;
        },
        
        // Get sequence based on level
        getInitialSequence(level) {
            switch(level) {
                case 1: return [1, 2, 3];    // Standard Labouchre
                case 2: return [1, 1, 1];    // Conservative Martingale
                case 3: return [2, 3, 4];    // Aggressive Martingale
                default: return [1, 2, 3];
            }
        },
        
        // Get strategy name
        getStrategyName() {
            switch(this.recoveryLevel) {
                case 1: return "Labouchre Standard";
                case 2: return "Martingale Conservative";
                case 3: return "Martingale Aggressive";
                default: return "Custom Strategy";
            }
        },
        
        // Advanced side determination
        determineInitialSide() {
            switch(this.sideMode) {
                case "heads": return "heads";
                case "tails": return "tails";
                case "manual": return getVal("p-flip-manual-side") || "heads";
                case "auto":
                default:
                    return this.analyzeMarketForSide() || 
                          (Math.random() > 0.5 ? "heads" : "tails");
            }
        },
        
        // Advanced market analysis
        analyzeMarketForSide() {
            if (this.pattern.length < 5) return null;
            
            // Technical Analysis
            const recentPattern = this.pattern.slice(0, 10);
            const wins = recentPattern.filter(r => r.win).length;
            const losses = recentPattern.length - wins;
            
            // RSI-like calculation
            const avgWin = wins > 0 ? recentPattern.filter(r => r.win).reduce((a, b) => a + b.profit, 0) / wins : 0;
            const avgLoss = losses > 0 ? Math.abs(recentPattern.filter(r => !r.win).reduce((a, b) => a + b.profit, 0) / losses) : 0;
            
            // Simple RSI
            const rs = avgWin / (avgLoss || 1);
            const rsi = 100 - (100 / (1 + rs));
            
            // If market is overbought/oversold, consider switching
            if (rsi > 70 && this.currentSide === "heads") {
                return "tails"; // Overbought, switch to tails
            } else if (rsi < 30 && this.currentSide === "tails") {
                return "heads"; // Oversold, switch to heads
            }
            
            // Pattern recognition
            const lastFive = this.pattern.slice(0, 5);
            const lossCount = lastFive.filter(r => !r.win).length;
            
            // If 4/5 are losses, high probability of reversal
            if (lossCount >= 4) {
                return this.currentSide === "heads" ? "tails" : "heads";
            }
            
            return null;
        },
        
        // Get next bet amount with risk management
        getNextBet() {
            if (this.sequence.length === 0) return this.baseBet;
            
            let betAmount;
            
            switch(this.recoveryLevel) {
                case 1: // Labouchre
                    if (this.sequence.length >= 2) {
                        betAmount = this.baseBet * (this.sequence[0] + this.sequence[this.sequence.length - 1]);
                    } else {
                        betAmount = this.baseBet * this.sequence[0];
                    }
                    break;
                    
                case 2: // Conservative Martingale
                    betAmount = this.baseBet * Math.pow(2, this.loseStreak);
                    break;
                    
                case 3: // Aggressive Martingale
                    betAmount = this.baseBet * Math.pow(2.5, this.loseStreak);
                    break;
                    
                default:
                    betAmount = this.baseBet;
            }
            
            // Risk management: Max 5% of balance
            const maxRisk = bot.stats.currentBal * 0.05;
            return Math.min(betAmount, maxRisk);
        },
        
        getProgress() {
            const target = Math.abs(this.originalProfit);
            const current = Math.abs(bot.stats.sessionProfit - this.originalProfit);
            return (current / target) * 100;
        },
        
        // Advanced trade analysis
        analyzeTrade(win, profit, gameData) {
            this.flipsCompleted++;
            this.stats.totalFlips++;
            
            // Update streaks
            if (win) {
                this.winStreak++;
                this.loseStreak = 0;
                if (this.winStreak > this.maxWinStreak) {
                    this.maxWinStreak = this.winStreak;
                }
            } else {
                this.loseStreak++;
                this.winStreak = 0;
                if (this.loseStreak > this.maxLoseStreak) {
                    this.maxLoseStreak = this.loseStreak;
                }
            }
            
            // Add to pattern
            this.pattern.unshift({
                win: win,
                side: this.currentSide,
                bet: this.getNextBet(),
                profit: profit,
                time: Date.now(),
                gameId: gameData?.id,
                multiplier: gameData?.payoutMultiplier || 1.96
            });
            
            // Keep last 20 trades for analysis
            if (this.pattern.length > 20) {
                this.pattern.pop();
            }
            
            // Add to history
            this.addTradeToHistory(this.getNextBet(), profit, win ? "WIN" : "LOSS");
            
            // Update statistics
            this.updateStatistics();
            
            // Make trading decision
            this.makeTradingDecision(win, profit, gameData);
            
            return {
                win: win,
                profit: profit,
                decision: this.tradingDecision,
                confidence: this.confidenceLevel,
                nextBet: this.getNextBet(),
                sequence: [...this.sequence]
            };
        },
        
        // Update trading statistics
        updateStatistics() {
            if (this.pattern.length === 0) return;
            
            const totalTrades = this.pattern.length;
            const winningTrades = this.pattern.filter(t => t.win).length;
            const losingTrades = totalTrades - winningTrades;
            
            // Win Rate
            this.stats.winRate = (winningTrades / totalTrades) * 100;
            
            // Profit Factor
            const grossProfit = this.pattern.filter(t => t.win).reduce((sum, t) => sum + t.profit, 0);
            const grossLoss = Math.abs(this.pattern.filter(t => !t.win).reduce((sum, t) => sum + t.profit, 0));
            this.stats.profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit;
            
            // Sharpe Ratio (simplified)
            const returns = this.pattern.map(t => t.profit);
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const stdDev = Math.sqrt(returns.reduce((sq, n) => sq + Math.pow(n - avgReturn, 2), 0) / returns.length);
            this.stats.sharpeRatio = stdDev > 0 ? avgReturn / stdDev : 0;
        },
        
        // Make trading decision
        makeTradingDecision(win, profit, gameData) {
            let decision = "HOLD";
            let confidence = 50;
            
            if (!win) {
                // After loss
                decision = "CONTINUE";
                confidence = 70;
                
                // If too many consecutive losses
                if (this.loseStreak >= 3) {
                    decision = "SWITCH_SIDE";
                    confidence = 85;
                }
                
            } else {
                // After win
                if (gameData?.active) {
                    // Game still active, we can continue or cashout
                    const currentProfit = bot.stats.sessionProfit;
                    const recoveryTarget = Math.abs(this.originalProfit);
                    const progress = (currentProfit / recoveryTarget) * 100;
                    
                    if (progress >= 80) {
                        // Close to target, cashout
                        decision = "CASHOUT";
                        confidence = 90;
                    } else if (this.winStreak >= 3) {
                        // Winning streak, cashout to secure profits
                        decision = "CASHOUT";
                        confidence = 75;
                    } else {
                        // Continue for more profit
                        decision = "CONTINUE";
                        confidence = 60;
                    }
                } else {
                    // Game ended (win on last round)
                    decision = "NEW_TRADE";
                    confidence = 80;
                }
            }
            
            this.tradingDecision = decision;
            this.confidenceLevel = confidence;
            
            return { decision, confidence };
        },
        
        // Handle trade result
        handleTradeResult(analysis) {
            const { win, profit, decision } = analysis;
            
            if (win) {
                return this.handleWin(decision);
            } else {
                return this.handleLoss(decision);
            }
        },
        
        // Handle win
        handleWin(decision) {
            console.log(`âœ… WIN | Decision: ${decision} | Confidence: ${this.confidenceLevel}%`);
            
            switch(decision) {
                case "CASHOUT":
                    // Cashout and complete level
                    return this.completeLevel(true, "CASHOUT_PROFIT");
                    
                case "CONTINUE":
                    // Continue with next round
                    if (this.sequence.length >= 2) {
                        this.sequence.shift();
                        this.sequence.pop();
                    } else {
                        this.sequence.shift();
                    }
                    return { complete: false, action: "CONTINUE", gameActive: true };
                    
                case "NEW_TRADE":
                    // Start new trade (sequence already updated in win handling)
                    if (this.sequence.length === 0) {
                        return this.completeLevel(true, "SEQUENCE_COMPLETE");
                    }
                    return { complete: false, action: "NEW_TRADE", gameActive: false };
                    
                default:
                    // Default win handling
                    if (this.sequence.length >= 2) {
                        this.sequence.shift();
                        this.sequence.pop();
                    } else {
                        this.sequence.shift();
                    }
                    
                    if (this.sequence.length === 0) {
                        return this.completeLevel(true, "SEQUENCE_COMPLETE");
                    }
                    
                    return { complete: false, action: "CONTINUE", gameActive: false };
            }
        },
        
        // Handle loss
        handleLoss(decision) {
            console.log(`âŒ LOSS | Decision: ${decision} | Confidence: ${this.confidenceLevel}%`);
            
            switch(decision) {
                case "SWITCH_SIDE":
                    // Switch side for next trade
                    const oldSide = this.currentSide;
                    this.currentSide = this.currentSide === "heads" ? "tails" : "heads";
                    console.log(`ðŸ”„ Side switched: ${oldSide} â†’ ${this.currentSide}`);
                    updateLogs(0, 0, "TRADING", 0, 
                        `Side switch: ${oldSide.toUpperCase()} â†’ ${this.currentSide.toUpperCase()} (${this.loseStreak}L streak)`);
                    // Fall through to add loss to sequence
                    
                case "CONTINUE":
                default:
                    // Add loss to sequence
                    const lossAmount = this.sequence.length >= 2 ? 
                        this.sequence[0] + this.sequence[this.sequence.length - 1] : 
                        this.sequence[0];
                    this.sequence.push(lossAmount);
                    
                    // Check risk limits
                    if (this.sequence.length > (getVal("p-flip-max-sequence") || 15)) {
                        return this.completeLevel(false, "MAX_SEQUENCE_REACHED");
                    }
                    
                    if (this.flipsCompleted >= this.maxFlips) {
                        return this.completeLevel(false, "MAX_FLIPS_REACHED");
                    }
                    
                    // Check drawdown limit
                    const currentDD = (this.startBalance - bot.stats.currentBal) / this.startBalance * 100;
                    const maxDD = getVal("p-flip-max-dd") || 10;
                    
                    if (currentDD > maxDD) {
                        return this.completeLevel(false, `MAX_DRAWDOWN_${currentDD.toFixed(1)}%`);
                    }
                    
                    return { complete: false, action: "NEW_TRADE", gameActive: false };
            }
        },
        
        // Complete current level
        completeLevel(success, reason) {
            const levelTime = Date.now() - (this.levelStartTime || this.startTime);
            
            if (success) {
                console.log(`âœ… Level ${this.recoveryLevel} COMPLETE | Reason: ${reason} | Time: ${(levelTime/1000).toFixed(1)}s`);
                
                this.stats.successfulRecoveries++;
                this.stats.totalRecovered += Math.abs(this.originalProfit);
                
                // Check if overall recovery complete
                if (this.shouldStopRecovery()) {
                    return this.finalizeRecovery(true, reason);
                }
                
                // Move to next level
                if (this.recoveryLevel < this.maxLevels) {
                    this.recoveryLevel++;
                    this.sequence = this.getInitialSequence(this.recoveryLevel);
                    this.flipsCompleted = 0;
                    this.levelStartTime = Date.now();
                    
                    console.log(`ðŸ”„ Moving to Level ${this.recoveryLevel} - ${this.getStrategyName()}`);
                    updateStatus(`ðŸ“Š FLIP RECOVERY L${this.recoveryLevel}`, "#F59E0B");
                    updateLogs(0, 0, "TRADING", 0, 
                        `Level up: ${this.recoveryLevel-1} â†’ ${this.recoveryLevel} | Strategy: ${this.getStrategyName()}`);
                    
                    return { complete: false, levelComplete: true, newLevel: this.recoveryLevel };
                }
                
                // All levels completed successfully
                return this.finalizeRecovery(true, "ALL_LEVELS_COMPLETE");
                
            } else {
                console.log(`âŒ Level ${this.recoveryLevel} FAILED | Reason: ${reason}`);
                
                this.stats.failedRecoveries++;
                
                // Try next level
                if (this.recoveryLevel < this.maxLevels) {
                    this.recoveryLevel++;
                    this.sequence = this.getInitialSequence(this.recoveryLevel);
                    this.flipsCompleted = 0;
                    this.pattern = [];
                    this.levelStartTime = Date.now();
                    
                    console.log(`ðŸ”„ Trying Level ${this.recoveryLevel} - ${this.getStrategyName()}`);
                    updateStatus(`ðŸ“Š FLIP RECOVERY L${this.recoveryLevel}`, "#F59E0B");
                    updateLogs(0, 0, "TRADING", 0, 
                        `Fallback to Level ${this.recoveryLevel} | Strategy: ${this.getStrategyName()}`);
                    
                    return { complete: false, levelComplete: true, newLevel: this.recoveryLevel };
                }
                
                // All levels failed
                return this.finalizeRecovery(false, "ALL_LEVELS_FAILED");
            }
        },
        
        // Check if should stop recovery
        shouldStopRecovery() {
            // Break-even dengan margin 0.1%
            const breakEvenThreshold = Math.abs(this.originalProfit) * 0.999;
            const recoveredAmount = Math.abs(bot.stats.sessionProfit - this.originalProfit);
            
            return recoveredAmount >= breakEvenThreshold;
        },
        
        // Finalize recovery
        finalizeRecovery(success, reason) {
            this.isActive = false;
            const recoveryTime = Date.now() - this.startTime;
            this.stats.totalTime += recoveryTime;
            
            // Final statistics update
            this.updateStatistics();
            
            if (success) {
                const recoveredAmount = Math.abs(this.originalProfit);
                const recoveryEfficiency = (recoveredAmount / (recoveredAmount + Math.abs(bot.stats.sessionProfit))) * 100;
                
                console.log(`ðŸ† RECOVERY SUCCESS in ${(recoveryTime/1000).toFixed(1)}s`);
                console.log(`   Recovered: ${recoveredAmount.toFixed(8)}`);
                console.log(`   Efficiency: ${recoveryEfficiency.toFixed(1)}%`);
                console.log(`   Win Rate: ${this.stats.winRate.toFixed(1)}%`);
                console.log(`   Profit Factor: ${this.stats.profitFactor.toFixed(2)}`);
                
                // Auto switch to original mode
                setTimeout(() => {
                    rotateMode(this.originalMode);
                    updateStatus("âš¡ BACK TO MAIN STRATEGY", "#8B5CF6");
                    updateLogs(0, 0, "TRADING", 0, 
                        `Recovery complete â†’ ${this.originalMode} mode | Time: ${(recoveryTime/1000).toFixed(1)}s | Efficiency: ${recoveryEfficiency.toFixed(1)}%`);
                }, 1500);
                
            } else {
                console.log(`ðŸ’¥ RECOVERY FAILED after ${this.flipsCompleted} trades`);
                console.log(`   Total Loss: ${Math.abs(bot.stats.sessionProfit).toFixed(8)}`);
                console.log(`   Win Rate: ${this.stats.winRate.toFixed(1)}%`);
                
                // Fallback to BASE mode
                setTimeout(() => {
                    rotateMode("BASE");
                    updateStatus("ðŸ”„ BACK TO BASE STRATEGY", "#6366F1");
                    updateLogs(0, 0, "TRADING", 0, 
                        `Recovery failed â†’ BASE mode | Trades: ${this.flipsCompleted} | Loss: ${Math.abs(bot.stats.sessionProfit).toFixed(8)}`);
                }, 2000);
            }
            
            // Send detailed report
            sendTelegramReport(success ? "flip_recovery_complete" : "flip_recovery_failed");
            
            return { complete: true, success: success, reason: reason };
        },
        
        // Add trade to history
        addTradeToHistory(bet, profit, type) {
            const trade = {
                time: Date.now(),
                bet: bet,
                profit: profit,
                type: type,
                side: this.currentSide,
                sequence: [...this.sequence],
                balance: bot.stats.currentBal,
                winRate: this.stats.winRate
            };
            
            this.profitHistory.push(trade);
            this.balanceHistory.push({
                time: Date.now(),
                balance: bot.stats.currentBal,
                equity: bot.stats.currentBal
            });
            
            // Keep last 50 trades
            if (this.profitHistory.length > 50) {
                this.profitHistory.shift();
                this.balanceHistory.shift();
            }
            
            // Update equity curve
            this.equityCurve = this.balanceHistory.map(h => h.equity);
        },
        
        // Get recovery statistics for display
        getRecoveryStats() {
            const successRate = this.stats.totalRecoveries > 0 ?
                (this.stats.successfulRecoveries / this.stats.totalRecoveries * 100) : 0;
            
            const avgTime = this.stats.totalRecoveries > 0 ?
                (this.stats.totalTime / this.stats.totalRecoveries / 1000) : 0;
            
            const currentDD = this.startBalance > 0 ?
                ((this.startBalance - bot.stats.currentBal) / this.startBalance * 100) : 0;
            
            const recoveryProgress = Math.abs(this.originalProfit) > 0 ?
                (Math.abs(bot.stats.sessionProfit - this.originalProfit) / Math.abs(this.originalProfit) * 100) : 0;
            
            return {
                successRate: successRate.toFixed(1),
                totalRecoveries: this.stats.totalRecoveries,
                successful: this.stats.successfulRecoveries,
                failed: this.stats.failedRecoveries,
                totalRecovered: this.stats.totalRecovered.toFixed(8),
                avgTime: avgTime.toFixed(1),
                currentWinRate: this.stats.winRate.toFixed(1),
                profitFactor: this.stats.profitFactor.toFixed(2),
                sharpeRatio: this.stats.sharpeRatio.toFixed(2),
                currentDD: currentDD.toFixed(2),
                recoveryProgress: recoveryProgress.toFixed(1),
                activeTrades: this.flipsCompleted,
                winStreak: this.winStreak,
                loseStreak: this.loseStreak
            };
        },
        
        // Get trading signals
        getTradingSignals() {
            const signals = [];
            
            // RSI Signal
            if (this.pattern.length >= 10) {
                const recent = this.pattern.slice(0, 10);
                const wins = recent.filter(t => t.win).length;
                const rs = wins / (10 - wins);
                const rsi = 100 - (100 / (1 + rs));
                
                if (rsi > 70) signals.push({ type: "OVERBOUGHT", value: rsi.toFixed(1) });
                if (rsi < 30) signals.push({ type: "OVERSOLD", value: rsi.toFixed(1) });
            }
            
            // Streak Signal
            if (this.winStreak >= 3) signals.push({ type: "WIN_STREAK", value: this.winStreak });
            if (this.loseStreak >= 3) signals.push({ type: "LOSE_STREAK", value: this.loseStreak });
            
            // Volume Signal (based on bet size changes)
            if (this.pattern.length >= 3) {
                const lastThree = this.pattern.slice(0, 3);
                const avgBet = lastThree.reduce((sum, t) => sum + t.bet, 0) / 3;
                const currentBet = this.getNextBet();
                
                if (currentBet > avgBet * 1.5) signals.push({ type: "HIGH_VOLUME", value: (currentBet/avgBet).toFixed(1) });
            }
            
            return signals;
        },
        
        // Get pattern as advanced chart
        getPatternChart() {
            if (this.pattern.length === 0) return "ðŸ“Š No trades yet";
            
            const last10 = this.pattern.slice(0, 10);
            const chart = last10.map(trade => 
                trade.win ? "ðŸŸ¢" : "ðŸ”´"
            ).join("");
            
            // Add streak indicator
            let streakIndicator = "";
            if (this.winStreak >= 2) streakIndicator = ` ðŸ”¥ ${this.winStreak}W`;
            if (this.loseStreak >= 2) streakIndicator = ` ðŸ’€ ${this.loseStreak}L`;
            
            return chart + streakIndicator;
        },
        
        // Force side change (for manual control)
        forceSide(side) {
            if (!this.isActive) return false;
            
            const oldSide = this.currentSide;
            this.currentSide = side;
            this.sideMode = "manual";
            
            console.log(`ðŸŽ® Manual side change: ${oldSide} â†’ ${side}`);
            updateStatus(`ðŸŽ® MANUAL ${side.toUpperCase()}`, "#3B82F6");
            updateLogs(0, 0, "TRADING", 0, `Manual override: ${oldSide.toUpperCase()} â†’ ${side.toUpperCase()}`);
            
            return true;
        },
        
        // Force cashout
        forceCashout() {
            if (!this.isActive || !this.activeGameId) return false;
            
            console.log(`ðŸ’µ Manual cashout requested`);
            updateStatus(`ðŸ’µ MANUAL CASHOUT`, "#10B981");
            updateLogs(0, 0, "TRADING", 0, "Manual cashout initiated");
            
            return true;
        }
    };

    // ==================== ENHANCED FLIP API FUNCTIONS ====================
    const FlipAPI = {
        async startFlipGame(amount, side) {
            try {
                const payload = {
                    query: `mutation FlipBet($amount: Float!, $currency: CurrencyEnum!, $guesses: [FlipConditionEnum!]!) {
                        flipBet(
                            amount: $amount
                            currency: $currency
                            guesses: $guesses
                        ) {
                            id
                            active
                            payoutMultiplier
                            amountMultiplier
                            amount
                            payout
                            updatedAt
                            currency
                            game
                            user {
                                id
                                name
                            }
                            state {
                                currentRound
                                payoutMultiplier
                                playedRounds
                                flips
                            }
                        }
                    }`,
                    variables: {
                        currency: bot.selectedCurrency.toLowerCase(),
                        amount: parseFloat(amount.toFixed(8)),
                        guesses: [side]
                    }
                };
                
                const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token,
                        "x-lockdown-token": "s5MNWtjTM5TvCMkAzxov"
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const flipGame = data?.data?.flipBet;
                
                if (!flipGame) {
                    throw new Error("Flip game start failed: " + JSON.stringify(data));
                }
                
                console.log(`ðŸŽ® Flip game started: ${side} | Amount: ${amount} | ID: ${flipGame.id}`);
                
                // Wait for animation (3 seconds)
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Get final result after animation
                const result = await this.getFlipResult(flipGame.id);
                
                return {
                    success: true,
                    game: result.game,
                    win: result.win,
                    profit: result.profit,
                    active: result.active,
                    gameId: flipGame.id,
                    rawData: flipGame
                };
                
            } catch (error) {
                console.error("Start flip game error:", error);
                throw error;
            }
        },
        
        async getFlipResult(gameId) {
            try {
                const payload = {
                    query: `query GetFlipResult($id: ID!) {
                        casinoBet(id: $id) {
                            id
                            active
                            payoutMultiplier
                            amountMultiplier
                            amount
                            payout
                            currency
                            state {
                                ... on CasinoGameFlip {
                                    currentRound
                                    payoutMultiplier
                                    playedRounds
                                    flips
                                }
                            }
                        }
                    }`,
                    variables: {
                        id: gameId
                    }
                };
                
                const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const game = data?.data?.casinoBet;
                
                return {
                    success: true,
                    game: game,
                    win: game?.payout > 0,
                    profit: game?.payout - game?.amount,
                    active: game?.active
                };
                
            } catch (error) {
                console.error("Get flip result error:", error);
                throw error;
            }
        },
        
        async flipNextRound(side) {
            try {
                const payload = {
                    query: `mutation FlipNext($condition: FlipConditionEnum!) {
                        flipNext(condition: $condition) {
                            id
                            active
                            payoutMultiplier
                            amountMultiplier
                            amount
                            payout
                            updatedAt
                            currency
                            game
                            user {
                                id
                                name
                            }
                            state {
                                currentRound
                                payoutMultiplier
                                playedRounds
                                flips
                            }
                        }
                    }`,
                    variables: {
                        condition: side
                    }
                };
                
                const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token,
                        "x-lockdown-token": "s5MNWtjTM5TvCMkAzxov"
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const result = data?.data?.flipNext;
                
                console.log(`ðŸ”„ Flip next round: ${side} | Active: ${result?.active} | Payout: ${result?.payout}`);
                
                // Wait for animation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Get updated result
                const finalResult = await this.getFlipResult(result?.id);
                
                return {
                    success: true,
                    game: finalResult.game,
                    win: finalResult.win,
                    profit: finalResult.profit,
                    active: finalResult.active,
                    gameId: result?.id
                };
                
            } catch (error) {
                console.error("Flip next round error:", error);
                throw error;
            }
        },
        
        async flipCashout() {
            try {
                const payload = {
                    query: `mutation FlipCashout {
                        flipCashout {
                            id
                            active
                            payoutMultiplier
                            amountMultiplier
                            amount
                            payout
                            updatedAt
                            currency
                            game
                            user {
                                id
                                name
                            }
                            state {
                                currentRound
                                payoutMultiplier
                                playedRounds
                                flips
                            }
                        }
                    }`
                };
                
                const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token,
                        "x-lockdown-token": "s5MNWtjTM5TvCMkAzxov"
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                const result = data?.data?.flipCashout;
                
                console.log(`ðŸ’µ Flip cashout: Payout: ${result?.payout} | Profit: ${result?.payout - result?.amount}`);
                
                return {
                    success: true,
                    game: result,
                    profit: result?.payout - result?.amount,
                    active: result?.active
                };
                
            } catch (error) {
                console.error("Flip cashout error:", error);
                throw error;
            }
        }
    };

    // ==================== PROFESSIONAL BOT ENGINE ====================
    const bot = {
        isRunning: false,
        isPaused: false,
        mode: "BASE",
        currentGame: "DICE",
        token: null,
        stakeUser: "Loading...",
        startTime: null,
        stopTime: null,
        lastRotationTime: null,
        
        // Enhanced Statistics
        stats: {
            profit: 0,
            wagered: 0,
            startBal: 0,
            currentBal: 0,
            bets: 0,
            wins: 0,
            loss: 0,
            
            sessionProfit: 0,
            sessionWagered: 0,
            sessionBets: 0,
            sessionStartBal: 0,
            
            maxDD: 0,
            maxDDPercent: 0,
            peakBalance: 0,
            
            biggestWin: 0,
            biggestLoss: 0,
            biggestBet: 0,
            
            currentWinStreak: 0,
            currentLossStreak: 0,
            longestWinStreak: 0,
            longestLossStreak: 0,
            
            winRate: 0,
            roi: 0,
            profitPerBet: 0,
            
            // Trading metrics
            sharpeRatio: 0,
            profitFactor: 0,
            expectancy: 0,
            recoveryFactor: 0
        },
        
        // Trading Settings
        selectedCurrency: localStorage.getItem('orion_last_coin') || "usdt",
        nextBet: 0,
        currentChance: 0,
        currentMulti: 0,
        
        // Trading Modes
        wgr: {
            ctwin: 0,
            balhigh: 0,
            profitc: 0,
            betload: 0
        },
        
        base: {
            ls: 0,
            lc: 0,
            bcount: 0,
            partialProfit: 0
        },
        
        // Session Management
        session: {
            maxSessions: 20,
            currentSession: 1,
            sessionHistory: [],
            sessionStartTime: null,
            sessionTargetAbs: 0
        },
        
        // Performance Tracking
        lastReportTime: 0,
        lastChartUpdate: 0,
        performanceLogs: [],
        
        licenseTier: "PREMIUM",
        supportContact: CONFIG.supportContact
    };

    // ==================== PROFESSIONAL PRESETS ====================
    const TradingPresets = {
        CONSERVATIVE: {
            name: "ðŸ›¡ï¸ CONSERVATIVE TRADER",
            description: "Capital preservation, steady growth",
            settings: {
                "p-basebet": 0.00000050,
                "p-bch-min": 85.0,
                "p-bch-max": 90.0,
                "p-hch-min": 25.0,
                "p-hch-max": 35.0,
                "p-wgr-chance": 99.5,
                "p-wgr-div": 150,
                "p-stoploss-pct": 2.0,
                "p-session-target": 0.1,
                "p-session-stoploss": 0.05,
                "p-recovery-threshold": -1.5,
                "p-flip-basebet": 0.00000050,
                "p-flip-max-sequence": 10,
                "p-flip-side-mode": "auto",
                "p-flip-max-dd": 5.0,
                "p-take-profit": 0.3
            }
        },
        
        BALANCED: {
            name: "âš–ï¸ BALANCED TRADER",
            description: "Optimal risk/reward, professional approach",
            settings: {
                "p-basebet": 0.00000100,
                "p-bch-min": 80.0,
                "p-bch-max": 85.0,
                "p-hch-min": 20.0,
                "p-hch-max": 30.0,
                "p-wgr-chance": 99.0,
                "p-wgr-div": 100,
                "p-stoploss-pct": 3.0,
                "p-session-target": 0.2,
                "p-session-stoploss": 0.1,
                "p-recovery-threshold": -2.0,
                "p-flip-basebet": 0.00000100,
                "p-flip-max-sequence": 12,
                "p-flip-side-mode": "auto",
                "p-flip-max-dd": 7.5,
                "p-take-profit": 0.5
            }
        },
        
        AGGRESSIVE: {
            name: "âš¡ AGGRESSIVE TRADER",
            description: "High conviction, maximum returns",
            settings: {
                "p-basebet": 0.00000200,
                "p-bch-min": 75.0,
                "p-bch-max": 80.0,
                "p-hch-min": 15.0,
                "p-hch-max": 25.0,
                "p-wgr-chance": 98.5,
                "p-wgr-div": 70,
                "p-stoploss-pct": 5.0,
                "p-session-target": 0.3,
                "p-session-stoploss": 0.15,
                "p-recovery-threshold": -2.5,
                "p-flip-basebet": 0.00000200,
                "p-flip-max-sequence": 15,
                "p-flip-side-mode": "auto",
                "p-flip-max-dd": 10.0,
                "p-take-profit": 0.8
            }
        },
        
        FLIP_SPECIALIST: {
            name: "ðŸŽ¯ FLIP SPECIALIST",
            description: "Optimized for Flip recovery trading",
            settings: {
                "p-basebet": 0.00000100,
                "p-bch-min": 82.0,
                "p-bch-max": 88.0,
                "p-hch-min": 22.0,
                "p-hch-max": 28.0,
                "p-wgr-chance": 99.2,
                "p-wgr-div": 120,
                "p-stoploss-pct": 4.0,
                "p-session-target": 0.25,
                "p-session-stoploss": 0.12,
                "p-recovery-threshold": -1.8,
                "p-flip-basebet": 0.00000150,
                "p-flip-max-sequence": 14,
                "p-flip-side-mode": "auto",
                "p-flip-max-dd": 8.0,
                "p-take-profit": 0.6,
                "p-flip-aggression": 75
            }
        }
    };

    // ==================== PROFESSIONAL API FUNCTIONS ====================
    const API = {
        async syncOnce() {
            bot.token = localStorage.getItem('apitoken') || 
                       (document.cookie.match(/session=([^;]+)/) ? 
                        document.cookie.match(/session=([^;]+)/)[1] : null);
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{name balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;
                    const bals = json.data.user.balances || [];
                    const sel = document.getElementById("p-currency");
                    
                    if (sel) {
                        const currentSelected = sel.value || bot.selectedCurrency;
                        sel.innerHTML = "";

                        bals.forEach(b => {
                            const opt = new Option(
                                `${b.available.currency.toUpperCase()} (${parseFloat(b.available.amount).toFixed(2)})`,
                                b.available.currency
                            );
                            if(b.available.currency === currentSelected) opt.selected = true;
                            sel.add(opt);
                        });
                        bot.selectedCurrency = sel.value;
                    }
                    
                    await updateBalanceDisplay();
                }
            } catch (e) {
                console.error("Sync Error:", e);
            }
        },

        async getBalance(coin) {
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(
                    b => b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                return active ? parseFloat(active.available.amount) : 0;
            } catch (e) {
                console.error("Balance Error:", e);
                return 0;
            }
        },

        async placeBet(gameType, params) {
            let endpoint;
            let payload;
            
            if (gameType === "DICE") {
                endpoint = "/casino/dice/roll";
                payload = {
                    amount: parseFloat(params.amount.toFixed(8)),
                    currency: bot.selectedCurrency,
                    target: (100 - params.chance).toFixed(1),
                    condition: "above",
                    identifier: Math.random().toString(36).slice(2) + Date.now()
                };
                
                try {
                    const r = await fetch(`${CONFIG.apiUrl}${endpoint}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-access-token": bot.token
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await r.json();
                    return result;
                } catch (error) {
                    console.error(`${gameType} Bet Error:`, error);
                    throw error;
                }
                
            } else if (gameType === "FLIP") {
                // Use enhanced Flip API
                if (params.action === "START") {
                    return await FlipAPI.startFlipGame(params.amount, params.side);
                } else if (params.action === "NEXT") {
                    return await FlipAPI.flipNextRound(params.side);
                } else if (params.action === "CASHOUT") {
                    return await FlipAPI.flipCashout();
                } else if (params.action === "GET_RESULT") {
                    return await FlipAPI.getFlipResult(params.gameId);
                }
            }
        }
    };

    function updateStatsSync(gameData, win, profit) {
        // Update basic statistics
        bot.stats.bets++;
        bot.stats.sessionBets++;
        bot.stats.wagered += gameData?.amount || bot.nextBet;
        bot.stats.sessionWagered += gameData?.amount || bot.nextBet;
        bot.stats.profit += profit;
        bot.stats.sessionProfit += profit;
        
        if (win) {
            bot.stats.wins++;
            bot.stats.currentWinStreak++;
            bot.stats.currentLossStreak = 0;
            bot.stats.longestWinStreak = Math.max(bot.stats.longestWinStreak, bot.stats.currentWinStreak);
            
            if (profit > bot.stats.biggestWin) {
                bot.stats.biggestWin = profit;
            }
        } else {
            bot.stats.loss++;
            bot.stats.currentLossStreak++;
            bot.stats.currentWinStreak = 0;
            bot.stats.longestLossStreak = Math.max(bot.stats.longestLossStreak, bot.stats.currentLossStreak);
            
            if (profit < bot.stats.biggestLoss) {
                bot.stats.biggestLoss = profit;
            }
        }
        
        // Update balance
        bot.stats.currentBal += profit;
        
        // Update peak balance and drawdown
        if (bot.stats.currentBal > bot.stats.peakBalance) {
            bot.stats.peakBalance = bot.stats.currentBal;
        }
        
        const drawdown = bot.stats.peakBalance - bot.stats.currentBal;
        if (drawdown > bot.stats.maxDD) {
            bot.stats.maxDD = drawdown;
        }
        
        const drawdownPercent = (drawdown / bot.stats.peakBalance) * 100;
        if (drawdownPercent > bot.stats.maxDDPercent) {
            bot.stats.maxDDPercent = drawdownPercent;
        }
        
        // Update win rate
        bot.stats.winRate = (bot.stats.wins / bot.stats.bets) * 100;
        
        // Update ROI
        bot.stats.roi = (bot.stats.profit / bot.stats.wagered) * 100;
        
        // Update profit per bet
        bot.stats.profitPerBet = bot.stats.profit / bot.stats.bets;
        
        // Track biggest bet
        const currentBet = gameData?.amount || bot.nextBet;
        if (currentBet > bot.stats.biggestBet) {
            bot.stats.biggestBet = currentBet;
        }
    }

    async function updateBalanceDisplay() {
        try {
            const balance = await API.getBalance(bot.selectedCurrency);
            bot.stats.currentBal = balance;
            return balance;
        } catch (error) {
            console.error("Update balance error:", error);
            return 0;
        }
    }

    async function sendTelegramReport(type) {
        // Implementation for sending Telegram reports
        // This should be implemented based on your Telegram bot setup
        console.log(`Telegram report: ${type}`);
    }

    function applyTradingPreset(presetName) {
        const preset = TradingPresets[presetName];
        if (!preset) return;
        
        for (const [key, value] of Object.entries(preset.settings)) {
            const el = document.getElementById(key);
            if (el) {
                if (el.type === 'checkbox') {
                    el.checked = Boolean(value);
                } else if (el.tagName === 'SELECT') {
                    el.value = value;
                    el.dispatchEvent(new Event('change'));
                } else {
                    el.value = value;
                }
            }
        }
        
        updateStatus(`âœ… ${preset.name} APPLIED`, "#10B981");
        updateLogs(0, 0, "SYSTEM", 0, `${preset.name}: ${preset.description}`);
        
        console.log(`âœ… ${preset.name} trading preset applied`);
    }

    // ==================== PROFESSIONAL UI CREATION ====================
    function createProfessionalUI() {
        if (document.getElementById("orion-pro-trader")) {
            document.getElementById("orion-pro-trader").remove();
        }
        
        // Add professional CSS
        const s = document.createElement("style");
        s.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap');
            
            :root {
                --bg-primary: #0B0E14;
                --bg-secondary: #161B22;
                --bg-tertiary: #21262D;
                --bg-card: #1C2128;
                --accent-primary: #1F6FEB;
                --accent-secondary: #388BFD;
                --accent-success: #238636;
                --accent-warning: #9E6A03;
                --accent-danger: #DA3633;
                --accent-info: #58A6FF;
                --text-primary: #F0F6FC;
                --text-secondary: #8B949E;
                --text-muted: #6E7681;
                --border-color: #30363D;
                --border-light: #3C444D;
                --gradient-primary: linear-gradient(135deg, #1F6FEB 0%, #388BFD 100%);
                --gradient-success: linear-gradient(135deg, #238636 0%, #2EA043 100%);
                --gradient-warning: linear-gradient(135deg, #9E6A03 0%, #BD8B13 100%);
                --gradient-danger: linear-gradient(135deg, #DA3633 0%, #F85149 100%);
                --shadow-lg: 0 10px 30px rgba(0,0,0,0.3);
                --shadow-xl: 0 20px 40px rgba(0,0,0,0.4);
                --radius-lg: 12px;
                --radius-md: 8px;
                --radius-sm: 6px;
            }
            
            #orion-pro-trader {
                position: fixed;
                width: 900px;
                height: 700px;
                background: var(--bg-primary);
                color: var(--text-primary);
                font-family: 'Inter', sans-serif;
                z-index: 99999;
                display: flex;
                flex-direction: column;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                overflow: hidden;
                border: 1px solid var(--border-color);
                resize: both;
                min-width: 800px;
                min-height: 600px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                backdrop-filter: blur(10px);
            }
            
            /* Trading Terminal Header */
            .terminal-header {
                background: var(--bg-secondary);
                padding: 16px 24px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                position: relative;
            }
            
            .terminal-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 2px;
                background: var(--gradient-primary);
            }
            
            .header-left {
                display: flex;
                align-items: center;
                gap: 16px;
            }
            
            .logo-container {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .logo-icon {
                width: 36px;
                height: 36px;
                background: var(--gradient-primary);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                font-weight: bold;
                color: white;
            }
            
            .logo-text {
                font-size: 20px;
                font-weight: 800;
                background: linear-gradient(135deg, #F0F6FC 0%, #8B949E 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                letter-spacing: 0.5px;
            }
            
            .version-badge {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                letter-spacing: 0.5px;
                border: 1px solid var(--border-color);
            }
            
            .header-right {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .user-badge {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .user-avatar {
                width: 28px;
                height: 28px;
                background: var(--gradient-primary);
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                color: white;
            }
            
            .user-info {
                display: flex;
                flex-direction: column;
            }
            
            .username {
                font-size: 13px;
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .user-status {
                font-size: 11px;
                color: var(--text-secondary);
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .status-indicator {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--accent-success);
            }
            
            .status-indicator.offline { background: var(--text-muted); }
            .status-indicator.warning { background: var(--accent-warning); }
            .status-indicator.danger { background: var(--accent-danger); }
            
            /* Terminal Body */
            .terminal-body {
                display: grid;
                grid-template-columns: 280px 1fr;
                flex: 1;
                overflow: hidden;
            }
            
            /* Sidebar */
            .terminal-sidebar {
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-color);
                padding: 20px;
                overflow-y: auto;
            }
            
            .sidebar-section {
                margin-bottom: 24px;
            }
            
            .section-title {
                font-size: 12px;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 1px;
                margin-bottom: 12px;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            /* Main Content */
            .terminal-main {
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Trading View */
            .trading-view {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .view-tabs {
                display: flex;
                border-bottom: 1px solid var(--border-color);
                background: var(--bg-secondary);
            }
            
            .view-tab {
                padding: 14px 24px;
                font-size: 13px;
                font-weight: 600;
                color: var(--text-secondary);
                border-bottom: 2px solid transparent;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .view-tab:hover {
                color: var(--text-primary);
                background: var(--bg-tertiary);
            }
            
            .view-tab.active {
                color: var(--accent-primary);
                border-bottom-color: var(--accent-primary);
                background: var(--bg-tertiary);
            }
            
            .view-content {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            
            /* Trading Dashboard */
            .trading-dashboard {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 20px;
            }
            
            .dashboard-card {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: 20px;
            }
            
            .card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 16px;
            }
            
            .card-title {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .card-value {
                font-size: 24px;
                font-weight: 700;
                font-family: 'JetBrains Mono', monospace;
            }
            
            .card-value.positive { color: var(--accent-success); }
            .card-value.negative { color: var(--accent-danger); }
            .card-value.neutral { color: var(--text-primary); }
            
            .card-change {
                font-size: 12px;
                padding: 4px 8px;
                border-radius: 4px;
                font-weight: 600;
            }
            
            .card-change.positive { background: rgba(35, 134, 54, 0.2); color: var(--accent-success); }
            .card-change.negative { background: rgba(218, 54, 51, 0.2); color: var(--accent-danger); }
            
            /* Trading Controls */
            .trading-controls {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                padding: 20px;
                margin-top: 20px;
            }
            
            .control-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 16px;
            }
            
            /* Trading Buttons */
            .trading-btn {
                padding: 14px 20px;
                border: none;
                border-radius: var(--radius-md);
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                font-family: 'Inter', sans-serif;
            }
            
            .trading-btn-primary {
                background: var(--gradient-primary);
                color: white;
            }
            
            .trading-btn-success {
                background: var(--gradient-success);
                color: white;
            }
            
            .trading-btn-warning {
                background: var(--gradient-warning);
                color: white;
            }
            
            .trading-btn-danger {
                background: var(--gradient-danger);
                color: white;
            }
            
            .trading-btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }
            
            .trading-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .trading-btn:active {
                transform: translateY(0);
            }
            
            /* Trading Logs */
            .trading-logs {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                margin-top: 20px;
                overflow: hidden;
            }
            
            .logs-header {
                padding: 16px 20px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .logs-content {
                max-height: 200px;
                overflow-y: auto;
            }
            
            .log-row {
                display: grid;
                grid-template-columns: 120px 100px 80px 100px 80px 1fr;
                padding: 12px 20px;
                border-bottom: 1px solid var(--border-color);
                font-size: 12px;
                font-family: 'JetBrains Mono', monospace;
            }
            
            .log-row:hover {
                background: var(--bg-tertiary);
            }
            
            /* Progress Bars */
            .progress-container {
                margin: 12px 0;
            }
            
            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                color: var(--text-secondary);
                margin-bottom: 6px;
            }
            
            .progress-bar {
                height: 6px;
                background: var(--bg-tertiary);
                border-radius: 3px;
                overflow: hidden;
            }
            
            .progress-fill {
                height: 100%;
                border-radius: 3px;
                transition: width 0.3s ease;
            }
            
            .progress-fill.primary { background: var(--gradient-primary); }
            .progress-fill.success { background: var(--gradient-success); }
            .progress-fill.warning { background: var(--gradient-warning); }
            .progress-fill.danger { background: var(--gradient-danger); }
            
            /* Signals */
            .signal-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                margin-right: 6px;
                margin-bottom: 4px;
            }
            
            .signal-buy { background: rgba(35, 134, 54, 0.2); color: var(--accent-success); }
            .signal-sell { background: rgba(218, 54, 51, 0.2); color: var(--accent-danger); }
            .signal-neutral { background: rgba(88, 166, 255, 0.2); color: var(--accent-info); }
            .signal-warning { background: rgba(158, 106, 3, 0.2); color: var(--accent-warning); }
            
            /* Mobile Responsive */
            @media (max-width: 768px) {
                #orion-pro-trader {
                    width: 95vw;
                    height: 90vh;
                    min-width: unset;
                    min-height: unset;
                    bottom: 0;
                    top: unset;
                    left: 2.5vw;
                    transform: none;
                    border-radius: 12px 12px 0 0;
                }
                
                .terminal-body {
                    grid-template-columns: 1fr;
                }
                
                .terminal-sidebar {
                    display: none;
                }
                
                .dashboard-card {
                    grid-column: 1 / -1;
                }
            }
            
            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: var(--bg-tertiary);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: var(--border-light);
            }
            
            /* Resize Handle */
            .resize-handle {
                position: absolute;
                bottom: 0;
                right: 0;
                width: 20px;
                height: 20px;
                cursor: se-resize;
                background: linear-gradient(135deg, transparent 50%, var(--border-light) 50%);
                border-top-left-radius: 8px;
            }
        `;
        document.head.appendChild(s);
        
        // Create professional UI
        const d = document.createElement("div");
        d.id = "orion-pro-trader";
        d.innerHTML = createTradingTerminalHTML();
        
        document.body.appendChild(d);
        
        // Setup event listeners
        setupProfessionalEventListeners();
        
        // Initialize
        API.syncOnce();
        updateProfessionalUI();
        
        // Start UI update interval
        setInterval(updateProfessionalUI, 1000);
    }
    
    function createTradingTerminalHTML() {
        return `
            <div class="resize-handle"></div>
            
            <!-- Trading Terminal Header -->
            <div class="terminal-header">
                <div class="header-left">
                    <div class="logo-container">
                        <div class="logo-icon">âš¡</div>
                        <div class="logo-text">ORION PRO TRADER</div>
                    </div>
                    <div class="version-badge">${CONFIG.version}</div>
                </div>
                
                <div class="header-right">
                    <div class="user-badge">
                        <div class="user-avatar">ðŸ‘¤</div>
                        <div class="user-info">
                            <div class="username">${bot.stakeUser}</div>
                            <div class="user-status">
                                <span class="status-indicator" id="connection-status"></span>
                                <span id="user-tier">${bot.licenseTier}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Terminal Body -->
            <div class="terminal-body">
                <!-- Sidebar -->
                <div class="terminal-sidebar">
                    <!-- Account Summary -->
                    <div class="sidebar-section">
                        <div class="section-title">Account Summary</div>
                        <div style="background: var(--bg-card); border-radius: var(--radius-md); padding: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">Balance</span>
                                <span id="sidebar-balance" style="font-family: 'JetBrains Mono'; font-weight: 600;">0.00000000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">PnL</span>
                                <span id="sidebar-pnl" class="card-value neutral">0.00000000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 12px; color: var(--text-secondary);">Win Rate</span>
                                <span id="sidebar-winrate" style="font-family: 'JetBrains Mono'; font-weight: 600;">0.0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trading Presets -->
                    <div class="sidebar-section">
                        <div class="section-title">Trading Strategies</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="trading-btn trading-btn-secondary preset-btn" data-preset="CONSERVATIVE">
                                ðŸ›¡ï¸ Conservative
                            </button>
                            <button class="trading-btn trading-btn-secondary preset-btn" data-preset="BALANCED">
                                âš–ï¸ Balanced
                            </button>
                            <button class="trading-btn trading-btn-secondary preset-btn" data-preset="AGGRESSIVE">
                                âš¡ Aggressive
                            </button>
                            <button class="trading-btn trading-btn-secondary preset-btn" data-preset="FLIP_SPECIALIST">
                                ðŸŽ¯ Flip Specialist
                            </button>
                        </div>
                    </div>
                    
                    <!-- Trading Signals -->
                    <div class="sidebar-section">
                        <div class="section-title">Market Signals</div>
                        <div id="trading-signals" style="min-height: 60px;">
                            <div style="color: var(--text-muted); font-size: 11px; text-align: center; padding: 20px;">
                                Waiting for market data...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="sidebar-section">
                        <div class="section-title">Quick Actions</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button id="btn-quick-start" class="trading-btn trading-btn-success">
                                ðŸš€ Start
                            </button>
                            <button id="btn-quick-pause" class="trading-btn trading-btn-warning">
                                â¸ï¸ Pause
                            </button>
                            <button id="btn-quick-stop" class="trading-btn trading-btn-danger">
                                ðŸ›‘ Stop
                            </button>
                            <button id="btn-quick-cashout" class="trading-btn trading-btn-primary">
                                ðŸ’µ Cashout
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="terminal-main">
                    <!-- View Tabs -->
                    <div class="view-tabs">
                        <div class="view-tab active" data-view="dashboard">ðŸ“Š Dashboard</div>
                        <div class="view-tab" data-view="trading">ðŸŽ® Trading</div>
                        <div class="view-tab" data-view="recovery">ðŸ”„ Recovery</div>
                        <div class="view-tab" data-view="analytics">ðŸ“ˆ Analytics</div>
                        <div class="view-tab" data-view="settings">âš™ï¸ Settings</div>
                    </div>
                    
                    <!-- View Content -->
                    <div class="view-content">
                        <!-- Dashboard View -->
                        <div id="view-dashboard" class="view-pane active">
                            <div class="trading-dashboard">
                                <!-- Performance Card -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“ˆ Performance</div>
                                        <div id="performance-change" class="card-change neutral">0.00%</div>
                                    </div>
                                    <div id="performance-value" class="card-value neutral">0.00000000</div>
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Session Target</span>
                                            <span id="target-progress">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="target-progress-bar" class="progress-fill primary" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Metrics Card -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">âš ï¸ Risk Metrics</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Drawdown</div>
                                            <div id="risk-dd" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.00%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Sharpe</div>
                                            <div id="risk-sharpe" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Win Rate</div>
                                            <div id="risk-winrate" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Profit Factor</div>
                                            <div id="risk-pf" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.00</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Trading Stats Card -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“Š Trading Stats</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Trades</div>
                                            <div id="stats-trades" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">W/L Ratio</div>
                                            <div id="stats-wl" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0/0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Avg Win</div>
                                            <div id="stats-avgwin" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.0000</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Avg Loss</div>
                                            <div id="stats-avgloss" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.0000</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Trade Card -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸŽ¯ Current Trade</div>
                                        <div id="trade-status" style="font-size: 11px; color: var(--text-secondary);">IDLE</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Next Bet</div>
                                            <div id="trade-nextbet" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.00000000</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Chance</div>
                                            <div id="trade-chance" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Mode</div>
                                            <div id="trade-mode" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">BASE</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Game</div>
                                            <div id="trade-game" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">DICE</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trading Controls -->
                            <div class="trading-controls">
                                <div class="control-grid">
                                    <button id="btn-start-trading" class="trading-btn trading-btn-success">
                                        <span>ðŸš€</span>
                                        START TRADING
                                    </button>
                                    <button id="btn-pause-trading" class="trading-btn trading-btn-warning">
                                        <span>â¸ï¸</span>
                                        PAUSE
                                    </button>
                                    <button id="btn-stop-trading" class="trading-btn trading-btn-danger">
                                        <span>ðŸ›‘</span>
                                        STOP
                                    </button>
                                </div>
                                
                                <div class="control-grid">
                                    <button class="trading-btn trading-btn-secondary mode-btn" data-mode="BASE">
                                        <span>ðŸ—ï¸</span>
                                        BASE MODE
                                    </button>
                                    <button class="trading-btn trading-btn-secondary mode-btn" data-mode="WAGER">
                                        <span>âš¡</span>
                                        WAGER MODE
                                    </button>
                                    <select id="p-currency" style="padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary); font-family: 'Inter';">
                                        <option value="loading">Loading currencies...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Recent Trades Log -->
                            <div class="trading-logs">
                                <div class="logs-header">
                                    <div class="card-title">ðŸ“ Recent Trades</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);" id="logs-count">0 trades</div>
                                </div>
                                <div class="logs-content" id="p-log-body">
                                    <!-- Logs will be inserted here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Trading View -->
                        <div id="view-trading" class="view-pane" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Game Selection -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸŽ® Game Selection</div>
                                    </div>
                                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                                        <button onclick="switchGame('DICE')" class="trading-btn trading-btn-secondary" style="flex: 1;">
                                            ðŸŽ² DICE
                                        </button>
                                        <button onclick="switchGame('FLIP')" class="trading-btn trading-btn-secondary" style="flex: 1;">
                                            ðŸ”„ FLIP
                                        </button>
                                    </div>
                                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                        <div style="font-size: 12px; color: var(--text-secondary);">Current Game:</div>
                                        <div style="font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; margin-top: 4px;">${bot.currentGame}</div>
                                    </div>
                                </div>
                                
                                <!-- Manual Control -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸŽ® Manual Control</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                                        <button onclick="forceFlipSide('heads')" class="trading-btn trading-btn-primary">
                                            ðŸŸ¡ HEADS
                                        </button>
                                        <button onclick="forceFlipSide('tails')" class="trading-btn trading-btn-warning">
                                            ðŸŸ  TAILS
                                        </button>
                                        <button onclick="forceCashout()" class="trading-btn trading-btn-success" style="grid-column: 1 / -1;">
                                            ðŸ’µ CASHOUT
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Current Game Stats -->
                                <div class="dashboard-card" style="grid-column: 1 / -1;">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“Š Game Statistics</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Bets</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.bets}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Wins</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.wins}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Losses</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.loss}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Win Rate</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.winRate.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recovery View -->
                        <div id="view-recovery" class="view-pane" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Recovery Stats -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ”„ Recovery Statistics</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">
                                            Level ${FlipRecovery.recoveryLevel}/3
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Success Rate</div>
                                            <div id="recovery-success-rate" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Progress</div>
                                            <div id="recovery-progress" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Drawdown</div>
                                            <div id="recovery-dd" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Trades</div>
                                            <div id="recovery-trades" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0</div>
                                        </div>
                                    </div>
                                    <div class="progress-container" style="margin-top: 16px;">
                                        <div class="progress-label">
                                            <span>Sequence Progress</span>
                                            <span id="sequence-progress">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="sequence-progress-bar" class="progress-fill warning" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Current Sequence -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“Š Current Sequence</div>
                                        <div id="recovery-strategy" style="font-size: 11px; color: var(--text-secondary;">
                                            Strategy: N/A
                                        </div>
                                    </div>
                                    <div style="margin: 16px 0;">
                                        <div id="recovery-sequence" style="font-size: 24px; font-family: 'JetBrains Mono'; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                            [ ]
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Next Bet</div>
                                            <div id="recovery-nextbet" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.00000000</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Current Side</div>
                                            <div id="recovery-side" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">N/A</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Trading Pattern -->
                                <div class="dashboard-card" style="grid-column: 1 / -1;">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“ˆ Trading Pattern</div>
                                        <div style="font-size: 11px; color: var(--text-secondary;">
                                            Last 10 trades
                                        </div>
                                    </div>
                                    <div style="margin: 16px 0; text-align: center;">
                                        <div id="pattern-chart" style="font-size: 24px; letter-spacing: 2px;">ðŸ“Š No trades yet</div>
                                    </div>
                                    <div style="display: flex; justify-content: center; gap: 12px; margin-top: 16px;">
                                        <button onclick="forceFlipSide('heads')" class="trading-btn trading-btn-primary" style="padding: 10px 20px;">
                                            ðŸŸ¡ HEADS
                                        </button>
                                        <button onclick="forceFlipSide('tails')" class="trading-btn trading-btn-warning" style="padding: 10px 20px;">
                                            ðŸŸ  TAILS
                                        </button>
                                        <button onclick="forceCashout()" class="trading-btn trading-btn-success" style="padding: 10px 20px;">
                                            ðŸ’µ CASHOUT
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics View -->
                        <div id="view-analytics" class="view-pane" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- Performance Analytics -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ“ˆ Performance Analytics</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Sharpe Ratio</div>
                                            <div id="analytics-sharpe" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.sharpeRatio.toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Profit Factor</div>
                                            <div id="analytics-pf" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.profitFactor.toFixed(2)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Expectancy</div>
                                            <div id="analytics-expectancy" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.expectancy.toFixed(4)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Recovery Factor</div>
                                            <div id="analytics-rf" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.recoveryFactor.toFixed(2)}</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 16px;">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Streaks</div>
                                        <div style="display: flex; gap: 12px;">
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Current Win</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; color: var(--accent-success);">${bot.stats.currentWinStreak}</div>
                                            </div>
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Max Win</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; color: var(--accent-success);">${bot.stats.longestWinStreak}</div>
                                            </div>
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Current Loss</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; color: var(--accent-danger);">${bot.stats.currentLossStreak}</div>
                                            </div>
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Max Loss</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; color: var(--accent-danger);">${bot.stats.longestLossStreak}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Session Analytics -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">â±ï¸ Session Analytics</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Session Time</div>
                                            <div id="session-time" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">00:00:00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Avg Time/Bet</div>
                                            <div id="avg-time-bet" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0s</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Bets/Hour</div>
                                            <div id="bets-hour" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Profit/Hour</div>
                                            <div id="profit-hour" style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">0.0000</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 16px;">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Biggest</div>
                                        <div style="display: flex; gap: 12px;">
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Win</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: var(--accent-success);">${bot.stats.biggestWin.toFixed(8)}</div>
                                            </div>
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Loss</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: var(--accent-danger);">${bot.stats.biggestLoss.toFixed(8)}</div>
                                            </div>
                                            <div style="flex: 1; text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-secondary);">Bet</div>
                                                <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: var(--accent-info);">${bot.stats.biggestBet.toFixed(8)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ROI Analysis -->
                                <div class="dashboard-card" style="grid-column: 1 / -1;">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ’° ROI Analysis</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Wagered</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600;">${bot.stats.wagered.toFixed(8)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Profit</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: ${bot.stats.profit >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'};">${bot.stats.profit.toFixed(8)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">ROI</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: ${bot.stats.roi >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'};">${bot.stats.roi.toFixed(2)}%</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Profit/Bet</div>
                                            <div style="font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; color: ${bot.stats.profitPerBet >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'};">${bot.stats.profitPerBet.toFixed(8)}</div>
                                        </div>
                                    </div>
                                    <div class="progress-container" style="margin-top: 16px;">
                                        <div class="progress-label">
                                            <span>Drawdown</span>
                                            <span>${bot.stats.maxDDPercent.toFixed(2)}%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill ${bot.stats.maxDDPercent > 10 ? 'danger' : bot.stats.maxDDPercent > 5 ? 'warning' : 'success'}" style="width: ${Math.min(100, bot.stats.maxDDPercent * 2)}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Settings View -->
                        <div id="view-settings" class="view-pane" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <!-- BASE Mode Settings -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ—ï¸ BASE Mode Settings</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Base Bet</label>
                                            <input type="number" id="p-basebet" value="0.00000100" step="0.00000001" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Base Chance Min</label>
                                                <input type="number" id="p-bch-min" value="85.0" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Base Chance Max</label>
                                                <input type="number" id="p-bch-max" value="90.0" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">High Chance Min</label>
                                                <input type="number" id="p-hch-min" value="25.0" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">High Chance Max</label>
                                                <input type="number" id="p-hch-max" value="35.0" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="p-base-progressive" style="width: 16px; height: 16px;">
                                            <label style="font-size: 12px; color: var(--text-primary);">Progressive Betting</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="p-base-recovery" style="width: 16px; height: 16px;">
                                            <label style="font-size: 12px; color: var(--text-primary);">Loss Recovery</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- WAGER Mode Settings -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">âš¡ WAGER Mode Settings</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Wager Chance (%)</label>
                                            <input type="number" id="p-wgr-chance" value="99.5" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Win Target</label>
                                                <input type="number" id="p-wgr-win-target" value="5" step="1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Stop Loss (%)</label>
                                                <input type="number" id="p-wgr-stoploss" value="10" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Win Multiplier</label>
                                                <input type="number" id="p-wgr-win-multiplier" value="1.2" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Profit Multiplier</label>
                                                <input type="number" id="p-wgr-profit-multiplier" value="1.5" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Profit Threshold (%)</label>
                                                <input type="number" id="p-wgr-profit-threshold" value="10" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Divisor</label>
                                                <input type="number" id="p-wgr-div" value="150" step="1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Recovery Settings -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ”„ Recovery Settings</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Recovery Threshold (%)</label>
                                            <input type="number" id="p-recovery-threshold" value="-1.5" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Flip Base Bet</label>
                                                <input type="number" id="p-flip-basebet" value="0.00000100" step="0.00000001" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Max Sequence</label>
                                                <input type="number" id="p-flip-max-sequence" value="15" step="1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                            </div>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Side Mode</label>
                                            <select id="p-flip-side-mode" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                                <option value="auto">Auto</option>
                                                <option value="heads">Heads Only</option>
                                                <option value="tails">Tails Only</option>
                                                <option value="manual">Manual</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Max Drawdown (%)</label>
                                            <input type="number" id="p-flip-max-dd" value="10" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="p-auto-recovery" style="width: 16px; height: 16px;" checked>
                                            <label style="font-size: 12px; color: var(--text-primary);">Auto Recovery</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="p-auto-switch-wager" style="width: 16px; height: 16px;">
                                            <label style="font-size: 12px; color: var(--text-primary);">Auto Switch to WAGER</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Risk Management -->
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <div class="card-title">âš ï¸ Risk Management</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Session Target (%)</label>
                                            <input type="number" id="p-session-target" value="0.1" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Session Stop Loss (%)</label>
                                            <input type="number" id="p-session-stoploss" value="0.05" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Max Bet % of Balance</label>
                                            <input type="number" id="p-max-bet-pct" value="5" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Stop Loss (%)</label>
                                            <input type="number" id="p-stoploss-pct" value="3.0" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Take Profit (%)</label>
                                            <input type="number" id="p-take-profit" value="0.3" step="0.1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Minimum Bet</label>
                                            <input type="number" id="p-minbet" value="0.00000001" step="0.00000001" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Max Sessions</label>
                                            <input type="number" id="p-max-sessions" value="20" step="1" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Save Settings -->
                                <div class="dashboard-card" style="grid-column: 1 / -1;">
                                    <div class="card-header">
                                        <div class="card-title">ðŸ’¾ Save & Load Settings</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
                                        <button onclick="saveSettings()" class="trading-btn trading-btn-success">
                                            ðŸ’¾ Save Settings
                                        </button>
                                        <button onclick="loadSettings()" class="trading-btn trading-btn-primary">
                                            ðŸ“‚ Load Settings
                                        </button>
                                        <button onclick="resetSettings()" class="trading-btn trading-btn-warning" style="grid-column: 1 / -1;">
                                            ðŸ”„ Reset to Default
                                        </button>
                                    </div>
                                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Settings Status</div>
                                        <div id="settings-status" style="font-family: 'JetBrains Mono'; font-size: 12px; color: var(--accent-info);">Settings not saved</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ==================== PROFESSIONAL UI FUNCTIONS ====================
    function setupProfessionalEventListeners() {
        // View tabs
        document.querySelectorAll('.view-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const viewId = this.getAttribute('data-view');
                
                // Update active tab
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show selected view
                document.querySelectorAll('.view-pane').forEach(pane => {
                    pane.style.display = 'none';
                });
                document.getElementById(`view-${viewId}`).style.display = 'block';
                
                // Refresh view data
                updateProfessionalUI();
            });
        });
        
        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const preset = this.getAttribute('data-preset');
                applyTradingPreset(preset);
            });
        });
        
        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const mode = this.getAttribute('data-mode');
                rotateMode(mode);
            });
        });
        
        // Trading buttons
        document.getElementById('btn-start-trading')?.addEventListener('click', startProfessionalTrading);
        document.getElementById('btn-pause-trading')?.addEventListener('click', togglePauseTrading);
        document.getElementById('btn-stop-trading')?.addEventListener('click', stopProfessionalTrading);
        document.getElementById('btn-quick-start')?.addEventListener('click', startProfessionalTrading);
        document.getElementById('btn-quick-pause')?.addEventListener('click', togglePauseTrading);
        document.getElementById('btn-quick-stop')?.addEventListener('click', stopProfessionalTrading);
        document.getElementById('btn-quick-cashout')?.addEventListener('click', forceCashout);
        
        // Currency selector
        const currencySelect = document.getElementById('p-currency');
        if (currencySelect) {
            currencySelect.addEventListener('change', async function() {
                bot.selectedCurrency = this.value;
                localStorage.setItem('orion_last_coin', bot.selectedCurrency);
                await updateBalanceDisplay();
            });
        }
    }
    
    function updateProfessionalUI() {
        try {
            // Update connection status
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                if (bot.isRunning) {
                    statusEl.className = 'status-indicator';
                    statusEl.style.background = '#238636';
                } else if (bot.isPaused) {
                    statusEl.className = 'status-indicator warning';
                } else {
                    statusEl.className = 'status-indicator offline';
                }
            }
            
            // Update sidebar
            document.getElementById('sidebar-balance').textContent = bot.stats.currentBal.toFixed(8);
            document.getElementById('sidebar-pnl').textContent = bot.stats.sessionProfit.toFixed(8);
            document.getElementById('sidebar-pnl').className = `card-value ${bot.stats.sessionProfit >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('sidebar-winrate').textContent = bot.stats.winRate.toFixed(1) + '%';
            
            // Update dashboard
            document.getElementById('performance-value').textContent = bot.stats.sessionProfit.toFixed(8);
            document.getElementById('performance-value').className = `card-value ${bot.stats.sessionProfit >= 0 ? 'positive' : 'negative'}`;
            
            const sessionProfitPct = bot.stats.sessionStartBal > 0 ? 
                (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100) : 0;
            document.getElementById('performance-change').textContent = sessionProfitPct.toFixed(2) + '%';
            document.getElementById('performance-change').className = `card-change ${sessionProfitPct >= 0 ? 'positive' : 'negative'}`;
            
            // Update target progress
            const sessionTargetPct = getVal("p-session-target") || 0.1;
            const targetProgress = (sessionProfitPct / sessionTargetPct) * 100;
            document.getElementById('target-progress').textContent = Math.min(100, targetProgress).toFixed(1) + '%';
            document.getElementById('target-progress-bar').style.width = Math.min(100, targetProgress) + '%';
            
            // Update risk metrics
            document.getElementById('risk-dd').textContent = bot.stats.maxDDPercent.toFixed(2) + '%';
            document.getElementById('risk-sharpe').textContent = bot.stats.sharpeRatio.toFixed(2);
            document.getElementById('risk-winrate').textContent = bot.stats.winRate.toFixed(1) + '%';
            document.getElementById('risk-pf').textContent = bot.stats.profitFactor.toFixed(2);
            
            // Update trading stats
            document.getElementById('stats-trades').textContent = bot.stats.bets;
            document.getElementById('stats-wl').textContent = `${bot.stats.wins}/${bot.stats.loss}`;
            document.getElementById('stats-avgwin').textContent = bot.stats.wins > 0 ? 
                (bot.stats.profit / bot.stats.wins).toFixed(4) : '0.0000';
            document.getElementById('stats-avgloss').textContent = bot.stats.loss > 0 ? 
                (Math.abs(bot.stats.profit) / bot.stats.loss).toFixed(4) : '0.0000';
            
            // Update current trade
            document.getElementById('trade-nextbet').textContent = bot.nextBet.toFixed(8);
            document.getElementById('trade-chance').textContent = bot.currentChance.toFixed(1) + '%';
            document.getElementById('trade-mode').textContent = bot.mode;
            document.getElementById('trade-game').textContent = bot.currentGame;
            document.getElementById('trade-status').textContent = bot.isRunning ? 
                (bot.isPaused ? 'PAUSED' : 'RUNNING') : 'IDLE';
            
            // Update logs count
            const logCount = document.getElementById('p-log-body')?.children.length || 0;
            document.getElementById('logs-count').textContent = `${logCount} trades`;
            
            // Update trading signals
            updateTradingSignals();
            
            // Update Flip Recovery UI if active
            updateRecoveryView();
            
            // Update analytics
            updateAnalyticsView();
            
        } catch (error) {
            console.error('UI update error:', error);
        }
    }
    
    function updateTradingSignals() {
        const signalsEl = document.getElementById('trading-signals');
        if (!signalsEl) return;
        
        const signals = FlipRecovery.isActive ? FlipRecovery.getTradingSignals() : [];
        
        if (signals.length === 0) {
            signalsEl.innerHTML = `
                <div style="color: var(--text-muted); font-size: 11px; text-align: center; padding: 20px;">
                    ${bot.isRunning ? 'Analyzing market...' : 'Waiting for market data...'}
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-wrap: wrap; gap: 6px;">';
        signals.forEach(signal => {
            let className = 'signal-neutral';
            let icon = 'ðŸ“Š';
            
            switch(signal.type) {
                case 'OVERBOUGHT':
                    className = 'signal-sell';
                    icon = 'ðŸ“‰';
                    break;
                case 'OVERSOLD':
                    className = 'signal-buy';
                    icon = 'ðŸ“ˆ';
                    break;
                case 'WIN_STREAK':
                    className = 'signal-buy';
                    icon = 'ðŸ”¥';
                    break;
                case 'LOSE_STREAK':
                    className = 'signal-sell';
                    icon = 'ðŸ’€';
                    break;
                case 'HIGH_VOLUME':
                    className = 'signal-warning';
                    icon = 'âš¡';
                    break;
            }
            
            html += `
                <div class="signal-badge ${className}">
                    ${icon} ${signal.type.replace('_', ' ')} ${signal.value}
                </div>
            `;
        });
        html += '</div>';
        
        signalsEl.innerHTML = html;
    }
    
    function updateRecoveryView() {
        if (!FlipRecovery.isActive) return;
        
        const stats = FlipRecovery.getRecoveryStats();
        const patternChart = FlipRecovery.getPatternChart();
        
        // Update recovery stats
        document.getElementById('recovery-success-rate').textContent = stats.successRate + '%';
        document.getElementById('recovery-progress').textContent = stats.recoveryProgress + '%';
        document.getElementById('recovery-dd').textContent = stats.currentDD + '%';
        document.getElementById('recovery-trades').textContent = stats.activeTrades;
        document.getElementById('sequence-progress').textContent = FlipRecovery.getProgress().toFixed(1) + '%';
        document.getElementById('sequence-progress-bar').style.width = FlipRecovery.getProgress() + '%';
        document.getElementById('recovery-strategy').textContent = `Strategy: ${FlipRecovery.getStrategyName()}`;
        document.getElementById('recovery-sequence').textContent = `[${FlipRecovery.sequence.join(', ')}]`;
        document.getElementById('recovery-nextbet').textContent = FlipRecovery.getNextBet().toFixed(8);
        document.getElementById('recovery-side').textContent = FlipRecovery.currentSide.toUpperCase();
        document.getElementById('pattern-chart').textContent = patternChart;
    }
    
    function updateAnalyticsView() {
        // Calculate session time
        let sessionTime = '00:00:00';
        if (bot.startTime) {
            const diff = Date.now() - bot.startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            sessionTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Calculate average time per bet
        let avgTimeBet = '0s';
        if (bot.stats.bets > 0 && bot.startTime) {
            const avgTime = (Date.now() - bot.startTime) / bot.stats.bets / 1000;
            avgTimeBet = avgTime.toFixed(1) + 's';
        }
        
        // Calculate bets per hour
        let betsHour = 0;
        if (bot.startTime && bot.stats.bets > 0) {
            const hours = (Date.now() - bot.startTime) / 3600000;
            betsHour = hours > 0 ? (bot.stats.bets / hours) : bot.stats.bets;
        }
        
        // Calculate profit per hour
        let profitHour = 0;
        if (bot.startTime && bot.stats.profit !== 0) {
            const hours = (Date.now() - bot.startTime) / 3600000;
            profitHour = hours > 0 ? (bot.stats.profit / hours) : bot.stats.profit;
        }
        
        // Update analytics view
        document.getElementById('session-time').textContent = sessionTime;
        document.getElementById('avg-time-bet').textContent = avgTimeBet;
        document.getElementById('bets-hour').textContent = betsHour.toFixed(1);
        document.getElementById('profit-hour').textContent = profitHour.toFixed(4);
        document.getElementById('analytics-sharpe').textContent = bot.stats.sharpeRatio.toFixed(2);
        document.getElementById('analytics-pf').textContent = bot.stats.profitFactor.toFixed(2);
        document.getElementById('analytics-expectancy').textContent = bot.stats.expectancy.toFixed(4);
        document.getElementById('analytics-rf').textContent = bot.stats.recoveryFactor.toFixed(2);
    }
    
    // Settings functions
    function saveSettings() {
        const settings = {};
        
        // Collect all settings
        const inputs = document.querySelectorAll('#view-settings input, #view-settings select');
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                settings[input.id] = input.checked;
            } else {
                settings[input.id] = input.value;
            }
        });
        
        // Save to localStorage
        localStorage.setItem('orion_trader_settings', JSON.stringify(settings));
        
        // Update status
        document.getElementById('settings-status').textContent = 'Settings saved successfully';
        document.getElementById('settings-status').style.color = '#238636';
        
        setTimeout(() => {
            document.getElementById('settings-status').textContent = 'Settings loaded from storage';
            document.getElementById('settings-status').style.color = '#58A6FF';
        }, 3000);
        
        console.log('Settings saved:', settings);
    }
    
    function loadSettings() {
        try {
            const saved = localStorage.getItem('orion_trader_settings');
            if (!saved) {
                document.getElementById('settings-status').textContent = 'No saved settings found';
                document.getElementById('settings-status').style.color = '#F59E0B';
                return;
            }
            
            const settings = JSON.parse(saved);
            
            // Apply settings
            for (const [id, value] of Object.entries(settings)) {
                const el = document.getElementById(id);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = Boolean(value);
                    } else if (el.tagName === 'SELECT') {
                        el.value = value;
                        el.dispatchEvent(new Event('change'));
                    } else {
                        el.value = value;
                    }
                }
            }
            
            document.getElementById('settings-status').textContent = 'Settings loaded successfully';
            document.getElementById('settings-status').style.color = '#238636';
            
            setTimeout(() => {
                document.getElementById('settings-status').textContent = 'Settings loaded from storage';
                document.getElementById('settings-status').style.color = '#58A6FF';
            }, 3000);
            
            console.log('Settings loaded:', settings);
            
        } catch (error) {
            document.getElementById('settings-status').textContent = 'Error loading settings';
            document.getElementById('settings-status').style.color = '#DA3633';
            console.error('Load settings error:', error);
        }
    }
    
    function resetSettings() {
        // Reset to default preset (Balanced)
        applyTradingPreset("BALANCED");
        
        document.getElementById('settings-status').textContent = 'Settings reset to default';
        document.getElementById('settings-status').style.color = '#F59E0B';
        
        setTimeout(() => {
            document.getElementById('settings-status').textContent = 'Settings loaded from storage';
            document.getElementById('settings-status').style.color = '#58A6FF';
        }, 3000);
    }
    
    // ==================== PROFESSIONAL TRADING FUNCTIONS ====================
    async function startProfessionalTrading() {
        if (bot.isRunning) return;
        
        const currencySelect = document.getElementById('p-currency');
        if (currencySelect) {
            bot.selectedCurrency = currencySelect.value;
            localStorage.setItem('orion_last_coin', bot.selectedCurrency);
        }
        
        await API.syncOnce();
        
        // Initialize session
        bot.session.maxSessions = getVal("p-max-sessions") || 20;
        bot.session.currentSession = 1;
        
        // Get initial balance
        bot.stats.startBal = await API.getBalance(bot.selectedCurrency);
        bot.stats.currentBal = bot.stats.startBal;
        bot.stats.sessionStartBal = bot.stats.startBal;
        
        // Reset statistics
        resetTradingStatistics();
        
        // Set session target
        const sessionTargetPct = getVal("p-session-target") || 0.1;
        bot.session.sessionTargetAbs = bot.stats.sessionStartBal * (sessionTargetPct / 100);
        
        // Initialize bot state
        bot.isRunning = true;
        bot.isPaused = false;
        bot.startTime = Date.now();
        bot.stopTime = null;
        bot.lastReportTime = Date.now();
        bot.lastChartUpdate = Date.now();
        
        // Reset session history
        bot.session.sessionHistory = [];
        bot.session.sessionStartTime = Date.now();
        
        // Initialize WAGER mode
        bot.wgr.balhigh = bot.stats.startBal;
        bot.wgr.profitc = 0;
        bot.wgr.ctwin = 0;
        bot.wgr.betload = 0;
        
        // Start in BASE mode
        rotateToBaseMode();
        
        // Clear logs
        const logBody = document.getElementById("p-log-body");
        if (logBody) logBody.innerHTML = "";
        
        // Log session start
        updateLogs(0, 0, "TRADING", 0, `ðŸ Session ${bot.session.currentSession} started | Target: ${sessionTargetPct}% | Balance: ${bot.stats.startBal.toFixed(8)}`);
        
        // Update status
        updateStatus("ðŸš€ TRADING ACTIVE", "#10B981");
        
        // Send telegram report
        await sendTelegramReport("start");
        
        // Start main loop
        runProfessionalTrading();
    }
    
    function resetTradingStatistics() {
        bot.stats.sessionProfit = 0;
        bot.stats.sessionWagered = 0;
        bot.stats.sessionBets = 0;
        bot.stats.profit = 0;
        bot.stats.wagered = 0;
        bot.stats.bets = 0;
        bot.stats.wins = 0;
        bot.stats.loss = 0;
        bot.stats.maxDD = 0;
        bot.stats.maxDDPercent = 0;
        bot.stats.peakBalance = bot.stats.startBal;
        bot.stats.biggestBet = 0;
        bot.stats.biggestWin = 0;
        bot.stats.biggestLoss = 0;
        bot.stats.currentWinStreak = 0;
        bot.stats.currentLossStreak = 0;
        bot.stats.longestWinStreak = 0;
        bot.stats.longestLossStreak = 0;
        bot.stats.sharpeRatio = 0;
        bot.stats.profitFactor = 0;
        bot.stats.expectancy = 0;
        bot.stats.recoveryFactor = 0;
    }
    
    async function runProfessionalTrading() {
        if (!bot.isRunning || bot.isPaused) return;
        
        try {
            // Check recovery trigger
            if (!FlipRecovery.isActive && bot.currentGame === "DICE") {
                checkRecoveryTrigger();
            }
            
            // FLIP RECOVERY MODE
            if (FlipRecovery.isActive) {
                await executeFlipTrade();
            } 
            // REGULAR DICE MODE
            else if (bot.currentGame === "DICE") {
                await executeDiceTrade();
            }
            
            // Schedule next iteration
            setTimeout(runProfessionalTrading, bot.currentGame === "FLIP" ? 1000 : 0);
            
        } catch (error) {
            console.error("Trading error:", error);
            setTimeout(runProfessionalTrading, 100);
        }
    }
    
    async function executeFlipTrade() {
        try {
            let flipResult;
            
            // Check if we have an active game that can continue
            if (FlipRecovery.canContinue && FlipRecovery.activeGameId) {
                // Continue with next round
                flipResult = await FlipAPI.flipNextRound(FlipRecovery.currentSide);
            } else {
                // Start new flip game
                flipResult = await FlipAPI.startFlipGame(
                    FlipRecovery.getNextBet(),
                    FlipRecovery.currentSide
                );
                
                // Store game ID if active
                if (flipResult.active) {
                    FlipRecovery.activeGameId = flipResult.gameId;
                }
            }
            
            if (flipResult.success) {
                const win = flipResult.win;
                const profit = flipResult.profit;
                
                // Update statistics
                updateStatsSync(flipResult.game, win, profit);
                
                // Log the trade
                updateLogs(
                    FlipRecovery.getNextBet(),
                    50,
                    `FLIP (${FlipRecovery.currentSide.toUpperCase()})`,
                    profit,
                    win ? `âœ… WIN | Multiplier: ${flipResult.game?.payoutMultiplier || 1.96}x` : `âŒ LOSS`
                );
                
                // Analyze trade and get decision
                const analysis = FlipRecovery.analyzeTrade(win, profit, flipResult.game);
                const tradeResult = FlipRecovery.handleTradeResult(analysis);
                
                // Update UI
                updateRecoveryView();
                
                // Handle trade result
                if (tradeResult.complete) {
                    // Recovery completed
                    return;
                }
                
                // Update active game state
                FlipRecovery.canContinue = tradeResult.gameActive;
                if (!tradeResult.gameActive) {
                    FlipRecovery.activeGameId = null;
                }
                
                // Send report every 5 flips
                if (FlipRecovery.flipsCompleted % 5 === 0) {
                    sendTelegramReport("flip_recovery_update");
                }
            }
            
        } catch (error) {
            console.error("Flip trade execution error:", error);
            updateLogs(0, 0, "ERROR", 0, `Flip trade failed: ${error.message}`);
        }
    }
    
    async function executeDiceTrade() {
        try {
            const result = await API.placeBet("DICE", {
                amount: bot.nextBet,
                chance: bot.currentChance
            });
            
            const dice = result?.data?.diceRoll || result?.diceRoll;
            if (dice) {
                const win = dice.payout > 0;
                const profit = dice.payout - dice.amount;
                
                updateStatsSync(dice, win, profit);
                
                // Enhanced logging
                const logType = win ? "âœ… WIN" : "âŒ LOSS";
                const streak = win ? bot.stats.currentWinStreak : bot.stats.currentLossStreak;
                const streakText = streak > 1 ? ` | Streak: ${streak}` : '';
                
                updateLogs(
                    dice.amount,
                    bot.currentChance,
                    bot.mode,
                    profit,
                    `${logType} | Chance: ${bot.currentChance.toFixed(1)}%${streakText}`
                );
                
                if (bot.mode === "BASE") {
                    handleBaseMode(win);
                } else if (bot.mode === "WAGER") {
                    handleWagerMode(win);
                }
                
                // Risk management
                const minBet = getVal("p-minbet") || 0.00000001;
                bot.nextBet = Math.max(bot.nextBet, minBet);
                
                // Update statistics every 5 bets
                if (bot.stats.bets % 5 === 0) {
                    updateTradingMetrics();
                }
                
                // Send auto report every 5 minutes
                if (Date.now() - bot.lastReportTime >= 300000) {
                    sendTelegramReport("auto");
                }
            }
            
        } catch (error) {
            console.error("Dice trade error:", error);
            updateLogs(0, 0, "ERROR", 0, `Dice trade failed: ${error.message}`);
        }
    }
    
    function updateTradingMetrics() {
        // Calculate advanced metrics
        if (bot.stats.bets > 0) {
            // Expectancy
            const avgWin = bot.stats.wins > 0 ? bot.stats.profit / bot.stats.wins : 0;
            const avgLoss = bot.stats.loss > 0 ? Math.abs(bot.stats.profit) / bot.stats.loss : 0;
            const winRate = bot.stats.winRate / 100;
            bot.stats.expectancy = (winRate * avgWin) - ((1 - winRate) * avgLoss);
            
            // Sharpe Ratio (simplified)
            const returns = bot.performanceLogs || [];
            if (returns.length > 1) {
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / returns.length;
                const stdDev = Math.sqrt(variance);
                bot.stats.sharpeRatio = stdDev > 0 ? mean / stdDev : 0;
            }
            
            // Recovery Factor
            bot.stats.recoveryFactor = bot.stats.maxDD > 0 ? bot.stats.profit / bot.stats.maxDD : 0;
        }
    }
    
    function togglePauseTrading() {
        bot.isPaused = !bot.isPaused;
        updateStatus(bot.isPaused ? "â¸ï¸ TRADING PAUSED" : "ðŸš€ TRADING ACTIVE",
                   bot.isPaused ? "#F59E0B" : "#10B981");
        updateLogs(0, 0, "SYSTEM", 0, bot.isPaused ? "Trading paused" : "Trading resumed");
    }
    
    async function stopProfessionalTrading() {
        bot.isRunning = false;
        bot.stopTime = Date.now();
        await updateBalanceDisplay();
        updateStatus("ðŸ›‘ TRADING STOPPED", "#EF4444");
        updateLogs(0, 0, "SYSTEM", 0, "Trading session stopped");
        await sendTelegramReport("stop");
    }
    
    // ==================== GLOBAL FUNCTIONS ====================
    if (typeof window !== 'undefined') {
        window.applyTradingPreset = applyTradingPreset;
        window.rotateMode = rotateMode;
        window.switchGame = switchGame;
        window.forceFlipSide = forceFlipSide;
        window.forceCashout = forceCashout;
        window.startProfessionalTrading = startProfessionalTrading;
        window.stopProfessionalTrading = stopProfessionalTrading;
        window.togglePauseTrading = togglePauseTrading;
        window.getVal = getVal;
        window.updateLogs = updateLogs;
        window.updateStatus = updateStatus;
        window.saveSettings = saveSettings;
        window.loadSettings = loadSettings;
        window.resetSettings = resetSettings;
    }
    
    // ==================== INITIALIZATION ====================
    async function initializeProfessional() {
        const isValid = await validateLicense();
        
        if (isValid) {
            console.log(`âœ… Professional trading bot initialized for ${currentUser}`);
            bot.licenseTier = licenseData.tier;
            bot.stakeUser = currentUser;
            
            createProfessionalUI();
            
            // Load saved settings
            setTimeout(loadSettings, 1000);
            
            // Initialize Flip Recovery with professional stats
            FlipRecovery.stats = {
                totalRecoveries: 0,
                successfulRecoveries: 0,
                failedRecoveries: 0,
                totalRecovered: 0,
                totalTime: 0,
                totalFlips: 0,
                winRate: 0,
                profitFactor: 0,
                sharpeRatio: 0
            };
            
        } else {
            console.log("âŒ License invalid or user not whitelisted");
        }
    }
    
    // Start professional bot
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeProfessional);
    } else {
        initializeProfessional();
    }

})();

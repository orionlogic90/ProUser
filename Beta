(function () {
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/api'; },
        get wsUrl() { return 'wss://ws.stake.com/socket.io/?EIO=3&transport=websocket'; },
        version: "ORION PREMIUM HYBRID v5.1 FIXED",
        tgToken: '8391763291:AAEA05v6FG70eM1WGrgU7mrPgckfjQaxkno',
        tgChatId: '-1003744641395',
        supportContact: '@OrionLogic'
    };

    // ==================== WHITELIST SYSTEM ====================
    const WHITELIST = {
        "orionlogic": { tier: "VIP", expiry: "2099-12-31" },
        "biele": { tier: "PREMIUM", expiry: "2026-02-26" },
        "siska82": { tier: "PREMIUM", expiry: "2026-02-26" },
        "dfransiska": { tier: "PREMIUM", expiry: "2026-02-26" },
        "brokenpips": { tier: "PREMIUM", expiry: "2026-02-26" },
        "aynus": { tier: "PREMIUM", expiry: "2026-02-26" },
        "terbaik444": { tier: "PREMIUM", expiry: "2026-01-30" },
        "k4pitiang": { tier: "PREMIUM", expiry: "2026-02-26" }
    };

    // ==================== PRESET SYSTEM ====================
    const PRESETS = {
        "SAFE": {
            name: "üîí SAFE",
            baseChanceMin: 90,
            baseChanceMax: 98,
            wagerChance: 99.5,
            stopLoss: 1.0,
            targetProfit: 3.0,
            riskPerTrade: 0.5,
            trailDistance: 0.5
        },
        "BALANCED": {
            name: "‚öñÔ∏è BALANCED",
            baseChanceMin: 85,
            baseChanceMax: 95,
            wagerChance: 99.0,
            stopLoss: 2.0,
            targetProfit: 5.0,
            riskPerTrade: 1.0,
            trailDistance: 1.0
        },
        "AGGRESSIVE": {
            name: "‚ö° AGGRESSIVE",
            baseChanceMin: 75,
            baseChanceMax: 90,
            wagerChance: 98.0,
            stopLoss: 3.0,
            targetProfit: 8.0,
            riskPerTrade: 2.0,
            trailDistance: 2.0
        },
        "WAGER_FARM": {
            name: "üèÉ WAGER FARM",
            baseChanceMin: 88,
            baseChanceMax: 96,
            wagerChance: 99.0,
            stopLoss: 2.5,
            targetProfit: 4.0,
            wagerTarget: 300,
            riskPerTrade: 0.3,
            trailDistance: 0.3
        }
    };

    // ==================== LICENSE VALIDATION ====================
    let currentUser = null;
    let licenseData = null;

    async function validateLicense() {
        try {
            const token = localStorage.getItem('apitoken') || 
                         (document.cookie.match(/session=([^;]+)/) ? 
                          document.cookie.match(/session=([^;]+)/)[1] : null);

            if (!token) {
                showLicenseModal("Please login to Stake.com first");
                return false;
            }

            const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "x-access-token": token 
                },
                body: JSON.stringify({ query: `query{user{name}}` })
            });

            const data = await response.json();
            const username = data?.data?.user?.name?.toLowerCase();

            if (!username) {
                showLicenseModal("Cannot retrieve username");
                return false;
            }

            currentUser = username;
            licenseData = WHITELIST[username];
            
            if (!licenseData) {
                showLicenseModal(
                    `Username <strong>${username}</strong> is not whitelisted.`, 
                    true
                );
                return false;
            }

            const expiryDate = new Date(licenseData.expiry);
            if (new Date() > expiryDate) {
                showLicenseModal(
                    `License expired on ${expiryDate.toLocaleDateString()}.`, 
                    true
                );
                return false;
            }

            console.log(`‚úÖ License validated: ${username} (${licenseData.tier})`);
            return true;

        } catch (error) {
            console.error("License validation error:", error);
            showLicenseModal("Connection error. Please refresh.");
            return false;
        }
    }

    function showLicenseModal(message, showPurchase = false) {
        const modal = document.createElement('div');
        modal.id = 'orion-license-modal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,15,25,0.98); display: flex; align-items: center;
            justify-content: center; z-index: 99999; backdrop-filter: blur(20px);
            font-family: 'Segoe UI', system-ui;
        `;

        modal.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                border: 2px solid ${showPurchase ? '#8b5cf6' : '#3b82f6'}; 
                border-radius: 20px; padding: 30px;
                width: 90%; max-width: 500px; color: #e2e8f0; text-align: center;
                box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
            ">
                <div style="font-size: 28px; font-weight: 800; margin-bottom: 10px;
                    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                    -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    üîê ORION PREMIUM
                </div>
                
                <div style="color: #94a3b8; margin-bottom: 25px; font-size: 14px; line-height: 1.5;">
                    ${message}
                </div>
                
                ${currentUser ? `
                <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; 
                    border-radius: 10px; margin: 20px 0; text-align: center;">
                    <div style="font-size: 12px; color: #60a5fa; margin-bottom: 5px;">
                        üîç Detected Username:
                    </div>
                    <div style="font-size: 18px; font-weight: bold; color: white; font-family: monospace;">
                        ${currentUser}
                    </div>
                </div>
                ` : ''}
                
                ${showPurchase ? `
                <div style="margin: 25px 0;">
                    <div style="font-size: 16px; font-weight: bold; color: #fbbf24; margin-bottom: 15px;">
                        üí∞ PURCHASE LICENSE
                    </div>
                    
                    <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 18px; color: #3b82f6; font-weight: bold;">‚ö° MONTHLY</div>
                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">$30</div>
                            <div style="font-size: 12px; color: #94a3b8;">
                                Full Access ‚Ä¢ 30 Days ‚Ä¢ Priority Support
                            </div>
                        </div>
                        
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 15px; border-radius: 10px;">
                            <div style="font-size: 18px; color: #8b5cf6; font-weight: bold;">üëë LIFETIME</div>
                            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">$99</div>
                            <div style="font-size: 12px; color: #94a3b8;">
                                Lifetime Access ‚Ä¢ VIP Features ‚Ä¢ All Updates
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 12px; color: #fbbf24;">
                            üìù Contact <a href="https://t.me/${CONFIG.supportContact.replace('@', '')}" target="_blank" 
                            style="color: #60a5fa; font-weight: bold;">${CONFIG.supportContact}</a> on Telegram
                        </div>
                    </div>
                    
                    <button onclick="window.open('https://t.me/${CONFIG.supportContact.replace('@', '')}', '_blank')"
                        style="background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                        color: white; border: none; padding: 14px; border-radius: 10px;
                        font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 8px;">
                        üì± CONTACT ON TELEGRAM
                    </button>
                </div>
                ` : ''}
                
                <button onclick="location.reload()"
                    style="background: ${showPurchase ? 'transparent' : 'linear-gradient(135deg, #3b82f6, #8b5cf6)'}; 
                    border: 1px solid ${showPurchase ? '#475569' : 'transparent'};
                    color: ${showPurchase ? '#94a3b8' : 'white'}; 
                    padding: 12px 30px; border-radius: 10px;
                    font-weight: 600; cursor: pointer; width: 100%;">
                    ${showPurchase ? 'Close' : 'üîÅ Retry'}
                </button>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #334155;">
                    <div style="font-size: 11px; color: #64748b;">
                        Support: <a href="https://t.me/${CONFIG.supportContact.replace('@', '')}" target="_blank" 
                        style="color: #60a5fa; font-weight: bold;">${CONFIG.supportContact}</a>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // ==================== ENHANCED FEATURES ====================
    const trailingStop = {
        enabled: false,
        trailDistance: 1.0,
        peakBalance: 0,
        triggerPoint: 0,
        isTrailing: false
    };

    const riskManager = {
        maxRiskPerTrade: 1.0,
        useKelly: false,
        kellyFraction: 0.5,
        minBetOverride: true,
        
        calculateMaxBet(balance, winRate, payoutRatio) {
            if (!this.maxRiskPerTrade) return Infinity;
            
            const maxByRisk = balance * (this.maxRiskPerTrade / 100);
            
            if (this.useKelly && winRate > 0 && payoutRatio > 0) {
                const p = winRate / 100;
                const q = 1 - p;
                const b = payoutRatio;
                const kelly = (p * b - q) / b;
                
                if (kelly > 0) {
                    const kellyBet = balance * kelly * this.kellyFraction;
                    return Math.min(maxByRisk, kellyBet);
                }
            }
            
            return maxByRisk;
        },
        
        adjustBetSize(proposedBet) {
            const balance = bot.stats.currentBal;
            const winRate = bot.stats.bets > 0 ? (bot.stats.wins / bot.stats.bets * 100) : 50;
            const payoutRatio = (100 / bot.currentChance) - 1;
            
            const maxBet = this.calculateMaxBet(balance, winRate, payoutRatio);
            const minBet = getVal("p-minbet");
            
            return Math.max(minBet, Math.min(proposedBet, maxBet));
        }
    };

    const analytics = {
        history: [],
        sessionStart: null,
        metrics: {
            sharpeRatio: 0,
            maxDrawdown: 0,
            volatility: 0,
            profitFactor: 0,
            expectancy: 0
        },
        
        recordTrade(amount, profit, chance, mode) {
            const trade = {
                timestamp: Date.now(),
                amount,
                profit,
                chance,
                mode,
                balance: bot.stats.currentBal,
                cumulativeProfit: bot.stats.profit
            };
            
            this.history.push(trade);
            
            if (this.history.length > 1000) {
                this.history.shift();
            }
            
            this.calculateMetrics();
        },
        
        calculateMetrics() {
            if (this.history.length < 2) return;
            
            const profits = this.history.map(t => t.profit);
            const wins = profits.filter(p => p > 0);
            const losses = profits.filter(p => p < 0);
            
            const avgReturn = profits.reduce((a, b) => a + b, 0) / profits.length;
            const stdDev = Math.sqrt(
                profits.map(p => Math.pow(p - avgReturn, 2))
                       .reduce((a, b) => a + b, 0) / profits.length
            );
            this.metrics.sharpeRatio = stdDev !== 0 ? avgReturn / stdDev : 0;
            
            let peak = this.history[0].balance;
            let maxDD = 0;
            
            this.history.forEach(trade => {
                if (trade.balance > peak) peak = trade.balance;
                const drawdown = (peak - trade.balance) / peak * 100;
                if (drawdown > maxDD) maxDD = drawdown;
            });
            
            this.metrics.maxDrawdown = maxDD;
            
            const totalWins = wins.reduce((a, b) => a + b, 0);
            const totalLosses = Math.abs(losses.reduce((a, b) => a + b, 0));
            this.metrics.profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins;
            
            const avgWin = wins.length > 0 ? totalWins / wins.length : 0;
            const avgLoss = losses.length > 0 ? totalLosses / losses.length : 0;
            const winRate = wins.length / profits.length;
            this.metrics.expectancy = (winRate * avgWin) - ((1 - winRate) * avgLoss);
            this.metrics.volatility = stdDev;
        }
    };

    // ==================== WEBSOCKET MANAGER ====================
    const WebSocketManager = {
        ws: null,
        connected: false,
        reconnectAttempts: 0,
        maxReconnectAttempts: 10,
        reconnectDelay: 3000,
        
        async connect() {
            try {
                this.ws = new WebSocket(CONFIG.wsUrl);
                
                this.ws.onopen = () => {
                    console.log("‚úÖ WebSocket connected");
                    this.connected = true;
                    this.reconnectAttempts = 0;
                    updateStatus("üîó WS Connected", "#10b981");
                    this.authenticate();
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (e) {
                        console.log("WS raw:", event.data);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log("‚ùå WebSocket disconnected");
                    this.connected = false;
                    updateStatus("üîå WS Disconnected", "#ef4444");
                    this.reconnect();
                };
                
                this.ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };
                
            } catch (error) {
                console.error("WebSocket connection failed:", error);
                this.reconnect();
            }
        },
        
        authenticate() {
            if (!this.ws || !bot.token) return;
            
            const authMessage = {
                type: "auth",
                token: bot.token
            };
            
            this.send(authMessage);
        },
        
        send(message) {
            if (this.ws && this.connected) {
                this.ws.send(JSON.stringify(message));
            }
        },
        
        handleMessage(data) {
            if (data.type === "balance_update") {
                bot.stats.currentBal = parseFloat(data.amount);
                if (document.getElementById("st-bal")) {
                    document.getElementById("st-bal").innerText = bot.stats.currentBal.toFixed(8);
                }
            }
        },
        
        reconnect() {
            if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                console.log("Max reconnection attempts reached");
                return;
            }
            
            this.reconnectAttempts++;
            const delay = this.reconnectDelay * Math.pow(1.5, this.reconnectAttempts - 1);
            
            console.log(`Reconnecting in ${delay/1000}s... (Attempt ${this.reconnectAttempts})`);
            
            setTimeout(() => {
                this.connect();
            }, delay);
        },
        
        disconnect() {
            if (this.ws) {
                this.ws.close();
                this.ws = null;
                this.connected = false;
            }
        }
    };

    // ==================== BOT ENGINE ====================
    const bot = {
        isRunning: false, 
        isPaused: false, 
        mode: "BASE", 
        token: null, 
        stakeUser: "Loading...", 
        startTime: null, 
        stopTime: null, 
        lastSwitchTime: null,
        stats: { 
            profit: 0, 
            wagered: 0, 
            startBal: 0, 
            currentBal: 0, 
            bets: 0, 
            wins: 0, 
            loss: 0, 
            maxDD: 0, 
            maxProfit: 0,
            sessionProfit: 0,
            sessionStart: null
        },
        selectedCurrency: localStorage.getItem('orion_last_coin') || "usdt", 
        nextBet: 0, 
        currentChance: 0, 
        currentMulti: 0,
        ls: 0, 
        lc: 0, 
        bcount: 0, 
        partialProfit: 0, 
        targetAbs: 0,
        wgr: { 
            ctwin: 0, 
            balhigh: 0, 
            profitc: 0, 
            betload: 0 
        },
        lastReportPct: 0,
        lastReportTime: 0,
        chartData: [],
        lastChartPct: 0,
        chartCandles: [],
        currentTrend: "SIDEWAYS",
        shootCount: 0,
        maxShots: 3,
        isShooting: false,
        licenseTier: "PREMIUM",
        supportContact: CONFIG.supportContact,
        currentPreset: "BALANCED",
        isMinimized: false,
        
        settings: {
            stopLossEnabled: true,
            stopLossPercent: 2.0,
            modeBase: true,
            modeWager: true,
            chartEnabled: true,
            autoSwitchEnabled: true,
            profitTargetEnabled: true,
            profitTargetPercent: 5.0,
            sessionProfitTarget: 0,
            usePreset: true,
            trailingStopEnabled: false,
            riskManagementEnabled: true,
            useWebSocket: true
        }
    };

    const API = {
        async syncOnce() {
            bot.token = localStorage.getItem('apitoken') || (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST", 
                    headers: { 
                        "Content-Type": "application/json", 
                        "x-access-token": bot.token 
                    },
                    body: JSON.stringify({ 
                        query: `query{user{name balances{available{amount currency}}}}` 
                    })
                });
                const json = await res.json();
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;
                    const bals = json.data.user.balances || [];
                    const sel = document.getElementById("p-currency");
                    
                    if (sel) {
                        const currentSelected = sel.value || bot.selectedCurrency;
                        sel.innerHTML = ""; 

                        bals.forEach(b => {
                            const opt = new Option(
                                `${b.available.currency.toUpperCase()} (${parseFloat(b.available.amount).toFixed(2)})`, 
                                b.available.currency
                            );
                            if(b.available.currency === currentSelected) opt.selected = true;
                            sel.add(opt);
                        });
                        bot.selectedCurrency = sel.value;
                    }
                    
                    await updateBalanceDisplay();
                }
            } catch (e) { 
                console.error("Sync Error:", e); 
            }
        },

        async getBalance(coin) {
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST", 
                    headers: { 
                        "Content-Type": "application/json", 
                        "x-access-token": bot.token 
                    },
                    body: JSON.stringify({ 
                        query: `query{user{balances{available{amount currency}}}}` 
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(
                    b => b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                return active ? parseFloat(active.available.amount) : 0;
            } catch (e) { 
                console.error("Balance Error:", e);
                return 0; 
            }
        },

        async placeBet(amount, chance) {
            const payload = { 
                amount: parseFloat(amount.toFixed(8)), 
                currency: bot.selectedCurrency, 
                target: (100 - chance).toFixed(1), 
                condition: "above", 
                identifier: Math.random().toString(36).slice(2) 
            };
            try {
                const r = await fetch(`${CONFIG.apiUrl}/casino/dice/roll`, { 
                    method: "POST", 
                    headers: { 
                        "Content-Type": "application/json", 
                        "x-access-token": bot.token 
                    }, 
                    body: JSON.stringify(payload) 
                });
                return r.json();
            } catch (error) {
                console.error("Bet Error:", error);
                throw error;
            }
        }
    };

    // ==================== ENHANCED FUNCTIONS ====================
    function updateTrailingStop() {
        if (!trailingStop.enabled || !bot.isRunning) return false;
        
        if (bot.stats.currentBal > trailingStop.peakBalance) {
            trailingStop.peakBalance = bot.stats.currentBal;
            trailingStop.triggerPoint = trailingStop.peakBalance * (1 - trailingStop.trailDistance / 100);
            trailingStop.isTrailing = true;
            
            const trailEl = document.getElementById("trailing-info");
            if (trailEl) {
                trailEl.innerHTML = `Peak: ${trailingStop.peakBalance.toFixed(8)}<br>Trigger: ${trailingStop.triggerPoint.toFixed(8)}`;
            }
        }
        
        if (trailingStop.isTrailing && bot.stats.currentBal <= trailingStop.triggerPoint) {
            console.log(`‚ö†Ô∏è TRAILING STOP LOSS TRIGGERED! Current: ${bot.stats.currentBal.toFixed(8)}`);
            updateStatus("üõë TRAILING STOP", "#ef4444");
            sendTelegramReport("trailing_stop");
            stopEngine();
            return true;
        }
        
        return false;
    }

    function checkStopLoss() {
        if (!bot.settings.stopLossEnabled || !bot.isRunning) return false;
        
        const stopLossPercent = getVal("p-stop-loss-pct");
        const currentLossPct = ((bot.stats.startBal - bot.stats.currentBal) / bot.stats.startBal * 100);
        
        if (currentLossPct >= stopLossPercent) {
            console.log(`‚ö†Ô∏è STOP LOSS TRIGGERED! Loss: ${currentLossPct.toFixed(2)}%`);
            updateStatus("üõë STOP LOSS", "#ef4444");
            sendTelegramReport("stop_loss");
            stopEngine();
            return true;
        }
        
        if (trailingStop.enabled) {
            return updateTrailingStop();
        }
        
        return false;
    }

    // ==================== TELEGRAM REPORT ====================
    async function sendTelegramReport(reason = "") {
        try {
            const now = Date.now();
            if (reason !== "target" && reason !== "shoot" && reason !== "stop_loss" && reason !== "session_target" && reason !== "trailing_stop" && reason !== "start" && reason !== "stop" && now - bot.lastReportTime < 300000) return;
            
            const profitPct = bot.stats.startBal > 0 ? (bot.stats.profit / bot.stats.startBal * 100) : 0;
            const currentPct = Math.round(profitPct * 10) / 10;
            
            if (reason !== "target" && reason !== "shoot" && reason !== "stop_loss" && reason !== "session_target" && reason !== "trailing_stop" && reason !== "start" && reason !== "stop" && Math.abs(currentPct - bot.lastReportPct) < 0.1) return;
            
            bot.lastReportPct = currentPct;
            bot.lastReportTime = now;
            
            const runningTime = getElapsedTime();
            const currentDD = bot.stats.startBal - bot.stats.currentBal;
            const currentDDPct = bot.stats.startBal > 0 ? (currentDD / bot.stats.startBal * 100) : 0;
            const wagerPct = bot.stats.startBal > 0 ? (bot.stats.wagered / bot.stats.startBal * 100) : 0;
            const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
            
            if (bot.stats.profit > bot.stats.maxProfit) {
                bot.stats.maxProfit = bot.stats.profit;
            }
            
            let header = "üöÄ *ORION PREMIUM BOT v5.1 ENHANCED*\n";
            if (reason === "target") header = "üéØ *PROFIT TARGET REACHED!*\n" + header;
            else if (reason === "session_target") header = "üèÜ *SESSION TARGET REACHED!*\n" + header;
            else if (reason === "start") header = "‚ñ∂Ô∏è *BOT STARTED*\n" + header;
            else if (reason === "stop") header = "üõë *BOT STOPPED*\n" + header;
            else if (reason === "stop_loss") header = "‚ö†Ô∏è *STOP LOSS TRIGGERED!*\n" + header;
            else if (reason === "trailing_stop") header = "üìâ *TRAILING STOP TRIGGERED!*\n" + header;
            
            const settingsReport = `üìã *ENHANCED SETTINGS:*\n` +
                `‚îú‚îÄ Preset: ${bot.currentPreset}\n` +
                `‚îú‚îÄ Mode: ${bot.settings.modeBase ? "BASE" : ""}${bot.settings.modeWager ? " +WAGER" : ""}\n` +
                `‚îú‚îÄ Trailing Stop: ${trailingStop.enabled ? `ON (${trailingStop.trailDistance}%)` : "OFF"}\n` +
                `‚îú‚îÄ Risk Management: ${riskManager.maxRiskPerTrade}% per trade\n` +
                `‚îú‚îÄ WebSocket: ${WebSocketManager.connected ? "‚úÖ" : "‚ùå"}\n` +
                `‚îî‚îÄ Analytics: ${analytics.history.length} trades recorded`;

            const message = header +
                `‚è± Time: ${runningTime}\n` +
                `üéÆ Mode: ${bot.mode}${bot.isShooting ? " (SHOOTING)" : ""}\n` +
                `üë§ User: ${bot.stakeUser}\n` +
                `üí∞ Currency: ${bot.selectedCurrency.toUpperCase()}\n` +
                `üîí License: ${bot.licenseTier}\n` +
                `üìä Analytics: ${analytics.metrics.sharpeRatio.toFixed(2)} Sharpe\n` +
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                `üè¶ Start: ${bot.stats.startBal.toFixed(8)}\n` +
                `üìà Current: ${bot.stats.currentBal.toFixed(8)}\n` +
                `‚úÖ Profit: ${bot.stats.profit.toFixed(8)} (${profitPct.toFixed(2)}%)\n` +
                `üéØ Wager: ${bot.stats.wagered.toFixed(8)} (${wagerPct.toFixed(1)}%)\n` +
                `üìâ Max DD: ${analytics.metrics.maxDrawdown.toFixed(2)}%\n` +
                `üìä Profit Factor: ${analytics.metrics.profitFactor.toFixed(2)}\n` +
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                `üîÑ W/L: ${bot.stats.wins}/${bot.stats.loss}\n` +
                `üé≤ Bets: ${bot.stats.bets}\n` +
                `üìä Win Rate: ${winRate.toFixed(1)}%\n` +
                `‚ö° Expectancy: ${analytics.metrics.expectancy.toFixed(4)}\n` +
                `üìà Volatility: ${analytics.metrics.volatility.toFixed(4)}\n` +
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                settingsReport + "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                `üí¨ Support: ${CONFIG.supportContact}`;

            const url = `https://api.telegram.org/bot${CONFIG.tgToken}/sendMessage`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CONFIG.tgChatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            
            if (!response.ok) {
                console.error('Telegram send failed');
            }
        } catch (error) {
            console.error('Telegram report error:', error);
        }
    }

    // ==================== BOT LOGIC FUNCTIONS ====================
    function getVal(id) { 
        try {
            const el = document.getElementById(id);
            if (!el) {
                const defaults = {
                    "p-shoot-div": 10,
                    "p-shoot-chance": 99,
                    "p-max-shots": 3,
                    "p-bull-threshold": 0.05,
                    "p-minbet": 0.00000001,
                    "p-target-pct": 5.0,
                    "p-stop-loss-pct": 2.0,
                    "p-wgr-div": 100,
                    "p-wgr-chance": 99,
                    "p-chrec-min": 50.0,
                    "p-chrec-max": 70.0,
                    "p-basebet": 0.00000100,
                    "p-multi-start": 1.45,
                    "p-multi-inc": 0.05,
                    "p-bch-min": 80.0,
                    "p-bch-max": 95.0,
                    "p-hch-min": 20.0,
                    "p-hch-max": 30.0,
                    "p-wagertarget": 200,
                    "p-betspersec": 5.5,
                    "p-session-target": 0,
                    "p-trail-distance": 1.0,
                    "p-risk-per-trade": 1.0
                };
                return defaults[id] || 0;
            }
            return parseFloat(el.value) || 0;
        } catch (e) {
            console.error(`Error getting value for ${id}:`, e);
            return 0;
        }
    }

    async function updateBalanceDisplay() {
        if (bot.isRunning) return;
        const balance = await API.getBalance(bot.selectedCurrency);
        bot.stats.currentBal = balance;
        if (bot.stats.startBal === 0) {
            bot.stats.startBal = balance;
        }
    }

    function checkProfitTarget() {
        if (!bot.isRunning) return false;
        
        if (bot.targetAbs > 0 && bot.stats.profit >= bot.targetAbs) {
            console.log(`üéØ PROFIT TARGET REACHED! Profit: ${bot.stats.profit.toFixed(8)}`);
            updateStatus("üéØ TARGET REACHED", "#10b981");
            sendTelegramReport("target");
            stopEngine();
            return true;
        }
        
        const sessionTarget = getVal("p-session-target");
        if (sessionTarget > 0 && bot.stats.sessionProfit >= sessionTarget) {
            console.log(`üèÜ SESSION TARGET REACHED! Session Profit: ${bot.stats.sessionProfit.toFixed(8)}`);
            updateStatus("üèÜ SESSION TARGET", "#8b5cf6");
            sendTelegramReport("session_target");
            stopEngine();
            return true;
        }
        
        return false;
    }

    function detectTrendWithoutChart() {
        if (!bot.isRunning || bot.chartData.length < 5) return "SIDEWAYS";
        
        const recentData = bot.chartData.slice(-10);
        const prices = recentData.map(d => d.value);
        
        if (prices.length < 3) return "SIDEWAYS";
        
        const lastPrice = prices[prices.length - 1];
        const firstPrice = prices[0];
        const changePct = ((lastPrice - firstPrice) / firstPrice * 100);
        
        if (changePct > 0.1) return "BULLISH";
        else if (changePct < -0.1) return "BEARISH";
        else return "SIDEWAYS";
    }

    function updateHeikinAshiChart() {
        if (!bot.isRunning || !bot.settings.chartEnabled) return;
        
        const profitPct = bot.stats.startBal > 0 ? (bot.stats.profit / bot.stats.startBal * 100) : 0;
        const currentPct = Math.round(profitPct * 100) / 100;
        
        if (Math.abs(currentPct - bot.lastChartPct) >= 0.01) {
            const timestamp = Date.now();
            const currentValue = bot.stats.currentBal;
            
            bot.chartData.push({
                time: timestamp,
                value: currentValue,
                pct: currentPct
            });
            
            bot.lastChartPct = currentPct;
            
            if (bot.chartData.length >= 10) {
                calculateHeikinAshi();
                updateTrend();
                renderChart();
            }
            
            if (bot.chartData.length > 100) {
                bot.chartData.shift();
            }
        }
    }

    function calculateHeikinAshi() {
        if (bot.chartData.length < 10) return;
        
        const dataPoints = bot.chartData.slice(-10);
        const values = dataPoints.map(d => d.value);
        
        const high = Math.max(...values);
        const low = Math.min(...values);
        const open = values[0];
        const close = values[values.length - 1];
        
        if (bot.chartCandles.length === 0) {
            bot.chartCandles.push({
                time: dataPoints[dataPoints.length - 1].time,
                open: open,
                high: high,
                low: low,
                close: close,
                haOpen: (open + close) / 2,
                haClose: (open + high + low + close) / 4,
                isBullish: close > open
            });
        } else {
            const lastCandle = bot.chartCandles[bot.chartCandles.length - 1];
            const haOpen = (lastCandle.haOpen + lastCandle.haClose) / 2;
            const haClose = (open + high + low + close) / 4;
            const haHigh = Math.max(high, haOpen, haClose);
            const haLow = Math.min(low, haOpen, haClose);
            
            bot.chartCandles.push({
                time: dataPoints[dataPoints.length - 1].time,
                open: open,
                high: high,
                low: low,
                close: close,
                haOpen: haOpen,
                haClose: haClose,
                haHigh: haHigh,
                haLow: haLow,
                isBullish: haClose > haOpen
            });
        }
        
        if (bot.chartCandles.length > 20) {
            bot.chartCandles.shift();
        }
    }

    function updateTrend() {
        if (bot.chartCandles.length < 3) return;
        
        const lastCandle = bot.chartCandles[bot.chartCandles.length - 1];
        const prevCandle = bot.chartCandles[bot.chartCandles.length - 2];
        
        if (!prevCandle) return;
        
        const changePct = ((lastCandle.haClose - prevCandle.haClose) / prevCandle.haClose * 100);
        const bullThreshold = getVal("p-bull-threshold");
        
        let newTrend = bot.currentTrend;
        
        if (changePct > bullThreshold) {
            newTrend = "BULLISH";
        } else if (changePct < -bullThreshold) {
            newTrend = "BEARISH";
        } else {
            newTrend = "SIDEWAYS";
        }
        
        if (newTrend !== bot.currentTrend) {
            bot.currentTrend = newTrend;
            updateTrendDisplay();
        }
    }

    function updateTrendDisplay() {
        const trendEl = document.getElementById("chart-trend");
        if (trendEl) {
            trendEl.innerText = bot.currentTrend === "BULLISH" ? "üìà BULLISH" : 
                               bot.currentTrend === "BEARISH" ? "üìâ BEARISH" : "‚ÜîÔ∏è SIDEWAYS";
            trendEl.style.color = bot.currentTrend === "BULLISH" ? "#10b981" : 
                                 bot.currentTrend === "BEARISH" ? "#ef4444" : "#f59e0b";
        }
    }

    function renderChart() {
        if (!bot.settings.chartEnabled) {
            const chartContainer = document.getElementById("chart-container");
            if (chartContainer) chartContainer.style.display = "none";
            return;
        }
        
        const chartContainer = document.getElementById("chart-container");
        if (!chartContainer || bot.chartCandles.length < 2) return;
        
        const canvas = document.getElementById("heikin-ashi-chart");
        if (!canvas) return;
        
        const ctx = canvas.getContext("2d");
        const width = canvas.width;
        const height = canvas.height;
        
        ctx.clearRect(0, 0, width, height);
        
        const allValues = bot.chartCandles.flatMap(c => [c.haLow, c.haHigh]);
        const minVal = Math.min(...allValues);
        const maxVal = Math.max(...allValues);
        const range = maxVal - minVal || 1;
        
        const candleWidth = 10;
        const padding = 20;
        const chartHeight = height - padding * 2;
        
        bot.chartCandles.forEach((candle, index) => {
            const x = padding + index * (candleWidth + 5);
            
            const yHigh = padding + chartHeight * (1 - (candle.haHigh - minVal) / range);
            const yLow = padding + chartHeight * (1 - (candle.haLow - minVal) / range);
            const yOpen = padding + chartHeight * (1 - (candle.haOpen - minVal) / range);
            const yClose = padding + chartHeight * (1 - (candle.haClose - minVal) / range);
            
            const isBullish = candle.isBullish;
            ctx.fillStyle = isBullish ? "#10b981" : "#ef4444";
            ctx.strokeStyle = isBullish ? "#10b981" : "#ef4444";
            
            const candleTop = Math.min(yOpen, yClose);
            const candleHeight = Math.abs(yClose - yOpen);
            if (candleHeight > 0) {
                ctx.fillRect(x - candleWidth/2, candleTop, candleWidth, candleHeight);
            }
            
            ctx.beginPath();
            ctx.moveTo(x, yHigh);
            ctx.lineTo(x, yLow);
            ctx.stroke();
        });
        
        const lastCandle = bot.chartCandles[bot.chartCandles.length - 1];
        const prevCandle = bot.chartCandles.length > 1 ? bot.chartCandles[bot.chartCandles.length - 2] : null;
        
        if (lastCandle) {
            const priceEl = document.getElementById("chart-price");
            const changeEl = document.getElementById("chart-change");
            if (priceEl) priceEl.innerText = lastCandle.haClose.toFixed(8);
            if (changeEl) {
                changeEl.innerText = prevCandle ? 
                    `${((lastCandle.haClose - prevCandle.haClose) / prevCandle.haClose * 100).toFixed(2)}%` : "0.00%";
            }
        }
    }

    function applyTrendBasedShooting(win) {
        if (bot.mode !== "WAGER" || !bot.settings.modeWager) return false;
        
        const maxShots = getVal("p-max-shots");
        
        if (win && bot.isShooting) {
            bot.isShooting = false;
            bot.shootCount = 0;
            return false;
        }
        
        let currentTrend = bot.settings.chartEnabled ? bot.currentTrend : detectTrendWithoutChart();
        
        if (currentTrend === "BULLISH" && bot.shootCount < maxShots && !win) {
            bot.isShooting = true;
            bot.shootCount++;
            
            const shootChance = getVal("p-shoot-chance");
            const shootDiv = getVal("p-shoot-div");
            
            bot.currentChance = shootChance;
            bot.nextBet = bot.stats.currentBal / shootDiv;
            
            const minBet = getVal("p-minbet");
            bot.nextBet = Math.max(bot.nextBet, minBet);
            
            updateStatus(`SHOOT #${bot.shootCount}`, "#ffaa00");
            
            return true;
        }
        
        if (bot.shootCount >= maxShots || currentTrend !== "BULLISH") {
            bot.isShooting = false;
            bot.shootCount = 0;
        }
        
        return false;
    }

    async function runLoop() {
        if (!bot.isRunning || bot.isPaused) return;
        
        if (checkStopLoss() || checkProfitTarget()) {
            return;
        }

        const now = Date.now();
        if (bot.settings.autoSwitchEnabled && bot.partialProfit >= 0 && 
            (now - bot.lastSwitchTime > 60000 || bot.stats.bets % 100 === 0)) {
            
            const enabledModes = [];
            if (bot.settings.modeBase) enabledModes.push("BASE");
            if (bot.settings.modeWager) enabledModes.push("WAGER");
            
            if (enabledModes.length > 1) {
                const currentIndex = enabledModes.indexOf(bot.mode);
                const nextIndex = (currentIndex + 1) % enabledModes.length;
                bot.mode = enabledModes[nextIndex];
                bot.lastSwitchTime = now;
                updateStatus(`MODE: ${bot.mode}`, "#a855f7");
                
                bot.isShooting = false;
                bot.shootCount = 0;
            }
        }

        try {
            // Apply risk management
            if (riskManager.maxRiskPerTrade > 0) {
                bot.nextBet = riskManager.adjustBetSize(bot.nextBet);
            }
            
            const res = await API.placeBet(bot.nextBet, bot.currentChance);
            const d = res?.data?.diceRoll || res?.diceRoll;
            if (d) {
                const win = d.payout > 0;
                const pft = d.payout - d.amount;
                bot.stats.bets++; 
                bot.stats.wagered += d.amount;
                bot.stats.profit += pft; 
                bot.stats.sessionProfit += pft;
                bot.partialProfit += pft;
                bot.stats.currentBal += pft;
                
                if (bot.stats.profit > bot.stats.maxProfit) {
                    bot.stats.maxProfit = bot.stats.profit;
                }
                
                if (win) bot.stats.wins++; else bot.stats.loss++;

                let drop = bot.stats.currentBal < bot.stats.startBal ? bot.stats.startBal - bot.stats.currentBal : 0;
                if (drop > bot.stats.maxDD) bot.stats.maxDD = drop;

                updateLogs(d.amount, bot.currentChance, bot.mode, pft);
                
                analytics.recordTrade(d.amount, pft, bot.currentChance, bot.mode);
                
                updateHeikinAshiChart();
                
                if (!bot.settings.chartEnabled) {
                    const detectedTrend = detectTrendWithoutChart();
                    if (detectedTrend !== bot.currentTrend) {
                        bot.currentTrend = detectedTrend;
                        updateTrendDisplay();
                    }
                }

                const isShooting = applyTrendBasedShooting(win);
                
                if (!isShooting) {
                    if (bot.mode === "WAGER" && bot.settings.modeWager) {
                        bot.wgr.profitc += pft;
                        bot.wgr.betload = bot.wgr.balhigh - bot.stats.currentBal;
                        if (bot.wgr.profitc > 0) { 
                            bot.wgr.profitc = 0; 
                            bot.wgr.balhigh = bot.stats.currentBal; 
                        }
                        if (win) {
                            bot.wgr.ctwin++;
                            if (bot.wgr.ctwin > 10) {
                                bot.wgr.ctwin = 0;
                                bot.currentChance = Math.random() * (getVal("p-chrec-max") - getVal("p-chrec-min")) + getVal("p-chrec-min");
                                bot.nextBet = Math.max(0, bot.wgr.betload) / ((99 / bot.currentChance) - 1);
                            } else {
                                bot.currentChance = getVal("p-wgr-chance");
                                bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                            }
                        } else {
                            if (bot.currentChance < 80) bot.nextBet = Math.abs(bot.wgr.betload) / ((99 / bot.currentChance) - 1);
                            else bot.nextBet = d.amount * 1.12;
                        }
                    } else if (bot.mode === "BASE" && bot.settings.modeBase) {
                        if (win) {
                            bot.ls = 0; 
                            bot.lc = 0; 
                            bot.partialProfit = 0;
                            bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
                            bot.nextBet = getVal("p-basebet");
                            bot.currentMulti = getVal("p-multi-start");
                        } else {
                            bot.ls++; 
                            bot.lc++;
                            if (bot.ls === 1 || bot.lc > bot.bcount) {
                                if (bot.ls > 1) bot.currentMulti += getVal("p-multi-inc");
                                bot.lc = 1;
                                bot.currentChance = Math.random() * (getVal("p-hch-max") - getVal("p-hch-min")) + getVal("p-hch-min");
                                bot.bcount = Math.ceil(99 / bot.currentChance);
                            }
                            bot.nextBet = (Math.abs(bot.partialProfit) / ((99/bot.currentChance) - 1)) * bot.currentMulti;
                        }
                    } else {
                        if (bot.settings.modeBase) {
                            bot.mode = "BASE";
                            bot.nextBet = getVal("p-basebet");
                            bot.currentChance = 85.0;
                        } else if (bot.settings.modeWager) {
                            bot.mode = "WAGER";
                            bot.currentChance = getVal("p-wgr-chance");
                            bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                        }
                    }
                }
                
                const minBet = getVal("p-minbet");
                bot.nextBet = Math.max(bot.nextBet, minBet);
                
                await sendTelegramReport();
            }
            setTimeout(runLoop, 150);
        } catch (e) { 
            console.error("Loop error:", e);
            setTimeout(runLoop, 1000); 
        }
    }

    async function stopEngine() { 
        bot.isRunning = false; 
        bot.stopTime = Date.now();
        bot.isShooting = false;
        bot.shootCount = 0;
        await updateBalanceDisplay();
        await sendTelegramReport("stop");
    }

    function updateStatus(text, color = "#0ff") {
        const el = document.getElementById("st-status-text");
        if (el) { 
            el.innerText = text; 
            el.style.color = color; 
        }
    }

    function updateLogs(amt, ch, mode, pft) {
        const logBox = document.getElementById("p-log-body");
        if (!logBox) return;
        
        const modeColors = {
            'WAGER': '#60a5fa',
            'BASE': '#fbbf24', 
            'SHOOT': '#f87171'
        };
        
        const row = document.createElement("div");
        row.style.cssText = `display:grid; grid-template-columns:1.2fr 1fr 0.8fr 1.2fr; font-size:9px; border-bottom:1px solid rgba(0,255,255,0.05); padding:2px 0; color:${pft >= 0 ? '#00ffcc' : '#ff3366'}; text-align:center;`;
        row.innerHTML = `
            <span>${amt.toFixed(5)}</span>
            <span>${ch.toFixed(1)}%</span>
            <span style="color:${modeColors[mode] || '#94a3b8'}">${bot.isShooting ? "SHOOT" : mode}</span>
            <span>${pft.toFixed(5)}</span>
        `;
        logBox.prepend(row);
        if (logBox.children.length > 10) logBox.lastChild.remove();
    }

    function getElapsedTime() {
        if (!bot.startTime) return "00:00:00";
        let now = bot.isRunning ? Date.now() : (bot.stopTime || Date.now());
        const d = Math.floor((now - bot.startTime) / 1000);
        return `${Math.floor(d/3600).toString().padStart(2,'0')}:${Math.floor((d%3600)/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
    }

    // ==================== FIXED PRESET FUNCTION ====================
    function applyPreset(presetKey) {
        try {
            const preset = PRESETS[presetKey];
            if (!preset) {
                console.warn(`Preset ${presetKey} tidak ditemukan`);
                return;
            }
            
            bot.currentPreset = presetKey;
            
            // Safe element updates dengan null checking
            const elementsToUpdate = [
                { id: "p-bch-min", value: preset.baseChanceMin },
                { id: "p-bch-max", value: preset.baseChanceMax },
                { id: "p-wgr-chance", value: preset.wagerChance },
                { id: "p-stop-loss-pct", value: preset.stopLoss },
                { id: "p-target-pct", value: preset.targetProfit },
                { id: "p-trail-distance", value: preset.trailDistance || 1.0 },
                { id: "p-risk-per-trade", value: preset.riskPerTrade || 1.0 }
            ];
            
            elementsToUpdate.forEach(item => {
                const el = document.getElementById(item.id);
                if (el) {
                    el.value = item.value;
                } else {
                    console.log(`Element ${item.id} not found, will set later`);
                    // Store untuk di-set nanti ketika element tersedia
                    setTimeout(() => {
                        const delayedEl = document.getElementById(item.id);
                        if (delayedEl) {
                            delayedEl.value = item.value;
                        }
                    }, 100);
                }
            });
            
            // Update wager target jika ada
            if (preset.wagerTarget) {
                const wagerEl = document.getElementById("p-wagertarget");
                if (wagerEl) wagerEl.value = preset.wagerTarget;
            }
            
            // Update UI preset buttons
            const presetButtons = document.querySelectorAll('.preset-btn');
            if (presetButtons.length > 0) {
                presetButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.preset === presetKey) {
                        btn.classList.add('active');
                    }
                });
            }
            
            updateStatus(`Preset: ${preset.name}`, "#a855f7");
            
        } catch (error) {
            console.error("Error applying preset:", error);
        }
    }

    // ==================== TAB SYSTEM ====================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            if (content) content.style.display = 'none';
        });
        
        document.querySelectorAll('.tab-btn').forEach(tab => {
            if (tab) tab.classList.remove('active');
        });
        
        const tabContent = document.getElementById(`tab-${tabName}`);
        if (tabContent) {
            tabContent.style.display = 'block';
        }
        
        const activeTab = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        localStorage.setItem('orion_active_tab', tabName);
    }

    // ==================== MINIMIZE/RESTORE ====================
    function toggleMinimize() {
        const wrap = document.getElementById("orion-wrap");
        const content = document.getElementById("orion-content");
        const minBtn = document.getElementById("minimize-btn");
        
        if (!wrap || !content || !minBtn) return;
        
        bot.isMinimized = !bot.isMinimized;
        
        if (bot.isMinimized) {
            content.style.display = 'none';
            wrap.style.width = '60px';
            wrap.style.height = '60px';
            wrap.style.padding = '10px';
            minBtn.innerHTML = 'üì•';
            minBtn.title = 'Restore';
            
            const header = document.querySelector('.header');
            const headerTitle = document.querySelector('.header-title');
            const statusBadge = document.querySelector('.status-badge');
            
            if (header) header.style.display = 'block';
            if (headerTitle) headerTitle.style.fontSize = '12px';
            if (statusBadge) statusBadge.style.display = 'none';
        } else {
            content.style.display = 'block';
            wrap.style.width = '';
            wrap.style.height = '';
            wrap.style.padding = '';
            minBtn.innerHTML = 'üì§';
            minBtn.title = 'Minimize';
            
            const header = document.querySelector('.header');
            const headerTitle = document.querySelector('.header-title');
            const statusBadge = document.querySelector('.status-badge');
            
            if (header) header.style.display = '';
            if (headerTitle) headerTitle.style.fontSize = '';
            if (statusBadge) statusBadge.style.display = '';
        }
    }

    // ==================== UI CREATION ====================
    function createUI() {
        // Remove existing UI if present
        const existingWrap = document.getElementById("orion-wrap");
        if (existingWrap) existingWrap.remove();
        
        const existingStyle = document.querySelector('style[data-orion]');
        if (existingStyle) existingStyle.remove();
        
        // Create styles
        const s = document.createElement("style");
        s.setAttribute('data-orion', 'enhanced');
        s.innerHTML = `
            /* ==================== ENHANCED STYLES ==================== */
            #orion-wrap {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                width: 440px !important;
                min-width: 440px !important;
                max-width: 440px !important;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
                border: 2px solid #3b82f6 !important;
                border-radius: 20px !important;
                padding: 15px !important;
                color: #e2e8f0 !important;
                font-family: 'Segoe UI', system-ui !important;
                z-index: 2147483647 !important;
                box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3) !important;
                backdrop-filter: blur(10px) !important;
                overflow-y: auto !important;
                max-height: 90vh !important;
                box-sizing: border-box !important;
                transform: none !important;
                margin: 0 !important;
            }
            
            .dashboard {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
                margin: 10px 0 !important;
                background: rgba(30, 41, 59, 0.5);
                padding: 10px !important;
                border-radius: 12px;
                border: 1px solid #334155;
            }
            
            .stat-card {
                background: rgba(15, 23, 42, 0.7);
                padding: 6px !important;
                border-radius: 8px;
                border-left: 3px solid #3b82f6;
                min-width: 0;
                overflow: hidden;
            }
            
            .stat-label {
                font-size: 7px !important;
                color: #94a3b8;
                text-transform: uppercase;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .stat-value {
                font-size: 10px !important;
                font-weight: 700;
                color: #f1f5f9;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .stat-sub {
                font-size: 6px !important;
                color: #64748b;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .tabs-container {
                display: flex;
                background: rgba(30, 41, 59, 0.5);
                border-radius: 10px;
                padding: 5px;
                margin-bottom: 15px;
                border: 1px solid #334155;
            }
            
            .tab-btn {
                flex: 1;
                padding: 8px 5px;
                border: none;
                background: transparent;
                color: #94a3b8;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                border-radius: 6px;
                transition: all 0.2s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }
            
            .tab-btn.active {
                background: #3b82f6;
                color: white;
            }
            
            .tab-content {
                display: none;
            }
            
            .settings-section {
                background: rgba(30, 41, 59, 0.5);
                border-radius: 10px !important;
                padding: 10px !important;
                margin: 8px 0 !important;
                border: 1px solid #334155;
            }
            
            .section-title {
                font-size: 11px !important;
                font-weight: 600;
                color: #94a3b8;
                margin-bottom: 8px !important;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .presets-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin: 10px 0;
            }
            
            .preset-btn {
                padding: 8px;
                border-radius: 8px;
                border: 1px solid #334155;
                background: rgba(15, 23, 42, 0.5);
                color: #e2e8f0;
                font-size: 10px;
                cursor: pointer;
                transition: all 0.2s;
                text-align: center;
            }
            
            .preset-btn.active {
                border-color: #3b82f6;
                background: rgba(59, 130, 246, 0.2);
                color: #3b82f6;
                font-weight: 600;
            }
            
            .enhanced-section {
                background: rgba(139, 92, 246, 0.1);
                border: 1px solid #8b5cf6;
                border-radius: 10px;
                padding: 10px;
                margin: 8px 0;
            }
            
            .toggle-container {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 6px;
                padding: 6px;
                background: rgba(15, 23, 42, 0.3);
                border-radius: 6px;
            }
            
            .toggle-label {
                font-size: 10px;
                color: #e2e8f0;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 36px;
                height: 18px;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #334155;
                transition: .4s;
                border-radius: 18px;
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 12px;
                width: 12px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }
            
            input:checked + .toggle-slider {
                background-color: #3b82f6;
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(18px);
            }
            
            .input-group {
                margin-bottom: 6px;
            }
            
            .input-label {
                font-size: 8px !important;
                color: #94a3b8;
                margin-bottom: 3px;
                display: block;
            }
            
            input, select {
                width: 100% !important;
                padding: 6px 8px !important;
                background: #1e293b;
                border: 1px solid #334155;
                border-radius: 6px;
                color: #e2e8f0;
                font-size: 10px !important;
                box-sizing: border-box !important;
            }
            
            .control-panel {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
                margin: 12px 0;
            }
            
            .button-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .btn {
                padding: 10px;
                border: none;
                border-radius: 8px;
                font-weight: 700;
                font-size: 11px;
                cursor: pointer;
                transition: all 0.2s;
                text-transform: uppercase;
                text-align: center;
            }
            
            .btn-run {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
            }
            
            .btn-pause {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
            }
            
            .btn-stop {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
            }
            
            .btn-support {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                color: white;
            }
            
            .analytics-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                margin: 10px 0;
            }
            
            .analytics-card {
                background: rgba(15, 23, 42, 0.7);
                padding: 8px;
                border-radius: 8px;
                border-left: 3px solid #8b5cf6;
                text-align: center;
            }
            
            .analytics-label {
                font-size: 7px;
                color: #94a3b8;
                text-transform: uppercase;
            }
            
            .analytics-value {
                font-size: 10px;
                font-weight: 700;
                color: #f1f5f9;
                margin: 4px 0;
            }
            
            .analytics-desc {
                font-size: 6px;
                color: #64748b;
            }
            
            @media (max-width: 500px) {
                #orion-wrap {
                    width: 95vw !important;
                    right: 2.5vw !important;
                    padding: 10px !important;
                }
            }
        `;
        document.head.appendChild(s);
        
        // Create main container
        const d = document.createElement("div");
        d.id = "orion-wrap";
        d.innerHTML = `
            <div id="orion-content">
                <!-- HEADER -->
                <div class="header">
                    <div class="header-controls">
                        <button id="minimize-btn" class="header-btn" title="Minimize">üì§</button>
                    </div>
                    <div class="header-title">
                        üöÄ ORION PREMIUM v5.1 FIXED
                        <span class="license-badge">${bot.licenseTier}</span>
                    </div>
                    <div class="status-badge" id="st-status-text">
                        üü¢ READY <span id="ws-status" style="color:#10b981; margin-left:5px;">üîå</span>
                    </div>
                </div>
                
                <!-- DASHBOARD -->
                <div class="dashboard">
                    <div class="stat-card">
                        <div class="stat-label">üë§ USER</div>
                        <div class="stat-value" id="st-user">${bot.stakeUser}</div>
                        <div class="stat-sub" id="license-info">${bot.licenseTier}</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">üí∞ BALANCE</div>
                        <div class="stat-value" id="st-bal">0.00000000</div>
                        <div class="stat-sub" id="profit-display">0.00000000 (0.00%)</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">‚ö° ANALYTICS</div>
                        <div class="stat-value" id="sharpe-display">0.00</div>
                        <div class="stat-sub" id="profit-factor">PF: 0.00</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è TIME</div>
                        <div class="stat-value" id="st-time">00:00:00</div>
                        <div class="stat-sub">W/L: <span id="wl-ratio">0/0</span></div>
                    </div>
                </div>
                
                <!-- TABS -->
                <div class="tabs-container">
                    <button class="tab-btn active" data-tab="settings">
                        ‚öôÔ∏è SETTINGS
                    </button>
                    <button class="tab-btn" data-tab="risk">
                        üõ°Ô∏è RISK
                    </button>
                    <button class="tab-btn" data-tab="analytics">
                        üìä ANALYTICS
                    </button>
                    <button class="tab-btn" data-tab="info">
                        ‚ÑπÔ∏è INFO
                    </button>
                </div>
                
                <!-- TAB 1: SETTINGS -->
                <div id="tab-settings" class="tab-content" style="display: block;">
                    <!-- PRESETS -->
                    <div class="settings-section">
                        <div class="section-title">üéØ QUICK PRESETS</div>
                        <div class="presets-container">
                            <button class="preset-btn" data-preset="SAFE">üîí SAFE</button>
                            <button class="preset-btn active" data-preset="BALANCED">‚öñÔ∏è BALANCED</button>
                            <button class="preset-btn" data-preset="AGGRESSIVE">‚ö° AGGRESSIVE</button>
                            <button class="preset-btn" data-preset="WAGER_FARM">üèÉ WAGER FARM</button>
                        </div>
                    </div>
                    
                    <!-- ENHANCED FEATURES -->
                    <div class="enhanced-section">
                        <div class="section-title">üöÄ ENHANCED FEATURES</div>
                        <div>
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>üìâ</span> Trailing Stop
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-trailing-stop">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>‚ö°</span> Risk Management
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-risk-management" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>üîó</span> WebSocket
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-websocket" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MODE SWITCH -->
                    <div class="settings-section">
                        <div class="section-title">üîÑ MODE SWITCH</div>
                        <div>
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>üîÑ</span> Auto Switch
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-auto-switch" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>üèóÔ∏è</span> BASE Mode
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-base-mode" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>‚ö°</span> WAGER Mode
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-wager-mode" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="toggle-container">
                                <div class="toggle-label">
                                    <span>üìä</span> Chart Display
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-chart" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BASE MODE SETTINGS -->
                    <div class="settings-section">
                        <div class="section-title">üèóÔ∏è BASE MODE SETTINGS</div>
                        <div>
                            <div class="input-group">
                                <label class="input-label">Base Bet</label>
                                <input id="p-basebet" value="0.00000100" type="number" step="0.00000001">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Base Chance Min (%)</label>
                                <input id="p-bch-min" value="85.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Base Chance Max (%)</label>
                                <input id="p-bch-max" value="95.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Hunt Chance Min (%)</label>
                                <input id="p-hch-min" value="20.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Hunt Chance Max (%)</label>
                                <input id="p-hch-max" value="30.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Multi Start</label>
                                <input id="p-multi-start" value="1.45" type="number" step="0.01">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Multi Increment</label>
                                <input id="p-multi-inc" value="0.05" type="number" step="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <!-- WAGER MODE SETTINGS -->
                    <div class="settings-section">
                        <div class="section-title">‚ö° WAGER MODE SETTINGS</div>
                        <div>
                            <div class="input-group">
                                <label class="input-label">Wager Chance (%)</label>
                                <input id="p-wgr-chance" value="99.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Wager Divider</label>
                                <input id="p-wgr-div" value="100" type="number" step="1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Recovery Chance Min (%)</label>
                                <input id="p-chrec-min" value="50.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Recovery Chance Max (%)</label>
                                <input id="p-chrec-max" value="70.0" type="number" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- CURRENCY SELECTION -->
                    <div class="settings-section">
                        <div class="section-title">üí∞ CURRENCY SELECTION</div>
                        <select id="p-currency"></select>
                    </div>
                    
                    <!-- BOT CONTROLS -->
                    <div class="control-panel">
                        <button id="btn-run" class="btn btn-run">üöÄ START ENGINE</button>
                        <div class="button-row">
                            <button id="btn-pause" class="btn btn-pause">‚è∏Ô∏è PAUSE</button>
                            <button id="btn-stop" class="btn btn-stop">üõë STOP</button>
                        </div>
                        <button id="btn-support" class="btn btn-support">
                            üí¨ CONTACT SUPPORT
                        </button>
                    </div>
                </div>
                
                <!-- TAB 2: RISK MANAGEMENT -->
                <div id="tab-risk" class="tab-content">
                    <div class="settings-section">
                        <div class="section-title">üõ°Ô∏è RISK MANAGEMENT</div>
                        <div>
                            <div class="input-group">
                                <label class="input-label">Risk Per Trade (%)</label>
                                <input id="p-risk-per-trade" value="1.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Trailing Distance (%)</label>
                                <input id="p-trail-distance" value="1.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Stop Loss (%)</label>
                                <input id="p-stop-loss-pct" value="2.0" type="number" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Target Profit (%)</label>
                                <input id="p-target-pct" value="5.0" type="number" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">üìä RISK METRICS</div>
                        <div id="trailing-info" style="font-size: 9px; color: #94a3b8; padding: 5px;">
                            Trailing Stop: Inactive
                        </div>
                        <div style="font-size: 9px; color: #94a3b8; padding: 5px;">
                            Current Risk: <span id="current-risk">1.0%</span><br>
                            Max Allowed Bet: <span id="max-allowed-bet">0.00000000</span>
                        </div>
                    </div>
                </div>
                
                <!-- TAB 3: ANALYTICS -->
                <div id="tab-analytics" class="tab-content">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-label">SHARPE RATIO</div>
                            <div class="analytics-value" id="analytics-sharpe">0.00</div>
                            <div class="analytics-desc">Risk-Adjusted Return</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">MAX DRAWDOWN</div>
                            <div class="analytics-value" id="analytics-maxdd">0.00%</div>
                            <div class="analytics-desc">Worst Loss</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">PROFIT FACTOR</div>
                            <div class="analytics-value" id="analytics-pf">0.00</div>
                            <div class="analytics-desc">Wins/Losses</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">EXPECTANCY</div>
                            <div class="analytics-value" id="analytics-expectancy">0.00</div>
                            <div class="analytics-desc">Avg Profit Per Trade</div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">üìà PERFORMANCE HISTORY</div>
                        <div style="font-size: 9px; color: #94a3b8; padding: 5px;">
                            Total Trades: <span id="total-trades">0</span><br>
                            Win Rate: <span id="analytics-winrate">0%</span><br>
                            Best Trade: <span id="best-trade">0.00000000</span><br>
                            Worst Trade: <span id="worst-trade">0.00000000</span>
                        </div>
                    </div>
                </div>
                
                <!-- TAB 4: INFO -->
                <div id="tab-info" class="tab-content">
                    <div class="settings-section">
                        <div class="section-title">üöÄ ABOUT ORION PREMIUM v5.1 FIXED</div>
                        <div style="font-size: 10px; color: #94a3b8; padding: 5px; line-height: 1.4;">
                            <div style="margin-bottom: 8px;">
                                <strong>Enhanced Trading Bot for Stake.com</strong><br>
                                Version: ${CONFIG.version}<br>
                                License: ${bot.licenseTier}<br>
                                User: ${bot.stakeUser}
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <strong>üõ°Ô∏è Enhanced Features:</strong><br>
                                ‚Ä¢ Trailing Stop Loss<br>
                                ‚Ä¢ Risk Management (Kelly Criterion)<br>
                                ‚Ä¢ Advanced Analytics Dashboard<br>
                                ‚Ä¢ WebSocket Real-time Updates<br>
                                ‚Ä¢ 4 Quick Presets with Risk Settings
                            </div>
                            
                            <div>
                                <strong>üí° Fixed Issues:</strong><br>
                                ‚Ä¢ Preset application error fixed<br>
                                ‚Ä¢ Null checking for all UI elements<br>
                                ‚Ä¢ Better error handling<br>
                                ‚Ä¢ Stable WebSocket connection
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="section-title">üìû SUPPORT & UPDATES</div>
                        <div style="font-size: 10px; color: #94a3b8; padding: 5px;">
                            <div style="margin-bottom: 5px;">
                                <strong>Telegram Support:</strong><br>
                                <a href="https://t.me/${CONFIG.supportContact.replace('@', '')}" target="_blank" style="color: #60a5fa;">
                                    ${CONFIG.supportContact}
                                </a>
                            </div>
                            <div>
                                <strong>Current License:</strong><br>
                                <span id="license-details">${bot.licenseTier} - Active</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- FOOTER -->
                <div style="text-align:center; margin-top:15px; font-size:7px; color:#64748b; border-top:1px solid #334155; padding-top:8px;">
                    <div>üöÄ ORION PREMIUM v5.1 FIXED | üîí ${bot.licenseTier} License</div>
                    <div>üõ°Ô∏è Risk Management Active | üìä ${analytics.history.length} Trades</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(d);
        
        // Initialize functions to window object
        window.switchTab = switchTab;
        window.applyPreset = applyPreset;
        window.toggleMinimize = toggleMinimize;
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize
        API.syncOnce();
        
        // Apply default preset
        setTimeout(() => {
            applyPreset("BALANCED");
        }, 100);
        
        // Connect WebSocket if enabled
        if (bot.settings.useWebSocket) {
            setTimeout(() => WebSocketManager.connect(), 2000);
        }
    }

    function setupEventListeners() {
        // Tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });
        
        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const presetKey = btn.getAttribute('data-preset');
                applyPreset(presetKey);
            });
        });
        
        // Minimize button
        const minBtn = document.getElementById("minimize-btn");
        if (minBtn) {
            minBtn.addEventListener('click', toggleMinimize);
        }
        
        // Toggle switches
        const toggleTrailing = document.getElementById("toggle-trailing-stop");
        if (toggleTrailing) {
            toggleTrailing.addEventListener('change', function(e) {
                trailingStop.enabled = e.target.checked;
                updateStatus(`Trailing Stop: ${e.target.checked ? 'ON' : 'OFF'}`, "#8b5cf6");
            });
        }
        
        const toggleRisk = document.getElementById("toggle-risk-management");
        if (toggleRisk) {
            toggleRisk.addEventListener('change', function(e) {
                riskManager.maxRiskPerTrade = e.target.checked ? getVal("p-risk-per-trade") : 0;
                updateStatus(`Risk Management: ${e.target.checked ? 'ON' : 'OFF'}`, "#10b981");
            });
        }
        
        const toggleWS = document.getElementById("toggle-websocket");
        if (toggleWS) {
            toggleWS.addEventListener('change', function(e) {
                bot.settings.useWebSocket = e.target.checked;
                if (e.target.checked) {
                    WebSocketManager.connect();
                } else {
                    WebSocketManager.disconnect();
                }
                updateStatus(`WebSocket: ${e.target.checked ? 'ON' : 'OFF'}`, "#3b82f6");
            });
        }
        
        const toggleAutoSwitch = document.getElementById("toggle-auto-switch");
        if (toggleAutoSwitch) {
            toggleAutoSwitch.addEventListener('change', function(e) {
                bot.settings.autoSwitchEnabled = e.target.checked;
                updateStatus(`Auto Switch: ${e.target.checked ? 'ON' : 'OFF'}`, "#a855f7");
            });
        }
        
        const toggleBaseMode = document.getElementById("toggle-base-mode");
        if (toggleBaseMode) {
            toggleBaseMode.addEventListener('change', function(e) {
                bot.settings.modeBase = e.target.checked;
                updateStatus(`BASE Mode: ${e.target.checked ? 'ON' : 'OFF'}`, "#fbbf24");
            });
        }
        
        const toggleWagerMode = document.getElementById("toggle-wager-mode");
        if (toggleWagerMode) {
            toggleWagerMode.addEventListener('change', function(e) {
                bot.settings.modeWager = e.target.checked;
                updateStatus(`WAGER Mode: ${e.target.checked ? 'ON' : 'OFF'}`, "#60a5fa");
            });
        }
        
        const toggleChart = document.getElementById("toggle-chart");
        if (toggleChart) {
            toggleChart.addEventListener('change', function(e) {
                bot.settings.chartEnabled = e.target.checked;
                updateStatus(`Chart: ${e.target.checked ? 'ON' : 'OFF'}`, "#3b82f6");
            });
        }
        
        // Risk management inputs
        const riskInput = document.getElementById("p-risk-per-trade");
        if (riskInput) {
            riskInput.addEventListener('change', function(e) {
                riskManager.maxRiskPerTrade = parseFloat(e.target.value);
            });
        }
        
        const trailInput = document.getElementById("p-trail-distance");
        if (trailInput) {
            trailInput.addEventListener('change', function(e) {
                trailingStop.trailDistance = parseFloat(e.target.value);
            });
        }
        
        // Currency selector
        const currencySelect = document.getElementById("p-currency");
        if (currencySelect) {
            currencySelect.addEventListener('change', async (e) => {
                bot.selectedCurrency = e.target.value;
                localStorage.setItem('orion_last_coin', bot.selectedCurrency);
                await updateBalanceDisplay();
            });
        }
        
        // Bot control buttons
        const btnRun = document.getElementById("btn-run");
        if (btnRun) {
            btnRun.addEventListener('click', async () => {
                if (!bot.isRunning) {
                    bot.selectedCurrency = document.getElementById("p-currency").value;
                    await API.syncOnce();
                    
                    bot.stats.startBal = await API.getBalance(bot.selectedCurrency);
                    bot.stats.currentBal = bot.stats.startBal;
                    bot.stats.profit = 0;
                    bot.stats.wagered = 0;
                    bot.stats.bets = 0;
                    bot.stats.wins = 0;
                    bot.stats.loss = 0;
                    bot.stats.maxDD = 0;
                    bot.stats.maxProfit = 0;
                    bot.stats.sessionProfit = 0;
                    bot.stats.sessionStart = Date.now();
                    
                    bot.targetAbs = bot.stats.startBal * (getVal("p-target-pct") / 100);
                    bot.isRunning = true;
                    bot.isPaused = false;
                    bot.startTime = Date.now();
                    bot.stopTime = null;
                    bot.lastSwitchTime = Date.now();
                    bot.wgr.balhigh = bot.stats.startBal;
                    bot.wgr.profitc = 0;
                    
                    if (bot.settings.modeBase) {
                        bot.mode = "BASE";
                        bot.nextBet = getVal("p-basebet");
                        bot.currentChance = 85.0;
                    } else if (bot.settings.modeWager) {
                        bot.mode = "WAGER";
                        bot.currentChance = getVal("p-wgr-chance");
                        bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                    } else {
                        updateStatus("NO MODE ENABLED", "#ef4444");
                        return;
                    }
                    
                    bot.currentMulti = getVal("p-multi-start");
                    bot.ls = 0;
                    bot.lc = 0;
                    bot.partialProfit = 0;
                    bot.shootCount = 0;
                    bot.isShooting = false;
                    
                    updateStatus("‚ö° RUNNING", "#10b981");
                    
                    await sendTelegramReport("start");
                    runLoop();
                }
            });
        }
        
        const btnStop = document.getElementById("btn-stop");
        if (btnStop) {
            btnStop.addEventListener('click', async () => { 
                await stopEngine(); 
                updateStatus("üõë STOPPED", "#ef4444"); 
            });
        }
        
        const btnPause = document.getElementById("btn-pause");
        if (btnPause) {
            btnPause.addEventListener('click', async () => {
                bot.isPaused = !bot.isPaused;
                updateStatus(bot.isPaused ? "‚è∏Ô∏è PAUSED" : "‚ö° RUNNING", 
                           bot.isPaused ? "#f59e0b" : "#10b981");
            });
        }
        
        const btnSupport = document.getElementById("btn-support");
        if (btnSupport) {
            btnSupport.addEventListener('click', () => {
                window.open(`https://t.me/${CONFIG.supportContact.replace('@', '')}`, '_blank');
            });
        }
    }

    // ==================== REAL-TIME UPDATES ====================
    setInterval(() => {
        try {
            if (!document.getElementById("st-bal")) return;
            
            // Update dashboard
            document.getElementById("st-bal").innerText = bot.stats.currentBal.toFixed(8);
            document.getElementById("st-user").innerText = bot.stakeUser;
            document.getElementById("st-time").innerText = getElapsedTime();
            document.getElementById("wl-ratio").innerText = `${bot.stats.wins}/${bot.stats.loss}`;
            
            const profitPct = (bot.stats.profit / (bot.stats.startBal || 1) * 100);
            const profitColor = profitPct >= 0 ? '#10b981' : '#ef4444';
            const profitDisplay = document.getElementById("profit-display");
            if (profitDisplay) {
                profitDisplay.innerHTML = 
                    `<span style="color:${profitColor}">${bot.stats.profit.toFixed(4)} (${profitPct.toFixed(2)}%)</span>`;
            }
            
            // Update analytics
            const sharpeDisplay = document.getElementById("sharpe-display");
            if (sharpeDisplay) sharpeDisplay.innerText = analytics.metrics.sharpeRatio.toFixed(2);
            
            const pfDisplay = document.getElementById("profit-factor");
            if (pfDisplay) pfDisplay.innerText = `PF: ${analytics.metrics.profitFactor.toFixed(2)}`;
            
            // Update WebSocket status
            const wsStatus = document.getElementById("ws-status");
            if (wsStatus) {
                wsStatus.textContent = WebSocketManager.connected ? 'üîó' : 'üîå';
                wsStatus.style.color = WebSocketManager.connected ? '#10b981' : '#ef4444';
            }
            
            // Update analytics tab
            const analyticsSharpe = document.getElementById("analytics-sharpe");
            if (analyticsSharpe) analyticsSharpe.innerText = analytics.metrics.sharpeRatio.toFixed(2);
            
            const analyticsMaxDD = document.getElementById("analytics-maxdd");
            if (analyticsMaxDD) analyticsMaxDD.innerText = analytics.metrics.maxDrawdown.toFixed(2) + '%';
            
            const analyticsPF = document.getElementById("analytics-pf");
            if (analyticsPF) analyticsPF.innerText = analytics.metrics.profitFactor.toFixed(2);
            
            const analyticsExpectancy = document.getElementById("analytics-expectancy");
            if (analyticsExpectancy) analyticsExpectancy.innerText = analytics.metrics.expectancy.toFixed(4);
            
            const analyticsWinrate = document.getElementById("analytics-winrate");
            if (analyticsWinrate) {
                analyticsWinrate.innerText = analytics.history.length > 0 ? 
                    ((analytics.history.filter(t => t.profit > 0).length / analytics.history.length * 100).toFixed(1) + '%') : '0%';
            }
            
            // Update trade history
            if (analytics.history.length > 0) {
                const profits = analytics.history.map(t => t.profit);
                const totalTrades = document.getElementById("total-trades");
                if (totalTrades) totalTrades.innerText = analytics.history.length;
                
                const bestTrade = document.getElementById("best-trade");
                if (bestTrade) bestTrade.innerText = Math.max(...profits).toFixed(8);
                
                const worstTrade = document.getElementById("worst-trade");
                if (worstTrade) worstTrade.innerText = Math.min(...profits).toFixed(8);
            }
            
            // Update risk metrics
            const winRate = bot.stats.bets > 0 ? (bot.stats.wins / bot.stats.bets * 100) : 50;
            const payoutRatio = bot.currentChance > 0 ? (100 / bot.currentChance) - 1 : 1;
            const maxBet = riskManager.calculateMaxBet(bot.stats.currentBal, winRate, payoutRatio);
            
            const currentRisk = document.getElementById("current-risk");
            if (currentRisk) currentRisk.innerText = riskManager.maxRiskPerTrade + '%';
            
            const maxAllowedBet = document.getElementById("max-allowed-bet");
            if (maxAllowedBet) maxAllowedBet.innerText = maxBet.toFixed(8);
            
            // Update trailing stop info
            if (trailingStop.enabled && trailingStop.isTrailing) {
                const currentDiff = ((trailingStop.peakBalance - bot.stats.currentBal) / trailingStop.peakBalance * 100).toFixed(2);
                const trailInfo = document.getElementById("trailing-info");
                if (trailInfo) {
                    trailInfo.innerHTML = 
                        `Peak: ${trailingStop.peakBalance.toFixed(8)}<br>` +
                        `Current: ${bot.stats.currentBal.toFixed(8)}<br>` +
                        `Distance: ${currentDiff}% / ${trailingStop.trailDistance}%`;
                }
            }
            
        } catch (e) {
            console.error("UI update error:", e);
        }
    }, 1000);

    // ==================== INITIALIZATION ====================
    async function initialize() {
        const isValid = await validateLicense();
        
        if (isValid) {
            console.log(`‚úÖ License valid for ${currentUser} (${licenseData.tier})`);
            bot.licenseTier = licenseData.tier;
            bot.stakeUser = currentUser;
            
            createUI();
            
            const licenseInfo = document.getElementById("license-info");
            if (licenseInfo) {
                licenseInfo.innerText = `${licenseData.tier} License - Expires: ${licenseData.expiry}`;
            }
            
            const savedTab = localStorage.getItem('orion_active_tab') || 'settings';
            switchTab(savedTab);
            
        } else {
            console.log("‚ùå License invalid or user not whitelisted");
        }
    }

    // Start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();

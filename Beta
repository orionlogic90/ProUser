(function () {
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/_api'; },
        version: "ORION ALPHA v4.6",
        tgToken: '8391763291:AAEA05v6FG70eM1WGrgU7mrPgckfjQaxkno',
        tgChatId: '-1003744641395',
        supportContact: '@OrionLogic'
    };

    // ==================== WHITELIST SYSTEM ====================
    const WHITELIST = {
        "orionlogic": { tier: "VIP", expiry: "2099-12-31" },
        "biele": { tier: "PREMIUM", expiry: "2026-02-26" },
        "siska82": { tier: "PREMIUM", expiry: "2026-02-26" },
        "dfransiska": { tier: "PREMIUM", expiry: "2026-02-26" },
        "brokenpips": { tier: "PREMIUM", expiry: "2026-02-26" },
        "aynus": { tier: "PREMIUM", expiry: "2026-02-26" },
        "terbaik444": { tier: "PREMIUM", expiry: "2026-01-30" },
        "k4pitiang": { tier: "PREMIUM", expiry: "2026-02-26" }
    };

    // ==================== LICENSE VALIDATION ====================
    let currentUser = null;
    let licenseData = null;

    async function validateLicense() {
        try {
            const token = localStorage.getItem('apitoken') || 
                         (document.cookie.match(/session=([^;]+)/) ? 
                          document.cookie.match(/session=([^;]+)/)[1] : null);

            if (!token) {
                showLicenseModal("Please login to Stake.com first");
                return false;
            }

            const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "x-access-token": token 
                },
                body: JSON.stringify({ query: `query{user{name}}` })
            });

            const data = await response.json();
            const username = data?.data?.user?.name?.toLowerCase();

            if (!username) {
                showLicenseModal("Cannot retrieve username");
                return false;
            }

            currentUser = username;
            licenseData = WHITELIST[username];
            
            if (!licenseData) {
                showLicenseModal(
                    `Username <strong>${username}</strong> is not whitelisted.`, 
                    true
                );
                return false;
            }

            const expiryDate = new Date(licenseData.expiry);
            if (new Date() > expiryDate) {
                showLicenseModal(
                    `License expired on ${expiryDate.toLocaleDateString()}.`, 
                    true
                );
                return false;
            }

            console.log(`‚úÖ License validated: ${username} (${licenseData.tier})`);
            
            await sendTelegramReport("load");
            
            return true;

        } catch (error) {
            console.error("License validation error:", error);
            showLicenseModal("Connection error. Please refresh.");
            return false;
        }
    }

    function showLicenseModal(message, isError = false) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
        `;
        
        modal.innerHTML = `
            <div style="background: #222; border-radius: 15px; padding: 30px; max-width: 400px; width: 100%; border: 2px solid ${isError ? '#ff3333' : '#666'};">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 32px; margin-bottom: 10px;">${isError ? '‚ùå' : 'üîí'}</div>
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: ${isError ? '#ff6b6b' : '#e0e0e0'};">ORION ALPHA ACCESS</div>
                    <div style="font-size: 12px; color: #888; margin-bottom: 20px;">${CONFIG.version}</div>
                </div>
                
                <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #ccc; text-align: center;">${message}</div>
                </div>
                
                ${isError ? `
                <div style="background: #332222; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #443333;">
                    <div style="font-size: 12px; color: #ff9999; text-align: center;">
                        Need license? Contact: ${CONFIG.supportContact}
                    </div>
                </div>
                ` : ''}
                
                <button onclick="this.parentElement.parentElement.remove(); location.reload();" 
                        style="width: 100%; padding: 12px; background: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    ${isError ? 'RETRY' : 'CONTINUE'}
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    // ==================== ROTATION SETTINGS SYSTEM ====================
    const RotationConfig = {
        // Base ‚Üí Wager triggers
        baseToWager: {
            enabled: true,
            minProfitMultiplier: 2, // Profit harus >= 2x basebet
            minWinStreak: 2,
            maxLossStreak: 0,
            minBets: 5,
            profitThreshold: 0.01, // Minimal 1% profit dari balance awal
            useProfitThreshold: false,
            checkSessionProfit: true,
            sessionProfitMin: 0.5 // Minimal 0.5% profit session
        },
        
        // Wager ‚Üí Base triggers
        wagerToBase: {
            enabled: true,
            maxLossStreak: 8,
            maxLossMultiplier: 3, // Loss tidak boleh > 3x loss awal
            minProfit: 0.00000100, // Minimal profit 1 basebet
            maxBets: 30,
            useTimeLimit: false,
            timeLimitMinutes: 5
        },
        
        // Base Recovery triggers
        baseRecovery: {
            enabled: true,
            lossStreakThreshold: 3,
            profitDropThreshold: 50, // 50% drop dari peak
            useDynamicRecovery: true,
            recoveryChanceMin: 70,
            recoveryChanceMax: 85,
            recoveryBetMultiplier: 1.5,
            maxRecoveryLevel: 5
        },
        
        // Wager Recovery triggers (D'Alembert)
        wagerRecovery: {
            enabled: true,
            lossThreshold: -0.01, // -1% dari balance
            useDallembert: true,
            dallembertLevel1: { min: 25, max: 35 },
            dallembertLevel2: { min: 45, max: 55 },
            dallembertLevel3: { min: 77, max: 87 }
        },
        
        // Auto Rotation
        autoRotation: {
            enabled: true,
            minSessionTime: 60, // Detik
            maxSessionTime: 300,
            forceRotateAfter: 600, // 10 menit
            rotationCooldown: 30 // Detik
        },
        
        // Statistics tracking
        stats: {
            lastRotationTime: null,
            rotationCount: 0,
            successfulRotations: 0,
            failedRotations: 0,
            rotationHistory: []
        }
    };

    // ==================== D'ALEMBERT RECOVERY SYSTEM ====================
    const DallembertRecovery = {
        levels: [
            { // Level 1-5
                min: 1, max: 5,
                chance: { min: 25, max: 35 },
                betMultiplier: 1.2,
                description: "Aggressive recovery"
            },
            { // Level 6-10
                min: 6, max: 10,
                chance: { min: 45, max: 55 },
                betMultiplier: 1.5,
                description: "Moderate recovery"
            },
            { // Level 11-15
                min: 11, max: 15,
                chance: { min: 77, max: 87 },
                betMultiplier: 2.0,
                description: "Conservative recovery"
            }
        ],
        
        getLevelSettings(lossStreak) {
            for (const level of this.levels) {
                if (lossStreak >= level.min && lossStreak <= level.max) {
                    return level;
                }
            }
            return this.levels[this.levels.length - 1];
        },
        
        calculateBet(baseBet, lossStreak, level) {
            return baseBet * level.betMultiplier * Math.pow(1.1, lossStreak);
        },
        
        calculateChance(level) {
            return Math.random() * (level.chance.max - level.chance.min) + level.chance.min;
        }
    };

    // ==================== BOT ENGINE ====================
    const bot = {
        isRunning: false,
        isPaused: false,
        mode: "BASE",
        token: null,
        stakeUser: "Loading...",
        startTime: null,
        stopTime: null,
        lastRotationTime: null,
        stats: {
            profit: 0,
            wagered: 0,
            startBal: 0,
            currentBal: 0,
            bets: 0,
            wins: 0,
            loss: 0,
            maxDD: 0,
            maxProfit: 0,
            sessionProfit: 0,
            sessionWagered: 0,
            sessionBets: 0,
            sessionStartBal: 0,
            peakBalance: 0,
            sessionsCompleted: 0,
            totalProfit: 0,
            totalWagered: 0,
            baseModeProfit: 0,
            wagerModeProfit: 0,
            longestWinStreak: 0,
            longestLossStreak: 0,
            currentWinStreak: 0,
            currentLossStreak: 0,
            biggestWin: 0,
            biggestLoss: 0,
            totalSessions: 0,
            profitableSessions: 0,
            losingSessions: 0,
            modeDuration: { BASE: 0, WAGER: 0 },
            modeBets: { BASE: 0, WAGER: 0 },
            modeProfits: { BASE: 0, WAGER: 0 }
        },
        selectedCurrency: localStorage.getItem('orion_last_coin') || "usdt",
        nextBet: 0,
        currentChance: 0,
        currentMulti: 0,
        ls: 0,
        lc: 0,
        bcount: 0,
        partialProfit: 0,
        targetAbs: 0,
        
        wgr: {
            ctwin: 0,
            balhigh: 0,
            profitc: 0,
            betload: 0,
            lossStreak: 0,
            recoveryActive: false,
            recoveryLevel: 0,
            recoveryWins: 0,
            recoveryTarget: 0,
            originalLoss: 0,
            recoveryType: null // 'BASE' atau 'WAGER'
        },
        
        lastReportPct: 0,
        lastReportTime: 0,
        
        licenseTier: "PREMIUM",
        supportContact: CONFIG.supportContact,
        
        session: {
            targetProfit: 0,
            stopLoss: 0,
            targetWager: 0,
            maxSessions: 20,
            currentSession: 1,
            sessionHistory: [],
            trailingStop: {
                enabled: true,
                activation: 0.5,
                distance: 0.2,
                activated: false,
                peak: 0
            },
            modeStartTime: Date.now(),
            modeBetsCount: 0
        }
    };

    // ==================== API FUNCTIONS ====================
    const API = {
        async syncOnce() {
            bot.token = localStorage.getItem('apitoken') || (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{name balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;
                    const bals = json.data.user.balances || [];
                    const sel = document.getElementById("p-currency");
                    
                    const currentSelected = sel.value || bot.selectedCurrency;
                    sel.innerHTML = "";

                    bals.forEach(b => {
                        const opt = new Option(
                            `${b.available.currency.toUpperCase()} (${parseFloat(b.available.amount).toFixed(2)})`,
                            b.available.currency
                        );
                        if(b.available.currency === currentSelected) opt.selected = true;
                        sel.add(opt);
                    });
                    bot.selectedCurrency = sel.value;
                    
                    await updateBalanceDisplay();
                }
            } catch (e) {
                console.error("Sync Error:", e);
            }
        },

        async getBalance(coin) {
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(
                    b => b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                return active ? parseFloat(active.available.amount) : 0;
            } catch (e) {
                console.error("Balance Error:", e);
                return 0;
            }
        },

        async placeBet(amount, chance) {
            const payload = {
                amount: parseFloat(amount.toFixed(8)),
                currency: bot.selectedCurrency,
                target: (100 - chance).toFixed(1),
                condition: "above",
                identifier: Math.random().toString(36).slice(2) + Date.now()
            };
            
            const startTime = Date.now();
            
            try {
                const r = await fetch(`${CONFIG.apiUrl}/casino/dice/roll`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify(payload)
                });
                const result = await r.json();
                
                const speed = Date.now() - startTime;
                if (speed > 100) {
                    console.log(`Bet speed: ${speed}ms`);
                }
                
                return result;
            } catch (error) {
                console.error("Bet Error:", error);
                throw error;
            }
        }
    };

    // ==================== TELEGRAM REPORT ====================
    async function sendTelegramReport(reason) {
        try {
            const now = Date.now();
            
            if (reason === "auto" && now - bot.lastReportTime < 300000) {
                return;
            }
            
            bot.lastReportTime = now;
            
            const runningTime = getElapsedTime();
            const currentDD = bot.stats.startBal - bot.stats.currentBal;
            const currentDDPct = bot.stats.startBal > 0 ? (currentDD / bot.stats.startBal * 100) : 0;
            const wagerPct = bot.stats.startBal > 0 ? (bot.stats.wagered / bot.stats.startBal * 100) : 0;
            const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
            const sessionProfitPct = bot.stats.sessionStartBal > 0 ?
                (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100) : 0;
            
            let header = "";
            let emoji = "üöÄ";
            
            switch(reason) {
                case "load": header = "üì± *BOT LOADED*"; emoji = "üì±"; break;
                case "start": header = "‚ñ∂Ô∏è *BOT STARTED*"; emoji = "‚ñ∂Ô∏è"; break;
                case "stop": header = "üõë *BOT STOPPED*"; emoji = "üõë"; break;
                case "target": header = "üéØ *TARGET REACHED*"; emoji = "üéØ"; break;
                case "stoploss": header = "‚õî *STOP LOSS HIT*"; emoji = "‚õî"; break;
                case "session_end": header = "üèÅ *SESSION COMPLETED*"; emoji = "üèÅ"; break;
                case "session_start": header = "üöÄ *NEW SESSION STARTED*"; emoji = "üöÄ"; break;
                case "max_sessions": header = "üìä *MAX SESSIONS REACHED*"; emoji = "üìä"; break;
                case "recovery_start": header = "üîÑ *RECOVERY STARTED*"; emoji = "üîÑ"; break;
                case "recovery_complete": header = "‚úÖ *RECOVERY COMPLETE*"; emoji = "‚úÖ"; break;
                case "mode_switch": header = "üîÑ *MODE SWITCHED*"; emoji = "üîÑ"; break;
                case "rotation": header = "üîÑ *AUTO ROTATION*"; emoji = "üîÑ"; break;
                default: header = "üìä *REGULAR REPORT*"; emoji = "üìä";
            }
            
            // Add rotation stats
            const rotationStats = RotationConfig.stats.rotationCount > 0 ? 
                `\nüîÑ *Rotations:* ${RotationConfig.stats.successfulRotations}/${RotationConfig.stats.rotationCount}` : '';
            
            const message =
                `${emoji} ${header}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üë§ *User:* ${bot.stakeUser}\n` +
                `üí∞ *Currency:* ${bot.selectedCurrency.toUpperCase()}\n` +
                `üîí *License:* ${bot.licenseTier}\n` +
                `üéÆ *Mode:* ${bot.mode}${bot.wgr.recoveryActive ? ` (${bot.wgr.recoveryType} RECOVERY LVL ${bot.wgr.recoveryLevel})` : ''}\n` +
                `‚è± *Time:* ${runningTime}\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üè¶ *Start Balance:* ${bot.stats.startBal.toFixed(8)}\n` +
                `üìà *Current Balance:* ${bot.stats.currentBal.toFixed(8)}\n` +
                `‚úÖ *Total Profit:* ${bot.stats.profit.toFixed(8)}\n` +
                `üìä *Session P/L:* ${bot.stats.sessionProfit.toFixed(8)} (${sessionProfitPct.toFixed(2)}%)\n` +
                `üéØ *Wagered:* ${bot.stats.wagered.toFixed(8)} (${wagerPct.toFixed(1)}%)\n` +
                `üìâ *Drawdown:* ${currentDD.toFixed(8)} (${currentDDPct.toFixed(2)}%)\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üèóÔ∏è *Base P/L:* ${bot.stats.baseModeProfit.toFixed(8)}\n` +
                `‚ö° *Wager P/L:* ${bot.stats.wagerModeProfit.toFixed(8)}\n` +
                (bot.wgr.recoveryActive ? 
                    `üîÑ *Recovery Level:* ${bot.wgr.recoveryLevel}\n` +
                    `üìâ *Loss Streak:* ${bot.wgr.lossStreak}\n` +
                    `üéØ *Chance:* ${bot.currentChance.toFixed(1)}%\n` : "") +
                `üîÑ *W/L:* ${bot.stats.wins}/${bot.stats.loss}\n` +
                `üé≤ *Bets:* ${bot.stats.bets}\n` +
                `üìä *Win Rate:* ${winRate.toFixed(1)}%\n` +
                `üìà *Session:* ${bot.session.currentSession}/${bot.session.maxSessions || '‚àû'}\n` +
                `üèÜ *Profitable Sessions:* ${bot.stats.profitableSessions}/${bot.stats.totalSessions}` +
                rotationStats + `\n` +
                `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                `üìä *Status:* ${bot.isRunning ? (bot.isPaused ? '‚è∏Ô∏è PAUSED' : '‚ñ∂Ô∏è RUNNING') : 'üõë STOPPED'}\n\n` +
                `üí¨ *Support:* ${CONFIG.supportContact}\n` +
                `‚ö° *Version:* ${CONFIG.version}`;

            const url = `https://api.telegram.org/bot${CONFIG.tgToken}/sendMessage`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CONFIG.tgChatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            
            console.log(`${emoji} Telegram report sent (${reason})`);
            
        } catch (error) {
            console.error('Telegram report error:', error);
        }
    }

    // ==================== ROTATION MANAGEMENT ====================
    function updateRotationConfigFromUI() {
        // Base ‚Üí Wager
        RotationConfig.baseToWager.enabled = getVal("p-rotate-base-wager-enabled") === 1;
        RotationConfig.baseToWager.minProfitMultiplier = getVal("p-rotate-base-wager-profit-mult");
        RotationConfig.baseToWager.minWinStreak = getVal("p-rotate-base-wager-win-streak");
        RotationConfig.baseToWager.maxLossStreak = getVal("p-rotate-base-wager-loss-streak");
        RotationConfig.baseToWager.minBets = getVal("p-rotate-base-wager-min-bets");
        RotationConfig.baseToWager.profitThreshold = getVal("p-rotate-base-wager-profit-threshold");
        RotationConfig.baseToWager.useProfitThreshold = getVal("p-rotate-base-wager-use-threshold") === 1;
        RotationConfig.baseToWager.checkSessionProfit = getVal("p-rotate-base-wager-session-profit") === 1;
        RotationConfig.baseToWager.sessionProfitMin = getVal("p-rotate-base-wager-session-profit-min");
        
        // Wager ‚Üí Base
        RotationConfig.wagerToBase.enabled = getVal("p-rotate-wager-base-enabled") === 1;
        RotationConfig.wagerToBase.maxLossStreak = getVal("p-rotate-wager-base-loss-streak");
        RotationConfig.wagerToBase.maxLossMultiplier = getVal("p-rotate-wager-base-loss-mult");
        RotationConfig.wagerToBase.minProfit = getVal("p-rotate-wager-base-min-profit");
        RotationConfig.wagerToBase.maxBets = getVal("p-rotate-wager-base-max-bets");
        RotationConfig.wagerToBase.useTimeLimit = getVal("p-rotate-wager-base-time-limit") === 1;
        RotationConfig.wagerToBase.timeLimitMinutes = getVal("p-rotate-wager-base-time-minutes");
        
        // Base Recovery
        RotationConfig.baseRecovery.enabled = getVal("p-rotate-base-recovery-enabled") === 1;
        RotationConfig.baseRecovery.lossStreakThreshold = getVal("p-rotate-base-recovery-loss-streak");
        RotationConfig.baseRecovery.profitDropThreshold = getVal("p-rotate-base-recovery-profit-drop");
        RotationConfig.baseRecovery.useDynamicRecovery = getVal("p-rotate-base-recovery-dynamic") === 1;
        RotationConfig.baseRecovery.recoveryChanceMin = getVal("p-rotate-base-recovery-chance-min");
        RotationConfig.baseRecovery.recoveryChanceMax = getVal("p-rotate-base-recovery-chance-max");
        RotationConfig.baseRecovery.recoveryBetMultiplier = getVal("p-rotate-base-recovery-bet-mult");
        RotationConfig.baseRecovery.maxRecoveryLevel = getVal("p-rotate-base-recovery-max-level");
        
        // Wager Recovery
        RotationConfig.wagerRecovery.enabled = getVal("p-rotate-wager-recovery-enabled") === 1;
        RotationConfig.wagerRecovery.lossThreshold = getVal("p-rotate-wager-recovery-loss-threshold");
        RotationConfig.wagerRecovery.useDallembert = getVal("p-rotate-wager-recovery-dallembert") === 1;
        
        // Auto Rotation
        RotationConfig.autoRotation.enabled = getVal("p-rotate-auto-enabled") === 1;
        RotationConfig.autoRotation.minSessionTime = getVal("p-rotate-auto-min-time");
        RotationConfig.autoRotation.maxSessionTime = getVal("p-rotate-auto-max-time");
        RotationConfig.autoRotation.forceRotateAfter = getVal("p-rotate-auto-force-time");
        RotationConfig.autoRotation.rotationCooldown = getVal("p-rotate-auto-cooldown");
        
        console.log("Rotation config updated from UI");
    }

    function shouldRotateToWager() {
        if (!RotationConfig.baseToWager.enabled || bot.mode !== "BASE") return false;
        
        const config = RotationConfig.baseToWager;
        
        // Check cooldown
        if (RotationConfig.stats.lastRotationTime && 
            (Date.now() - RotationConfig.stats.lastRotationTime) < (RotationConfig.autoRotation.rotationCooldown * 1000)) {
            return false;
        }
        
        // Check minimum bets in current mode
        if (bot.session.modeBetsCount < config.minBets) return false;
        
        // Check loss streak
        if (config.maxLossStreak >= 0 && bot.stats.currentLossStreak > config.maxLossStreak) return false;
        
        // Check win streak
        if (bot.stats.currentWinStreak < config.minWinStreak) return false;
        
        // Check profit multiplier
        const minProfit = getVal("p-basebet") * config.minProfitMultiplier;
        if (bot.stats.baseModeProfit < minProfit) return false;
        
        // Check profit threshold (percentage)
        if (config.useProfitThreshold) {
            const profitPct = (bot.stats.baseModeProfit / bot.stats.sessionStartBal) * 100;
            if (profitPct < config.profitThreshold) return false;
        }
        
        // Check session profit
        if (config.checkSessionProfit) {
            const sessionProfitPct = (bot.stats.sessionProfit / bot.stats.sessionStartBal) * 100;
            if (sessionProfitPct < config.sessionProfitMin) return false;
        }
        
        // Check if in recovery
        if (bot.wgr.recoveryActive) return false;
        
        return true;
    }

    function shouldRotateToBase() {
        if (!RotationConfig.wagerToBase.enabled || bot.mode !== "WAGER") return false;
        
        const config = RotationConfig.wagerToBase;
        
        // Check cooldown
        if (RotationConfig.stats.lastRotationTime && 
            (Date.now() - RotationConfig.stats.lastRotationTime) < (RotationConfig.autoRotation.rotationCooldown * 1000)) {
            return false;
        }
        
        // Check loss streak
        if (bot.wgr.lossStreak >= config.maxLossStreak) return true;
        
        // Check loss multiplier
        if (config.maxLossMultiplier > 0 && bot.wgr.recoveryActive) {
            const currentLoss = Math.abs(bot.wgr.profitc);
            const originalLoss = Math.abs(bot.wgr.originalLoss);
            if (originalLoss > 0 && currentLoss >= originalLoss * config.maxLossMultiplier) return true;
        }
        
        // Check minimum profit
        if (bot.stats.wagerModeProfit < config.minProfit) return true;
        
        // Check max bets
        if (config.maxBets > 0 && bot.session.modeBetsCount >= config.maxBets) return true;
        
        // Check time limit
        if (config.useTimeLimit) {
            const modeDuration = Date.now() - bot.session.modeStartTime;
            if (modeDuration >= config.timeLimitMinutes * 60 * 1000) return true;
        }
        
        // Auto rotation force
        if (RotationConfig.autoRotation.enabled) {
            const modeDuration = Date.now() - bot.session.modeStartTime;
            if (modeDuration >= RotationConfig.autoRotation.forceRotateAfter * 1000) return true;
        }
        
        return false;
    }

    function shouldStartBaseRecovery() {
        if (!RotationConfig.baseRecovery.enabled || bot.mode !== "BASE" || bot.wgr.recoveryActive) return false;
        
        const config = RotationConfig.baseRecovery;
        
        // Check loss streak
        if (bot.stats.currentLossStreak >= config.lossStreakThreshold) return true;
        
        // Check profit drop
        if (config.profitDropThreshold > 0) {
            const profitDrop = (bot.stats.peakBalance - bot.stats.currentBal) / bot.stats.peakBalance * 100;
            if (profitDrop >= config.profitDropThreshold) return true;
        }
        
        return false;
    }

    function shouldStartWagerRecovery() {
        if (!RotationConfig.wagerRecovery.enabled || bot.mode !== "WAGER" || bot.wgr.recoveryActive) return false;
        
        const config = RotationConfig.wagerRecovery;
        
        // Check loss threshold (percentage)
        if (config.lossThreshold < 0) {
            const lossPct = (bot.wgr.profitc / bot.stats.startBal) * 100;
            if (lossPct <= config.lossThreshold) return true;
        }
        
        return false;
    }

    function rotateMode(newMode) {
        const oldMode = bot.mode;
        const rotationTime = Date.now();
        
        // Update rotation stats
        RotationConfig.stats.rotationCount++;
        RotationConfig.stats.lastRotationTime = rotationTime;
        
        // Record rotation history
        const rotationRecord = {
            timestamp: rotationTime,
            from: oldMode,
            to: newMode,
            reason: getRotationReason(oldMode, newMode),
            baseProfit: bot.stats.baseModeProfit,
            wagerProfit: bot.stats.wagerModeProfit,
            sessionProfit: bot.stats.sessionProfit,
            balance: bot.stats.currentBal
        };
        
        RotationConfig.stats.rotationHistory.unshift(rotationRecord);
        if (RotationConfig.stats.rotationHistory.length > 20) {
            RotationConfig.stats.rotationHistory.pop();
        }
        
        // Perform rotation
        bot.mode = newMode;
        bot.lastRotationTime = rotationTime;
        bot.session.modeStartTime = rotationTime;
        bot.session.modeBetsCount = 0;
        
        // Reset mode-specific stats
        if (newMode === "BASE") {
            rotateToBaseMode();
        } else if (newMode === "WAGER") {
            rotateToWagerMode();
        }
        
        // Update UI
        updateStatus(`üîÑ ${oldMode} ‚Üí ${newMode}`, "#888");
        updateLogs(0, 0, "ROTATION", 0, `${oldMode} ‚Üí ${newMode} (${rotationRecord.reason})`);
        
        // Send report
        sendTelegramReport("rotation");
        
        RotationConfig.stats.successfulRotations++;
        
        console.log(`üîÑ Mode rotated: ${oldMode} ‚Üí ${newMode}`);
    }

    function rotateToBaseMode() {
        // Reset base mode parameters
        bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
        bot.nextBet = getVal("p-basebet");
        bot.currentMulti = getVal("p-multi-start");
        bot.ls = 0;
        bot.lc = 0;
        bot.partialProfit = 0;
        bot.bcount = 0;
        
        // Reset recovery
        bot.wgr.recoveryActive = false;
        bot.wgr.recoveryType = null;
        bot.wgr.lossStreak = 0;
        bot.wgr.recoveryLevel = 0;
        bot.wgr.recoveryWins = 0;
        
        console.log("üîÑ Rotated to BASE mode");
    }

    function rotateToWagerMode() {
        // Reset wager mode parameters
        bot.currentChance = getVal("p-wgr-chance");
        bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
        bot.wgr.balhigh = bot.stats.currentBal;
        bot.wgr.profitc = 0;
        bot.wgr.ctwin = 0;
        bot.wgr.betload = 0;
        
        // Reset recovery
        bot.wgr.recoveryActive = false;
        bot.wgr.recoveryType = null;
        bot.wgr.lossStreak = 0;
        bot.wgr.recoveryLevel = 0;
        bot.wgr.recoveryWins = 0;
        
        console.log("üîÑ Rotated to WAGER mode");
    }

    function getRotationReason(fromMode, toMode) {
        if (fromMode === "BASE" && toMode === "WAGER") {
            return "Profit target reached";
        } else if (fromMode === "WAGER" && toMode === "BASE") {
            if (bot.wgr.lossStreak >= RotationConfig.wagerToBase.maxLossStreak) {
                return "Loss streak too high";
            } else if (bot.session.modeBetsCount >= RotationConfig.wagerToBase.maxBets) {
                return "Max bets reached";
            } else {
                return "Profit target achieved";
            }
        }
        return "Manual rotation";
    }

    // ==================== RECOVERY MANAGEMENT ====================
    function startBaseRecovery() {
        bot.wgr.recoveryActive = true;
        bot.wgr.recoveryType = "BASE";
        bot.wgr.recoveryLevel = 1;
        bot.wgr.recoveryWins = 0;
        bot.wgr.lossStreak = bot.stats.currentLossStreak;
        bot.wgr.originalLoss = bot.stats.baseModeProfit;
        
        const config = RotationConfig.baseRecovery;
        
        // Set recovery chance
        if (config.useDynamicRecovery) {
            bot.currentChance = Math.random() * (config.recoveryChanceMax - config.recoveryChanceMin) + config.recoveryChanceMin;
        } else {
            bot.currentChance = 80; // Default
        }
        
        // Set recovery bet
        bot.nextBet = getVal("p-basebet") * config.recoveryBetMultiplier;
        
        // Reset base parameters
        bot.ls = 0;
        bot.lc = 0;
        bot.partialProfit = 0;
        bot.currentMulti = getVal("p-multi-start");
        
        updateStatus(`üîÑ BASE RECOVERY LVL ${bot.wgr.recoveryLevel}`, "#ffa500");
        updateLogs(0, 0, "RECOVERY", 0, "Base mode recovery started");
        sendTelegramReport("recovery_start");
        
        return true;
    }

    function startWagerRecovery() {
        bot.wgr.recoveryActive = true;
        bot.wgr.recoveryType = "WAGER";
        bot.wgr.originalLoss = bot.wgr.profitc;
        bot.wgr.recoveryLevel = 1;
        bot.wgr.recoveryWins = 0;
        bot.wgr.lossStreak = 0;
        
        if (RotationConfig.wagerRecovery.useDallembert) {
            updateDallembertRecovery();
        } else {
            // Simple recovery
            bot.currentChance = 95;
            bot.nextBet = bot.stats.currentBal / (getVal("p-wgr-div") * 2);
        }
        
        updateStatus(`üîÑ WAGER RECOVERY LVL ${bot.wgr.recoveryLevel}`, "#ffa500");
        updateLogs(0, 0, "RECOVERY", 0, "Wager mode recovery started");
        sendTelegramReport("recovery_start");
        
        return true;
    }

    function updateDallembertRecovery() {
        if (!bot.wgr.recoveryActive || bot.wgr.recoveryType !== "WAGER") return;
        
        const levelSettings = DallembertRecovery.getLevelSettings(bot.wgr.lossStreak);
        bot.wgr.recoveryLevel = Math.floor((bot.wgr.lossStreak - 1) / 5) + 1;
        
        bot.currentChance = DallembertRecovery.calculateChance(levelSettings);
        
        const baseBet = bot.stats.currentBal / getVal("p-wgr-div");
        bot.nextBet = DallembertRecovery.calculateBet(baseBet, bot.wgr.lossStreak, levelSettings);
        
        const minBet = getVal("p-minbet");
        bot.nextBet = Math.max(bot.nextBet, minBet);
        
        updateRecoveryUI();
    }

    function handleRecoveryWin() {
        if (!bot.wgr.recoveryActive) return;
        
        bot.wgr.recoveryWins++;
        
        if (bot.wgr.recoveryType === "BASE") {
            bot.wgr.lossStreak = Math.max(0, bot.wgr.lossStreak - 1);
            
            // Check if recovery complete
            if (bot.stats.baseModeProfit > bot.wgr.originalLoss) {
                completeRecovery(true);
            } else {
                // Continue recovery with adjusted parameters
                const config = RotationConfig.baseRecovery;
                bot.currentChance = Math.max(70, bot.currentChance - 5);
                bot.nextBet *= 1.1;
            }
        } else if (bot.wgr.recoveryType === "WAGER") {
            bot.wgr.lossStreak = Math.max(0, bot.wgr.lossStreak - 2);
            
            if (bot.wgr.profitc >= 0) {
                completeRecovery(true);
            } else {
                updateDallembertRecovery();
            }
        }
    }

    function handleRecoveryLoss() {
        if (!bot.wgr.recoveryActive) return;
        
        bot.wgr.lossStreak++;
        
        if (bot.wgr.recoveryType === "BASE") {
            // Check if should stop recovery and rotate
            if (bot.wgr.lossStreak >= RotationConfig.baseRecovery.maxRecoveryLevel * 3) {
                completeRecovery(false);
                if (shouldRotateToWager()) {
                    rotateMode("WAGER");
                }
                return;
            }
            
            // Increase chance for next bet
            const config = RotationConfig.baseRecovery;
            bot.currentChance = Math.min(95, bot.currentChance + 10);
            bot.nextBet *= 1.2;
            bot.wgr.recoveryLevel = Math.floor((bot.wgr.lossStreak - 1) / 3) + 1;
            
        } else if (bot.wgr.recoveryType === "WAGER") {
            if (shouldRotateToBase()) {
                completeRecovery(false);
                rotateMode("BASE");
                return;
            }
            
            updateDallembertRecovery();
        }
    }

    function completeRecovery(success) {
        const recoveryType = bot.wgr.recoveryType;
        
        bot.wgr.recoveryActive = false;
        bot.wgr.recoveryType = null;
        bot.wgr.lossStreak = 0;
        bot.wgr.recoveryLevel = 0;
        bot.wgr.recoveryWins = 0;
        
        if (recoveryType === "BASE") {
            bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
            bot.nextBet = getVal("p-basebet");
        } else if (recoveryType === "WAGER") {
            bot.currentChance = getVal("p-wgr-chance");
            bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
        }
        
        if (success) {
            updateStatus(`‚úÖ ${recoveryType} RECOVERY COMPLETE`, "#4CAF50");
            sendTelegramReport("recovery_complete");
        } else {
            updateStatus(`‚ùå ${recoveryType} RECOVERY FAILED`, "#ff6b6b");
        }
        
        updateRecoveryUI();
    }

    // ==================== SESSION MANAGEMENT ====================
    function startNewSession() {
        if (bot.stats.sessionStartBal > 0 && bot.stats.sessionBets > 0) {
            const sessionData = {
                sessionNumber: bot.session.currentSession,
                startBalance: bot.stats.sessionStartBal,
                endBalance: bot.stats.currentBal,
                profit: bot.stats.sessionProfit,
                profitPct: (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100),
                bets: bot.stats.sessionBets,
                duration: Date.now() - bot.startTime
            };
            
            bot.session.sessionHistory.push(sessionData);
            
            if (bot.stats.sessionProfit > 0) {
                bot.stats.profitableSessions++;
            } else {
                bot.stats.losingSessions++;
            }
            bot.stats.totalSessions++;
        }
        
        bot.session.currentSession++;
        bot.stats.sessionStartBal = bot.stats.currentBal;
        bot.stats.sessionProfit = 0;
        bot.stats.sessionWagered = 0;
        bot.stats.sessionBets = 0;
        
        bot.session.trailingStop.peak = bot.stats.currentBal;
        bot.session.trailingStop.activated = false;
        
        bot.session.modeStartTime = Date.now();
        bot.session.modeBetsCount = 0;
        
        console.log(`üöÄ Starting session ${bot.session.currentSession}`);
        updateStatus(`üöÄ SESSION ${bot.session.currentSession}`, "#666");
        sendTelegramReport("session_start");
        
        updateLogs(0, 0, "SESSION", 0, `Session ${bot.session.currentSession} started`);
        
        bot.isRunning = true;
        bot.isPaused = false;
        
        return true;
    }

    function checkSessionCompletion() {
        const sessionTargetPct = getVal("p-session-target");
        const sessionStopLossPct = getVal("p-session-stoploss");
        const sessionProfitPct = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
        
        if (sessionProfitPct >= sessionTargetPct) {
            completeSession("TARGET");
            return true;
        }
        
        if (sessionProfitPct <= -sessionStopLossPct) {
            completeSession("STOP LOSS");
            return true;
        }
        
        return false;
    }

    function completeSession(reason) {
        const sessionData = {
            sessionNumber: bot.session.currentSession,
            startBalance: bot.stats.sessionStartBal,
            endBalance: bot.stats.currentBal,
            profit: bot.stats.sessionProfit,
            profitPct: (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100),
            bets: bot.stats.sessionBets,
            duration: Date.now() - bot.startTime,
            reason: reason
        };
        
        bot.session.sessionHistory.push(sessionData);
        
        if (bot.stats.sessionProfit > 0) {
            bot.stats.profitableSessions++;
        } else {
            bot.stats.losingSessions++;
        }
        bot.stats.totalSessions++;
        
        const maxSessions = getVal("p-max-sessions");
        if (maxSessions > 0 && bot.session.currentSession >= maxSessions) {
            stopEngine();
            updateStatus("üìä MAX SESSIONS", "#888");
            sendTelegramReport("max_sessions");
            return false;
        }
        
        startNewSession();
        return true;
    }

    function updateTrailingStop() {
        if (!bot.session.trailingStop.enabled) return false;
        
        const currentProfitPct = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
        
        if (bot.stats.currentBal > bot.session.trailingStop.peak) {
            bot.session.trailingStop.peak = bot.stats.currentBal;
        }
        
        if (!bot.session.trailingStop.activated && currentProfitPct >= bot.session.trailingStop.activation) {
            bot.session.trailingStop.activated = true;
            updateLogs(0, 0, "TRAILING", 0, "Trailing stop activated");
        }
        
        if (bot.session.trailingStop.activated) {
            const distanceFromPeak = (bot.session.trailingStop.peak - bot.stats.currentBal) / bot.session.trailingStop.peak * 100;
            
            if (distanceFromPeak > bot.session.trailingStop.distance) {
                updateLogs(0, 0, "TRAILING", 0, `Trailing stop triggered: ${distanceFromPeak.toFixed(2)}%`);
                completeSession("TRAILING STOP");
                return true;
            }
        }
        
        return false;
    }

    // ==================== UTILITY FUNCTIONS ====================
    function getVal(id) {
        try {
            const el = document.getElementById(id);
            if (!el) {
                const defaults = {
                    "p-minbet": 0.00000001,
                    "p-target-pct": 5.0,
                    "p-wgr-div": 100,
                    "p-wgr-chance": 99,
                    "p-basebet": 0.00000100,
                    "p-multi-start": 1.45,
                    "p-multi-inc": 0.05,
                    "p-bch-min": 80.0,
                    "p-bch-max": 95.0,
                    "p-hch-min": 20.0,
                    "p-hch-max": 30.0,
                    "p-wagertarget": 200,
                    "p-stoploss-pct": 5.0,
                    "p-session-target": 10.0,
                    "p-session-stoploss": 5.0,
                    "p-max-sessions": 20,
                    "p-trailing-enabled": 1,
                    "p-trailing-activation": 0.5,
                    "p-trailing-distance": 0.2,
                    "p-dallembert-level1-min": 25,
                    "p-dallembert-level1-max": 35,
                    "p-dallembert-level2-min": 45,
                    "p-dallembert-level2-max": 55,
                    "p-dallembert-level3-min": 77,
                    "p-dallembert-level3-max": 87,
                    "p-chrec-min": 50.0,
                    "p-chrec-max": 70.0,
                    // Rotation settings defaults
                    "p-rotate-base-wager-enabled": 1,
                    "p-rotate-base-wager-profit-mult": 2,
                    "p-rotate-base-wager-win-streak": 2,
                    "p-rotate-base-wager-loss-streak": 0,
                    "p-rotate-base-wager-min-bets": 5,
                    "p-rotate-base-wager-profit-threshold": 1.0,
                    "p-rotate-base-wager-use-threshold": 0,
                    "p-rotate-base-wager-session-profit": 1,
                    "p-rotate-base-wager-session-profit-min": 0.5,
                    "p-rotate-wager-base-enabled": 1,
                    "p-rotate-wager-base-loss-streak": 8,
                    "p-rotate-wager-base-loss-mult": 3,
                    "p-rotate-wager-base-min-profit": 0.00000100,
                    "p-rotate-wager-base-max-bets": 30,
                    "p-rotate-wager-base-time-limit": 0,
                    "p-rotate-wager-base-time-minutes": 5,
                    "p-rotate-base-recovery-enabled": 1,
                    "p-rotate-base-recovery-loss-streak": 3,
                    "p-rotate-base-recovery-profit-drop": 50.0,
                    "p-rotate-base-recovery-dynamic": 1,
                    "p-rotate-base-recovery-chance-min": 70.0,
                    "p-rotate-base-recovery-chance-max": 85.0,
                    "p-rotate-base-recovery-bet-mult": 1.5,
                    "p-rotate-base-recovery-max-level": 5,
                    "p-rotate-wager-recovery-enabled": 1,
                    "p-rotate-wager-recovery-loss-threshold": -1.0,
                    "p-rotate-wager-recovery-dallembert": 1,
                    "p-rotate-auto-enabled": 1,
                    "p-rotate-auto-min-time": 60,
                    "p-rotate-auto-max-time": 300,
                    "p-rotate-auto-force-time": 600,
                    "p-rotate-auto-cooldown": 30
                };
                return defaults[id] || 0;
            }
            return parseFloat(el.value) || 0;
        } catch (e) {
            console.error(`Error getting value for ${id}:`, e);
            return 0;
        }
    }

    async function updateBalanceDisplay() {
        if (bot.isRunning) return;
        const balance = await API.getBalance(bot.selectedCurrency);
        bot.stats.currentBal = balance;
        if (bot.stats.startBal === 0) {
            bot.stats.startBal = balance;
        }
    }

    function updateStatsSync(d, win, pft) {
        bot.stats.bets++;
        bot.stats.sessionBets++;
        bot.session.modeBetsCount++;
        bot.stats.wagered += d.amount;
        bot.stats.sessionWagered += d.amount;
        bot.stats.profit += pft;
        bot.stats.sessionProfit += pft;
        bot.stats.currentBal += pft;
        bot.partialProfit += pft;
        
        if (bot.stats.profit > bot.stats.maxProfit) {
            bot.stats.maxProfit = bot.stats.profit;
        }
        
        if (win) {
            bot.stats.wins++;
            if (bot.mode === "BASE") {
                bot.stats.baseModeProfit += pft;
                bot.stats.modeProfits.BASE += pft;
                bot.stats.modeBets.BASE++;
            } else {
                bot.stats.wagerModeProfit += pft;
                bot.stats.modeProfits.WAGER += pft;
                bot.stats.modeBets.WAGER++;
            }
        } else {
            bot.stats.loss++;
        }

        let drop = bot.stats.currentBal < bot.stats.startBal ? bot.stats.startBal - bot.stats.currentBal : 0;
        if (drop > bot.stats.maxDD) bot.stats.maxDD = drop;
        
        updateStreakStats(win, pft);
    }

    function updateStreakStats(win, profit) {
        if (win) {
            bot.stats.currentWinStreak++;
            bot.stats.currentLossStreak = 0;
            
            if (bot.stats.currentWinStreak > bot.stats.longestWinStreak) {
                bot.stats.longestWinStreak = bot.stats.currentWinStreak;
            }
            
            if (profit > bot.stats.biggestWin) {
                bot.stats.biggestWin = profit;
            }
        } else {
            bot.stats.currentLossStreak++;
            bot.stats.currentWinStreak = 0;
            
            if (bot.stats.currentLossStreak > bot.stats.longestLossStreak) {
                bot.stats.longestLossStreak = bot.stats.currentLossStreak;
            }
            
            if (Math.abs(profit) > Math.abs(bot.stats.biggestLoss)) {
                bot.stats.biggestLoss = profit;
            }
        }
    }

    function handleBaseMode(win) {
        if (win) {
            if (bot.stats.currentBal > bot.stats.peakBalance) {
                bot.stats.peakBalance = bot.stats.currentBal;
            }
            
            if (bot.wgr.recoveryActive && bot.wgr.recoveryType === "BASE") {
                handleRecoveryWin();
                return;
            }
            
            bot.ls = 0;
            bot.lc = 0;
            bot.partialProfit = 0;
            bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
            bot.nextBet = getVal("p-basebet");
            bot.currentMulti = getVal("p-multi-start");
            
            if (shouldRotateToWager()) {
                rotateMode("WAGER");
            }
        } else {
            bot.ls++;
            bot.lc++;
            
            if (!bot.wgr.recoveryActive && shouldStartBaseRecovery()) {
                startBaseRecovery();
            }
            
            if (bot.wgr.recoveryActive && bot.wgr.recoveryType === "BASE") {
                handleRecoveryLoss();
                return;
            }
            
            if (bot.ls === 1 || bot.lc > bot.bcount) {
                if (bot.ls > 1) bot.currentMulti += getVal("p-multi-inc");
                bot.lc = 1;
                bot.currentChance = Math.random() * (getVal("p-hch-max") - getVal("p-hch-min")) + getVal("p-hch-min");
                bot.bcount = Math.ceil(99 / bot.currentChance);
            }
            bot.nextBet = (Math.abs(bot.partialProfit) / ((99/bot.currentChance) - 1)) * bot.currentMulti;
        }
    }

    function handleWagerMode(win) {
        if (win) {
            bot.wgr.ctwin++;
            
            if (bot.wgr.recoveryActive && bot.wgr.recoveryType === "WAGER") {
                handleRecoveryWin();
                return;
            }
            
            if (bot.wgr.ctwin > 10) {
                bot.wgr.ctwin = 0;
                const recoveryChance = Math.random() * (getVal("p-chrec-max") - getVal("p-chrec-min")) + getVal("p-chrec-min");
                bot.currentChance = recoveryChance;
                bot.nextBet = Math.max(0, bot.wgr.betload) / ((99 / bot.currentChance) - 1);
            } else {
                bot.currentChance = getVal("p-wgr-chance");
                bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
            }
            
            if (bot.stats.currentBal > bot.wgr.balhigh) {
                bot.wgr.balhigh = bot.stats.currentBal;
            }
            
            if (shouldRotateToBase()) {
                rotateMode("BASE");
            }
        } else {
            bot.wgr.profitc += (bot.stats.currentBal - bot.wgr.balhigh);
            bot.wgr.betload = bot.wgr.balhigh - bot.stats.currentBal;
            
            if (!bot.wgr.recoveryActive && shouldStartWagerRecovery()) {
                startWagerRecovery();
            }
            
            if (bot.wgr.recoveryActive && bot.wgr.recoveryType === "WAGER") {
                handleRecoveryLoss();
                return;
            }
            
            if (bot.currentChance < 80) {
                bot.nextBet = Math.abs(bot.wgr.betload) / ((99 / bot.currentChance) - 1);
            } else {
                bot.nextBet *= 1.12;
            }
            
            if (shouldRotateToBase()) {
                rotateMode("BASE");
            }
        }
    }

    // ==================== MAIN BOT LOOP ====================
    async function runLoop() {
        if (!bot.isRunning || bot.isPaused) return;
        
        if (checkSessionCompletion()) {
            setTimeout(runLoop, 10);
            return;
        }
        
        if (updateTrailingStop()) {
            setTimeout(runLoop, 10);
            return;
        }
        
        const stopLossPct = getVal("p-stoploss-pct");
        const currentProfitPct = bot.stats.profit / bot.stats.startBal * 100;
        
        if (currentProfitPct <= -stopLossPct) {
            await stopEngine();
            updateStatus("‚õî STOP LOSS", "#ff6b6b");
            await sendTelegramReport("stoploss");
            return;
        }
        
        if (bot.targetAbs > 0 && bot.stats.profit >= bot.targetAbs) {
            await stopEngine();
            updateStatus("üéØ TARGET REACHED", "#4CAF50");
            await sendTelegramReport("target");
            return;
        }

        API.placeBet(bot.nextBet, bot.currentChance)
            .then(res => {
                const d = res?.data?.diceRoll || res?.diceRoll;
                if (d) {
                    const win = d.payout > 0;
                    const pft = d.payout - d.amount;
                    
                    updateStatsSync(d, win, pft);
                    updateLogs(d.amount, bot.currentChance, bot.mode, pft);
                    
                    if (bot.mode === "BASE") {
                        handleBaseMode(win);
                    } else if (bot.mode === "WAGER") {
                        handleWagerMode(win);
                    }
                    
                    const minBet = getVal("p-minbet");
                    bot.nextBet = Math.max(bot.nextBet, minBet);
                    
                    if (Date.now() - bot.lastReportTime >= 300000) {
                        sendTelegramReport("auto");
                    }
                    
                    setTimeout(runLoop, 0);
                } else {
                    setTimeout(runLoop, 50);
                }
            })
            .catch(e => {
                console.error("Loop error:", e);
                setTimeout(runLoop, 100);
            });
    }

    async function stopEngine() {
        bot.isRunning = false;
        bot.stopTime = Date.now();
        bot.wgr.recoveryActive = false;
        await updateBalanceDisplay();
    }

    function updateStatus(text, color) {
        const el = document.getElementById("st-status-text");
        if (el) {
            el.innerText = text;
            el.style.color = color || "#ccc";
        }
    }

    function updateLogs(amt, ch, mode, pft, customText = "") {
        const logBox = document.getElementById("p-log-body");
        if (!logBox) return;
        
        const modeColors = {
            'WAGER': '#888',
            'BASE': '#999',
            'RECOVERY': '#777',
            'SESSION': '#4CAF50',
            'TRAILING': '#ffa500',
            'MODE': '#888',
            'ROTATION': '#888'
        };
        
        const currentMode = bot.wgr.recoveryActive ? 'RECOVERY' : mode;
        
        const row = document.createElement("div");
        
        if (customText) {
            row.style.cssText = `padding: 6px; margin: 3px 0; background: rgba(40, 44, 52, 0.5); border-radius: 6px; border-left: 3px solid ${modeColors[mode] || '#666'}; font-size: 9px; color: #ccc;`;
            row.innerHTML = `<div style="display: flex; align-items: center; gap: 6px;"><span style="color: ${modeColors[mode] || '#666'}">${mode}</span><span>${customText}</span></div>`;
        } else {
            row.style.cssText = `display:grid; grid-template-columns:1.2fr 1fr 0.8fr 1.2fr; font-size:9px; border-bottom:1px solid rgba(255,255,255,0.05); padding:6px 0; color:${pft >= 0 ? '#4CAF50' : '#ff6b6b'}; text-align:center;`;
            row.innerHTML = `
                <span>${amt.toFixed(5)}</span>
                <span>${ch.toFixed(1)}%</span>
                <span style="color:${modeColors[currentMode] || '#888'}">${currentMode}</span>
                <span>${pft.toFixed(5)}</span>
            `;
        }
        
        logBox.prepend(row);
        if (logBox.children.length > 15) logBox.removeChild(logBox.lastChild);
    }

    function getElapsedTime() {
        if (!bot.startTime) return "00:00:00";
        let now = bot.isRunning ? Date.now() : (bot.stopTime || Date.now());
        const d = Math.floor((now - bot.startTime) / 1000);
        return `${Math.floor(d/3600).toString().padStart(2,'0')}:${Math.floor((d%3600)/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
    }

    function updateRecoveryUI() {
        const recoveryStatus = document.getElementById("recovery-status");
        const recoveryLevel = document.getElementById("recovery-level");
        const recoveryProgress = document.getElementById("recovery-progress");
        
        if (!recoveryStatus || !recoveryLevel || !recoveryProgress) return;
        
        if (!bot.wgr.recoveryActive) {
            recoveryStatus.innerText = "INACTIVE";
            recoveryLevel.innerText = "0";
            recoveryProgress.style.width = "0%";
            return;
        }
        
        recoveryStatus.innerText = bot.wgr.recoveryType + " ACTIVE";
        recoveryLevel.innerText = bot.wgr.recoveryLevel;
        
        const progress = Math.min(100, (bot.wgr.recoveryWins / 3) * 100);
        recoveryProgress.style.width = `${progress}%`;
    }

    // ==================== ROTATION UI UPDATES ====================
    function updateRotationUI() {
        try {
            // Update rotation stats
            const rotationStatsEl = document.getElementById("rotation-stats");
            if (rotationStatsEl) {
                rotationStatsEl.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-item-label">TOTAL ROTATIONS</div>
                        <div class="stat-item-value">${RotationConfig.stats.rotationCount}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">SUCCESS RATE</div>
                        <div class="stat-item-value ${RotationConfig.stats.successfulRotations/RotationConfig.stats.rotationCount >= 0.7 ? 'text-success' : 'text-warning'}">
                            ${RotationConfig.stats.rotationCount > 0 ? 
                                ((RotationConfig.stats.successfulRotations/RotationConfig.stats.rotationCount)*100).toFixed(1) + '%' : '0%'}
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">LAST ROTATION</div>
                        <div class="stat-item-value">${RotationConfig.stats.lastRotationTime ? 
                            Math.floor((Date.now() - RotationConfig.stats.lastRotationTime)/1000) + 's ago' : 'Never'}</div>
                    </div>
                `;
            }
            
            // Update rotation history
            const rotationHistoryEl = document.getElementById("rotation-history");
            if (rotationHistoryEl) {
                let historyHTML = '';
                RotationConfig.stats.rotationHistory.forEach((record, index) => {
                    const timeAgo = Math.floor((Date.now() - record.timestamp)/1000);
                    historyHTML += `
                        <div class="history-item">
                            <div class="history-time">${timeAgo}s ago</div>
                            <div class="history-details">
                                <span class="history-from">${record.from}</span>
                                <span class="history-arrow">‚Üí</span>
                                <span class="history-to">${record.to}</span>
                                <span class="history-reason">(${record.reason})</span>
                            </div>
                            <div class="history-profit ${record.balance >= record.sessionStartBal ? 'text-success' : 'text-danger'}">
                                ${record.profit > 0 ? '+' : ''}${record.profit.toFixed(8)}
                            </div>
                        </div>
                    `;
                });
                rotationHistoryEl.innerHTML = historyHTML || '<div class="history-empty">No rotation history yet</div>';
            }
            
            // Update current triggers status
            updateTriggersStatus();
            
        } catch (e) {
            console.error("Rotation UI update error:", e);
        }
    }

    function updateTriggersStatus() {
        try {
            const triggersEl = document.getElementById("triggers-status");
            if (!triggersEl) return;
            
            const baseToWagerTriggered = shouldRotateToWager();
            const wagerToBaseTriggered = shouldRotateToBase();
            const baseRecoveryTriggered = shouldStartBaseRecovery();
            const wagerRecoveryTriggered = shouldStartWagerRecovery();
            
            triggersEl.innerHTML = `
                <div class="trigger-item ${baseToWagerTriggered ? 'trigger-active' : ''}">
                    <div class="trigger-label">BASE ‚Üí WAGER</div>
                    <div class="trigger-status">${baseToWagerTriggered ? '‚úÖ READY' : '‚è≥ WAITING'}</div>
                </div>
                <div class="trigger-item ${wagerToBaseTriggered ? 'trigger-active' : ''}">
                    <div class="trigger-label">WAGER ‚Üí BASE</div>
                    <div class="trigger-status">${wagerToBaseTriggered ? '‚úÖ READY' : '‚è≥ WAITING'}</div>
                </div>
                <div class="trigger-item ${baseRecoveryTriggered ? 'trigger-active' : ''}">
                    <div class="trigger-label">BASE RECOVERY</div>
                    <div class="trigger-status">${baseRecoveryTriggered ? '‚ö†Ô∏è NEEDED' : '‚úÖ OK'}</div>
                </div>
                <div class="trigger-item ${wagerRecoveryTriggered ? 'trigger-active' : ''}">
                    <div class="trigger-label">WAGER RECOVERY</div>
                    <div class="trigger-status">${wagerRecoveryTriggered ? '‚ö†Ô∏è NEEDED' : '‚úÖ OK'}</div>
                </div>
            `;
            
        } catch (e) {
            console.error("Triggers status update error:", e);
        }
    }

    // ==================== COMPLETE UI CREATION ====================
    function createUI() {
        if (document.getElementById("orion-wrap")) {
            document.getElementById("orion-wrap").remove();
        }
        
        const s = document.createElement("style");
        s.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            #orion-wrap {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                height: 90vh;
                background: #1a1a1a;
                color: #e0e0e0;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
                overflow: hidden;
                touch-action: pan-y;
                -webkit-tap-highlight-color: transparent;
            }
            
            @media (min-width: 768px) {
                #orion-wrap {
                    width: 450px;
                    height: 85vh;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    border-radius: 20px;
                    bottom: auto;
                }
            }
            
            @supports (-webkit-touch-callout: none) {
                #orion-wrap {
                    height: 85vh;
                    max-height: -webkit-fill-available;
                }
            }
            
            .header {
                background: linear-gradient(135deg, #222, #1a1a1a);
                padding: 15px;
                border-bottom: 1px solid #333;
                position: relative;
            }
            
            .header-title {
                font-size: 20px;
                font-weight: 800;
                color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                margin-bottom: 8px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                letter-spacing: 0.5px;
            }
            
            .header-title::before {
                content: "‚ö°";
                font-size: 24px;
            }
            
            .license-badge {
                background: linear-gradient(135deg, #4a4a4a, #333);
                color: #fff;
                padding: 4px 15px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                border: 1px solid #555;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            
            .status-badge {
                display: inline-block;
                padding: 8px 20px;
                background: #2a2a2a;
                border: 1px solid #333;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                color: #ccc;
            }
            
            .drag-handle {
                width: 40px;
                height: 5px;
                background: #444;
                border-radius: 3px;
                margin: 0 auto 10px;
                cursor: grab;
            }
            
            .tab-nav {
                display: flex;
                background: #222;
                border-bottom: 1px solid #333;
                position: sticky;
                top: 0;
                z-index: 10;
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
                scrollbar-width: none;
            }
            
            .tab-nav::-webkit-scrollbar {
                display: none;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 80px;
                padding: 14px 10px;
                background: transparent;
                border: none;
                border-bottom: 3px solid transparent;
                color: #888;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                white-space: nowrap;
                -webkit-tap-highlight-color: transparent;
            }
            
            .tab-btn.active {
                color: #fff;
                border-bottom-color: #666;
                background: rgba(100, 100, 100, 0.1);
            }
            
            .tab-content {
                display: none;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 15px;
                background: #1a1a1a;
            }
            
            .tab-content.active {
                display: block;
            }
            
            /* Dashboard Styles */
            .quick-stats {
                display: flex;
                justify-content: space-between;
                background: #222;
                border-radius: 12px;
                padding: 12px;
                margin: 10px 0;
                font-size: 11px;
            }
            
            .quick-stat {
                text-align: center;
                flex: 1;
            }
            
            .quick-stat-value {
                font-size: 14px;
                font-weight: 700;
                color: #e0e0e0;
                margin-bottom: 2px;
            }
            
            .quick-stat-label {
                color: #888;
                font-size: 10px;
            }
            
            .session-progress {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin: 15px 0;
            }
            
            .session-info {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #888;
                margin-bottom: 10px;
            }
            
            .progress-bar {
                height: 6px;
                background: #2a2a2a;
                border-radius: 3px;
                overflow: hidden;
            }
            
            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #666, #888);
                border-radius: 3px;
                transition: width 0.3s ease;
            }
            
            .performance-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 15px 0;
            }
            
            .performance-card {
                background: #222;
                border-radius: 12px;
                padding: 12px;
                border-left: 4px solid;
            }
            
            .performance-card.base {
                border-left-color: #999;
            }
            
            .performance-card.wager {
                border-left-color: #777;
            }
            
            .performance-title {
                font-size: 11px;
                color: #888;
                font-weight: 600;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .performance-stats {
                font-size: 11px;
                color: #ccc;
                line-height: 1.6;
            }
            
            .recovery-panel {
                background: #252525;
                border: 1px solid #333;
                border-radius: 12px;
                padding: 15px;
                margin: 15px 0;
            }
            
            .recovery-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .recovery-title {
                font-size: 13px;
                font-weight: 700;
                color: #aaa;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .recovery-level {
                background: #333;
                border: 1px solid #444;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                color: #aaa;
            }
            
            .progress-container {
                margin: 12px 0;
            }
            
            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: #888;
                margin-bottom: 6px;
            }
            
            .stats-panel {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 15px 0;
            }
            
            .stat-item {
                background: #222;
                border-radius: 8px;
                padding: 12px;
            }
            
            .stat-item-label {
                font-size: 9px;
                color: #888;
                margin-bottom: 4px;
            }
            
            .stat-item-value {
                font-size: 12px;
                font-weight: 600;
                color: #e0e0e0;
            }
            
            /* Rotation Tab Specific */
            .triggers-panel {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin: 15px 0;
                border: 1px solid #333;
            }
            
            .trigger-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                margin: 5px 0;
                background: #2a2a2a;
                border-radius: 8px;
                border-left: 4px solid #444;
                transition: all 0.3s;
            }
            
            .trigger-item.trigger-active {
                background: #2a3a2a;
                border-left-color: #4CAF50;
            }
            
            .trigger-label {
                font-size: 12px;
                font-weight: 600;
                color: #ccc;
            }
            
            .trigger-status {
                font-size: 11px;
                font-weight: 600;
                padding: 4px 8px;
                border-radius: 4px;
                background: #333;
            }
            
            .rotation-history {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin: 15px 0;
                border: 1px solid #333;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .history-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid rgba(51, 51, 51, 0.3);
                font-size: 11px;
            }
            
            .history-time {
                color: #888;
                min-width: 60px;
            }
            
            .history-details {
                flex: 1;
                margin: 0 10px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .history-from, .history-to {
                font-weight: 600;
                color: #ccc;
            }
            
            .history-arrow {
                color: #888;
            }
            
            .history-reason {
                color: #666;
                font-size: 10px;
            }
            
            .history-profit {
                font-weight: 600;
                min-width: 70px;
                text-align: right;
            }
            
            .history-empty {
                text-align: center;
                color: #666;
                font-size: 11px;
                padding: 20px;
            }
            
            /* Controls */
            .currency-selector {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .control-panel {
                display: grid;
                gap: 10px;
                margin: 20px 0;
            }
            
            .control-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .btn {
                padding: 16px;
                border: none;
                border-radius: 12px;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                -webkit-tap-highlight-color: transparent;
            }
            
            .btn:active {
                transform: scale(0.98);
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #333, #444);
                color: #fff;
                border: 1px solid #555;
                font-weight: 700;
            }
            
            .btn-secondary {
                background: #444;
                color: #e0e0e0;
                border: 1px solid #555;
            }
            
            .btn-danger {
                background: #5a2a2a;
                color: #ff8a8a;
                border: 1px solid #6a3a3a;
            }
            
            .btn-warning {
                background: #5a4a2a;
                color: #ffd166;
                border: 1px solid #6a5a3a;
            }
            
            /* Settings */
            .settings-group {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                border: 1px solid #333;
            }
            
            .settings-title {
                font-size: 13px;
                font-weight: 700;
                color: #888;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            .settings-content {
                display: none;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .settings-content.active {
                display: grid;
            }
            
            .input-group {
                margin-bottom: 12px;
            }
            
            .input-label {
                display: block;
                font-size: 11px;
                color: #888;
                margin-bottom: 6px;
                font-weight: 500;
            }
            
            input, select {
                width: 100%;
                padding: 12px;
                background: #2a2a2a;
                border: 1px solid #333;
                border-radius: 8px;
                color: #e0e0e0;
                font-size: 13px;
                font-family: 'Inter', sans-serif;
                transition: all 0.3s;
                -webkit-appearance: none;
            }
            
            input:focus, select:focus {
                outline: none;
                border-color: #666;
                background: #2c2c2c;
            }
            
            /* Logs */
            .logs-container {
                background: #222;
                border-radius: 12px;
                padding: 15px;
                margin: 15px 0;
                max-height: 200px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .logs-header {
                display: grid;
                grid-template-columns: 1.2fr 1fr 0.8fr 1.2fr;
                padding: 10px 0;
                border-bottom: 1px solid #333;
                font-size: 10px;
                color: #888;
                font-weight: 600;
                text-align: center;
                position: sticky;
                top: 0;
                background: #222;
            }
            
            .log-entry {
                display: grid;
                grid-template-columns: 1.2fr 1fr 0.8fr 1.2fr;
                padding: 10px 0;
                border-bottom: 1px solid rgba(51, 51, 51, 0.5);
                font-size: 11px;
                text-align: center;
            }
            
            /* Footer */
            .footer {
                background: #222;
                padding: 15px;
                border-top: 1px solid #333;
                text-align: center;
            }
            
            .support-info {
                font-size: 11px;
                color: #666;
                line-height: 1.5;
            }
            
            .support-link {
                color: #888;
                text-decoration: none;
                font-weight: 600;
            }
            
            /* Utility Classes */
            .text-success { color: #4CAF50 !important; }
            .text-warning { color: #ffa500 !important; }
            .text-danger { color: #ff6b6b !important; }
            .text-info { color: #888 !important; }
            .text-muted { color: #666 !important; }
            
            .badge {
                display: inline-block;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 10px;
                font-weight: 600;
            }
            
            .badge-success { background: #1a3a2a; color: #4CAF50; }
            .badge-warning { background: #3a3a1a; color: #ffa500; }
            .badge-danger { background: #3a1a1a; color: #ff6b6b; }
            .badge-info { background: #2a2a3a; color: #888; }
            
            .toggle-icon {
                transition: transform 0.3s ease;
                font-size: 12px;
                color: #888;
            }
            
            .swipe-indicator {
                text-align: center;
                font-size: 10px;
                color: #666;
                margin-top: 10px;
                display: none;
            }
            
            @media (max-width: 768px) {
                .swipe-indicator {
                    display: block;
                }
            }
        `;
        document.head.appendChild(s);
        
        const d = document.createElement("div");
        d.id = "orion-wrap";
        d.innerHTML = `
            <div class="drag-handle"></div>
            
            <div class="header">
                <div class="header-title">
                    ORION ALPHA
                    <span class="license-badge">${bot.licenseTier}</span>
                </div>
                <div class="status-badge" id="st-status-text">üü¢ READY</div>
            </div>
            
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="controls">üéÆ Controls</button>
                <button class="tab-btn" data-tab="rotation">üîÑ Rotation</button>
                <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
                <button class="tab-btn" data-tab="logs">üìù Logs</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="quick-balance">0.0000</div>
                        <div class="quick-stat-label">BALANCE</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value text-success" id="quick-profit">0.00%</div>
                        <div class="quick-stat-label">PROFIT</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="quick-bets">0</div>
                        <div class="quick-stat-label">BETS</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="quick-time">00:00</div>
                        <div class="quick-stat-label">TIME</div>
                    </div>
                </div>
                
                <div class="session-progress">
                    <div class="session-info">
                        <span>Session <span id="session-num">1</span>/<span id="max-sessions">20</span></span>
                        <span id="session-progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="session-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="session-info" style="margin-top: 8px; font-size: 10px;">
                        <span>Target: <span id="session-target-display">10%</span></span>
                        <span>Stop Loss: <span id="session-stoploss-display">-5%</span></span>
                    </div>
                </div>
                
                <div class="performance-grid">
                    <div class="performance-card base">
                        <div class="performance-title">
                            <span>üèóÔ∏è BASE</span>
                            <span class="badge badge-info" id="base-badge">OFF</span>
                        </div>
                        <div class="performance-stats">
                            <div>P/L: <span id="base-profit" class="text-success">0.0000</span></div>
                            <div>Bets: <span id="base-bets">0</span></div>
                            <div>Streak: <span id="base-streak">0</span></div>
                        </div>
                    </div>
                    
                    <div class="performance-card wager">
                        <div class="performance-title">
                            <span>‚ö° WAGER</span>
                            <span class="badge badge-info" id="wager-badge">OFF</span>
                        </div>
                        <div class="performance-stats">
                            <div>P/L: <span id="wager-profit" class="text-success">0.0000</span></div>
                            <div>Bets: <span id="wager-bets">0</span></div>
                            <div>Streak: <span id="wager-streak">0</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="recovery-panel">
                    <div class="recovery-header">
                        <div class="recovery-title">üîÑ RECOVERY</div>
                        <div class="recovery-level" id="recovery-level">0</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span id="recovery-status">INACTIVE</span>
                            <span id="recovery-streak">LS: 0</span>
                        </div>
                        <div class="progress-bar">
                            <div id="recovery-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="font-size: 10px; color: #888; margin-top: 8px; text-align: center;">
                        Base: 70-85% ‚Ä¢ Wager: D'Alembert
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div class="stat-item">
                        <div class="stat-item-label">WIN RATE</div>
                        <div class="stat-item-value" id="stats-winrate">0.00%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">MAX DD</div>
                        <div class="stat-item-value text-danger" id="stats-maxdd">0.00%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">PROFIT SESS</div>
                        <div class="stat-item-value text-success" id="stats-profsessions">0/0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">TRAILING</div>
                        <div class="stat-item-value text-muted" id="trailing-status">OFF</div>
                    </div>
                </div>
                
                <div class="swipe-indicator">‚¨ÜÔ∏è Swipe up for more</div>
            </div>
            
            <!-- Controls Tab -->
            <div id="controls-tab" class="tab-content">
                <div class="currency-selector">
                    <div class="input-group">
                        <label class="input-label">SELECT CURRENCY</label>
                        <select id="p-currency" class="currency-select"></select>
                    </div>
                </div>
                
                <div class="control-panel">
                    <button id="btn-run" class="btn btn-primary">üöÄ START BOT</button>
                    
                    <div class="control-row">
                        <button id="btn-pause" class="btn btn-warning">‚è∏Ô∏è PAUSE</button>
                        <button id="btn-stop" class="btn btn-danger">üõë STOP</button>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title">MANUAL ROTATION</div>
                        <div class="control-row">
                            <button onclick="rotateMode('BASE')" class="btn btn-secondary">üèóÔ∏è BASE</button>
                            <button onclick="rotateMode('WAGER')" class="btn btn-secondary">‚ö° WAGER</button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title">MANUAL RECOVERY</div>
                        <div class="control-row">
                            <button onclick="startBaseRecovery()" class="btn btn-secondary">üîÑ BASE RECOVERY</button>
                            <button onclick="startWagerRecovery()" class="btn btn-secondary">üîÑ WAGER RECOVERY</button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title">REPORT & SUPPORT</div>
                        <div class="control-row">
                            <button onclick="sendTelegramReport('manual')" class="btn btn-secondary">üìä SEND REPORT</button>
                            <button onclick="window.open('https://t.me/${CONFIG.supportContact.replace('@', '')}', '_blank')" 
                                class="btn btn-secondary">üí¨ SUPPORT</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rotation Tab -->
            <div id="rotation-tab" class="tab-content">
                <div class="triggers-panel">
                    <div class="settings-title" style="margin-bottom: 10px;">üîÑ ACTIVE TRIGGERS</div>
                    <div id="triggers-status">
                        <div class="trigger-item">
                            <div class="trigger-label">BASE ‚Üí WAGER</div>
                            <div class="trigger-status">‚è≥ WAITING</div>
                        </div>
                        <div class="trigger-item">
                            <div class="trigger-label">WAGER ‚Üí BASE</div>
                            <div class="trigger-status">‚è≥ WAITING</div>
                        </div>
                        <div class="trigger-item">
                            <div class="trigger-label">BASE RECOVERY</div>
                            <div class="trigger-status">‚úÖ OK</div>
                        </div>
                        <div class="trigger-item">
                            <div class="trigger-label">WAGER RECOVERY</div>
                            <div class="trigger-status">‚úÖ OK</div>
                        </div>
                    </div>
                </div>
                
                <div class="rotation-history">
                    <div class="settings-title" style="margin-bottom: 10px;">üìä ROTATION HISTORY</div>
                    <div id="rotation-history">
                        <div class="history-empty">No rotation history yet</div>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div id="rotation-stats">
                        <div class="stat-item">
                            <div class="stat-item-label">TOTAL ROTATIONS</div>
                            <div class="stat-item-value">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-label">SUCCESS RATE</div>
                            <div class="stat-item-value">0%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-item-label">LAST ROTATION</div>
                            <div class="stat-item-value">Never</div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        ‚öôÔ∏è ROTATION SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <!-- Settings will be populated by updateRotationSettingsUI -->
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        üèóÔ∏è BASE MODE SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content active">
                        <div class="input-group"><label class="input-label">Base Bet</label><input id="p-basebet" value="0.00000100" type="number" step="0.00000001" min="0"></div>
                        <div class="input-group"><label class="input-label">Base Chance Min</label><input id="p-bch-min" value="80.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Base Chance Max</label><input id="p-bch-max" value="95.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Hunt Chance Min</label><input id="p-hch-min" value="20.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Hunt Chance Max</label><input id="p-hch-max" value="30.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Multi Start</label><input id="p-multi-start" value="1.45" type="number" step="0.05" min="1"></div>
                        <div class="input-group"><label class="input-label">Multi Inc</label><input id="p-multi-inc" value="0.05" type="number" step="0.01" min="0.01"></div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        ‚ö° WAGER MODE SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <div class="input-group"><label class="input-label">Wager Chance</label><input id="p-wgr-chance" value="99.0" type="number" step="0.1" min="90" max="99.99"></div>
                        <div class="input-group"><label class="input-label">Wager Divider</label><input id="p-wgr-div" value="100" type="number" step="1" min="10"></div>
                        <div class="input-group"><label class="input-label">Recovery Chance Min</label><input id="p-chrec-min" value="50.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Recovery Chance Max</label><input id="p-chrec-max" value="70.0" type="number" step="0.1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Wager Target (x)</label><input id="p-wagertarget" value="200" type="number" step="10" min="10"></div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        üîÑ D'ALEMBERT SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <div class="input-group"><label class="input-label">Level 1 Min</label><input id="p-dallembert-level1-min" value="25" type="number" step="1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Level 1 Max</label><input id="p-dallembert-level1-max" value="35" type="number" step="1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Level 2 Min</label><input id="p-dallembert-level2-min" value="45" type="number" step="1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Level 2 Max</label><input id="p-dallembert-level2-max" value="55" type="number" step="1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Level 3 Min</label><input id="p-dallembert-level3-min" value="77" type="number" step="1" min="1" max="99"></div>
                        <div class="input-group"><label class="input-label">Level 3 Max</label><input id="p-dallembert-level3-max" value="87" type="number" step="1" min="1" max="99"></div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        üéØ SESSION SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <div class="input-group"><label class="input-label">Max Sessions</label><input id="p-max-sessions" value="20" type="number" step="1" min="1"></div>
                        <div class="input-group"><label class="input-label">Session Target %</label><input id="p-session-target" value="10.0" type="number" step="0.1" min="0.1"></div>
                        <div class="input-group"><label class="input-label">Session Stop Loss %</label><input id="p-session-stoploss" value="5.0" type="number" step="0.1" min="0.1"></div>
                        <div class="input-group"><label class="input-label">Global Target %</label><input id="p-target-pct" value="5.0" type="number" step="0.1" min="0.1"></div>
                        <div class="input-group"><label class="input-label">Global Stop Loss %</label><input id="p-stoploss-pct" value="5.0" type="number" step="0.1" min="0.1"></div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        üìà TRAILING STOP
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <div class="input-group"><label class="input-label">Enabled</label><select id="p-trailing-enabled"><option value="1">Yes</option><option value="0">No</option></select></div>
                        <div class="input-group"><label class="input-label">Activation %</label><input id="p-trailing-activation" value="0.5" type="number" step="0.1" min="0.1"></div>
                        <div class="input-group"><label class="input-label">Distance %</label><input id="p-trailing-distance" value="0.2" type="number" step="0.1" min="0.1"></div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        üõ°Ô∏è SAFETY SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-content">
                        <div class="input-group"><label class="input-label">Minimum Bet</label><input id="p-minbet" value="0.00000001" type="number" step="0.00000001" min="0"></div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="logs-container">
                    <div class="logs-header">
                        <span>AMOUNT</span>
                        <span>CHANCE</span>
                        <span>MODE</span>
                        <span>PROFIT</span>
                    </div>
                    <div id="p-log-body"></div>
                </div>
                
                <div class="stats-panel" style="margin-top: 15px;">
                    <div class="stat-item"><div class="stat-item-label">TOTAL WAGERED</div><div class="stat-item-value" id="stats-wagered">0.00x</div></div>
                    <div class="stat-item"><div class="stat-item-label">BIGGEST WIN</div><div class="stat-item-value text-success" id="stats-bigwin">0.0000</div></div>
                    <div class="stat-item"><div class="stat-item-label">BIGGEST LOSS</div><div class="stat-item-value text-danger" id="stats-bigloss">0.0000</div></div>
                    <div class="stat-item"><div class="stat-item-label">LONG WIN STREAK</div><div class="stat-item-value text-success" id="stats-longwin">0</div></div>
                    <div class="stat-item"><div class="stat-item-label">LONG LOSS STREAK</div><div class="stat-item-value text-danger" id="stats-longloss">0</div></div>
                    <div class="stat-item"><div class="stat-item-label">AVG BET SIZE</div><div class="stat-item-value" id="stats-avgbet">0.0000</div></div>
                    <div class="stat-item"><div class="stat-item-label">MAX PROFIT</div><div class="stat-item-value text-success" id="stats-maxprofit">0.0000</div></div>
                    <div class="stat-item"><div class="stat-item-label">TOTAL SESSIONS</div><div class="stat-item-value" id="stats-totalsessions">0</div></div>
                </div>
            </div>
            
            <div class="footer">
                <div class="support-info">
                    üí¨ <a href="https://t.me/${CONFIG.supportContact.replace('@', '')}" target="_blank" class="support-link">${CONFIG.supportContact}</a>
                    <div style="margin-top: 5px; font-size: 10px; color: #555;">
                        ‚ö° ${CONFIG.version} | üîí ${bot.licenseTier} | üîÑ SMART ROTATION
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(d);
        
        // Create rotation settings UI
        createRotationSettingsUI();
        
        // Mobile interactions
        let startY = 0;
        const dragHandle = d.querySelector('.drag-handle');
        const orionWrap = d;
        
        dragHandle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        dragHandle.addEventListener('touchmove', (e) => {
            const currentY = e.touches[0].clientY;
            const diff = startY - currentY;
            
            if (diff > 50) {
                orionWrap.style.transform = 'translateY(-10px)';
            } else if (diff < -50) {
                orionWrap.style.transform = 'translateY(0)';
            }
        }, { passive: true });
        
        dragHandle.addEventListener('touchend', () => {
            orionWrap.style.transform = 'translateY(0)';
        });
        
        // Tab Navigation
        const tabBtns = d.querySelectorAll('.tab-btn');
        const tabContents = d.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const tabId = btn.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
                
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            });
        });
        
        // Toggle settings
        window.toggleSettings = function(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.toggle-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñº';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñ≤';
            }
        };
        
        // Global functions
        window.rotateMode = rotateMode;
        window.startBaseRecovery = startBaseRecovery;
        window.startWagerRecovery = startWagerRecovery;
        
        // Event Listeners
        document.getElementById("p-currency").addEventListener('change', async (e) => {
            bot.selectedCurrency = e.target.value;
            localStorage.setItem('orion_last_coin', bot.selectedCurrency);
            await updateBalanceDisplay();
        });

        document.getElementById("btn-run").addEventListener('click', async () => {
            if (!bot.isRunning) {
                bot.selectedCurrency = document.getElementById("p-currency").value;
                await API.syncOnce();
                
                updateRotationConfigFromUI();
                
                bot.session.maxSessions = getVal("p-max-sessions");
                bot.session.currentSession = 1;
                bot.session.trailingStop.enabled = getVal("p-trailing-enabled") === 1;
                bot.session.trailingStop.activation = getVal("p-trailing-activation");
                bot.session.trailingStop.distance = getVal("p-trailing-distance");
                
                bot.stats.startBal = await API.getBalance(bot.selectedCurrency);
                bot.stats.currentBal = bot.stats.startBal;
                bot.stats.sessionStartBal = bot.stats.startBal;
                bot.stats.sessionProfit = 0;
                bot.stats.sessionWagered = 0;
                bot.stats.sessionBets = 0;
                bot.stats.profit = 0;
                bot.stats.wagered = 0;
                bot.stats.bets = 0;
                bot.stats.wins = 0;
                bot.stats.loss = 0;
                bot.stats.maxDD = 0;
                bot.stats.maxProfit = 0;
                bot.stats.peakBalance = bot.stats.startBal;
                bot.stats.baseModeProfit = 0;
                bot.stats.wagerModeProfit = 0;
                bot.stats.longestWinStreak = 0;
                bot.stats.longestLossStreak = 0;
                bot.stats.currentWinStreak = 0;
                bot.stats.currentLossStreak = 0;
                bot.stats.biggestWin = 0;
                bot.stats.biggestLoss = 0;
                bot.stats.totalSessions = 0;
                bot.stats.profitableSessions = 0;
                bot.stats.losingSessions = 0;
                bot.stats.modeDuration = { BASE: 0, WAGER: 0 };
                bot.stats.modeBets = { BASE: 0, WAGER: 0 };
                bot.stats.modeProfits = { BASE: 0, WAGER: 0 };
                
                bot.targetAbs = bot.stats.startBal * (getVal("p-target-pct") / 100);
                bot.isRunning = true;
                bot.isPaused = false;
                bot.startTime = Date.now();
                bot.stopTime = null;
                bot.lastRotationTime = null;
                bot.lastReportTime = Date.now();
                
                bot.session.sessionHistory = [];
                
                bot.wgr.balhigh = bot.stats.startBal;
                bot.wgr.profitc = 0;
                bot.wgr.ctwin = 0;
                bot.wgr.recoveryActive = false;
                bot.wgr.recoveryType = null;
                bot.wgr.lossStreak = 0;
                bot.wgr.recoveryLevel = 0;
                bot.wgr.recoveryWins = 0;
                bot.wgr.recoveryTarget = 0;
                bot.wgr.originalLoss = 0;
                
                bot.session.trailingStop.peak = bot.stats.startBal;
                bot.session.trailingStop.activated = false;
                
                bot.session.modeStartTime = Date.now();
                bot.session.modeBetsCount = 0;
                
                rotateToBaseMode();
                
                const logBody = document.getElementById("p-log-body");
                if (logBody) logBody.innerHTML = "";
                
                updateLogs(0, 0, "SESSION", 0, `Session ${bot.session.currentSession} started`);
                
                updateStatus("‚ö° RUNNING", "#4CAF50");
                
                await sendTelegramReport("start");
                runLoop();
            }
        });
        
        document.getElementById("btn-stop").addEventListener('click', async () => {
            await stopEngine();
            updateStatus("üõë STOPPED", "#ff6b6b");
            await sendTelegramReport("stop");
        });
        
        document.getElementById("btn-pause").addEventListener('click', async () => {
            bot.isPaused = !bot.isPaused;
            updateStatus(bot.isPaused ? "‚è∏Ô∏è PAUSED" : "‚ö° RUNNING",
                       bot.isPaused ? "#ffa500" : "#4CAF50");
        });
        
        // Mobile: Close keyboard on tap outside
        document.addEventListener('touchstart', (e) => {
            if (!e.target.matches('input, select, textarea')) {
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            }
        });
        
        // Initialize
        API.syncOnce();
    }

    function createRotationSettingsUI() {
        const rotationSettingsEl = document.querySelector('#rotation-tab .settings-content');
        if (!rotationSettingsEl) return;
        
        rotationSettingsEl.innerHTML = `
            <div class="input-group">
                <label class="input-label">Base ‚Üí Wager Enabled</label>
                <select id="p-rotate-base-wager-enabled">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Min Profit Multiplier</label>
                <input id="p-rotate-base-wager-profit-mult" value="2" type="number" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Min Win Streak</label>
                <input id="p-rotate-base-wager-win-streak" value="2" type="number" step="1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Max Loss Streak</label>
                <input id="p-rotate-base-wager-loss-streak" value="0" type="number" step="1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Min Bets in Mode</label>
                <input id="p-rotate-base-wager-min-bets" value="5" type="number" step="1" min="1">
            </div>
            <div class="input-group">
                <label class="input-label">Profit Threshold %</label>
                <input id="p-rotate-base-wager-profit-threshold" value="1.0" type="number" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Use Profit Threshold</label>
                <select id="p-rotate-base-wager-use-threshold">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Check Session Profit</label>
                <select id="p-rotate-base-wager-session-profit">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Min Session Profit %</label>
                <input id="p-rotate-base-wager-session-profit-min" value="0.5" type="number" step="0.1" min="0">
            </div>
            
            <div class="input-group">
                <label class="input-label">Wager ‚Üí Base Enabled</label>
                <select id="p-rotate-wager-base-enabled">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Max Loss Streak</label>
                <input id="p-rotate-wager-base-loss-streak" value="8" type="number" step="1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Max Loss Multiplier</label>
                <input id="p-rotate-wager-base-loss-mult" value="3" type="number" step="0.1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Min Profit to Stay</label>
                <input id="p-rotate-wager-base-min-profit" value="0.00000100" type="number" step="0.00000001" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Max Bets in Mode</label>
                <input id="p-rotate-wager-base-max-bets" value="30" type="number" step="1" min="1">
            </div>
            <div class="input-group">
                <label class="input-label">Use Time Limit</label>
                <select id="p-rotate-wager-base-time-limit">
                    <option value="0">No</option>
                    <option value="1">Yes</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Time Limit (minutes)</label>
                <input id="p-rotate-wager-base-time-minutes" value="5" type="number" step="1" min="1">
            </div>
            
            <div class="input-group">
                <label class="input-label">Base Recovery Enabled</label>
                <select id="p-rotate-base-recovery-enabled">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Loss Streak Threshold</label>
                <input id="p-rotate-base-recovery-loss-streak" value="3" type="number" step="1" min="0">
            </div>
            <div class="input-group">
                <label class="input-label">Profit Drop % Threshold</label>
                <input id="p-rotate-base-recovery-profit-drop" value="50.0" type="number" step="1" min="0" max="100">
            </div>
            <div class="input-group">
                <label class="input-label">Dynamic Recovery</label>
                <select id="p-rotate-base-recovery-dynamic">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Recovery Chance Min %</label>
                <input id="p-rotate-base-recovery-chance-min" value="70.0" type="number" step="0.1" min="1" max="99">
            </div>
            <div class="input-group">
                <label class="input-label">Recovery Chance Max %</label>
                <input id="p-rotate-base-recovery-chance-max" value="85.0" type="number" step="0.1" min="1" max="99">
            </div>
            <div class="input-group">
                <label class="input-label">Recovery Bet Multiplier</label>
                <input id="p-rotate-base-recovery-bet-mult" value="1.5" type="number" step="0.1" min="1">
            </div>
            <div class="input-group">
                <label class="input-label">Max Recovery Level</label>
                <input id="p-rotate-base-recovery-max-level" value="5" type="number" step="1" min="1">
            </div>
            
            <div class="input-group">
                <label class="input-label">Wager Recovery Enabled</label>
                <select id="p-rotate-wager-recovery-enabled">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Loss % Threshold</label>
                <input id="p-rotate-wager-recovery-loss-threshold" value="-1.0" type="number" step="0.1" max="0">
            </div>
            <div class="input-group">
                <label class="input-label">Use D'Alembert</label>
                <select id="p-rotate-wager-recovery-dallembert">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            
            <div class="input-group">
                <label class="input-label">Auto Rotation Enabled</label>
                <select id="p-rotate-auto-enabled">
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Min Time in Mode (s)</label>
                <input id="p-rotate-auto-min-time" value="60" type="number" step="1" min="10">
            </div>
            <div class="input-group">
                <label class="input-label">Max Time in Mode (s)</label>
                <input id="p-rotate-auto-max-time" value="300" type="number" step="10" min="30">
            </div>
            <div class="input-group">
                <label class="input-label">Force Rotate After (s)</label>
                <input id="p-rotate-auto-force-time" value="600" type="number" step="30" min="60">
            </div>
            <div class="input-group">
                <label class="input-label">Rotation Cooldown (s)</label>
                <input id="p-rotate-auto-cooldown" value="30" type="number" step="5" min="0">
            </div>
        `;
        
        // Set initial values
        updateRotationConfigFromUI();
    }

    // ==================== REAL-TIME UPDATES ====================
    setInterval(() => {
        try {
            if (!document.getElementById("st-status-text")) return;
            
            // Update quick stats
            document.getElementById("quick-balance").innerText = bot.stats.currentBal.toFixed(4);
            
            const profitPct = (bot.stats.profit / (bot.stats.startBal || 1) * 100);
            const profitColor = profitPct >= 0 ? '#4CAF50' : '#ff6b6b';
            document.getElementById("quick-profit").innerText = `${profitPct.toFixed(2)}%`;
            document.getElementById("quick-profit").style.color = profitColor;
            
            document.getElementById("quick-bets").innerText = bot.stats.bets;
            
            const time = getElapsedTime();
            document.getElementById("quick-time").innerText = time.split(':').slice(0, 2).join(':');
            
            // Update session progress
            const sessionTargetPct = getVal("p-session-target");
            const sessionStopLossPct = getVal("p-session-stoploss");
            const sessionProfitPct = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
            const sessionProgress = Math.min(100, Math.max(0, (sessionProfitPct + sessionStopLossPct) / (sessionTargetPct + sessionStopLossPct) * 100));
            
            document.getElementById("session-progress-text").innerText = `${sessionProgress.toFixed(1)}%`;
            document.getElementById("session-progress").style.width = `${sessionProgress}%`;
            document.getElementById("session-num").innerText = bot.session.currentSession;
            document.getElementById("max-sessions").innerText = bot.session.maxSessions;
            document.getElementById("session-target-display").innerText = `${sessionTargetPct}%`;
            document.getElementById("session-stoploss-display").innerText = `-${sessionStopLossPct}%`;
            document.getElementById("trailing-status").innerText = bot.session.trailingStop.activated ? "ON" : "OFF";
            document.getElementById("trailing-status").style.color = bot.session.trailingStop.activated ? '#ffa500' : '#666';
            
            // Update performance cards
            document.getElementById("base-profit").innerText = bot.stats.baseModeProfit.toFixed(4);
            document.getElementById("base-bets").innerText = bot.mode === "BASE" ? bot.session.modeBetsCount : "0";
            document.getElementById("base-streak").innerText = bot.stats.currentLossStreak;
            document.getElementById("base-badge").innerText = bot.mode === "BASE" ? "ON" : "OFF";
            document.getElementById("base-badge").className = bot.mode === "BASE" ? "badge badge-info" : "badge";
            
            document.getElementById("wager-profit").innerText = bot.stats.wagerModeProfit.toFixed(4);
            document.getElementById("wager-bets").innerText = bot.mode === "WAGER" ? bot.session.modeBetsCount : "0";
            document.getElementById("wager-streak").innerText = bot.wgr.lossStreak;
            document.getElementById("wager-badge").innerText = bot.mode === "WAGER" ? "ON" : "OFF";
            document.getElementById("wager-badge").className = bot.mode === "WAGER" ? "badge badge-info" : "badge";
            
            // Update recovery UI
            const recoveryType = bot.wgr.recoveryType || '';
            document.getElementById("recovery-status").innerText = bot.wgr.recoveryActive ? recoveryType + " ACTIVE" : "INACTIVE";
            document.getElementById("recovery-level").innerText = bot.wgr.recoveryLevel;
            document.getElementById("recovery-streak").innerText = `LS: ${bot.wgr.lossStreak}`;
            
            const recoveryProgress = Math.min(100, (bot.wgr.recoveryWins / 3) * 100);
            document.getElementById("recovery-progress").style.width = `${recoveryProgress}%`;
            
            // Update statistics
            document.getElementById("stats-winrate").innerText = bot.stats.bets > 0 ? 
                `${((bot.stats.wins / bot.stats.bets) * 100).toFixed(2)}%` : "0.00%";
            document.getElementById("stats-wagered").innerText = (bot.stats.wagered / (bot.stats.startBal || 1)).toFixed(2) + "x";
            document.getElementById("stats-maxdd").innerText = (bot.stats.maxDD / (bot.stats.startBal || 1) * 100).toFixed(2) + "%";
            document.getElementById("stats-bigwin").innerText = bot.stats.biggestWin.toFixed(4);
            document.getElementById("stats-bigloss").innerText = Math.abs(bot.stats.biggestLoss).toFixed(4);
            document.getElementById("stats-longwin").innerText = bot.stats.longestWinStreak;
            document.getElementById("stats-longloss").innerText = bot.stats.longestLossStreak;
            document.getElementById("stats-profsessions").innerText = `${bot.stats.profitableSessions}/${bot.stats.totalSessions}`;
            document.getElementById("stats-avgbet").innerText = bot.stats.bets > 0 ? 
                (bot.stats.wagered / bot.stats.bets).toFixed(8) : "0.00000000";
            document.getElementById("stats-maxprofit").innerText = bot.stats.maxProfit.toFixed(4);
            document.getElementById("stats-totalsessions").innerText = bot.stats.totalSessions;
            
            // Update rotation UI every 2 seconds
            if (Date.now() % 2000 < 100) {
                updateRotationUI();
            }
                
        } catch (e) {
            console.error("UI update error:", e);
        }
    }, 500);

    // ==================== INITIALIZATION ====================
    async function initialize() {
        const isValid = await validateLicense();
        
        if (isValid) {
            console.log(`‚úÖ License valid for ${currentUser} (${licenseData.tier})`);
            bot.licenseTier = licenseData.tier;
            bot.stakeUser = currentUser;
            
            createUI();
            
        } else {
            console.log("‚ùå License invalid or user not whitelisted");
        }
    }

    // Start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();

(function () {
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        get apiUrl() { return window.location.origin + '/_api'; },
        version: "ORION PRO v5.0",
        tgToken: '8391763291:AAEA05v6FG70eM1WGrgU7mrPgckfjQaxkno',
        tgChatId: '-1003744641395',
        supportContact: '@OrionLogic'
    };

    // ==================== WHITELIST SYSTEM ====================
    const WHITELIST = {
        "orionlogic": { tier: "VIP", expiry: "2099-12-31" },
        "biele": { tier: "PREMIUM", expiry: "2026-02-26" },
        "siska82": { tier: "PREMIUM", expiry: "2026-02-26" },
        "dfransiska": { tier: "PREMIUM", expiry: "2026-02-26" },
        "brokenpips": { tier: "PREMIUM", expiry: "2026-02-26" },
        "aynus": { tier: "PREMIUM", expiry: "2026-02-26" },
        "terbaik444": { tier: "PREMIUM", expiry: "2026-01-30" },
        "k4pitiang": { tier: "PREMIUM", expiry: "2026-02-26" }
    };

    // ==================== LICENSE VALIDATION ====================
    let currentUser = null;
    let licenseData = null;
    let userExpiry = "";

    async function validateLicense() {
        try {
            const token = localStorage.getItem('apitoken') || 
                         (document.cookie.match(/session=([^;]+)/) ? 
                          document.cookie.match(/session=([^;]+)/)[1] : null);

            if (!token) {
                showLicenseModal("Please login to Stake.com first");
                return false;
            }

            const response = await fetch(`${CONFIG.apiUrl}/graphql`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "x-access-token": token 
                },
                body: JSON.stringify({ query: `query{user{name}}` })
            });

            const data = await response.json();
            const username = data?.data?.user?.name?.toLowerCase();

            if (!username) {
                showLicenseModal("Cannot retrieve username");
                return false;
            }

            currentUser = username;
            licenseData = WHITELIST[username];
            
            if (!licenseData) {
                showLicenseModal(
                    `Username <strong>${username}</strong> is not whitelisted.`, 
                    true
                );
                return false;
            }

            const expiryDate = new Date(licenseData.expiry);
            if (new Date() > expiryDate) {
                showLicenseModal(
                    `License expired on ${expiryDate.toLocaleDateString()}.`, 
                    true
                );
                return false;
            }

            userExpiry = expiryDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            console.log(`‚úÖ License validated: ${username} (${licenseData.tier}) - Expires: ${userExpiry}`);
            
            await sendTelegramReport("load");
            
            return true;

        } catch (error) {
            console.error("License validation error:", error);
            showLicenseModal("Connection error. Please refresh.");
            return false;
        }
    }

    function showLicenseModal(message, isError = false) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            font-family: 'Inter', sans-serif;
        `;
        
        modal.innerHTML = `
            <div style="background: linear-gradient(145deg, #1A1D28, #131722); border-radius: 16px; padding: 30px; max-width: 400px; width: 100%; border: 1px solid #374151; box-shadow: 0 20px 40px rgba(0,0,0,0.3); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, ${isError ? '#EF4444' : '#6366F1'}, ${isError ? '#DC2626' : '#8B5CF6'});"></div>
                
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 42px; margin-bottom: 15px; color: ${isError ? '#EF4444' : '#6366F1'};">${isError ? '‚õî' : 'üîê'}</div>
                    <div style="font-size: 20px; font-weight: 800; margin-bottom: 8px; color: #F3F4F6; letter-spacing: 0.5px;">ORION PRO ACCESS</div>
                    <div style="font-size: 11px; color: #9CA3AF; letter-spacing: 1px; text-transform: uppercase;">${CONFIG.version}</div>
                </div>
                
                <div style="background: rgba(55, 65, 81, 0.3); padding: 18px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #4B5563;">
                    <div style="font-size: 14px; color: #E5E7EB; text-align: center; line-height: 1.5;">${message}</div>
                </div>
                
                ${isError ? `
                <div style="background: linear-gradient(145deg, #1F2937, #111827); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #6B7280;">
                    <div style="font-size: 12px; color: #FCA5A5; text-align: center;">
                        <div style="margin-bottom: 5px; font-weight: 600;">Need license?</div>
                        <div style="color: #9CA3AF;">Contact: ${CONFIG.supportContact}</div>
                    </div>
                </div>
                ` : ''}
                
                <button onclick="this.parentElement.parentElement.remove(); location.reload();" 
                        style="width: 100%; padding: 14px; background: linear-gradient(135deg, #374151, #4B5563); color: #F3F4F6; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s; letter-spacing: 0.5px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: 0.5s;"></div>
                    <span style="position: relative;">${isError ? 'üîÑ RETRY' : 'üöÄ CONTINUE'}</span>
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add hover effect
        const btn = modal.querySelector('button');
        btn.onmouseenter = () => {
            btn.style.background = 'linear-gradient(135deg, #4B5563, #6B7280)';
            btn.style.transform = 'translateY(-2px)';
            btn.style.boxShadow = '0 8px 20px rgba(0,0,0,0.3)';
        };
        btn.onmouseleave = () => {
            btn.style.background = 'linear-gradient(135deg, #374151, #4B5563)';
            btn.style.transform = 'translateY(0)';
            btn.style.boxShadow = 'none';
        };
    }

    // ==================== HYBRID RECOVERY SYSTEM ====================
    const HybridRecovery = {
        mode: "DALEMBERT", // DALEMBERT | LABOUCHRE
        currentLevel: 1,
        lossStreak: 0,
        recoveryWins: 0,
        originalLoss: 0,
        sequence: [],
        
        // D'Alembert Configuration
        dalembert: {
            levels: [
                { chance: { min: 85, max: 88 }, multiplier: 1.5, description: "Safe Recovery" },
                { chance: { min: 80, max: 83 }, multiplier: 1.8, description: "Medium Recovery" },
                { chance: { min: 75, max: 78 }, multiplier: 2.2, description: "Aggressive Recovery" }
            ],
            winsNeeded: 3,
            maxLossStreak: 12
        },
        
        // Labouchre Configuration  
        labouchre: {
            initialSequence: [1, 2, 3],
            minChance: 60,
            maxChance: 75,
            maxSequenceLength: 10
        },
        
        // Auto-switch Rules
        autoSwitch: {
            dalembertToLabouchre: 6, // loss streak threshold
            labouchreToDalembert: 2, // consecutive wins to switch back
            maxDrawdown: 0.15 // 15% balance drop
        },
        
        // Statistics
        stats: {
            totalRecoveries: 0,
            successfulRecoveries: 0,
            failedRecoveries: 0,
            modeSwitches: 0,
            totalRecoveredAmount: 0
        },
        
        // Initialize
        initialize() {
            this.mode = "DALEMBERT";
            this.currentLevel = 1;
            this.lossStreak = 0;
            this.recoveryWins = 0;
            this.originalLoss = 0;
            this.sequence = [...this.labouchre.initialSequence];
        },
        
        // Start recovery
        startRecovery(originalLoss) {
            this.originalLoss = originalLoss;
            this.lossStreak = 0;
            this.recoveryWins = 0;
            this.stats.totalRecoveries++;
            
            if (this.mode === "DALEMBERT") {
                this.currentLevel = 1;
                console.log("üîÑ D'Alembert Recovery Started (Level 1)");
                updateStatus("üîÑ D'ALEMBERT STARTED", "#8B5CF6");
            } else {
                this.sequence = [...this.labouchre.initialSequence];
                console.log("‚ö° Labouchre Recovery Started");
                updateStatus("‚ö° LABOUCHRE STARTED", "#10B981");
            }
            
            updateLogs(0, 0, "RECOVERY", 0, `${this.mode} recovery started`);
            updateRecoveryUI();
            
            return true;
        },
        
        // Calculate next bet
        calculateNextBet(baseBet) {
            if (this.mode === "DALEMBERT") {
                const level = this.dalembert.levels[Math.min(this.currentLevel - 1, 2)];
                return baseBet * level.multiplier * Math.pow(1.1, this.lossStreak);
            } else {
                // Labouchre: bet = first + last sequence numbers
                if (this.sequence.length >= 2) {
                    return baseBet * (this.sequence[0] + this.sequence[this.sequence.length - 1]);
                } else {
                    return baseBet * this.sequence[0];
                }
            }
        },
        
        // Calculate next chance
        calculateNextChance() {
            if (this.mode === "DALEMBERT") {
                const level = this.dalembert.levels[Math.min(this.currentLevel - 1, 2)];
                return Math.random() * (level.chance.max - level.chance.min) + level.chance.min;
            } else {
                // Labouchre: dynamic chance based on sequence length
                const chanceRange = this.labouchre.maxChance - this.labouchre.minChance;
                const sequenceFactor = Math.min(1, this.sequence.length / this.labouchre.maxSequenceLength);
                return this.labouchre.maxChance - (chanceRange * sequenceFactor);
            }
        },
        
        // Handle win
        handleWin() {
            this.recoveryWins++;
            this.lossStreak = Math.max(0, this.lossStreak - 2);
            
            if (this.mode === "DALEMBERT") {
                if (this.recoveryWins >= this.dalembert.winsNeeded) {
                    this.completeRecovery(true);
                    return { complete: true, switchMode: false };
                }
                this.currentLevel = Math.max(1, Math.floor((this.lossStreak - 1) / 3) + 1);
                return { complete: false, switchMode: false };
            } else {
                // Labouchre: Remove first and last numbers
                if (this.sequence.length >= 2) {
                    this.sequence.shift();
                    this.sequence.pop();
                } else if (this.sequence.length === 1) {
                    this.sequence.shift();
                }
                
                if (this.sequence.length === 0) {
                    this.completeRecovery(true);
                    return { complete: true, switchMode: true }; // Switch back to D'Alembert
                }
                
                // Check if should switch back to D'Alembert
                if (this.recoveryWins >= this.autoSwitch.labouchreToDalembert) {
                    this.completeRecovery(true);
                    return { complete: true, switchMode: true };
                }
                
                return { complete: false, switchMode: false };
            }
        },
        
        // Handle loss
        handleLoss() {
            this.lossStreak++;
            
            if (this.mode === "DALEMBERT") {
                this.currentLevel = Math.min(3, Math.floor((this.lossStreak - 1) / 3) + 1);
                
                // Check if should switch to Labouchre
                if (this.lossStreak >= this.autoSwitch.dalembertToLabouchre) {
                    this.switchToLabouchre();
                    return { switchMode: true };
                }
                
                if (this.lossStreak >= this.dalembert.maxLossStreak) {
                    this.completeRecovery(false);
                    return { complete: true, switchMode: false };
                }
            } else {
                // Labouchre: Add bet amount to sequence
                const betAmount = this.sequence.length >= 2 ? 
                    this.sequence[0] + this.sequence[this.sequence.length - 1] : 
                    this.sequence[0];
                this.sequence.push(betAmount);
                
                // Check sequence length limit
                if (this.sequence.length > this.labouchre.maxSequenceLength) {
                    this.completeRecovery(false);
                    return { complete: true, switchMode: true };
                }
            }
            
            return { complete: false, switchMode: false };
        },
        
        // Switch to Labouchre mode
        switchToLabouchre() {
            const oldMode = this.mode;
            this.mode = "LABOUCHRE";
            this.sequence = [...this.labouchre.initialSequence];
            this.currentLevel = 1;
            this.stats.modeSwitches++;
            
            console.log(`üîÑ Switching to Labouchre from ${oldMode}`);
            updateStatus("üîÑ ‚Üí ‚ö° LABOUCHRE", "#10B981");
            updateLogs(0, 0, "RECOVERY", 0, `Switched to Labouchre recovery`);
            
            return true;
        },
        
        // Switch to D'Alembert mode
        switchToDalembert() {
            const oldMode = this.mode;
            this.mode = "DALEMBERT";
            this.currentLevel = 1;
            this.stats.modeSwitches++;
            
            console.log(`üîÑ Switching to D'Alembert from ${oldMode}`);
            updateStatus("‚ö° ‚Üí üîÑ D'ALEMBERT", "#8B5CF6");
            updateLogs(0, 0, "RECOVERY", 0, `Switched to D'Alembert recovery`);
            
            return true;
        },
        
        // Complete recovery
        completeRecovery(success) {
            if (success) {
                this.stats.successfulRecoveries++;
                this.stats.totalRecoveredAmount += Math.abs(this.originalLoss);
                updateStatus("‚úÖ RECOVERY COMPLETE", "#10B981");
                updateLogs(0, 0, "RECOVERY", 0, `Recovery completed successfully`);
            } else {
                this.stats.failedRecoveries++;
                updateStatus("‚ùå RECOVERY FAILED", "#EF4444");
                updateLogs(0, 0, "RECOVERY", 0, `Recovery failed`);
            }
            
            // Reset to D'Alembert mode
            this.mode = "DALEMBERT";
            this.currentLevel = 1;
            this.lossStreak = 0;
            this.recoveryWins = 0;
            this.originalLoss = 0;
            this.sequence = [...this.labouchre.initialSequence];
            
            updateRecoveryUI();
        },
        
        // Check if should start recovery
        shouldStartRecovery(currentProfit) {
            const threshold = getVal("p-recovery-threshold");
            return currentProfit <= threshold && !this.isActive();
        },
        
        // Check if active
        isActive() {
            return this.lossStreak > 0 || this.recoveryWins > 0;
        },
        
        // Get progress percentage
        getProgress() {
            if (this.mode === "DALEMBERT") {
                return Math.min(100, (this.recoveryWins / this.dalembert.winsNeeded) * 100);
            } else {
                const initialLength = this.labouchre.initialSequence.length;
                const currentReduction = initialLength - this.sequence.length;
                return Math.min(100, (currentReduction / initialLength) * 100);
            }
        },
        
        // Get recovery statistics
        getStats() {
            const successRate = this.stats.totalRecoveries > 0 ? 
                (this.stats.successfulRecoveries / this.stats.totalRecoveries * 100) : 0;
            
            return {
                successRate: successRate.toFixed(1),
                totalRecoveries: this.stats.totalRecoveries,
                successful: this.stats.successfulRecoveries,
                failed: this.stats.failedRecoveries,
                modeSwitches: this.stats.modeSwitches,
                totalRecovered: this.stats.totalRecoveredAmount.toFixed(8)
            };
        }
    };

    // ==================== ROTATION SETTINGS SYSTEM ====================
    const RotationConfig = {
        baseMode: {
            targetProfit: 0.00000500,
            minBets: 10,
            stopLoss: 0.00001000,
            recoveryEnabled: true
        },
        
        wagerMode: {
            maxLossStreak: 5,
            minProfit: 0.00000200,
            maxTimeMinutes: 3
        },
        
        autoRotation: {
            enabled: true,
            cooldownSeconds: 30
        },
        
        stats: {
            lastRotationTime: null,
            rotationCount: 0,
            rotationHistory: []
        }
    };

    // ==================== BOT ENGINE ====================
    const bot = {
        isRunning: false,
        isPaused: false,
        mode: "BASE",
        token: null,
        stakeUser: "Loading...",
        startTime: null,
        stopTime: null,
        lastRotationTime: null,
        
        stats: {
            profit: 0,
            wagered: 0,
            startBal: 0,
            currentBal: 0,
            bets: 0,
            wins: 0,
            loss: 0,
            maxDD: 0,
            maxProfit: 0,
            peakBalance: 0,
            sessionProfit: 0,
            sessionWagered: 0,
            sessionBets: 0,
            sessionStartBal: 0,
            baseModeProfit: 0,
            wagerModeProfit: 0,
            baseModeBets: 0,
            wagerModeBets: 0,
            baseModeWins: 0,
            wagerModeWins: 0,
            longestWinStreak: 0,
            longestLossStreak: 0,
            currentWinStreak: 0,
            currentLossStreak: 0,
            biggestWin: 0,
            biggestLoss: 0,
            totalSessions: 0,
            profitableSessions: 0,
            losingSessions: 0,
            completedSessions: 0,
            totalRuntime: 0,
            avgBetTime: 0,
            lastBetTime: null,
            winRate: 0,
            profitPerBet: 0,
            roi: 0,
            sharpeRatio: 0,
            maxConsecutiveLoss: 0,
            maxConsecutiveWin: 0,
            wagerEfficiency: 0,
            recoverySuccessRate: 0
        },
        
        selectedCurrency: localStorage.getItem('orion_last_coin') || "usdt",
        nextBet: 0,
        currentChance: 0,
        currentMulti: 0,
        ls: 0,
        lc: 0,
        bcount: 0,
        partialProfit: 0,
        targetAbs: 0,
        
        wgr: {
            ctwin: 0,
            balhigh: 0,
            profitc: 0,
            betload: 0
        },
        
        lastReportPct: 0,
        lastReportTime: 0,
        
        licenseTier: "PREMIUM",
        supportContact: CONFIG.supportContact,
        
        session: {
            targetProfit: 0,
            stopLoss: 0,
            maxSessions: 20,
            currentSession: 1,
            sessionHistory: [],
            modeStartTime: Date.now(),
            modeBetsCount: 0
        }
    };

    // ==================== QUICK PRESETS SYSTEM ====================
    const QuickPresets = {
        CONSERVATIVE: {
            name: "üõ°Ô∏è CONSERVATIVE",
            description: "Low risk, steady profit",
            settings: {
                "p-basebet": 0.00000050,
                "p-bch-min": 85.0,
                "p-bch-max": 90.0,
                "p-hch-min": 25.0,
                "p-hch-max": 35.0,
                "p-wgr-chance": 99.5,
                "p-wgr-div": 150,
                "p-stoploss-pct": 3.0,
                "p-session-target": 5.0,
                "p-session-stoploss": 3.0,
                "p-recovery-mode": "dalembert_only",
                "p-recovery-threshold": -0.00000300
            }
        },
        
        BALANCED: {
            name: "‚öñÔ∏è BALANCED",
            description: "Optimal risk/reward ratio",
            settings: {
                "p-basebet": 0.00000100,
                "p-bch-min": 80.0,
                "p-bch-max": 85.0,
                "p-hch-min": 20.0,
                "p-hch-max": 30.0,
                "p-wgr-chance": 99.0,
                "p-wgr-div": 100,
                "p-stoploss-pct": 5.0,
                "p-session-target": 8.0,
                "p-session-stoploss": 5.0,
                "p-recovery-mode": "hybrid",
                "p-recovery-threshold": -0.00000500
            }
        },
        
        AGGRESSIVE: {
            name: "‚ö° AGGRESSIVE",
            description: "High risk, high reward",
            settings: {
                "p-basebet": 0.00000200,
                "p-bch-min": 75.0,
                "p-bch-max": 80.0,
                "p-hch-min": 15.0,
                "p-hch-max": 25.0,
                "p-wgr-chance": 98.5,
                "p-wgr-div": 70,
                "p-stoploss-pct": 8.0,
                "p-session-target": 12.0,
                "p-session-stoploss": 8.0,
                "p-recovery-mode": "labouchre_only",
                "p-recovery-threshold": -0.00000800
            }
        }
    };

    // ==================== PERFORMANCE OPTIMIZATIONS ====================
    const Performance = {
        lastUIUpdate: 0,
        uiUpdateInterval: 500, // ms
        logCache: [],
        maxLogs: 50,
        virtualScrollEnabled: true,
        
        // Debounced UI updates
        shouldUpdateUI() {
            const now = Date.now();
            if (now - this.lastUIUpdate >= this.uiUpdateInterval) {
                this.lastUIUpdate = now;
                return true;
            }
            return false;
        },
        
        // Optimized log management
        addLog(log) {
            this.logCache.unshift(log);
            if (this.logCache.length > this.maxLogs) {
                this.logCache.pop();
            }
            
            // Only update visible logs
            if (this.virtualScrollEnabled) {
                this.updateVisibleLogs();
            }
        },
        
        updateVisibleLogs() {
            const visibleLogs = this.logCache.slice(0, 15);
            // Update DOM with only visible logs
        },
        
        // Throttled function calls
        throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
    };

    // ==================== API FUNCTIONS ====================
    const API = {
        async syncOnce() {
            bot.token = localStorage.getItem('apitoken') || (document.cookie.match(/session=([^;]+)/) ? document.cookie.match(/session=([^;]+)/)[1] : null);
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{name balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                if (json?.data?.user) {
                    bot.stakeUser = json.data.user.name;
                    const bals = json.data.user.balances || [];
                    const sel = document.getElementById("p-currency");
                    
                    if (sel) {
                        const currentSelected = sel.value || bot.selectedCurrency;
                        sel.innerHTML = "";

                        bals.forEach(b => {
                            const opt = new Option(
                                `${b.available.currency.toUpperCase()} (${parseFloat(b.available.amount).toFixed(2)})`,
                                b.available.currency
                            );
                            if(b.available.currency === currentSelected) opt.selected = true;
                            sel.add(opt);
                        });
                        bot.selectedCurrency = sel.value;
                    }
                    
                    await updateBalanceDisplay();
                }
            } catch (e) {
                console.error("Sync Error:", e);
            }
        },

        async getBalance(coin) {
            try {
                const res = await fetch(`${CONFIG.apiUrl}/graphql`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify({
                        query: `query{user{balances{available{amount currency}}}}`
                    })
                });
                const json = await res.json();
                const active = json.data.user.balances.find(
                    b => b.available.currency.toLowerCase() === coin.toLowerCase()
                );
                return active ? parseFloat(active.available.amount) : 0;
            } catch (e) {
                console.error("Balance Error:", e);
                return 0;
            }
        },

        async placeBet(amount, chance) {
            const payload = {
                amount: parseFloat(amount.toFixed(8)),
                currency: bot.selectedCurrency,
                target: (100 - chance).toFixed(1),
                condition: "above",
                identifier: Math.random().toString(36).slice(2) + Date.now()
            };
            
            const startTime = Date.now();
            
            try {
                const r = await fetch(`${CONFIG.apiUrl}/casino/dice/roll`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-access-token": bot.token
                    },
                    body: JSON.stringify(payload)
                });
                const result = await r.json();
                
                const speed = Date.now() - startTime;
                if (speed > 100) {
                    console.log(`Bet speed: ${speed}ms`);
                }
                
                return result;
            } catch (error) {
                console.error("Bet Error:", error);
                throw error;
            }
        }
    };

    // ==================== TELEGRAM REPORT ====================
    async function sendTelegramReport(reason) {
        try {
            const now = Date.now();
            
            if (reason === "auto" && now - bot.lastReportTime < 300000) {
                return;
            }
            
            bot.lastReportTime = now;
            
            const runningTime = getElapsedTime();
            const currentDD = bot.stats.startBal - bot.stats.currentBal;
            const currentDDPct = bot.stats.startBal > 0 ? (currentDD / bot.stats.startBal * 100) : 0;
            const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
            const sessionProfitPct = bot.stats.sessionStartBal > 0 ?
                (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100) : 0;
            
            const roi = bot.stats.wagered > 0 ? (bot.stats.profit / bot.stats.wagered * 100) : 0;
            const profitPerBet = bot.stats.bets > 0 ? (bot.stats.profit / bot.stats.bets) : 0;
            
            let header = "";
            let emoji = "üöÄ";
            
            switch(reason) {
                case "load": header = "BOT LOADED"; emoji = "üì±"; break;
                case "start": header = "BOT STARTED"; emoji = "‚ñ∂Ô∏è"; break;
                case "stop": header = "BOT STOPPED"; emoji = "üõë"; break;
                case "target": header = "TARGET REACHED"; emoji = "üéØ"; break;
                case "stoploss": header = "STOP LOSS HIT"; emoji = "‚õî"; break;
                case "session_start": header = "NEW SESSION"; emoji = "üöÄ"; break;
                case "max_sessions": header = "MAX SESSIONS"; emoji = "üìä"; break;
                case "recovery_start": header = "RECOVERY STARTED"; emoji = "üîÑ"; break;
                case "recovery_complete": header = "RECOVERY COMPLETE"; emoji = "‚úÖ"; break;
                case "mode_switch": header = "MODE SWITCHED"; emoji = "üîÑ"; break;
                case "report": header = "MANUAL REPORT"; emoji = "üìä"; break;
                default: header = "REGULAR REPORT"; emoji = "üìä";
            }
            
            const message = `
<b>${emoji} ORION PRO ${header}</b>
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
<b>üë§ User:</b> ${bot.stakeUser}
<b>üìÖ Expiry:</b> ${userExpiry}
<b>üí∞ Currency:</b> ${bot.selectedCurrency.toUpperCase()}
<b>üîí License:</b> ${bot.licenseTier}
<b>üéÆ Mode:</b> ${bot.mode}
<b>‚è± Time:</b> ${runningTime}

<b>üìä BALANCE INFO</b>
‚îú‚îÄ Start: ${bot.stats.startBal.toFixed(8)}
‚îú‚îÄ Current: ${bot.stats.currentBal.toFixed(8)}
‚îú‚îÄ Profit: <b>${bot.stats.profit.toFixed(8)}</b>
‚îú‚îÄ Session P/L: ${bot.stats.sessionProfit.toFixed(8)} (${sessionProfitPct.toFixed(2)}%)
‚îî‚îÄ Drawdown: ${currentDD.toFixed(8)} (${currentDDPct.toFixed(2)}%)

<b>üìà PERFORMANCE</b>
‚îú‚îÄ Bets: ${bot.stats.bets}
‚îú‚îÄ Win/Loss: ${bot.stats.wins}/${bot.stats.loss}
‚îú‚îÄ Win Rate: ${winRate.toFixed(1)}%
‚îú‚îÄ ROI: ${roi.toFixed(2)}%
‚îî‚îÄ Avg Profit/Bet: ${profitPerBet.toFixed(8)}

${HybridRecovery.isActive() ? `
<b>üîÑ HYBRID RECOVERY</b>
‚îú‚îÄ Mode: ${HybridRecovery.mode}
‚îú‚îÄ Level: ${HybridRecovery.currentLevel}
‚îú‚îÄ Loss Streak: ${HybridRecovery.lossStreak}
‚îú‚îÄ Recovery Wins: ${HybridRecovery.recoveryWins}
‚îî‚îÄ Progress: ${HybridRecovery.getProgress().toFixed(1)}%
` : ''}

<b>üìä SESSION INFO</b>
‚îú‚îÄ Session: ${bot.session.currentSession}/${bot.session.maxSessions}
‚îú‚îÄ Profitable Sessions: ${bot.stats.profitableSessions}/${bot.stats.totalSessions}
‚îî‚îÄ Status: ${bot.isRunning ? (bot.isPaused ? '‚è∏Ô∏è PAUSED' : '‚ñ∂Ô∏è RUNNING') : 'üõë STOPPED'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üí¨ <b>Support:</b> ${CONFIG.supportContact}
‚ö° <b>Version:</b> ${CONFIG.version}
            `;

            const url = `https://api.telegram.org/bot${CONFIG.tgToken}/sendMessage`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: CONFIG.tgChatId,
                    text: message,
                    parse_mode: 'HTML',
                    disable_web_page_preview: true
                })
            });
            
            console.log(`${emoji} Telegram report sent (${reason})`);
            
        } catch (error) {
            console.error('Telegram report error:', error);
        }
    }

    // ==================== ROTATION MANAGEMENT ====================
    function updateRotationConfigFromUI() {
        RotationConfig.baseMode.targetProfit = getVal("p-base-target-profit");
        RotationConfig.baseMode.minBets = getVal("p-base-min-bets");
        RotationConfig.baseMode.stopLoss = getVal("p-base-stop-loss");
        RotationConfig.baseMode.recoveryEnabled = getVal("p-base-recovery-enabled") === 1;
        
        RotationConfig.wagerMode.maxLossStreak = getVal("p-wager-max-loss");
        RotationConfig.wagerMode.minProfit = getVal("p-wager-min-profit");
        RotationConfig.wagerMode.maxTimeMinutes = getVal("p-wager-max-time");
        
        RotationConfig.autoRotation.enabled = getVal("p-auto-rotate-enabled") === 1;
        RotationConfig.autoRotation.cooldownSeconds = getVal("p-rotate-cooldown");
        
        console.log("Rotation config updated");
    }

    function shouldSwitchToWager() {
        if (!RotationConfig.autoRotation.enabled || bot.mode !== "BASE") return false;
        
        if (RotationConfig.stats.lastRotationTime && 
            (Date.now() - RotationConfig.stats.lastRotationTime) < (RotationConfig.autoRotation.cooldownSeconds * 1000)) {
            return false;
        }
        
        if (bot.session.modeBetsCount < RotationConfig.baseMode.minBets) return false;
        
        if (bot.stats.baseModeProfit >= RotationConfig.baseMode.targetProfit) {
            return true;
        }
        
        if (bot.stats.baseModeProfit <= -RotationConfig.baseMode.stopLoss) {
            return true;
        }
        
        return false;
    }

    function shouldSwitchToBase() {
        if (!RotationConfig.autoRotation.enabled || bot.mode !== "WAGER") return false;
        
        if (RotationConfig.stats.lastRotationTime && 
            (Date.now() - RotationConfig.stats.lastRotationTime) < (RotationConfig.autoRotation.cooldownSeconds * 1000)) {
            return false;
        }
        
        if (bot.stats.currentLossStreak >= RotationConfig.wagerMode.maxLossStreak) {
            return true;
        }
        
        if (bot.stats.wagerModeProfit < RotationConfig.wagerMode.minProfit) {
            return true;
        }
        
        const modeDuration = Date.now() - bot.session.modeStartTime;
        if (modeDuration >= RotationConfig.wagerMode.maxTimeMinutes * 60 * 1000) {
            return true;
        }
        
        return false;
    }

    function rotateMode(newMode) {
        const oldMode = bot.mode;
        const rotationTime = Date.now();
        
        RotationConfig.stats.rotationCount++;
        RotationConfig.stats.lastRotationTime = rotationTime;
        
        const rotationRecord = {
            timestamp: rotationTime,
            from: oldMode,
            to: newMode,
            baseProfit: bot.stats.baseModeProfit,
            wagerProfit: bot.stats.wagerModeProfit,
            balance: bot.stats.currentBal
        };
        
        RotationConfig.stats.rotationHistory.unshift(rotationRecord);
        if (RotationConfig.stats.rotationHistory.length > 10) {
            RotationConfig.stats.rotationHistory.pop();
        }
        
        bot.mode = newMode;
        bot.lastRotationTime = rotationTime;
        bot.session.modeStartTime = rotationTime;
        bot.session.modeBetsCount = 0;
        
        if (newMode === "BASE") {
            rotateToBaseMode();
        } else if (newMode === "WAGER") {
            rotateToWagerMode();
        }
        
        updateStatus(`üîÑ ${oldMode} ‚Üí ${newMode}`, "#9CA3AF");
        updateLogs(0, 0, "ROTATION", 0, `${oldMode} ‚Üí ${newMode}`);
        
        sendTelegramReport("mode_switch");
        
        console.log(`üîÑ Mode rotated: ${oldMode} ‚Üí ${newMode}`);
    }

    function rotateToBaseMode() {
        bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
        bot.nextBet = getVal("p-basebet");
        bot.currentMulti = getVal("p-multi-start");
        bot.ls = 0;
        bot.lc = 0;
        bot.partialProfit = 0;
        bot.bcount = 0;
        
        if (HybridRecovery.isActive()) {
            HybridRecovery.completeRecovery(false);
        }
        
        console.log("üîÑ Rotated to BASE mode");
    }

    function rotateToWagerMode() {
        bot.currentChance = getVal("p-wgr-chance");
        bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
        bot.wgr.balhigh = bot.stats.currentBal;
        bot.wgr.profitc = 0;
        bot.wgr.ctwin = 0;
        bot.wgr.betload = 0;
        
        console.log("üîÑ Rotated to WAGER mode");
    }

    // ==================== SESSION MANAGEMENT ====================
    function startNewSession() {
        if (bot.stats.sessionStartBal > 0 && bot.stats.sessionBets > 0) {
            const sessionData = {
                sessionNumber: bot.session.currentSession,
                startBalance: bot.stats.sessionStartBal,
                endBalance: bot.stats.currentBal,
                profit: bot.stats.sessionProfit,
                profitPct: (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100),
                bets: bot.stats.sessionBets,
                duration: Date.now() - bot.startTime
            };
            
            bot.session.sessionHistory.push(sessionData);
            
            if (bot.stats.sessionProfit > 0) {
                bot.stats.profitableSessions++;
            } else {
                bot.stats.losingSessions++;
            }
            bot.stats.totalSessions++;
            bot.stats.completedSessions++;
        }
        
        bot.session.currentSession++;
        bot.stats.sessionStartBal = bot.stats.currentBal;
        bot.stats.sessionProfit = 0;
        bot.stats.sessionWagered = 0;
        bot.stats.sessionBets = 0;
        
        bot.session.modeStartTime = Date.now();
        bot.session.modeBetsCount = 0;
        
        rotateToBaseMode();
        
        console.log(`üöÄ Starting session ${bot.session.currentSession}`);
        updateStatus(`üöÄ SESSION ${bot.session.currentSession}`, "#6366F1");
        sendTelegramReport("session_start");
        
        updateLogs(0, 0, "SESSION", 0, `Session ${bot.session.currentSession} started`);
        
        bot.isRunning = true;
        bot.isPaused = false;
        
        return true;
    }

    function checkSessionCompletion() {
        const sessionTargetPct = getVal("p-session-target");
        const sessionStopLossPct = getVal("p-session-stoploss");
        const sessionProfitPct = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
        
        if (sessionProfitPct >= sessionTargetPct) {
            completeSession("TARGET");
            return true;
        }
        
        if (sessionProfitPct <= -sessionStopLossPct) {
            completeSession("STOP LOSS");
            return true;
        }
        
        return false;
    }

    function completeSession(reason) {
        const sessionData = {
            sessionNumber: bot.session.currentSession,
            startBalance: bot.stats.sessionStartBal,
            endBalance: bot.stats.currentBal,
            profit: bot.stats.sessionProfit,
            profitPct: (bot.stats.sessionProfit / bot.stats.sessionStartBal * 100),
            bets: bot.stats.sessionBets,
            duration: Date.now() - bot.startTime,
            reason: reason
        };
        
        bot.session.sessionHistory.push(sessionData);
        
        if (bot.stats.sessionProfit > 0) {
            bot.stats.profitableSessions++;
        } else {
            bot.stats.losingSessions++;
        }
        bot.stats.totalSessions++;
        bot.stats.completedSessions++;
        
        const maxSessions = getVal("p-max-sessions");
        if (maxSessions > 0 && bot.session.currentSession >= maxSessions) {
            stopEngine();
            updateStatus("üìä MAX SESSIONS", "#9CA3AF");
            sendTelegramReport("max_sessions");
            return false;
        }
        
        startNewSession();
        return true;
    }

    // ==================== UTILITY FUNCTIONS ====================
    function getVal(id) {
        try {
            const el = document.getElementById(id);
            if (!el) {
                const defaults = {
                    "p-minbet": 0.00000001,
                    "p-target-pct": 5.0,
                    "p-wgr-div": 100,
                    "p-wgr-chance": 99,
                    "p-basebet": 0.00000100,
                    "p-multi-start": 1.45,
                    "p-multi-inc": 0.05,
                    "p-bch-min": 80.0,
                    "p-bch-max": 95.0,
                    "p-hch-min": 20.0,
                    "p-hch-max": 30.0,
                    "p-wagertarget": 200,
                    "p-stoploss-pct": 5.0,
                    "p-session-target": 10.0,
                    "p-session-stoploss": 5.0,
                    "p-max-sessions": 20,
                    "p-base-target-profit": 0.00000500,
                    "p-base-min-bets": 10,
                    "p-base-stop-loss": 0.00001000,
                    "p-base-recovery-enabled": 1,
                    "p-wager-max-loss": 5,
                    "p-wager-min-profit": 0.00000200,
                    "p-wager-max-time": 3,
                    "p-auto-rotate-enabled": 1,
                    "p-rotate-cooldown": 30,
                    "p-recovery-enabled": 1,
                    "p-recovery-threshold": -0.00000500,
                    "p-recovery-mode": "hybrid"
                };
                return defaults[id] || 0;
            }
            return parseFloat(el.value) || 0;
        } catch (e) {
            console.error(`Error getting value for ${id}:`, e);
            return 0;
        }
    }

    async function updateBalanceDisplay() {
        if (bot.isRunning) return;
        const balance = await API.getBalance(bot.selectedCurrency);
        bot.stats.currentBal = balance;
        if (bot.stats.startBal === 0) {
            bot.stats.startBal = balance;
        }
    }

    function updateStatsSync(d, win, pft) {
        const betTime = Date.now();
        
        bot.stats.bets++;
        bot.stats.sessionBets++;
        bot.session.modeBetsCount++;
        bot.stats.wagered += d.amount;
        bot.stats.sessionWagered += d.amount;
        bot.stats.profit += pft;
        bot.stats.sessionProfit += pft;
        bot.stats.currentBal += pft;
        bot.partialProfit += pft;
        
        if (bot.mode === "BASE") {
            bot.stats.baseModeBets++;
            bot.stats.baseModeProfit += pft;
            if (win) bot.stats.baseModeWins++;
        } else {
            bot.stats.wagerModeBets++;
            bot.stats.wagerModeProfit += pft;
            if (win) bot.stats.wagerModeWins++;
        }
        
        if (win) {
            bot.stats.wins++;
            bot.stats.currentWinStreak++;
            bot.stats.currentLossStreak = 0;
            
            if (bot.stats.currentWinStreak > bot.stats.longestWinStreak) {
                bot.stats.longestWinStreak = bot.stats.currentWinStreak;
            }
            
            if (pft > bot.stats.biggestWin) {
                bot.stats.biggestWin = pft;
            }
        } else {
            bot.stats.loss++;
            bot.stats.currentLossStreak++;
            bot.stats.currentWinStreak = 0;
            
            if (bot.stats.currentLossStreak > bot.stats.longestLossStreak) {
                bot.stats.longestLossStreak = bot.stats.currentLossStreak;
            }
            
            if (Math.abs(pft) > Math.abs(bot.stats.biggestLoss)) {
                bot.stats.biggestLoss = pft;
            }
        }
        
        let drop = bot.stats.currentBal < bot.stats.startBal ? bot.stats.startBal - bot.stats.currentBal : 0;
        if (drop > bot.stats.maxDD) bot.stats.maxDD = drop;
        
        if (bot.stats.currentBal > bot.stats.peakBalance) {
            bot.stats.peakBalance = bot.stats.currentBal;
        }
        
        if (bot.stats.profit > bot.stats.maxProfit) {
            bot.stats.maxProfit = bot.stats.profit;
        }
        
        if (bot.stats.lastBetTime) {
            const timeBetweenBets = betTime - bot.stats.lastBetTime;
            bot.stats.avgBetTime = (bot.stats.avgBetTime * (bot.stats.bets - 1) + timeBetweenBets) / bot.stats.bets;
        }
        bot.stats.lastBetTime = betTime;
        bot.stats.totalRuntime = betTime - bot.startTime;
        
        // Update advanced stats
        bot.stats.winRate = bot.stats.bets > 0 ? (bot.stats.wins / bot.stats.bets * 100) : 0;
        bot.stats.profitPerBet = bot.stats.bets > 0 ? (bot.stats.profit / bot.stats.bets) : 0;
        bot.stats.roi = bot.stats.wagered > 0 ? (bot.stats.profit / bot.stats.wagered * 100) : 0;
        
        const avgWagerBet = bot.stats.wagerModeBets > 0 ? 
            (bot.stats.wagered / bot.stats.bets) : 0;
        bot.stats.wagerEfficiency = avgWagerBet > 0 ? 
            (bot.stats.wagerModeProfit / (bot.stats.wagerModeBets * avgWagerBet) * 100) : 0;
    }

    function handleBaseMode(win) {
        if (win) {
            bot.ls = 0;
            bot.lc = 0;
            bot.partialProfit = 0;
            bot.currentChance = Math.random() * (getVal("p-bch-max") - getVal("p-bch-min")) + getVal("p-bch-min");
            bot.nextBet = getVal("p-basebet");
            bot.currentMulti = getVal("p-multi-start");
            
            if (shouldSwitchToWager()) {
                rotateMode("WAGER");
            }
        } else {
            bot.ls++;
            bot.lc++;
            
            // Check if should start recovery
            if (getVal("p-recovery-enabled") === 1 && bot.mode === "WAGER" && 
                !HybridRecovery.isActive() && bot.wgr.profitc <= getVal("p-recovery-threshold")) {
                HybridRecovery.startRecovery(bot.wgr.profitc);
            }
            
            if (bot.ls === 1 || bot.lc > bot.bcount) {
                if (bot.ls > 1) bot.currentMulti += getVal("p-multi-inc");
                bot.lc = 1;
                bot.currentChance = Math.random() * (getVal("p-hch-max") - getVal("p-hch-min")) + getVal("p-hch-min");
                bot.bcount = Math.ceil(99 / bot.currentChance);
            }
            bot.nextBet = (Math.abs(bot.partialProfit) / ((99/bot.currentChance) - 1)) * bot.currentMulti;
            
            if (shouldSwitchToWager()) {
                rotateMode("WAGER");
            }
        }
    }

    function handleWagerMode(win) {
        if (win) {
            bot.wgr.ctwin++;
            
            // Handle recovery if active
            if (HybridRecovery.isActive()) {
                const result = HybridRecovery.handleWin();
                if (result.complete) {
                    if (result.switchMode) {
                        HybridRecovery.switchToDalembert();
                    }
                    bot.currentChance = getVal("p-wgr-chance");
                    bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                } else {
                    bot.currentChance = HybridRecovery.calculateNextChance();
                    bot.nextBet = HybridRecovery.calculateNextBet(bot.stats.currentBal / getVal("p-wgr-div"));
                }
            } else {
                if (bot.wgr.ctwin > 10) {
                    bot.wgr.ctwin = 0;
                    const recoveryChance = Math.random() * (getVal("p-chrec-max") - getVal("p-chrec-min")) + getVal("p-chrec-min");
                    bot.currentChance = recoveryChance;
                    bot.nextBet = Math.max(0, bot.wgr.betload) / ((99 / bot.currentChance) - 1);
                } else {
                    bot.currentChance = getVal("p-wgr-chance");
                    bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                }
            }
            
            if (bot.stats.currentBal > bot.wgr.balhigh) {
                bot.wgr.balhigh = bot.stats.currentBal;
            }
            
            if (shouldSwitchToBase()) {
                rotateMode("BASE");
            }
        } else {
            bot.wgr.profitc += (bot.stats.currentBal - bot.wgr.balhigh);
            bot.wgr.betload = bot.wgr.balhigh - bot.stats.currentBal;
            
            // Handle recovery if active
            if (HybridRecovery.isActive()) {
                const result = HybridRecovery.handleLoss();
                if (result.complete) {
                    if (result.switchMode) {
                        HybridRecovery.switchToDalembert();
                    }
                    bot.currentChance = getVal("p-wgr-chance");
                    bot.nextBet = bot.stats.currentBal / getVal("p-wgr-div");
                } else if (result.switchMode) {
                    HybridRecovery.switchToLabouchre();
                    bot.currentChance = HybridRecovery.calculateNextChance();
                    bot.nextBet = HybridRecovery.calculateNextBet(bot.stats.currentBal / getVal("p-wgr-div"));
                } else {
                    bot.currentChance = HybridRecovery.calculateNextChance();
                    bot.nextBet = HybridRecovery.calculateNextBet(bot.stats.currentBal / getVal("p-wgr-div"));
                }
            } else {
                // Start recovery if threshold reached
                if (getVal("p-recovery-enabled") === 1 && 
                    bot.wgr.profitc <= getVal("p-recovery-threshold")) {
                    HybridRecovery.startRecovery(bot.wgr.profitc);
                    bot.currentChance = HybridRecovery.calculateNextChance();
                    bot.nextBet = HybridRecovery.calculateNextBet(bot.stats.currentBal / getVal("p-wgr-div"));
                } else {
                    if (bot.currentChance < 80) {
                        bot.nextBet = Math.abs(bot.wgr.betload) / ((99 / bot.currentChance) - 1);
                    } else {
                        bot.nextBet *= 1.12;
                    }
                }
            }
            
            if (shouldSwitchToBase()) {
                rotateMode("BASE");
            }
        }
    }

    // ==================== MAIN BOT LOOP ====================
    async function runLoop() {
        if (!bot.isRunning || bot.isPaused) return;
        
        if (checkSessionCompletion()) {
            setTimeout(runLoop, 10);
            return;
        }
        
        const stopLossPct = getVal("p-stoploss-pct");
        const currentProfitPct = bot.stats.profit / bot.stats.startBal * 100;
        
        if (currentProfitPct <= -stopLossPct) {
            await stopEngine();
            updateStatus("‚õî STOP LOSS", "#EF4444");
            await sendTelegramReport("stoploss");
            return;
        }
        
        if (bot.targetAbs > 0 && bot.stats.profit >= bot.targetAbs) {
            await stopEngine();
            updateStatus("üéØ TARGET REACHED", "#10B981");
            await sendTelegramReport("target");
            return;
        }

        API.placeBet(bot.nextBet, bot.currentChance)
            .then(res => {
                const d = res?.data?.diceRoll || res?.diceRoll;
                if (d) {
                    const win = d.payout > 0;
                    const pft = d.payout - d.amount;
                    
                    updateStatsSync(d, win, pft);
                    updateLogs(d.amount, bot.currentChance, bot.mode, pft);
                    
                    if (bot.mode === "BASE") {
                        handleBaseMode(win);
                    } else if (bot.mode === "WAGER") {
                        handleWagerMode(win);
                    }
                    
                    const minBet = getVal("p-minbet");
                    bot.nextBet = Math.max(bot.nextBet, minBet);
                    
                    // Update recovery UI if active
                    if (HybridRecovery.isActive()) {
                        updateRecoveryUI();
                    }
                    
                    // Update session summary every 10 bets
                    if (bot.stats.bets % 10 === 0) {
                        updateSessionSummary();
                    }
                    
                    // Send auto report every 5 minutes
                    if (Date.now() - bot.lastReportTime >= 300000) {
                        sendTelegramReport("auto");
                    }
                    
                    setTimeout(runLoop, 0);
                } else {
                    setTimeout(runLoop, 50);
                }
            })
            .catch(e => {
                console.error("Loop error:", e);
                setTimeout(runLoop, 100);
            });
    }

    async function stopEngine() {
        bot.isRunning = false;
        bot.stopTime = Date.now();
        await updateBalanceDisplay();
    }

    function updateStatus(text, color) {
        const el = document.getElementById("st-status-text");
        if (el) {
            el.innerText = text;
            el.style.color = color || "#9CA3AF";
        }
    }

    function updateLogs(amt, ch, mode, pft, customText = "") {
        const logBox = document.getElementById("p-log-body");
        if (!logBox) return;
        
        const modeColors = {
            'WAGER': '#8B5CF6',
            'BASE': '#6366F1',
            'RECOVERY': '#10B981',
            'SESSION': '#6366F1',
            'ROTATION': '#F59E0B'
        };
        
        const row = document.createElement("div");
        
        if (customText) {
            row.style.cssText = `padding: 8px 12px; margin: 4px 0; background: rgba(55, 65, 81, 0.3); border-radius: 8px; border-left: 3px solid ${modeColors[mode] || '#6366F1'}; font-size: 11px; color: #E5E7EB;`;
            row.innerHTML = `<div style="display: flex; align-items: center; gap: 8px;"><span style="color: ${modeColors[mode] || '#6366F1'}">${mode}</span><span>${customText}</span></div>`;
        } else {
            row.style.cssText = `display:grid; grid-template-columns:1.2fr 1fr 0.8fr 1.2fr; font-size:11px; border-bottom:1px solid rgba(255,255,255,0.05); padding:8px 0; color:${pft >= 0 ? '#10B981' : '#EF4444'}; text-align:center;`;
            row.innerHTML = `
                <span>${amt.toFixed(5)}</span>
                <span>${ch.toFixed(1)}%</span>
                <span style="color:${modeColors[mode] || '#6366F1'}">${mode}</span>
                <span>${pft.toFixed(5)}</span>
            `;
        }
        
        logBox.prepend(row);
        if (logBox.children.length > 15) logBox.removeChild(logBox.lastChild);
        
        // Add to performance cache
        Performance.addLog({
            amount: amt,
            chance: ch,
            mode: mode,
            profit: pft,
            timestamp: Date.now(),
            customText: customText
        });
    }

    function getElapsedTime() {
        if (!bot.startTime) return "00:00:00";
        let now = bot.isRunning ? Date.now() : (bot.stopTime || Date.now());
        const d = Math.floor((now - bot.startTime) / 1000);
        return `${Math.floor(d/3600).toString().padStart(2,'0')}:${Math.floor((d%3600)/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
    }

    function updateRecoveryUI() {
        const recoveryStatus = document.getElementById("recovery-status");
        const recoveryMode = document.getElementById("recovery-mode");
        const recoveryLevel = document.getElementById("recovery-level");
        const recoveryProgress = document.getElementById("recovery-progress");
        const recoverySequence = document.getElementById("recovery-sequence");
        
        if (!recoveryStatus || !recoveryMode || !recoveryLevel || !recoveryProgress) return;
        
        if (!HybridRecovery.isActive()) {
            recoveryStatus.innerText = "INACTIVE";
            recoveryMode.innerText = "READY";
            recoveryLevel.innerText = "0";
            recoveryProgress.style.width = "0%";
            if (recoverySequence) recoverySequence.innerText = "[ ]";
            return;
        }
        
        recoveryStatus.innerText = "ACTIVE";
        recoveryMode.innerText = HybridRecovery.mode;
        recoveryLevel.innerText = HybridRecovery.currentLevel;
        
        const progress = HybridRecovery.getProgress();
        recoveryProgress.style.width = `${progress}%`;
        
        if (recoverySequence && HybridRecovery.mode === "LABOUCHRE") {
            recoverySequence.innerText = `[${HybridRecovery.sequence.join(', ')}]`;
        }
    }

    function updateSessionSummary() {
        const summaryEl = document.getElementById("session-summary");
        if (!summaryEl) return;
        
        const winRate = bot.stats.bets > 0 ? ((bot.stats.wins / bot.stats.bets) * 100) : 0;
        const roi = bot.stats.wagered > 0 ? (bot.stats.profit / bot.stats.wagered * 100) : 0;
        const avgProfitPerBet = bot.stats.bets > 0 ? (bot.stats.profit / bot.stats.bets) : 0;
        
        summaryEl.innerHTML = `
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Win Rate</div>
                    <div class="summary-value ${winRate >= 50 ? 'text-success' : 'text-danger'}">
                        ${winRate.toFixed(1)}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ROI</div>
                    <div class="summary-value ${roi >= 0 ? 'text-success' : 'text-danger'}">
                        ${roi.toFixed(2)}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Profit/Bet</div>
                    <div class="summary-value ${avgProfitPerBet >= 0 ? 'text-success' : 'text-danger'}">
                        ${avgProfitPerBet.toFixed(8)}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Avg Bet Time</div>
                    <div class="summary-value">${bot.stats.avgBetTime.toFixed(0)}ms</div>
                </div>
            </div>
        `;
    }

    // ==================== PRESET APPLY FUNCTION ====================
    function applyPreset(presetName) {
        const preset = QuickPresets[presetName];
        if (!preset) return;
        
        // Apply all settings from preset
        for (const [key, value] of Object.entries(preset.settings)) {
            const el = document.getElementById(key);
            if (el) {
                el.value = value;
                // Trigger change event for select elements
                if (el.tagName === 'SELECT') {
                    el.dispatchEvent(new Event('change'));
                }
            }
        }
        
        // Update rotation config
        updateRotationConfigFromUI();
        
        // Show confirmation
        updateStatus(`‚úÖ ${preset.name} APPLIED`, "#10B981");
        updateLogs(0, 0, "PRESET", 0, `${preset.name} preset applied`);
        
        console.log(`‚úÖ ${preset.name} preset applied`);
    }

    // ==================== RESPONSIVE UI CREATION ====================
    function createUI() {
        if (document.getElementById("orion-wrap")) {
            document.getElementById("orion-wrap").remove();
        }
        
        const s = document.createElement("style");
        s.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
            
            :root {
                --bg-primary: #0F1117;
                --bg-secondary: #1A1D28;
                --bg-tertiary: #242837;
                --accent-primary: #6366F1;
                --accent-secondary: #8B5CF6;
                --accent-success: #10B981;
                --accent-warning: #F59E0B;
                --accent-danger: #EF4444;
                --text-primary: #F3F4F6;
                --text-secondary: #9CA3AF;
                --text-muted: #6B7280;
                --border-color: #374151;
                --border-light: #4B5563;
                --gradient-primary: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
                --gradient-success: linear-gradient(135deg, #10B981 0%, #34D399 100%);
                --gradient-warning: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
                --gradient-danger: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            #orion-wrap {
                position: fixed;
                width: 420px;
                height: 650px;
                max-height: 85vh;
                background: var(--bg-primary);
                color: var(--text-primary);
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
                overflow: hidden;
                resize: both;
                min-width: 380px;
                min-height: 550px;
                max-width: 95vw;
                max-height: 95vh;
                border: 1px solid var(--border-color);
            }
            
            @media (max-width: 500px) {
                #orion-wrap {
                    width: 95vw;
                    height: 85vh;
                    bottom: 10px;
                    left: 2.5vw;
                    top: auto;
                    resize: none;
                }
            }
            
            @media (min-width: 501px) {
                #orion-wrap {
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }
            }
            
            /* Premium Header */
            .header {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
                padding: 20px 20px 15px 20px;
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
                position: relative;
                overflow: hidden;
            }
            
            .header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: var(--gradient-primary);
            }
            
            .header-main {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 15px;
            }
            
            .header-title {
                font-size: 22px;
                font-weight: 800;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 10px;
                letter-spacing: 0.5px;
            }
            
            .header-title::before {
                content: "‚ö°";
                font-size: 24px;
                background: var(--gradient-primary);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .license-badge {
                background: var(--gradient-primary);
                color: white;
                padding: 6px 16px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 0.5px;
                box-shadow: var(--shadow-md);
            }
            
            /* User Info Card */
            .user-info-card {
                background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
                border-radius: 12px;
                padding: 14px;
                border: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: 8px;
                box-shadow: var(--shadow-md);
            }
            
            .user-info-left {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
                background: var(--gradient-primary);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                color: white;
            }
            
            .user-details {
                display: flex;
                flex-direction: column;
            }
            
            .username {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-primary);
            }
            
            .expiry-date {
                font-size: 11px;
                color: var(--text-secondary);
                display: flex;
                align-items: center;
                gap: 4px;
            }
            
            .status-badge {
                display: inline-block;
                padding: 10px 22px;
                background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
                border: 1px solid var(--border-color);
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
                color: var(--text-primary);
                margin-top: 12px;
                text-align: center;
                letter-spacing: 0.5px;
                box-shadow: var(--shadow-sm);
            }
            
            /* Currency Selector */
            .currency-selector {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-radius: 12px;
                padding: 14px;
                margin: 16px;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-md);
            }
            
            .currency-select {
                width: 100%;
                padding: 12px;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                color: var(--text-primary);
                font-size: 13px;
                font-weight: 500;
                font-family: 'Inter', sans-serif;
                transition: all 0.3s;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 16px;
                padding-right: 40px;
            }
            
            .currency-select:focus {
                outline: none;
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }
            
            /* Tab Navigation */
            .tab-nav {
                display: flex;
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-bottom: 1px solid var(--border-color);
                flex-shrink: 0;
                overflow-x: auto;
                scrollbar-width: none;
                padding: 0 16px;
            }
            
            .tab-nav::-webkit-scrollbar {
                display: none;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 80px;
                padding: 14px 10px;
                background: transparent;
                border: none;
                border-bottom: 3px solid transparent;
                color: var(--text-secondary);
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                white-space: nowrap;
                letter-spacing: 0.3px;
                position: relative;
                overflow: hidden;
            }
            
            .tab-btn::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                width: 0;
                height: 3px;
                background: var(--gradient-primary);
                transition: all 0.3s;
                transform: translateX(-50%);
            }
            
            .tab-btn.active {
                color: var(--text-primary);
            }
            
            .tab-btn.active::after {
                width: 100%;
            }
            
            .tab-content {
                display: none;
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                background: var(--bg-primary);
            }
            
            .tab-content.active {
                display: block;
            }
            
            /* Dashboard Grid */
            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .dashboard-card {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-radius: 12px;
                padding: 16px;
                border: 1px solid var(--border-color);
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }
            
            .dashboard-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
                border-color: var(--border-light);
            }
            
            .card-title {
                font-size: 11px;
                color: var(--text-secondary);
                margin-bottom: 8px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .card-value {
                font-size: 18px;
                font-weight: 700;
                color: var(--text-primary);
                line-height: 1.2;
                margin-bottom: 4px;
            }
            
            .card-sub {
                font-size: 10px;
                color: var(--text-muted);
                font-weight: 500;
            }
            
            /* Progress Bars */
            .progress-container {
                margin: 16px 0;
            }
            
            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: var(--text-secondary);
                margin-bottom: 6px;
                font-weight: 500;
            }
            
            .progress-bar {
                height: 8px;
                background: var(--bg-tertiary);
                border-radius: 4px;
                overflow: hidden;
                position: relative;
            }
            
            .progress-fill {
                height: 100%;
                background: var(--gradient-primary);
                border-radius: 4px;
                transition: width 0.5s ease;
                position: relative;
                overflow: hidden;
            }
            
            .progress-fill::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                background-image: linear-gradient(
                    -45deg,
                    rgba(255, 255, 255, 0.2) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.2) 75%,
                    transparent 75%,
                    transparent
                );
                background-size: 20px 20px;
                animation: moveStripes 1s linear infinite;
            }
            
            @keyframes moveStripes {
                0% { background-position: 0 0; }
                100% { background-position: 20px 0; }
            }
            
            /* Recovery Monitor */
            .recovery-monitor {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-radius: 12px;
                padding: 16px;
                margin: 16px 0;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-md);
            }
            
            .recovery-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .recovery-title {
                font-size: 13px;
                font-weight: 700;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .recovery-stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 12px;
            }
            
            .recovery-stat {
                background: var(--bg-primary);
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            
            .recovery-stat-label {
                font-size: 10px;
                color: var(--text-secondary);
                margin-bottom: 4px;
                font-weight: 500;
            }
            
            .recovery-stat-value {
                font-size: 13px;
                font-weight: 700;
                color: var(--text-primary);
            }
            
            /* Quick Presets */
            .presets-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin: 16px 0;
            }
            
            .preset-btn {
                padding: 12px 8px;
                border: none;
                border-radius: 10px;
                font-size: 11px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                letter-spacing: 0.3px;
            }
            
            .preset-conservative {
                background: linear-gradient(145deg, #1F2937, #111827);
                color: #9CA3AF;
                border: 1px solid #374151;
            }
            
            .preset-balanced {
                background: linear-gradient(145deg, #1E3A8A, #1E40AF);
                color: #E5E7EB;
                border: 1px solid #3B82F6;
            }
            
            .preset-aggressive {
                background: linear-gradient(145deg, #7C2D12, #9A3412);
                color: #FDE68A;
                border: 1px solid #F59E0B;
            }
            
            .preset-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .preset-btn:active {
                transform: translateY(0);
            }
            
            /* Control Panel */
            .control-panel {
                display: grid;
                gap: 10px;
                margin: 20px 0;
            }
            
            .control-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .btn {
                padding: 14px;
                border: none;
                border-radius: 12px;
                font-weight: 700;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                letter-spacing: 0.3px;
                position: relative;
                overflow: hidden;
            }
            
            .btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.1);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }
            
            .btn:active::after {
                width: 300px;
                height: 300px;
            }
            
            .btn-primary {
                background: var(--gradient-primary);
                color: white;
                border: none;
                font-weight: 800;
                box-shadow: var(--shadow-lg);
            }
            
            .btn-secondary {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }
            
            .btn-danger {
                background: var(--gradient-danger);
                color: white;
                border: none;
            }
            
            .btn-warning {
                background: var(--gradient-warning);
                color: #1F2937;
                border: none;
            }
            
            .btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
            
            .btn:active {
                transform: translateY(0);
            }
            
            /* Settings */
            .settings-group {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 16px;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-md);
            }
            
            .settings-title {
                font-size: 13px;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer;
                user-select: none;
                padding: 8px 0;
            }
            
            .settings-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-top: 12px;
            }
            
            .input-group {
                margin-bottom: 10px;
            }
            
            .input-label {
                display: block;
                font-size: 11px;
                color: var(--text-secondary);
                margin-bottom: 6px;
                font-weight: 500;
            }
            
            input, select {
                width: 100%;
                padding: 10px 12px;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 12px;
                font-weight: 500;
                font-family: 'Inter', sans-serif;
                transition: all 0.3s;
            }
            
            input:focus, select:focus {
                outline: none;
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }
            
            /* Logs */
            .logs-container {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                border-radius: 12px;
                padding: 16px;
                margin: 16px 0;
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--border-color);
                box-shadow: var(--shadow-md);
            }
            
            .logs-header {
                display: grid;
                grid-template-columns: 1.2fr 1fr 0.8fr 1.2fr;
                padding: 10px 0;
                border-bottom: 1px solid var(--border-color);
                font-size: 11px;
                color: var(--text-secondary);
                font-weight: 600;
                text-align: center;
                position: sticky;
                top: 0;
                background: var(--bg-secondary);
                z-index: 1;
            }
            
            .log-entry {
                display: grid;
                grid-template-columns: 1.2fr 1fr 0.8fr 1.2fr;
                padding: 8px 0;
                border-bottom: 1px solid rgba(55, 65, 81, 0.3);
                font-size: 11px;
                text-align: center;
                transition: background 0.2s;
            }
            
            .log-entry:hover {
                background: rgba(55, 65, 81, 0.2);
            }
            
            /* Footer */
            .footer {
                background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
                padding: 16px;
                border-top: 1px solid var(--border-color);
                text-align: center;
                flex-shrink: 0;
            }
            
            .support-info {
                font-size: 11px;
                color: var(--text-secondary);
                line-height: 1.5;
            }
            
            .support-link {
                color: var(--accent-primary);
                text-decoration: none;
                font-weight: 600;
                transition: color 0.3s;
            }
            
            .support-link:hover {
                color: var(--accent-secondary);
                text-decoration: underline;
            }
            
            /* Text Colors */
            .text-success { color: var(--accent-success) !important; }
            .text-warning { color: var(--accent-warning) !important; }
            .text-danger { color: var(--accent-danger) !important; }
            .text-info { color: var(--accent-primary) !important; }
            .text-muted { color: var(--text-muted) !important; }
            
            /* Session Summary */
            .summary-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-top: 12px;
            }
            
            .summary-item {
                background: var(--bg-primary);
                padding: 10px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            
            .summary-label {
                font-size: 10px;
                color: var(--text-secondary);
                margin-bottom: 4px;
                font-weight: 500;
            }
            
            .summary-value {
                font-size: 12px;
                font-weight: 700;
                color: var(--text-primary);
            }
            
            /* Resize Handle */
            .resize-handle {
                position: absolute;
                bottom: 0;
                right: 0;
                width: 20px;
                height: 20px;
                cursor: se-resize;
                background: linear-gradient(135deg, transparent 50%, var(--border-light) 50%);
                border-top-left-radius: 8px;
            }
            
            /* Animation */
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            
            .pulse {
                animation: pulse 2s infinite;
            }
            
            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: var(--bg-tertiary);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: var(--border-light);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: var(--accent-primary);
            }
        `;
        document.head.appendChild(s);
        
        const d = document.createElement("div");
        d.id = "orion-wrap";
        d.innerHTML = `
            <div class="resize-handle"></div>
            
            <!-- Premium Header -->
            <div class="header">
                <div class="header-main">
                    <div class="header-title">
                        ORION PRO
                    </div>
                    <div class="license-badge">
                        ${bot.licenseTier}
                    </div>
                </div>
                
                <!-- User Info Card -->
                <div class="user-info-card">
                    <div class="user-info-left">
                        <div class="user-avatar">
                            üë§
                        </div>
                        <div class="user-details">
                            <div class="username">${bot.stakeUser}</div>
                            <div class="expiry-date">
                                <span>üìÖ</span>
                                <span>Expires: ${userExpiry}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="status-badge" id="st-status-text">üü¢ READY</div>
            </div>
            
            <!-- Currency Selector -->
            <div class="currency-selector">
                <select id="p-currency" class="currency-select">
                    <option value="loading">Loading currencies...</option>
                </select>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
                <button class="tab-btn" data-tab="logs">üìù Logs</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- Balance & Profit Cards -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-title">
                            <span>üí∞</span>
                            BALANCE
                        </div>
                        <div class="card-value" id="dashboard-balance">0.0000</div>
                        <div class="card-sub" id="dashboard-profit">+0.0000 (0.00%)</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">
                            <span>üéØ</span>
                            BETS
                        </div>
                        <div class="card-value" id="dashboard-bets">0</div>
                        <div class="card-sub">W/L: <span id="dashboard-wl">0/0</span></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">
                            <span>üéÆ</span>
                            MODE
                        </div>
                        <div class="card-value" id="dashboard-mode">BASE</div>
                        <div class="card-sub">Bets: <span id="dashboard-mode-bets">0</span></div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">
                            <span>üìä</span>
                            SESSION
                        </div>
                        <div class="card-value" id="dashboard-session">1/20</div>
                        <div class="card-sub" id="dashboard-session-profit">+0.0000</div>
                    </div>
                </div>
                
                <!-- Session Progress -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Session Progress</span>
                        <span id="session-progress-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="session-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Quick Presets -->
                <div class="presets-grid">
                    <button class="preset-btn preset-conservative" onclick="applyPreset('CONSERVATIVE')">
                        <span>üõ°Ô∏è</span>
                        CONSERVATIVE
                    </button>
                    <button class="preset-btn preset-balanced" onclick="applyPreset('BALANCED')">
                        <span>‚öñÔ∏è</span>
                        BALANCED
                    </button>
                    <button class="preset-btn preset-aggressive" onclick="applyPreset('AGGRESSIVE')">
                        <span>‚ö°</span>
                        AGGRESSIVE
                    </button>
                </div>
                
                <!-- Hybrid Recovery Monitor -->
                <div class="recovery-monitor">
                    <div class="recovery-header">
                        <div class="recovery-title">
                            <span>üîÑ</span>
                            HYBRID RECOVERY
                        </div>
                        <div class="text-muted" id="recovery-mode">READY</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span id="recovery-status">INACTIVE</span>
                            <span>Level: <span id="recovery-level">0</span></span>
                        </div>
                        <div class="progress-bar">
                            <div id="recovery-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="recovery-stats">
                        <div class="recovery-stat">
                            <div class="recovery-stat-label">Loss Streak</div>
                            <div class="recovery-stat-value" id="recovery-streak">0</div>
                        </div>
                        <div class="recovery-stat">
                            <div class="recovery-stat-label">Recovery Wins</div>
                            <div class="recovery-stat-value" id="recovery-wins">0/3</div>
                        </div>
                        <div class="recovery-stat">
                            <div class="recovery-stat-label">Sequence</div>
                            <div class="recovery-stat-value" id="recovery-sequence">[ ]</div>
                        </div>
                        <div class="recovery-stat">
                            <div class="recovery-stat-label">Success Rate</div>
                            <div class="recovery-stat-value" id="recovery-success">0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Session Summary -->
                <div class="settings-group">
                    <div class="settings-title">
                        <span>üìà</span>
                        SESSION SUMMARY
                    </div>
                    <div id="session-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Win Rate</div>
                                <div class="summary-value">0.0%</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ROI</div>
                                <div class="summary-value">0.00%</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Profit/Bet</div>
                                <div class="summary-value">0.0000</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Avg Bet Time</div>
                                <div class="summary-value">0ms</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Controls -->
                <div class="control-panel">
                    <button id="btn-run" class="btn btn-primary">
                        <span>üöÄ</span>
                        START BOT
                    </button>
                    
                    <div class="control-row">
                        <button id="btn-pause" class="btn btn-warning">
                            <span>‚è∏Ô∏è</span>
                            PAUSE
                        </button>
                        <button id="btn-stop" class="btn btn-danger">
                            <span>üõë</span>
                            STOP
                        </button>
                    </div>
                    
                    <div class="control-row">
                        <button onclick="rotateMode('BASE')" class="btn btn-secondary">
                            <span>üèóÔ∏è</span>
                            BASE MODE
                        </button>
                        <button onclick="rotateMode('WAGER')" class="btn btn-secondary">
                            <span>‚ö°</span>
                            WAGER MODE
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <!-- Base Mode Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>üèóÔ∏è</span>
                        BASE MODE SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Base Bet</label>
                            <input id="p-basebet" value="0.00000100" type="number" step="0.00000001" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Chance Min</label>
                            <input id="p-bch-min" value="80.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Chance Max</label>
                            <input id="p-bch-max" value="95.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Hunt Chance Min</label>
                            <input id="p-hch-min" value="20.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Hunt Chance Max</label>
                            <input id="p-hch-max" value="30.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Multiplier Start</label>
                            <input id="p-multi-start" value="1.45" type="number" step="0.05" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Multiplier Increment</label>
                            <input id="p-multi-inc" value="0.05" type="number" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Wager Mode Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>‚ö°</span>
                        WAGER MODE SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Wager Chance</label>
                            <input id="p-wgr-chance" value="99.0" type="number" step="0.1" min="90" max="99.99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Wager Divider</label>
                            <input id="p-wgr-div" value="100" type="number" step="1" min="10">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Recovery Chance Min</label>
                            <input id="p-chrec-min" value="50.0" type="number" step="0.1" min="1" max="99">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Recovery Chance Max</label>
                            <input id="p-chrec-max" value="70.0" type="number" step="0.1" min="1" max="99">
                        </div>
                    </div>
                </div>
                
                <!-- Hybrid Recovery Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>üîÑ</span>
                        HYBRID RECOVERY SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Recovery Mode</label>
                            <select id="p-recovery-mode">
                                <option value="dalembert_only">D'Alembert Only</option>
                                <option value="labouchre_only">Labouchre Only</option>
                                <option value="hybrid" selected>Hybrid</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Loss Threshold</label>
                            <input id="p-recovery-threshold" value="-0.00000500" type="number" step="0.00000001" max="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">D'Alembert ‚Üí Labouchre</label>
                            <input id="p-dalembert-switch" value="6" type="number" step="1" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Labouchre ‚Üí D'Alembert</label>
                            <input id="p-labouchre-switch" value="2" type="number" step="1" min="1">
                        </div>
                    </div>
                </div>
                
                <!-- Rotation Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>üîÑ</span>
                        ROTATION SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Auto Rotation</label>
                            <select id="p-auto-rotate-enabled">
                                <option value="1">Enabled</option>
                                <option value="0">Disabled</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Cooldown (seconds)</label>
                            <input id="p-rotate-cooldown" value="30" type="number" step="5" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Target Profit</label>
                            <input id="p-base-target-profit" value="0.00000500" type="number" step="0.00000001" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Min Bets</label>
                            <input id="p-base-min-bets" value="10" type="number" step="1" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Stop Loss</label>
                            <input id="p-base-stop-loss" value="0.00001000" type="number" step="0.00000001" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Session Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>üéØ</span>
                        SESSION SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Max Sessions</label>
                            <input id="p-max-sessions" value="20" type="number" step="1" min="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Session Target %</label>
                            <input id="p-session-target" value="10.0" type="number" step="0.1" min="0.1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Session Stop Loss %</label>
                            <input id="p-session-stoploss" value="5.0" type="number" step="0.1" min="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Safety Settings -->
                <div class="settings-group">
                    <div class="settings-title" onclick="toggleSettings(this)">
                        <span>üõ°Ô∏è</span>
                        SAFETY SETTINGS
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="settings-grid" style="display: none;">
                        <div class="input-group">
                            <label class="input-label">Minimum Bet</label>
                            <input id="p-minbet" value="0.00000001" type="number" step="0.00000001" min="0">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Global Stop Loss %</label>
                            <input id="p-stoploss-pct" value="5.0" type="number" step="0.1" min="0.1">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="logs-container">
                    <div class="logs-header">
                        <span>AMOUNT</span>
                        <span>CHANCE</span>
                        <span>MODE</span>
                        <span>PROFIT</span>
                    </div>
                    <div id="p-log-body"></div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
                <div class="support-info">
                    üí¨ <a href="https://t.me/${CONFIG.supportContact.replace('@', '')}" target="_blank" class="support-link">${CONFIG.supportContact}</a>
                    <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
                        ‚ö° ${CONFIG.version} | üîí ${bot.licenseTier} | üîÑ Hybrid Recovery System
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(d);
        
        // Add resize functionality
        let isResizing = false;
        const resizeHandle = d.querySelector('.resize-handle');
        const orionWrap = d;
        
        resizeHandle.addEventListener('mousedown', initResize);
        resizeHandle.addEventListener('touchstart', initResize);
        
        function initResize(e) {
            e.preventDefault();
            isResizing = true;
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('touchmove', resize);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchend', stopResize);
        }
        
        function resize(e) {
            if (!isResizing) return;
            
            e.preventDefault();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            if (clientX && clientY) {
                const newWidth = Math.max(380, Math.min(clientX - orionWrap.offsetLeft, window.innerWidth * 0.95));
                const newHeight = Math.max(550, Math.min(clientY - orionWrap.offsetTop, window.innerHeight * 0.95));
                
                orionWrap.style.width = `${newWidth}px`;
                orionWrap.style.height = `${newHeight}px`;
            }
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('touchmove', resize);
        }
        
        // Tab Navigation
        const tabBtns = d.querySelectorAll('.tab-btn');
        const tabContents = d.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const tabId = btn.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
                
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            });
        });
        
        // Toggle settings
        window.toggleSettings = function(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.toggle-icon');
            
            if (content.style.display === 'grid') {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'grid';
                icon.textContent = '‚ñ≤';
            }
        };
        
        // Global functions
        window.rotateMode = rotateMode;
        window.applyPreset = applyPreset;
        
        // Event Listeners
        document.getElementById("p-currency").addEventListener('change', async (e) => {
            bot.selectedCurrency = e.target.value;
            localStorage.setItem('orion_last_coin', bot.selectedCurrency);
            await updateBalanceDisplay();
        });

        document.getElementById("btn-run").addEventListener('click', async () => {
            if (!bot.isRunning) {
                bot.selectedCurrency = document.getElementById("p-currency").value;
                await API.syncOnce();
                
                updateRotationConfigFromUI();
                HybridRecovery.initialize();
                
                bot.session.maxSessions = getVal("p-max-sessions");
                bot.session.currentSession = 1;
                
                bot.stats.startBal = await API.getBalance(bot.selectedCurrency);
                bot.stats.currentBal = bot.stats.startBal;
                bot.stats.sessionStartBal = bot.stats.startBal;
                bot.stats.sessionProfit = 0;
                bot.stats.sessionWagered = 0;
                bot.stats.sessionBets = 0;
                bot.stats.profit = 0;
                bot.stats.wagered = 0;
                bot.stats.bets = 0;
                bot.stats.wins = 0;
                bot.stats.loss = 0;
                bot.stats.maxDD = 0;
                bot.stats.maxProfit = 0;
                bot.stats.peakBalance = bot.stats.startBal;
                bot.stats.baseModeProfit = 0;
                bot.stats.wagerModeProfit = 0;
                bot.stats.baseModeBets = 0;
                bot.stats.wagerModeBets = 0;
                bot.stats.baseModeWins = 0;
                bot.stats.wagerModeWins = 0;
                bot.stats.longestWinStreak = 0;
                bot.stats.longestLossStreak = 0;
                bot.stats.currentWinStreak = 0;
                bot.stats.currentLossStreak = 0;
                bot.stats.biggestWin = 0;
                bot.stats.biggestLoss = 0;
                bot.stats.totalSessions = 0;
                bot.stats.profitableSessions = 0;
                bot.stats.losingSessions = 0;
                bot.stats.completedSessions = 0;
                bot.stats.maxConsecutiveLoss = 0;
                bot.stats.maxConsecutiveWin = 0;
                
                bot.targetAbs = bot.stats.startBal * (getVal("p-session-target") / 100);
                bot.isRunning = true;
                bot.isPaused = false;
                bot.startTime = Date.now();
                bot.stopTime = null;
                bot.lastRotationTime = null;
                bot.lastReportTime = Date.now();
                
                bot.session.sessionHistory = [];
                bot.session.modeStartTime = Date.now();
                bot.session.modeBetsCount = 0;
                
                bot.wgr.balhigh = bot.stats.startBal;
                bot.wgr.profitc = 0;
                bot.wgr.ctwin = 0;
                bot.wgr.betload = 0;
                
                rotateToBaseMode();
                
                const logBody = document.getElementById("p-log-body");
                if (logBody) logBody.innerHTML = "";
                
                updateLogs(0, 0, "SESSION", 0, `Session ${bot.session.currentSession} started`);
                
                updateStatus("‚ö° RUNNING", "#10B981");
                
                await sendTelegramReport("start");
                runLoop();
            }
        });
        
        document.getElementById("btn-stop").addEventListener('click', async () => {
            await stopEngine();
            updateStatus("üõë STOPPED", "#EF4444");
            await sendTelegramReport("stop");
        });
        
        document.getElementById("btn-pause").addEventListener('click', async () => {
            bot.isPaused = !bot.isPaused;
            updateStatus(bot.isPaused ? "‚è∏Ô∏è PAUSED" : "‚ö° RUNNING",
                       bot.isPaused ? "#F59E0B" : "#10B981");
        });
        
        // Initialize Hybrid Recovery
        HybridRecovery.initialize();
        
        // Initialize UI
        API.syncOnce();
    }

    // ==================== REAL-TIME UPDATES ====================
    setInterval(() => {
        try {
            if (!document.getElementById("st-status-text")) return;
            
            if (Performance.shouldUpdateUI()) {
                // Update dashboard
                document.getElementById("dashboard-balance").innerText = bot.stats.currentBal.toFixed(4);
                
                const profitPct = (bot.stats.profit / (bot.stats.startBal || 1) * 100);
                const profitColor = profitPct >= 0 ? '#10B981' : '#EF4444';
                document.getElementById("dashboard-profit").innerText = 
                    `${bot.stats.profit >= 0 ? '+' : ''}${bot.stats.profit.toFixed(8)} (${profitPct.toFixed(2)}%)`;
                document.getElementById("dashboard-profit").style.color = profitColor;
                
                document.getElementById("dashboard-bets").innerText = bot.stats.bets;
                document.getElementById("dashboard-wl").innerText = `${bot.stats.wins}/${bot.stats.loss}`;
                document.getElementById("dashboard-mode").innerText = bot.mode;
                document.getElementById("dashboard-mode-bets").innerText = bot.session.modeBetsCount;
                document.getElementById("dashboard-session").innerText = `${bot.session.currentSession}/${bot.session.maxSessions}`;
                
                const sessionProfitPct = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
                document.getElementById("dashboard-session-profit").innerText = 
                    `${bot.stats.sessionProfit >= 0 ? '+' : ''}${bot.stats.sessionProfit.toFixed(8)} (${sessionProfitPct.toFixed(2)}%)`;
                document.getElementById("dashboard-session-profit").style.color = 
                    bot.stats.sessionProfit >= 0 ? '#10B981' : '#EF4444';
                
                // Update session progress
                const sessionTargetPct = getVal("p-session-target");
                const sessionStopLossPct = getVal("p-session-stoploss");
                const sessionProfitPct2 = bot.stats.sessionProfit / bot.stats.sessionStartBal * 100;
                const sessionProgress = Math.min(100, Math.max(0, (sessionProfitPct2 + sessionStopLossPct) / (sessionTargetPct + sessionStopLossPct) * 100));
                
                document.getElementById("session-progress-text").innerText = `${sessionProgress.toFixed(1)}%`;
                document.getElementById("session-progress").style.width = `${sessionProgress}%`;
                
                // Update Hybrid Recovery UI
                if (HybridRecovery.isActive()) {
                    document.getElementById("recovery-status").innerText = "ACTIVE";
                    document.getElementById("recovery-mode").innerText = HybridRecovery.mode;
                    document.getElementById("recovery-level").innerText = HybridRecovery.currentLevel;
                    document.getElementById("recovery-streak").innerText = HybridRecovery.lossStreak;
                    document.getElementById("recovery-wins").innerText = `${HybridRecovery.recoveryWins}/3`;
                    
                    const recoveryStats = HybridRecovery.getStats();
                    document.getElementById("recovery-success").innerText = `${recoveryStats.successRate}%`;
                    
                    const progress = HybridRecovery.getProgress();
                    document.getElementById("recovery-progress").style.width = `${progress}%`;
                    
                    if (HybridRecovery.mode === "LABOUCHRE") {
                        document.getElementById("recovery-sequence").innerText = `[${HybridRecovery.sequence.join(', ')}]`;
                    }
                }
                
                // Update user info
                const usernameEl = document.querySelector('.username');
                if (usernameEl) {
                    usernameEl.textContent = bot.stakeUser;
                }
                
                // Update session summary periodically
                if (Date.now() % 5000 < 100) {
                    updateSessionSummary();
                }
            }
                
        } catch (e) {
            console.error("UI update error:", e);
        }
    }, 100);

    // ==================== INITIALIZATION ====================
    async function initialize() {
        const isValid = await validateLicense();
        
        if (isValid) {
            console.log(`‚úÖ License valid for ${currentUser} (${licenseData.tier})`);
            bot.licenseTier = licenseData.tier;
            bot.stakeUser = currentUser;
            
            createUI();
            
        } else {
            console.log("‚ùå License invalid or user not whitelisted");
        }
    }

    // Start
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();
